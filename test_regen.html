<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ¡ƒåœ’å¸‚ å…¬è»Š + YouBike + EV æ•´åˆç‰ˆï¼ˆmap-onlyï¼šå°æªœæºª UIï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- FontAwesome / ArcGIS / Chart.js / Swiperï¼ˆå°æªœæºª UI æœƒç”¨åˆ°å°±ä¸€èµ·ä¿ç•™ï¼‰ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ====== âœ… çµ±ä¸€åœ–è¡¨æ–‡å­—/åº§æ¨™è»¸/åœ–ä¾‹é¡è‰²ï¼ˆé¿å…ç§‘æŠ€éœ“è™¹è‰²ï¼‰ ====== */
window.addEventListener('DOMContentLoaded', () => {
  if (window.Chart && Chart.defaults) {
    Chart.defaults.color = '#ffffff';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.15)';
    Chart.defaults.font.family = '"Segoe UI","Noto Sans TC",sans-serif';
    // è®“åº§æ¨™è»¸æ ¼ç·šæ›´æŸ”å’Œ
    const grid = { color: 'rgba(255,255,255,0.12)' };
    Chart.defaults.scales = Chart.defaults.scales || {};
    // ä¸å¼·è¡ŒæŒ‡å®šæ¯ä¸€ç¨® scaleï¼Œåªæä¾›é è¨­å€¼ï¼ˆå„åœ–ä»å¯è‡ªè¨‚ï¼‰
    Chart.defaults.scale = Chart.defaults.scale || {};
    Chart.defaults.scale.grid = Object.assign({}, Chart.defaults.scale.grid || {}, grid);
    Chart.defaults.plugins = Chart.defaults.plugins || {};
    Chart.defaults.plugins.legend = Chart.defaults.plugins.legend || {};
    Chart.defaults.plugins.legend.labels = Object.assign({}, Chart.defaults.plugins.legend.labels || {}, { color:'#ffffff' });
    Chart.defaults.plugins.title = Object.assign({}, Chart.defaults.plugins.title || {}, { color:'#ffffff' });
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script src="https://js.arcgis.com/4.31/"></script>

<style>
html, body, #viewDiv {
  margin: 0; padding: 0;
  height: 100%;
  width: 100%;
  background: #0f172a;
  color: #e5e7eb;
  font-family: "Segoe UI","Noto Sans TC",sans-serif;
}

/* =========================
   âœ… å³ä¸Šè§’ï¼š[äº¤é€š] ç¸½é–‹é—œ
   ========================= */
#uiModeToggle{
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 500000;
  padding: 10px 14px;
  border-radius: 14px;
  background: rgba(2,6,23,0.85);
  color: #e5e7eb;
  border: 1px solid rgba(255,255,255,.25);
  font-size: 13px;
  cursor: pointer;
  backdrop-filter: blur(6px);
}
#uiModeToggle:hover{ background: rgba(30,41,59,.95); }

/* =========================
   âœ… å³ä¸‹è§’ï¼šé»ä½é–‹é—œé¢æ¿ + é–‹é—œæŒ‰éˆ•
   ========================= */
#layerPanelToggle {
  position: fixed;
  right: 16px;
  bottom: 10px;
  z-index: 500000;
  padding: 8px 14px;
  border-radius: 999px;
  background: rgba(15,23,42,0.96);
  color: #e5e7eb;
  border: 1px solid rgba(148,163,184,0.7);
  font-size: 13px;
  cursor: pointer;
  backdrop-filter: blur(8px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}
#layerPanelToggle:hover {
  background: rgba(30,64,175,0.95);
}

#layerPanel {
  position: fixed;
  right: 10px;
  bottom: 50px;
  z-index: 500000;
  background: rgba(15,23,42,0.96);
  backdrop-filter: blur(10px);
  padding: 8px 12px 10px;
  border-radius: 14px;
  min-width: 190px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.7);
  font-size: 13px;
}
.layer-panel-header{
  font-weight: 600;
  font-size: 13px;
  margin-bottom: 6px;
  padding-bottom: 4px;
  border-bottom: 1px solid rgba(148,163,184,0.5);
}
.layer-toggle-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:6px;
  margin:4px 0;
}
.layer-toggle-row .toggle-label{
  white-space: nowrap;
}

/* å…±ç”¨ switch æ¨£å¼ï¼ˆäº¤é€šç”¨ï¼‰ */
.switch {
  position: relative;
  display: inline-block;
  width: 38px;
  height: 20px;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background-color: #4b5563;
  transition: .2s;
  border-radius: 999px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  transition: .2s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #22c55e;
}
input:checked + .slider:before {
  transform: translateX(18px);
}

/* =========================
   âœ… åªæœ‰åœ°åœ–æ¨¡å¼ï¼šéš±è—äº¤é€š UI
   ========================= */
body.map-only .panel{ display:none !important; }
body.map-only #floatingPopup{ display:none !important; }
body.map-only #modeToggleBtn{ display:none !important; }
body.map-only #layerPanel,
body.map-only #layerPanelToggle{ display:none !important; }

/* âœ… äº¤é€šé—œé–‰(map-only)æ™‚ï¼Œä¹Ÿä¸€èµ·éš±è— YouBike / EV é¢æ¿ */
body.map-only #yRightPanel,
body.map-only #infoPanel,
body.map-only #evRightPanel,
body.map-only #evInfoPanel,
body.map-only #pRightPanel,
body.map-only #pInfoPanel,
body.map-only #parkingModeBtn{
  display:none !important;

  background: rgba(59,130,246,0.75);
  color:#ffffff;

  background: rgba(37,99,235,0.9) !important;
  color:#ffffff !important;
}

/* =========================
   âœ… CCTVï¼ˆåªåœ¨äº¤é€šä»‹é¢é¡¯ç¤ºï¼‰
   ========================= */
#cctv-toggle-btn{
  position: fixed;
  bottom: 3px;
  right: 175px;
  z-index: 900;
  width: 50px;
  height: 50px;
  padding: 0;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: url('https://vvrl.cc/api/image/kru7l8/view') no-repeat center center;
  background-size: contain;
  outline: none;
  transition: transform 0.1s ease;
  display: none; /* ç”± openTrafficUI() é¡¯ç¤º */
}
#cctv-toggle-btn:hover{ transform: scale(1.05); }
#cctv-toggle-btn:active{ transform: scale(0.9); }

#cctv-panel{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  background: rgba(255,255,255,0.98);
  padding: 14px 18px;
  border-radius: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  width: 340px;
  max-height: 70vh;
    min-height: 0;
overflow: hidden;
  display: none;
  flex-direction: column;
}


/* âœ… CCTV é¢æ¿ï¼šå…§å®¹å¯æ»¾å‹•ï¼Œåº•éƒ¨é¡¯ç¤ºä½ç½®é–‹é—œå›ºå®š */
#cctv-scroll-body{
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}
/* âœ… é¡¯ç¤ºCCTVä½ç½®é–‹é—œï¼šæ”¾æœ€ä¸‹é¢ */
#cctv-switch-container{
  position: sticky;
  bottom: 0;
  background: rgba(255,255,255,0.98);
  padding: 6px 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  border-top: 1px solid #ccc;
}

#cctv-panel h3{ margin:0 0 10px 0; font-size:1.2rem; color:#0077cc; text-align:center; }
#cctv-panel select{ width:100%; margin-bottom:10px; padding:8px 10px; font-size:1rem; border-radius:8px; border:2px solid #0077cc; background:#f9f9f9; color:#111827; }
#cctv-panel .switch-container{ display:flex; align-items:center; gap:8px; margin-bottom:10px; }
#cctv-panel .switch{ position: relative; width:50px; height:26px; display:inline-block; }
#cctv-panel .switch input{ opacity:0; width:0; height:0; }
#cctv-panel .slider{ position:absolute; cursor:pointer; inset:0; background:#ccc; border-radius:26px; transition:0.3s; }
#cctv-panel .slider:before{ content:""; position:absolute; left:3px; bottom:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition:0.3s; }
#cctv-panel input:checked + .slider{ background:#0077cc; }
#cctv-panel input:checked + .slider:before{ transform:translateX(24px); }

#cctv-panel .cctv-video{ width:100%; border-radius:10px; border:2px solid #0077cc; margin-bottom:8px; display:block; }
#cctv-panel .cctv-info{ background:#e6f0ff; border-left:4px solid #0077cc; padding:8px 10px; border-radius:8px; font-size:0.95rem; color:#222; margin-bottom:8px; }
#cctv-buttons-container button{ margin:2px; padding:3px 5px; border:1px solid #0077cc; border-radius:4px; background:#f9f9f9; cursor:pointer; }
#cctv-buttons-container button:hover{ background:#e0f0ff; }
#back-btn{ display:none; margin-top:8px; padding:6px 10px; border:none; background:#0077cc; color:#fff; border-radius:6px; cursor:pointer; }
/* ===== CCTV é¢æ¿æ–‡å­—é¡è‰²ä¿®æ­£ ===== */
#cctv-panel,
#cctv-panel * {
  color: #000 !important;   /* å¼·åˆ¶æ”¹æˆé»‘è‰²æ–‡å­— */
}

/* æ¨™é¡Œç¨å¾®åŠ ç²— */
#cctv-panel h3,
#cctv-panel .cctv-title {
  color: #000 !important;
  font-weight: 600;
}

@media (max-width:480px){
  #cctv-panel{ width:92%; left:50%; top:50%; transform: translate(-50%,-50%); max-height:60vh; }
}

/* map-onlyï¼ˆäº¤é€šé—œé–‰ï¼‰æ™‚å¼·åˆ¶éš±è— */
body.map-only #cctv-panel{ display:none !important; }

/* =========================
   âœ… CMSï¼ˆåªåœ¨äº¤é€šä»‹é¢é¡¯ç¤ºï¼‰
   ========================= */
#cms-toggle-btn:hover{ transform: scale(1.08); background-color: #f0f0f0; }
#cms-toggle-btn:active{ transform: scale(0.9); background-color: #e0e0e0; }
#cms-toggle-btn.active{ background-color: #ff0000; color: #ffffff; border-color: #ff0000; }

/* âœ… CMS Popupï¼šç¢ºä¿åœ¨æœ€ä¸Šå±¤ä¸”å¯é»æ“Š */
/* ç§»é™¤ç®­é ­ */
/* map-only æ™‚è‡ªå‹•éš±è— */
/* CCTV é¢æ¿å…§æ§åˆ¶é … */
#cctv-panel h3{
  margin: 0 0 10px 0;
  font-size: 1.15rem;
  color: #0077cc;
  text-align: center;
}
#cctv-panel select{
  width: 100%;
  margin-bottom: 10px;
  padding: 8px 10px;
  font-size: 0.98rem;
  border-radius: 10px;
  border: 2px solid #0077cc;
  background: #f9f9f9;
  color:#0f172a;
}
#cctv-panel .cctv-switch-container{
  position: sticky;
  bottom: 0;
  background: rgba(255,255,255,0.98);
  padding: 8px 0 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  border-top: 1px solid #d1d5db;
  flex: 0 0 auto;
}
#cctv-panel .cctv-switch{
  position: relative;
  width: 50px;
  height: 26px;
  display: inline-block;
}
#cctv-panel .cctv-switch input{ opacity:0; width:0; height:0; }
#cctv-panel .cctv-slider{
  position:absolute;
  cursor:pointer;
  inset:0;
  background:#cbd5e1;
  border-radius: 26px;
  transition: 0.2s;
}
#cctv-panel .cctv-slider:before{
  content:"";
  position:absolute;
  left:3px;
  bottom:3px;
  width:20px;
  height:20px;
  background:#fff;
  border-radius:50%;
  transition: 0.2s;
}
#cctv-panel .cctv-switch input:checked + .cctv-slider{ background:#0077cc; }
#cctv-panel .cctv-switch input:checked + .cctv-slider:before{ transform: translateX(24px); }

#cctv-panel .cctv-video{
  width: 100%;
  border-radius: 12px;
  border: 2px solid #0077cc;
  margin-bottom: 8px;
  display: block;
}
#cctv-panel .cctv-info{
  background:#e6f0ff;
  border-left:4px solid #0077cc;
  padding:8px 10px;
  border-radius:10px;
  font-size: 0.95rem;
  color:#111827;
  margin-bottom: 8px;
}
#cctv-buttons-container button{
  margin: 2px;
  padding: 4px 6px;
  border: 1px solid #0077cc;
  border-radius: 8px;
  background: #f9f9f9;
  color:#0f172a;
  cursor:pointer;
}
#cctv-buttons-container button:hover{ background:#e0f0ff; }
#back-btn{
  display:none;
  margin-top: 8px;
  padding: 8px 10px;
  border:none;
  background:#0077cc;
  color:#fff;
  border-radius: 10px;
  cursor:pointer;
}

@media (max-width:480px){
  #cctv-panel{
    width: 92%;
    left: 50%;
    top: 12px;
    transform: translate(-50%, 0);
    max-height: 60vh;
  }
}

/* ===== å…¬è»Šï¼šåˆä½µé¢æ¿ ===== */
.panel{
  position: absolute;
  top: 60px;
  height: 520px;
  right:10px;
  background: rgba(15,23,42,0.94);
  border-radius: 26px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.45);
  display: flex;
  flex-direction: column;
  z-index: 999;
}
.panel-header{
  padding: 12px 14px;
  font-weight: 600;
  background: linear-gradient(135deg,#1e293b,#020617);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top-left-radius: 26px;
  border-top-right-radius: 26px;
  gap: 10px;
}
.panel-header .small{
  text-align: right;
  max-width: 70%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.panel-combined{ left: 10px; width: 380px; }

.panel-tools {
  padding: 10px;
  display: flex;
  gap: 8px;
  align-items: center;
  border-bottom: 1px solid rgba(255,255,255,.06);
}

/* Tab å·¥å…·åˆ— */
.panel-tools.tabbar{
  justify-content: space-between;
  gap: 10px;
}
.tab-left{
  display: flex;
  gap: 8px;
  align-items: center;
  flex: 0 0 auto;
}
.tab-right{
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1 1 auto;
  justify-content: flex-end;
  min-width: 0;
}

/* åœ–ä¾‹ */
.panel-legend{
  display:flex;
  align-items:center;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: flex-end;
}
.legend-item{
  display:flex;
  align-items:center;
  gap: 4px;
  font-size: 11px;
  color: #cbd5f5;
  opacity: .92;
  white-space: nowrap;
}
.legend-item img{
  width: 18px;
  height: 18px;
  object-fit: contain;
}

select, button {
  background: #020617;
  color: #e5e7eb;
  border: 1px solid rgba(255,255,255,.15);
  border-radius: 10px;
  padding: 8px 10px;
  font-size: 13px;
}
button { cursor: pointer; }
button.active { border-color: #facc15; }

.panel-page{
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}
.table-container {
  flex: 1;
  overflow-y: auto;
  scrollbar-width: none;
}
.table-container::-webkit-scrollbar { display:none; }

table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
thead { position: sticky; top: 0; background: #020617; z-index: 2; }
th, td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,.06); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
th { text-align: left; }
td:nth-child(1), th:nth-child(1) { text-align: center; }
td:last-child, th:last-child { text-align: center; }
tr:hover { background: rgba(148,163,184,.15); cursor: pointer; }

.route-row-active {
  background: rgba(250,204,21,.22)!important;
  outline: 1px solid rgba(250,204,21,.20);
}

.badge { padding: 2px 4px; border-radius: 6px; color: #fff; font-size: 11px; }
.dir0 { background: #16a34a; }
.dir1 { background: #dc2626; }
.route-img { width: 100%; margin-top: 6px; border-radius: 10px; opacity: 0.95; cursor: zoom-in; }
tfoot td { padding: 10px; border-bottom: none; }

.small { font-size: 12px; color: #94a3b8; }

.route-link{
  color:#60a5fa;
  text-decoration: underline;
  cursor:pointer;
}
.route-link:hover{ opacity:.85; }

/* å…¬è»Šè¡¨ï¼šå‰ä¸‰æ¬„æ›´é å·¦ */
.tbl-bus th:nth-child(1),
.tbl-bus td:nth-child(1),
.tbl-bus th:nth-child(2),
.tbl-bus td:nth-child(2),
.tbl-bus th:nth-child(3),
.tbl-bus td:nth-child(3){
  text-align: left;
  padding-left: 6px;
  padding-right: 4px;
}

.tbl-bus th:nth-child(4),
.tbl-bus td:nth-child(4) {
  white-space: normal;
  text-overflow: clip;
  overflow: visible;
  text-align: left;
}

/* è‡ªè¨‚å½ˆè·³è¦–çª—ï¼ˆæ°¸é åœ¨æœ€ä¸Šå±¤ï¼‰ */
#floatingPopup{
  position: absolute;
  z-index: 200000;
  min-width: 240px;
  max-width: 340px;
  background: rgba(2,6,23,0.92);
  border: 1px solid rgba(255,255,255,.16);
  border-radius: 12px;
  box-shadow: 0 18px 40px rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
  color: #e5e7eb;
  pointer-events: auto;
  display: none;
}
#floatingPopup .pop-hd{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  font-weight: 700;
  border-bottom: 1px solid rgba(255,255,255,.08);
}
#floatingPopup .pop-bd{
  padding: 10px 12px;
  font-size: 13px;
  line-height: 1.45;
}
#floatingPopup .pop-close{
  cursor:pointer;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color:#e5e7eb;
  border-radius: 8px;
  padding: 4px 8px;
  font-size: 12px;
}
#floatingPopup .pop-arrow{
  position:absolute;
  left: 50%;
  bottom: -10px;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 10px solid rgba(2,6,23,0.92);
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
}

/* =========================
   âœ… YouBike / EV æ¨¡å¼åˆ‡æ›æŒ‰éˆ•ï¼ˆå³å´ç›´ç«‹ï¼‰
   ========================= */
#modeToggleBtn {
  position: absolute;
  top: 40px;
  right: 230px;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.5);
  border-radius: 8px 0 0 8px;
  cursor: pointer;
  font-size: 14px;
  z-index: 9999;
  writing-mode: vertical-rl;
  text-orientation: upright;
  width: 30px;
  height: auto;
  padding: 6px 0;
  text-align: center;
  transition: all 0.2s ease-in-out;
}
#modeToggleBtn:hover {
  background: rgba(255,255,255,0.98);
  transform: scale(1.05);
}

/* YouBike å³å´é¢æ¿ */
#yRightPanel {
  position: absolute;
  top: 20px;
  right: 10px;
  width: 200px;
  height: 60%;
  background: rgba(255,255,255,0.4);
  backdrop-filter: blur(8px);
  border-left: 1px solid rgba(255,255,255,0.3);
  display: flex;
  flex-direction: column;
  padding: 10px;
  border-radius: 8px;
  z-index: 9998;
}
#ySearchBox { width:100%; padding:8px; border:none; border-radius:6px; margin-bottom:10px; font-size:15px; }
#yStationList { flex:1; overflow-y:auto; scrollbar-width:none; -ms-overflow-style:none; }
#yStationList::-webkit-scrollbar { display:none; }
#yStationListInner { display:flex; flex-direction:column; }
.yStationItem { padding:8px; margin-bottom:6px; border-radius:6px; cursor:pointer; background:rgba(255,255,255,0.6); border:1px solid rgba(255,255,255,0.2); }
.yStationItem:hover { background: rgba(255,255,255,0.9); }
.yStationItem strong { display:block; font-size:14px; margin-bottom:2px;color: #0f172a; }
.yStationItem span { font-size:12px; color:#000080; }

/* YouBike infoPanel */
#infoPanel {
  position:absolute;
  left:50%;
  bottom:40px;
  transform: translateX(-50%);
  width:260px;
  height:150px;
  background:rgba(0,0,0,0.45);
  color:white;
  padding:12px;
  border-radius:8px;
  font-size:14px;
  line-height:1.4;
  display:none;
  cursor: move;
  overflow-y: auto;
  scrollbar-width: none;
  z-index: 9999;
}
#infoPanelClose { position:absolute; top:5px; right:8px; cursor:pointer; font-weight:bold; font-size:16px; }

/* EV å³å´é¢æ¿ */
#evRightPanel {
  position:absolute; top:40px; right:10px; width:200px; height:60%;
  background:rgba(255,255,255,0.4); backdrop-filter:blur(8px);
  border-left:1px solid rgba(255,255,255,0.3);
  display:flex; flex-direction:column; padding:10px; border-radius:8px;
  z-index:9998;
  display:none;
}
#evSearchBox { width:100%; padding:8px; border:none; border-radius:6px; margin-bottom:10px; font-size:15px; }
#evStationList { flex:1; overflow-y:auto; scrollbar-width:none; -ms-overflow-style:none; }
#evStationList::-webkit-scrollbar{ display:none; }
.evStationItem { padding:8px; margin-bottom:6px; border-radius:6px; cursor:pointer; background:rgba(255,255,255,0.6); border:1px solid rgba(255,255,255,0.2); }
.evStationItem:hover { background: rgba(255,255,255,0.9); }
#evRightPanel .evStationItem strong { color: #0f172a; }

/* EV infoPanel */
#evInfoPanel {
  position: absolute;
  left: 50%;
  bottom: 220px;
  transform: translateX(-50%);
  width: 350px;
  padding: 12px;
  border-radius: 10px;
  font-size: 14px;
  line-height: 1.6;
  cursor: move;
  z-index: 9999;

  /* â­ é—œéµä¿®æ­£ï¼šç§»å‹•æ™‚ä¸å†é€æ˜ */
  background: #111827 !important;   /* å¯¦å¿ƒæ·±è‰² */
  opacity: 1 !important;
  backdrop-filter: none !important;

  display: none;
  color: #ffffff;
}

#evInfoPanelClose { position:absolute; top:5px; right:8px; cursor:pointer; font-weight:bold; color:white; font-size:16px; }

/* =========================
   âœ… åœè»Šå ´ï¼ˆParkingï¼‰æ¨¡å¼ï¼šæŒ‰éˆ• + å³å´é¢æ¿ + è³‡è¨Šé¢æ¿
   ========================= */
#parkingModeBtn{
  position: absolute;
  top: 240px;              /* âœ… æ”¾åœ¨ modeToggleBtn(ç´„60px) ä¸‹æ–¹ï¼Œè¦–è¦ºä¸Šåœ¨ EV ä¸‹æ–¹ */
  right: 230px;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.5);
  border-radius: 8px 0 0 8px;
  cursor: pointer;
  font-size: 14px;
  z-index: 9999;
  writing-mode: vertical-rl;
  text-orientation: upright;
  width: 30px;
  height: auto;
  padding: 6px 0;
  color: #0f172a;
  text-align: center;
  transition: all 0.2s ease-in-out;

  background: rgba(59,130,246,0.75);
  color:#ffffff;

  background: rgba(37,99,235,0.9) !important;
  color:#ffffff !important;
}
#parkingModeBtn:hover{
  background: rgba(255,255,255,0.98);
  transform: scale(1.05);
}

/* åœè»Šå ´å³å´é¢æ¿ */
#pRightPanel{
  position:absolute; top:40px; right:10px; width:200px; height:60%;
  background:rgba(255,255,255,0.4); backdrop-filter:blur(8px);
  border-left:1px solid rgba(255,255,255,0.3);
  display:flex; flex-direction:column; padding:10px; border-radius:8px;
  z-index:9998;
  display:none;
}
#pSearchBox{ width:100%; padding:8px; border:none; border-radius:6px; margin-bottom:10px; font-size:15px; }
#pStationList{ flex:1; overflow-y:auto; scrollbar-width:none; -ms-overflow-style:none; }
#pStationList::-webkit-scrollbar{ display:none; }
.pStationItem{
  padding:8px; margin-bottom:6px; border-radius:6px; cursor:pointer;
  background:rgba(255,255,255,0.6); border:1px solid rgba(255,255,255,0.2);
}
.pStationItem:hover{ background: rgba(255,255,255,0.9); }
#pRightPanel .pStationItem strong{ color:#0f172a; display:block; font-size:14px; margin-bottom:2px; }
#pRightPanel .pStationItem span{ font-size:12px; color:#000080; }

/* åœè»Šå ´è³‡è¨Šé¢æ¿ï¼ˆå¯æ‹–æ›³ï¼‰ */
#pInfoPanel{
  position:absolute;
  left:50%;
  bottom:40px;
  transform: translateX(-50%);
  width:260px;
  height:150px;
  background:rgba(0,0,0,0.6);
  color:white;
  padding:12px;
  border-radius:8px;
  font-size:14px;
  line-height:1.6;
  display:none;
  cursor:move;
  z-index:9999;
  overflow-y:auto;
  scrollbar-width:none;
}
#pInfoPanel::-webkit-scrollbar{ display:none; }
#pInfoPanelClose{ position:absolute; top:5px; right:8px; cursor:pointer; font-weight:bold; color:white; font-size:16px; }

.connectorList { display:flex; flex-wrap:wrap; }
.connector { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin: 2px; transition: all 0.25s ease; box-shadow: 0 0 0 rgba(0, 0, 0, 0); }
.connector:hover { transform: scale(1.6); box-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 15px currentColor; filter: brightness(1.3); }
.status-1 { background-color: #4caf50; }
.status-2 { background-color: #ff9800; }
.status-3 { background-color: #f44336; }
.infoLine { display:flex; margin-bottom:4px; }
.infoIcon { width:20px; flex-shrink:0; }
.infoText { word-break:break-word; flex:1; }
.infoButtons { display:flex; justify-content:center; gap:10px; margin-top:8px; }
.infoButtons button { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; color:white; }
#showCPBtn { background:#4caf50; }
#showConnectorBtn { background:#2196F3; }
#cpDetails, #connectorDetails { margin-top:6px; font-size:13px; max-height:150px; overflow:auto; scrollbar-width:none; }
#cpDetails::-webkit-scrollbar, #connectorDetails::-webkit-scrollbar { display:none; }

.tooltip { position: absolute; background: rgba(255,255,255,0.9); color:#333; padding:6px 10px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size:13px; line-height:1.4; pointer-events:none; white-space:pre-line; z-index:10000; backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,0.5); transition: opacity 0.15s ease, transform 0.15s ease; transform: translateY(-4px); opacity:0; }
.tooltip.available { background: rgba(76,175,80,0.9); color:#fff; }
.tooltip.charging { background: rgba(255,152,0,0.9); color:#fff; }
.tooltip.error { background: rgba(244,67,54,0.9); color:#fff; }

/* âœ… åœ“å½¢æŒ‰éˆ•æç¤ºå°æ¡†ï¼ˆæ»‘é¼ ç§»éå»é¡¯ç¤ºï¼‰ */
.circle-btn-tip{
  position: fixed;
  z-index: 999999;
  opacity: 0;
  pointer-events: none;
  transform: translateY(-6px);
  transition: opacity 0.12s ease, transform 0.12s ease;
}
.circle-btn-tip.show{
  opacity: 1;
  transform: translateY(-10px);
}


/* å…±ç”¨æ¨™é¡Œæ¨£å¼ */
.panel-title {
  font-size: 18px;
  font-weight: 500;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
  padding: 1px 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  text-align: center;
}
.panel-title.youbike {
  color: #ff8d1c;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
}
.panel-title.ev {
  color: #1bb34e;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
}
.panel-title i { font-size: 18px; }

/* =========================
   âœ… è·¯ç·šåœ–æ”¾å¤§ Modal
   ========================= */
#imgModal {
  display: none;
  position: fixed;
  z-index: 999999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(4px);
}
#imgModalContent {
  display: block;
  max-width: 90%;
  max-height: 90%;
  margin: 60px auto;
  border-radius: 10px;
  box-shadow: 0 0 14px rgba(255,255,255,0.4);
}
#imgModalClose {
  position: absolute;
  top: 20px;
  right: 40px;
  font-size: 48px;
  color: white;
  cursor: pointer;
}

/* =========================================================
   âœ… å°æªœæºª UIï¼ˆåªåœ¨ map-only é¡¯ç¤ºï¼‰
   âœ… é‡è¦ï¼šå…¨éƒ¨éƒ½åŠ  #livabilityUI å‰ç¶´ï¼Œé¿å…å’Œäº¤é€š switch/css æ‰“æ¶
   ========================================================= */
#livabilityUI{
  position: absolute;
  inset: 0;
  z-index: 300000;            /* ä¿è­‰åœ¨åœ°åœ–ä¸Šæ–¹ */
  pointer-events: none;       /* å…ˆé—œï¼Œè£¡é¢ UI å†å„è‡ªæ‰“é–‹ */
  display: none;
}
body.map-only #livabilityUI{ display:block; }

#livabilityUI *{ pointer-events: auto; }

/* âœ… å·¦å´æ»‘å‡ºé¢æ¿é®ç½©ï¼šæ‰“é–‹æ°´è³ª/æ·¹æ°´/çŠ¯ç½ªé¢æ¿æ™‚ï¼Œç”¨ä¾†æ“‹ä½å…¶ä»–æŒ‰éˆ• */
#livabilityUI #leftPanelMask{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0);  /* é€æ˜å°±å¥½ï¼ˆåªè¦æ“‹é»æ“Šï¼‰ */
  display: none;
  z-index: 20000;             /* ä»‹æ–¼æŒ‰éˆ•(<=9900) èˆ‡é¢æ¿(20001)ä¹‹é–“ */
  pointer-events: auto;
}
#livabilityUI.left-panels-open #leftPanelMask{ display:block; }


/* ä½ çµ¦çš„å°æªœæºª UI æ¨£å¼ï¼ˆåš scopeï¼‰ */
#livabilityUI #legend, 
#livabilityUI #medLegend, 
#livabilityUI #msg, 
#livabilityUI #customPopup{
  position: absolute;
  background: white;
  padding: 10px;
  border: 1px solid gray;
  z-index: 999;
  max-height: 300px;
  overflow-y: auto;
  font-size: 13px;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
  border-radius: 4px;
  color: #000;
}

/* âœ… è‡ªè¨‚å½ˆè·³è¦–çª—ï¼ˆç¸®å°å¯¬åº¦ï¼‰ */
#livabilityUI #customPopup{
  z-index: 99999;
  display: none;
  width: 240px;
  max-width: 240px;
  min-width: 0;
  pointer-events: auto;
  cursor: default;
}

#livabilityUI #legend, 
#livabilityUI #medLegend{
  bottom: 10px;
  right: 175px;
  width: 150px;
  height: 160px;
  overflow-y: auto;
  background-color: rgba(255, 255, 255, 0.9);
  padding: 10px;
  border-radius: 10px;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  font-size: 14px;
  scrollbar-width: none;        /* Firefox */
  -ms-overflow-style: none;     /* IE/èˆŠ Edge */
}
#livabilityUI #legend::-webkit-scrollbar,
#livabilityUI #medLegend::-webkit-scrollbar{
  display: none;               /* Chrome / Edge / Safari */
}
#livabilityUI #msg{
  top: 13px;
  right: 8px;
  max-width: 350px;
  white-space: pre-line;
  color: #000 !important;      /* âœ… å¼·åˆ¶é»‘å­— */
}

#livabilityUI .popup-tabs{ display:flex; border-bottom:1px solid #ccc; margin-bottom:6px; }
#livabilityUI .popup-tab{ flex:1; text-align:center; padding:4px; cursor:pointer; user-select:none; background:#f0f0f0; }
#livabilityUI .popup-tab.active{ background:#fff; font-weight:bold; border-bottom:2px solid #0079c1; }
#livabilityUI .popup-content{ display:none; }
#livabilityUI .popup-content.active{ display:block; }

#livabilityUI .legend-item{ display:flex; align-items:center; margin-bottom:4px; cursor:pointer; }
#livabilityUI .legend-color{ width:18px; height:18px; margin-right:6px; border:1px solid black; border-radius:3px; box-sizing:border-box; }
#livabilityUI .legend-icon{ width:18px; height:18px; margin-right:6px; border-radius:3px; border:none; object-fit:contain; box-sizing:border-box; background-color:transparent; }

#livabilityUI .popup-table{ border-collapse:collapse; width:100%; font-size:12px; }
#livabilityUI .popup-table th, 
#livabilityUI .popup-table td{
  border-bottom:1px solid #ddd; padding:2px 4px; text-align:left; vertical-align:top; white-space:nowrap;
}
#livabilityUI .popup-table th{ font-weight:bold; color:#333; }

/* äº¤é€šåœ–å±¤é–‹é—œï¼ˆå°æªœæºªå…§ï¼‰ */
#livabilityUI .switch-container{
  position: absolute; top: 350px; left: 20px; z-index: 99;
  display: flex; align-items: center; background: white;
  border-radius: 10px; box-shadow: 0 2px 6px rgbas(0, 0, 0, 0.25);
  padding: 8px 12px; font-family: "Noto Sans TC", sans-serif;
}
#livabilityUI .switch-label{ margin-right: 8px; font-size: 14px; color: #000;}

#livabilityUI .switch{ position: relative; display:inline-block; width:48px; height:24px; }
#livabilityUI .switch input{ opacity:0; width:0; height:0; }
#livabilityUI .slider{
  position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
  background-color:#ccc; transition:0.3s; border-radius:24px;
}
#livabilityUI .slider:before{
  position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px;
  background-color:white; transition:0.3s; border-radius:50%;
}
#livabilityUI input:checked + .slider{ background-color:#4CAF50; }
#livabilityUI input:checked + .slider:before{ transform: translateX(24px); }

/* åº•åœ–åœ“å½¢æŒ‰éˆ• */
#livabilityUI #basemapButton{
  position:absolute; bottom:10px; left:200px;
  width:50px; height:50px; border-radius:50%;
  background:#b0c8dc; border:none; cursor:pointer;
  display:flex; flex-wrap:wrap; justify-content:center; align-content:center;
  padding:5px; z-index:99000; box-sizing:border-box;
  transition: transform 0.2s ease; box-shadow: 0 0 8px rgba(0,0,0,0.4);
}
#livabilityUI #basemapButton:hover{ transform:scale(1.1); box-shadow:0px 4px 15px rgba(0, 0, 0, 0.4); }
#livabilityUI #basemapButton div{
  width:15px; height:15px; margin:1px; border-radius:3px;
  box-sizing:border-box; transition: box-shadow 0.2s ease, transform 0.2s ease;
}
#livabilityUI #basemapButton:hover div{ transform:scale(1.1); box-shadow:0px 4px 15px rgb(236,234,234); }
#livabilityUI .box-streets{ background-color:#e6e2d3; }
#livabilityUI .box-topo{ background-color:#cce0aa; }
#livabilityUI .box-satellite{ background-color:#8bc34a; }
#livabilityUI .box-emap{ background-color:#4fc3f7; }

  /* è‡ªè¨‚ç¯„åœå·¥å…·åœ“å½¢æŒ‰éˆ•ï¼ˆè·Ÿåº•åœ–æŒ‰éˆ•åŒé¢¨æ ¼ï¼‰ */
  #livabilityUI #rangeToolToggleBtn{
  position:absolute;
  bottom:130px;
  left:20px;
  width:50px;
  height:50px;
  border-radius:50%;
  background: url("https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ç¯„åœ.png") no-repeat center center;
  background-size: 30px 30px;   /* æ§åˆ¶åœ–æ¡ˆå¤§å° */
  background-color:#b0c8dc;
  border:none;
  cursor:pointer;
  z-index:9900;
  box-shadow: 0 0 8px rgba(0,0,0,0.4);
}
  #livabilityUI #rangeToolToggleBtn:hover{
    transform: scale(1.1);
    box-shadow:0px 4px 15px rgba(0, 0, 0, 0.4);
  }
  #livabilityUI #rangeToolToggleBtn i{
    font-size: 22px;
    color: #0b1b33;
    line-height: 1;
  }
  #livabilityUI #rangeToolToggleBtn.active{
    outline: 2px solid rgba(255,202,40,0.9);
  }

/* =========================
   âœ… åº•åœ–é¢æ¿ï¼ˆåªå½±éŸ¿åº•åœ–ï¼Œä¸å½±éŸ¿å…¶ä»– switchï¼‰
   ========================= */
#livabilityUI #basemapPanel{
  position: absolute;
  bottom: 80px;
  left: 190px;
  width: 200px;
  background: #ffffff;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.25);
  padding: 18px ;
  display: none;
  z-index: 990000;
}
#livabilityUI #basemapPanel h3{
  margin: 0 0 10px 0;
  font-size: 16px;
  text-align: center;
  color: #000;
}

/* âœ… åº•åœ–é¢æ¿å…§çš„ toggleï¼šç”¨ç¨ç«‹ classï¼Œé¿å…è·Ÿäº¤é€š switch æ‰“æ¶ */
#livabilityUI #basemapPanel .bm-switch{
  position: relative;
  display: inline-block;
  width: 36px;
  height: 18px;
}
#livabilityUI #basemapPanel .bm-switch input{ display: none; }
#livabilityUI #basemapPanel .bm-slider{
  position: absolute;
  cursor: pointer;
  inset: 0;
  background-color: #ccc;
  border-radius: 18px;
  transition: 0.2s;
}
#livabilityUI #basemapPanel .bm-slider:before{
  position: absolute;
  content: "";
  height: 14px;
  width: 14px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  border-radius: 50%;
  transition: 0.2s;
}
#livabilityUI #basemapPanel input:checked + .bm-slider{ background-color: #0078D7; }
#livabilityUI #basemapPanel input:checked + .bm-slider:before{ transform: translateX(18px); }
/* è®“æ¯ä¸€åˆ—è®Šæˆå·¦å³æ’åˆ— */
#livabilityUI #basemapPanel .basemap-item{
  display: flex;
  align-items: center;
}

/* æ–‡å­—ä½”æ»¿ä¸­é–“ç©ºé–“ */
#livabilityUI #basemapPanel .basemap-item span{
  flex: 1;
}

/* toggle è²¼é½Šé¢æ¿å³å´ */
#livabilityUI #basemapPanel .bm-switch{
  margin-left: auto;
}

/* âœ… å³å´å…±ç”¨çµ±è¨ˆé¢æ¿ */
#livabilityUI #statsPanel{
  position: absolute; bottom: 10px; right: 8px;
  background: #0d1b3a; padding: 6px; border: 1px solid #1e3a70;
  border-radius: 8px; width: 150px; max-height: 200px;
  overflow-y: scroll; overflow-x: hidden; z-index: 999; color: #fff; font-size: 12px;
  scrollbar-width: none;
}
#livabilityUI #statsPanel::-webkit-scrollbar{ display:none; }

#livabilityUI #statsHeader{
  background:#0079c1; color:#fff; padding:6px; border-radius:6px 6px 0 0;
  text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.3);
  margin:-6px -6px 4px -6px;
}
#livabilityUI #statsHeaderTitle{ font-weight:bold; font-size:14px; margin-bottom:4px; }
#livabilityUI #statsTabs{ display:flex; gap:4px; justify-content:center; margin-top:4px; }
#livabilityUI .stats-tab-btn{
  flex:1; padding:2px 4px; border:none; border-radius:12px;
  cursor:pointer; font-size:12px; background:rgba(255,255,255,0.2); color:#fff;
}
#livabilityUI .stats-tab-btn.active{ background:#ffca28; color:#222; font-weight:bold; }
#livabilityUI #statsFacilityContainer, 
#livabilityUI #statsMedContainer{ margin-top:6px; }
#livabilityUI #statsMedContainer{ display:none; }

#livabilityUI .big-cat-title{
  font-weight:bold; cursor:pointer; background:#1e3a70;
  color:#ffffff; padding:2px 4px; border-radius:3px; margin-bottom:2px;
}
#livabilityUI .sub-cat-row{ display:flex; align-items:center; margin:2px 0; }
#livabilityUI .sub-cat-row button{
  flex:1; padding:4px 6px; border-radius:3px; border:none; cursor:pointer;
  background:gray; color:#fff; font-size:12px;
}
#livabilityUI .sub-cat-row span{ margin-left:6px; color:#FFC55A; }

    /* âœ… å·¦ä¸‹è§’ï¼š15 åˆ†é˜ç”Ÿæ´»åœˆ + å®œå±…åˆ†æ•¸ï¼ˆåŒä¸€é¢æ¿ / åˆ†é ï¼‰ */
#livabilityUI #lifePanel{
  position:absolute;
  right:8px;
  top:100px;
  width:250px;
  max-height:260px;
  background: rgba(13,27,58,0.95);
  color:#fff;
  border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.45);
  z-index: 1000;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  font-size:12px;
}

/* åˆ†é åˆ— */
#livabilityUI #lifePanelHeader{
  display:flex;
  background:#102a54;
}
#livabilityUI .life-tab{
  flex:1;
  border:none;
  background:rgba(255,255,255,0.15);
  color:#fff;
  padding:7px 6px;
  cursor:pointer;
  font-size:13px;
}
#livabilityUI .life-tab.active{
  background:#ffca28;
  color:#222;
  font-weight:bold;
}

/* åˆ†é å…§å®¹ */
#livabilityUI .life-page{
  display:none;
  padding:10px 10px 8px;
  overflow-y:auto;
  scrollbar-width:none;
}
#livabilityUI .life-page::-webkit-scrollbar{ display:none; }
#livabilityUI .life-page.active{ display:block; }

#livabilityUI #livabilityPanelTitle{
  font-weight:bold;
  font-size:14px;
  text-align:center;
  margin-bottom:6px;
}

/* âœ… åŸæœ¬ isoPanel æ”¹æˆã€Œå¡åœ¨ lifeIsoPage è£¡ã€ï¼Œæ‰€ä»¥è¦æŠŠå®šä½æ‹¿æ‰ */
#livabilityUI #isoPanel{
  position: static !important;
  top:auto !important;
  left:auto !important;
  width: auto !important;
  margin: 0 !important;
  padding: 0 !important;  /* isoPanel å…§éƒ¨æœ¬ä¾†å°±æœ‰ padding */
  background: transparent !important;
  box-shadow: none !important;
}


/* è‡ªè¨‚ç¯„åœå·¥å…· */
#livabilityUI #customPanel{
  position: absolute;           /* ç”± JS å‹•æ…‹æ”¾åˆ°æŒ‰éˆ•æ—é‚Š */
  top: 200px;
  left: 70px;
  z-index: 999999;
  padding: 8px;
  background: rgba(13,27,58,0.95);
  color: #fff;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  font-size: 12px;
  width: 210px;
  display: none;             /* âœ… åˆå§‹å…ˆæ”¶èµ· */
}
/* çŠ¯ç½ªé¢æ¿ */
#livabilityUI #crimePanel{
  position: fixed;
  bottom: 20px;
  left: 80px; /* åœ¨å·¦ä¸‹è§’æŒ‰éˆ•æ—é‚Šï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰ */
  z-index: 900500;
  width: 340px;              /* âœ… è®Šå¯¬ä¸€é» */
  max-height: 70vh;          /* âœ… ä¸è¶…éæœ€é«˜é«˜åº¦ */
  overflow-y: auto;          /* âœ… æ•´å€‹é¢æ¿å¯æ»¾å‹• */
  scrollbar-width: none;     /* Firefox éš±è—æ²è»¸ */
  background: rgba(13,27,58,0.95);
  color:#fff;
  border:1px solid rgba(255,255,255,0.15);
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.35);
  padding: 10px;
  font-size: 12px;
  display: none;             /* âœ… é è¨­æ”¶èµ·ï¼Œç”¨å·¦ä¸‹è§’åœ“å½¢æŒ‰éˆ•é–‹ */
}
#livabilityUI #crimePanel::-webkit-scrollbar{ display:none; }

/* âœ… æ’è¡Œæ¦œï¼ˆæ©«å‘æ›´å¥½çœ‹ï¼‰ */
#livabilityUI #schoolRankList{
  margin-top: 10px;
}

/* âœ… æ’è¡Œæ¦œå®¹å™¨ï¼šæ”¾åœ¨æŒ‰éˆ•ä¸‹æ–¹ï¼Œå›ºå®šé«˜åº¦å¯æ»¾å‹• */
#livabilityUI #schoolRankWrap{
  max-height: 220px;
  overflow-y: auto;
  scrollbar-width: none;
}
#livabilityUI #schoolRankWrap::-webkit-scrollbar{ display:none; }
#livabilityUI #schoolRankList .rankItem{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius: 12px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.10);
  margin-bottom: 8px;
  cursor:pointer;
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
#livabilityUI #schoolRankList .rankItem:hover{
  transform: translateY(-1px);
  background: rgba(255,255,255,.12);
  border-color: rgba(255,255,255,.18);
}
#livabilityUI #schoolRankList .rankNo{
  width: 26px;
  text-align: right;
  font-weight: 800;
  color: #ffca28;
  flex: 0 0 auto;
}
#livabilityUI #schoolRankList .rankName{
  flex: 1 1 auto;
  min-width: 0;
  font-weight: 800;
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#livabilityUI #schoolRankList .rankMeta{
  flex: 0 0 auto;
  display:flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 2px;
  font-variant-numeric: tabular-nums;
}
#livabilityUI #schoolRankList .rankMeta .rankDensity{
  font-weight: 800;
  font-size: 13px;
}
#livabilityUI #schoolRankList .rankMeta .rankCount{
  font-size: 11px;
  opacity: .85;
}

/* çŠ¯ç½ªé¢æ¿ï¼šæ¨™é¡Œåˆ— + å³ä¸Šè§’ X */
#livabilityUI #crimePanel .crime-panel-hd{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  margin: 0 0 8px 0;
}
#livabilityUI #crimePanel .crime-panel-hd h3{
  margin: 0;
  font-size: 14px;
  text-align:center;
  flex: 1 1 auto;
}
#livabilityUI #crimePanel .crime-close-x{
  flex: 0 0 auto;
  border: none;
  background: rgba(255,255,255,0.12);
  color: #fff;
  width: 26px;
  height: 26px;
  border-radius: 8px;
  cursor:pointer;
  line-height: 26px;
  text-align:center;
}
#livabilityUI #crimePanel .crime-close-x:hover{
  background: rgba(255,255,255,0.22);
}
#livabilityUI #crimePanel .crimeSwitchRow{
  margin-top: 6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}


#livabilityUI #crimePanel h3{
  margin: 0 0 8px 0;
  font-size: 14px;
  text-align:center;
}

/* âœ… çŠ¯ç½ªé¢æ¿ï¼šæ¨™é¡Œåˆ— + å³ä¸Šè§’é—œé–‰ X */
#livabilityUI #crimePanel .panelTitleRow{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin: 0 0 8px 0;
}
#livabilityUI #crimePanel .panelTitleRow .panelTitle{
  font-size: 14px;
  font-weight: 700;
}
#livabilityUI #crimePanel .panelCloseBtn{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.25);
  background: rgba(255,255,255,0.08);
  color: #fff;
  cursor: pointer;
  line-height: 26px;
  text-align: center;
  font-size: 18px;
}
#livabilityUI #crimePanel .panelCloseBtn:hover{
  background: rgba(255,255,255,0.16);
}
#livabilityUI .crimeRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 8px;
  margin: 6px 0;
}
#livabilityUI .crimeRow label{ flex: 0 0 auto; opacity: 0.95; }
#livabilityUI .crimeRow select{
  flex: 1 1 auto;
  padding: 4px 6px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.25);
  background: rgba(255,255,255,0.08);
  color: #fff;
  outline: none;
}
#livabilityUI .crimeRow select option{
  background:#0d1b3a;
  color:#fff;
}
#livabilityUI .crimeHint{
  margin-top: 6px;
  font-size: 11px;
  color: #ffd54f;
  line-height: 1.4;
}
#livabilityUI #crimeSwitchWrap{
  margin-top: 6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
#livabilityUI .kpiRow{ display:flex; gap:8px; margin: 8px 0 6px 0; }
#livabilityUI .kpiCard{
  flex:1;
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 8px;
  padding: 8px;
  text-align:center;
}
#livabilityUI .kpiCard .kpiVal{
  font-weight:700;
  font-size: 16px;
  color:#ffca28;
}
#livabilityUI .kpiCard .kpiLab{ font-size: 11px; opacity: 0.9; }
/* map-only éš±è—ä½ ä¹‹å‰å¯«çš„ livability-ui è¦å‰‡ï¼ˆä¿ç•™ä½†ä¸è¦è“‹ä½ï¼‰ */
/*---------- ç©ºæ°£å“è³ªAQI & æº«åº¦ & UV & é›¨é‡ -------*/
/* åº•éƒ¨é¢æ¿ */
#bottomPanel {
  position: fixed;
  bottom: 1px;
  left: 50%;
  transform: translateX(-50%) scale(0.9);
  transform-origin: bottom center;
  width: 280px; 
  height: 45px;
  background: rgba(28,61,125,0.8);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;     
  padding: 0 8px;
  color: #eee;
  font-size: 10px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.5);
  z-index: 999999 !important;
}

#obsTime {
  position: absolute;
  bottom: 56px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 10px;
  color: #1f8dbc;
  font-weight: bold; /* åŠ ç²— */
  z-index: 999990 !important;
}

/* åœ“åœˆè¨­å®š */
.circle {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  cursor: pointer;
  text-shadow: 0 0 2px rgba(255,255,255,0.3);
  transition: box-shadow 0.3s ease, transform 0.2s ease;
  position: relative;
  color: #f2f2f2;
}
.circle span:first-child { font-size: 11px; opacity: 0.9; line-height: 1.1; }
.circle span:last-child { font-size: 16px; opacity: 0.9; line-height: 1.1; }
.circle:hover { transform: scale(1.07); }

/* åœ“åœˆé¡è‰² */
#aqiCircle { background: linear-gradient(145deg, #00E400, #00A000); box-shadow: 0 0 4px #00E400, 0 0 8px #00E400; }
#tempCircle { background: linear-gradient(145deg, #FFAA00, #FF6600); box-shadow: 0 0 4px #FFAA00, 0 0 8px #FFAA00; }
#uvCircle { background: linear-gradient(145deg, #FF4500, #D63031); box-shadow: 0 0 4px #FF4500, 0 0 8px #FF4500; }
#rainCircle { background: linear-gradient(145deg, #00BFFF, #0066FF); box-shadow: 0 0 4px #00BFFF, 0 0 8px #00BFFF; }

/* æç¤º */
.hoverTip {
  position: absolute;
  top: -23px;
  background: rgba(31, 234, 196, 0.8);
  color: #333;
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 10px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  white-space: nowrap;
   /* ğŸ”§ ç½®é ‚é¿å…è¢«é¢æ¿æ“‹ä½ */
  z-index: 999999;
}
.circle:hover .hoverTip { opacity: 1; }

/* ä¸­å¤®è³‡è¨Šæ¡† */
.centerTooltip {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(29, 178, 171, 0.9);
  color: #fff;
  padding: 5px 9px;
  border-radius: 5px;
  font-size: 10px;
  display: none;
  z-index: 2000;
  white-space: nowrap;
}

/* AQI æ‡¸æµ®è¨Šæ¯ å·¦å´é¡¯ç¤º */
#aqiMessageHover {
  position: absolute;
  top: 50%;
  left: -8px;
  transform: translate(-100%, -50%);
  background: #FFA500; /* JSæœƒå‹•æ…‹æ”¹ */
  color: #111;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: bold;
  display: none; /* åˆå§‹éš±è— */
  white-space: nowrap;
  z-index: 3000;
  --arrow-color: #FFA500; /* CSS è®Šæ•¸ */
}

/* å°–å°–ç®­é ­ï¼Œè·Ÿè¨Šæ¯æ¡†é¡è‰²åŒæ­¥ */
#aqiMessageHover::after {
  content: "";
  position: absolute;
  top: 50%;
  right: -6px;
  transform: translateY(-50%);
  width: 0;
  height: 0;
  border-style: solid;
  border-width: 6px 0 6px 6px; /* ä¸Š å³ ä¸‹ å·¦ */
  border-color: transparent transparent transparent var(--arrow-color);
}
/* ---------------åœŸå£¤æ¶²åŒ–-------------*/
/* å·¦ä¸‹è§’åœ“å½¢æŒ‰éˆ• */
#livabilityUI #customLayerToggleBtn {
  position: fixed;
  bottom: 10px;
  left: 80px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: url('https://vvrl.cc/api/image/ir1eq1/view') no-repeat center center;
  background-size: 40px 40px;
  background-color: #ffae17;
  cursor: pointer;
  z-index: 1110;
  box-shadow: 1px 1px 6px rgba(225, 154, 2, 0.7);
  transition: transform 0.2s ease;
  border: none;
  outline: none;
}
#livabilityUI #customLayerToggleBtn:hover {
  background-color: #e08516;
  transform: scale(1.1);
}

/* åœ–ä¾‹ */
#livabilityUI #customLegend {
  position: fixed;
  bottom: 80px;
  left: 20px;
  background: rgba(255,255,255,0.9);
  padding: 10px;
  border-radius: 8px;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  display: none;
  color: #111;  
  z-index: 99999;
}
#livabilityUI .legend-item {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
  color: #111;  
}
#livabilityUI .legend-color {
  width: 16px;
  height: 16px;
  margin-right: 6px;
  border: 1px solid #000;
  color: #111;  
}
/*----------æ°´è³ª+æ·¹æ°´-------*/
/* æ°´è³ªé¢æ¿ */
#livabilityUI .water-panel{
  position: fixed;
  top: 60px;
  left: -290px;                 /* åˆå§‹æ”¶èµ· */
  width: 250px;
  height: 70vh;
  background: #fdfdfd;
  border: 1px solid #ccc;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
  padding: 15px;
  overflow-y: auto;

  scrollbar-width: none;        /* Firefox */
  -ms-overflow-style: none;     /* IE/Edge èˆŠç‰ˆ */
  z-index: 200010;
  border-radius: 20px;
  transition: left 0.3s ease, width 0.3s ease;

  display: flex;
  flex-direction: column;
}
#livabilityUI .water-panel::-webkit-scrollbar{ display:none; }
#livabilityUI .water-panel.expanded{ width: 400px; left: 0; }
#livabilityUI .water-panel.open{ left: 0; }

/* æ°´è³ªæ¨™é¡Œ */
#livabilityUI .water-panel h3{
  margin-top:0;
  font-size:1.2rem;
  color:#0077cc;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:2px solid #0077cc;
  padding-bottom:5px;
}

#livabilityUI .btn-toggle{
  background:#0077cc;
  color:white;
  border:none;
  padding:5px 10px;
  font-size:0.85rem;
  border-radius:6px;
  cursor:pointer;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
#livabilityUI .btn-toggle:hover{ background:#005fa3; }

/* æ°´è³ªåœ“åœˆæŒ‡æ¨™ */
#livabilityUI .indicators{
  display:flex;
  justify-content:center;
  gap:20px;
  margin-bottom:10px;
}
#livabilityUI .indicator{
  width:60px;
  height:60px;
  border-radius:50%;
  background:#e3f2fd;
  color:#0077cc;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-size:0.9rem;
  font-weight:bold;
  cursor:pointer;
  transition:transform 0.2s ease, box-shadow 0.2s ease;
}
#livabilityUI .indicator:hover{
  transform:scale(1.2);
  box-shadow:0 0 12px rgba(0,0,0,0.3);
}

/* æ°´è³ªä¾¿æ¢ç´™é …ç›® */
#livabilityUI .table-wrapper{
  display:flex;
  flex-direction:column;
  flex:1;
  margin-top:10px;

  overflow-y:auto;
  scrollbar-width:none;
  -ms-overflow-style:none;
}
#livabilityUI .table-wrapper::-webkit-scrollbar{ display:none; }

#livabilityUI .table-item{
  width:220px;
  display:flex;
  justify-content:space-between;
  background:#45b5d7;
  padding:6px 10px;
  margin-bottom:6px;
  border-radius:8px;
  box-shadow:1px 1px 3px rgba(0,0,0,0.2);
  font-size:0.85rem;
  transition:transform 0.2s ease;
}
#livabilityUI .table-item:hover{ transform:scale(1.03) translateY(-2px); }
#livabilityUI .table-item span{ color:#fff; }

/* RPI åˆ†ç´šæ¢ */
#livabilityUI .rpi-panel{
  display:none;
  position:absolute;
  top:20px;
  left:260px;
  width:100px;
  height:250px;
  transition:all 0.3s ease;
  z-index:1099;
}
#livabilityUI .rpi-container{ position:relative; width:80px; margin:0 auto; height:250px; }
#livabilityUI .rpi-line{ position:absolute; left:30px; width:12px; border-radius:6px; }
#livabilityUI .rpi-point{ position:absolute; left:26px; width:16px; height:16px; border-radius:50%; border:2px solid white; box-shadow:0 0 4px rgba(0,0,0,0.3); }
#livabilityUI .rpi-value{ position:absolute; left:5px; font-size:0.8rem; font-weight:bold; transform:translateY(-50%); color:#000; }
#livabilityUI .rpi-label{ position:absolute; left:50px; font-size:0.8rem; font-weight:bold; white-space:nowrap; }

/* å·¦ä¸‹è§’ï¼šæ°´è³ªåœ“å½¢æŒ‰éˆ• */
#livabilityUI #panel-toggle{
  position:fixed;
  bottom:10px;
  left:140px;
  width:50px;
  height:50px;
  border-radius:50%;
  background:url('https://vvrl.cc/api/image/g6hlrq/view') no-repeat center center;
  background-size:70px 70px;
  background-color:#83c8f9;
  cursor:pointer;
  z-index:111000;
  box-shadow:1px 1px 6px rgba(20,189,241,0.7);
  transition:transform 0.2s ease, background-color 0.2s ease;
}
#livabilityUI #panel-toggle:hover{
  background-color:#4c96e1;
  transform:scale(1.1);
}

/* å·¦ä¸‹è§’ï¼šçŠ¯ç½ªåœ“å½¢æŒ‰éˆ•ï¼ˆè·Ÿæ°´è³ªåŒé¢¨æ ¼ï¼‰ */
#livabilityUI #crime-toggle-btn{
  position:fixed;
  bottom:70px;
  left:20px; /* æ°´è³ª 140pxï¼ŒçŠ¯ç½ªå¾€å³ä¸€æ ¼ */
  width:50px;
  height:50px;
  border-radius:50%;
  background:url('https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/çŠ¯ç½ª.png') no-repeat center center;
  background-size:30px 30px;
  background-color:#f15151;
  cursor:pointer;
  z-index:1110;
  box-shadow:1px 1px 6px rgba(239,68,68,0.7);
  transition:transform 0.2s ease, background-color 0.2s ease;
}
#livabilityUI #crime-toggle-btn:hover{
  background-color:#ef4444;
  transform:scale(1.1);
}

#livabilityUI #custom-popup{
  color: #111;           /* é€™ä¸€è¡Œå°±æ˜¯æ§åˆ¶å­—é¡è‰² */
}
/* =========================
   âœ… æ·¹æ°´é¢æ¿
   ========================= */
#livabilityUI .flood3D_panel{
  position:fixed;
  top:60px;
  left:-290px;
  width:250px;
  height:70vh;
  background:#fdfdfd;
  border:1px solid #ccc;
  box-shadow:2px 2px 10px rgba(0,0,0,0.2);
  padding:15px;
  overflow-y:auto;

  scrollbar-width:none;
  -ms-overflow-style:none;

  z-index:200010;
  border-radius:20px;
  transition:left 0.3s ease, width 0.3s ease;

  display:flex;
  flex-direction:column;

  color:#111; /* âœ… ç™½åº•é»‘å­— */
}
#livabilityUI .flood3D_panel::-webkit-scrollbar{ display:none; }
#livabilityUI .flood3D_panel.open{ left:0; }

#livabilityUI .flood3D_panel h3{
  margin-top:0;
  font-size:1.2rem;
  color:#0077cc;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:2px solid #0077cc;
  padding-bottom:5px;
}

/* å·¦ä¸‹è§’ï¼šæ·¹æ°´åœ“å½¢æŒ‰éˆ• */
#livabilityUI #flood3D_toggleBtn{
  position:fixed;
  bottom:10px;
  left:20px;
  width:50px;
  height:50px;
  border-radius:50%;
  background:url('https://vvrl.cc/api/image/il4t6q/view') no-repeat center center;
  background-size:50px 50px;
  background-color:#83c8f9;
  cursor:pointer;
  z-index:1110;
  box-shadow:1px 1px 6px rgba(20,189,241,0.7);
  transition:transform 0.2s ease, background-color 0.2s ease;
}
#livabilityUI #flood3D_toggleBtn:hover{
  background-color:#4c96e1;
  transform:scale(1.1);
}

#livabilityUI #flood3D_updateTime{
  margin-bottom:10px;
  background:rgba(58,140,240,0.2);
  padding:6px;
  border-radius:4px;
  font-size:13px;
  width:100%;
  text-align:center;
  margin-left:-6px;
  color:#111;
}

/* âœ… æ·¹æ°´ä¸‹æ‹‰å¼æ¸…å–®ï¼šç™½åº•é»‘å­— + éš±è—æ»‘æ¡¿ */
#livabilityUI #flood3D_stationSelect{
  width:100%;
  padding:6px;
  margin-bottom:10px;
  background:#fff;
  color:#111;
  border:1px solid #111;
  border-radius:6px;

  /* éš±è—æ»‘æ¡¿ï¼ˆselect æœ¬é«”ï¼‰ */
  scrollbar-width:none;
  -ms-overflow-style:none;
}
#livabilityUI #flood3D_stationSelect::-webkit-scrollbar{
  width:0;
  height:0;
}
#livabilityUI #flood3D_stationSelect option{
  color:#111;
  background:#fff;
}

#livabilityUI #flood3D_stationInfo{
  display:none;
  flex-direction:column;
  align-items:center;
  margin-top:10px;
}

#livabilityUI #flood3D_basicInfo{
  background:#d0e7ff;
  padding:6px;
  border-radius:4px;
  width:100%;
  text-align:left;
  margin-bottom:8px;
  font-size:13px;
  color:#111;
}

#livabilityUI #flood3D_stationInfo img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  padding: 10px;
  display: none;
}

#livabilityUI #flood3D_depthImg{
  width:150px;
  height:150px;
  border-radius:50%;
  padding:10px;
  margin-top:25px;
  margin-bottom:15px;
  transition:transform 0.3s ease, box-shadow 0.3s ease;
  cursor:pointer;
}
#livabilityUI #flood3D_depthImg:hover{
  transform:scale(1.1);
  box-shadow:0px 4px 15px rgba(0,0,0,0.4);
}

/* âœ… æ°´æ·±ï¼šhover è®Šè—è‰² */
#livabilityUI #flood3D_depth{
  margin-top:6px;
  font-weight:bold;
  cursor:pointer;
  transition:transform 0.15s ease, color 0.15s ease;
  color:#111;
}
#livabilityUI #flood3D_depth:hover{
  transform:scale(1.05);
  color:#0077cc;
}

/* è‡ªè¨‚å½ˆçª— */
#livabilityUI #custom-popup{
  position:absolute;
  display:none;
  background:white;
  padding:12px;
  border-radius:8px;
  border:1px solid #ccc;
  box-shadow:2px 2px 8px rgba(0,0,0,0.3);
  z-index:1200;
  max-width:250px;
  font-size:0.85rem;
}

/* =========================
   âœ… äº¤é€šäº‹æ•…ï¼ˆé¢æ¿å…§ï¼‰
   ========================= */
#pageAccident{
  padding: 10px;
  gap: 10px;
}
#pageAccident .acc-tools{
  display:flex;
  align-items:flex-start;
  justify-content: space-between;
  gap: 10px;
}
#accGroupSelect{
  flex: 1 1 auto;
  min-width: 140px;
}
#pageAccident .acc-mini{
  flex: 0 0 auto;
  text-align:right;
  line-height: 1.3;
  min-width: 110px;
}
#pageAccident .acc-chart-wrap{
  background: rgba(2,6,23,.35);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  padding: 10px;
}
#pageAccident canvas{
  width: 100% !important;
  height: 180px !important;
}
#pageAccident .acc-timeline{
  background: rgba(2,6,23,.35);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  padding: 10px;
}
#accTimeSlider{ width:100%; }
#pageAccident .acc-range{
  display:flex;
  justify-content: space-between;
  margin-top: 6px;
}
#pageAccident .acc-hint{
  margin-top: 6px;
  color: #cbd5f5;
  opacity: .9;
}


/* âœ… äº¤é€šæµé‡ 2D è¦†è“‹å±¤ï¼ˆè®“ 3D SceneView ä¹Ÿèƒ½çœ‹ MapServer äº¤é€šï¼‰ */
#traffic2DDiv{
  position:absolute;
  inset:0;
  z-index: 5;
  pointer-events:none;
  display:none;
}


/* âœ… CCTV é¢æ¿å¯æ‹–æ›³ï¼ˆæ‹–æ›³æŠŠæ‰‹ï¼šæ¨™é¡Œåˆ—ï¼‰ */
#cctv-panel h3{
  cursor: move;
  user-select: none;
}


/* =========================
   âœ… åº•åœ–é¢æ¿æ¨£å¼ä¿®æ­£ï¼ˆæ–‡å­—é»‘è‰² + é–‹é—œä¸€è‡´ï¼‰
   - é¿å…è¢«å…¨åŸŸ .switch/.sliderï¼ˆäº¤é€šé¢æ¿ï¼‰è¦†è“‹
   ========================= */
#basemapPanel{
  color:#000;
}
#basemapPanel h3,
#basemapPanel span{
  color:#000 !important;
}


</style>

<!-- ===== äººå£çµ±è¨ˆæ¨£å¼ï¼ˆä¾†è‡ª äººå£çµ±è¨ˆ.htmlï¼Œå·²ç§»é™¤ html/body/#viewDiv å…¨åŸŸæ¨£å¼ï¼‰ ===== -->
<style id='statsUnifiedStyle'>
/* åªåœ¨äº¤é€šé—œé–‰(map-only)é¡¯ç¤º */
body:not(.map-only) #statsSmallPanel,
body:not(.map-only) #statsOverlay{ display:none !important; }

#statsOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.45);
  z-index:79999;
  display:none;
}

/* å…±ç”¨å°é¢æ¿ï¼ˆè·Ÿä½ ç¾æœ‰é¢æ¿åŒé¢¨æ ¼ï¼‰ */
#statsSmallPanel{
  position:fixed;
  top:70px; left:8px;
  width:328px;
  background:rgba(20,30,50,.88);
  border-radius:14px;
  padding:10px;
  box-shadow:0 0 22px rgba(0,220,255,.45);
  z-index:80010;
  backdrop-filter:blur(6px);
  border:1px solid rgba(0,255,255,.25);
  box-sizing:border-box;
  user-select:none;
}

/* tabs */
#statsSmallPanel .statsTabs{
  display:flex;
  gap:8px;
  margin-bottom:8px;
}
#statsSmallPanel .statsTab{
  flex:1 1 0;
  border:1px solid rgba(255,255,255,.35);
  background:rgba(255,255,255,.10);
  color:#00ffff;
  padding:7px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:12px;
}
#statsSmallPanel .statsTab.active{
  background:rgba(0,255,255,.30);
  border-color:rgba(0,255,255,.85);
  font-weight:700;
}

/* panes */
#statsSmallPanel .statsPane{ display:none; }
#statsSmallPanel .statsPane.active{ display:block; }

/* âœ… è®“åŸæœ¬çš„ chartContainer / eduSmallPanel æ”¾é€²ä¾†å¾Œä¸è¦å† fixed äº‚è·‘ */
#statsSmallPanel #chartContainer,
#statsSmallPanel #eduSmallPanel{
  position:relative !important;
  top:auto !important;
  left:auto !important;
  width:100% !important;
  height:170px !important;
  background:transparent !important;
  border:none !important;
  box-shadow:none !important;
  padding:0 !important;
  border-radius:0 !important;
}

/* å…§éƒ¨æ¨™é¡Œè‰²çµ±ä¸€ */
#statsSmallPanel #chartContainer h4,
#statsSmallPanel #eduSmallTitle{
  margin:0 0 6px 0 !important;
  font-size:14px !important;
  color:#00ffff !important;
}

/* canvas é«˜åº¦ */
#statsSmallPanel #populationChart,
#statsSmallPanel #eduSmallLine{
  width:100% !important;
  height:140px !important;
}

/* é¿å… canvas æ“‹ tab é»æ“Š */
#statsSmallPanel canvas{ pointer-events:none; }
#statsSmallPanel .statsTabs, #statsSmallPanel .statsTab{ pointer-events:auto; }

/* å¤§é¢æ¿ï¼šä»ä½¿ç”¨åŸæœ¬å…©å¥—ï¼ˆdetailPanel / eduDetailPanelï¼‰ï¼Œä½†ç”¨å…±ç”¨ overlay é—œé–‰ */
</style>
<style id="popStatsStyle">

#chartContainer {
  position: absolute;
  top: 20px;
  left: 20px;
  width: 310px;
  height: 180px;
  background: rgba(20, 30, 50, 0.85); /* åŠé€æ˜ç§‘æŠ€è—è‰² */
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 0 20px rgba(0, 200, 255, 0.4); /* å¾®å…‰æ•ˆæœ */
  z-index: 99;
  cursor: pointer;
  backdrop-filter: blur(5px); /* èƒŒæ™¯æ¨¡ç³Šï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ */
  color: #00ffff; /* æ–‡å­—é¡è‰²ç§‘æŠ€æ„Ÿ */
}

#chartContainer h4 {
  margin: 0 0 5px 0;
  font-size: 14px;
  color: #00ffff;
}
#chartContainer canvas {
  margin-left: -15px;   /* â¬…ï¸ å…§å®¹å¾€å·¦æ¨ */
}
#detailPanel {
  position: absolute;
  top: 35px;
  left: 50%;
  transform: translateX(-50%);
  width: 900px;
  height: 500px;
  background: linear-gradient(145deg, #0f2027, #203a43, #2c5364); /* æ·±è‰²ç§‘æŠ€æ„Ÿæ¼¸å±¤ */
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 0 30px rgba(0,255,255,0.5); /* æ·¡é’è‰²éœ“è™¹å…‰æšˆ */
  border: 1px solid rgba(0,255,255,0.3);
  z-index: 100;
  display: none;
  overflow: hidden;
  color: #fff; /* æ–‡å­—æ”¹ç™½è‰² */
}

#detailPanel h3 {
  margin-top: -0px;
  font-size: 22px;
  text-align: center;
  margin-bottom: 20px;
  color: #00ffff; /* æ¨™é¡Œéœ“è™¹è— */
}

/* å¤§é¢æ¿å…§æ‰€æœ‰åœ–è¡¨æ¨™é¡Œ */
#detailPanel .chart-block h4,
#detailPanel #pieContainer h4 {
  margin-top: -5px;    /* å¾€ä¸Šå¾®èª¿ */
  margin-bottom: 14px;  /* æ§åˆ¶æ¨™é¡Œèˆ‡åœ–è¡¨é–“è· */
}

#detailPanel .chart-block canvas {
  margin-top: -20px;  /* å¾€ä¸Šç§» 10pxï¼Œå¯ä¾éœ€æ±‚èª¿æ•´ */
}

#chartsGrid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  gap: 20px;
  align-items: start;      
  justify-items: center;
  padding-top: -25px;
}

.chart-block {
  position: relative;
  background: rgba(20,20,20,0.7); /* åŠé€æ˜æ·±è‰²å€å¡Š */
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 4px 12px rgba(0,255,255,0.2);
  align-self: start; 
  margin-top: -10px; /* æ¯å€‹åœ–å¾€ä¸Šç§» */      
}

.chart-block h4 {
  text-align: center;
  font-size: 14px;
  margin-bottom: 5px;
  color: #00ffff;
}

#pieContainer {
  grid-column: 2 / 3;   
  grid-row: 1 / 3;      
  width: 200px;
  height: 280px;
  margin: auto;          
  background: rgba(20,20,20,0.8);   /* åŠé€æ˜æ·±è‰²åº• */
  border-radius: 12px;   
  padding: 15px;         
  box-shadow: 0 4px 12px rgba(0,255,255,0.3);
  display: flex;
  flex-direction: column;
  align-items: center;   
  justify-content: center;
}

#pieContainer h4 {
  color: #00ffff;  /* æ¨™é¡Œéœ“è™¹è— */
  margin-bottom: 5px;
  font-size: 14px;
}

canvas { width: 100% !important; height: 100% !important; }

#areaSearchBox{
  position:absolute;
  top:15px;
  left:15px;
  width:220px;
  z-index:200;
}

#areaSearch{
  width:100%;
  padding:6px 8px;
  border-radius:6px;
  border:1px solid rgba(0,255,255,0.6);
  background:rgba(0,0,0,0.6);
  color:#00ffff;
  margin-bottom:4px;
}

#areaList{
  display:none; 
  width:100%;
  max-height:180px;
  background:rgba(0,0,0,0.8);
  color:#00ffff;
  border:1px solid rgba(0,255,255,0.4);
  border-radius:6px;
}

.mode-btn {
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.4);
  color: #00ffff;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 6px;
  cursor: pointer;
  margin:0 4px;
}
.mode-btn.active {
  background: rgba(0,255,255,0.4);
  border-color: rgba(0,255,255,0.9);
  font-weight: bold;
}
.trend-text {
  color: #00ffff;
  font-size: 13px;
  text-align: center;
  margin-top: 5px;
}

#toggleLayerBtn {
  position: absolute;
  left: 10px;
  bottom: 10px;
  padding: 2px 6px;
  font-size: 10px;
  border-radius: 4px;
  border: 1px solid rgba(0,255,255,0.6);
  background: rgba(0,0,0,0.6);
  color: #00ffff;
  cursor: pointer;
}

#toggleLayerBtn:hover {
  background: rgba(0,255,255,0.3);
}



/* åªåœ¨äº¤é€šé—œé–‰(map-only)é¡¯ç¤ºäººå£çµ±è¨ˆ */
body:not(.map-only) #chartContainer,
body:not(.map-only) #detailPanel{ display:none !important; }

</style>
<style id='eduEduPanelStyle'>

/* ===== æ•™è‚²ç¨‹åº¦ï¼šå°é¢æ¿ï¼ˆmap-onlyï¼‰ ===== */
#eduOverlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.45);
  z-index:70000; display:none;
}
#eduSmallPanel{
  position:fixed;
  top:16px; left:16px;
  width:330px; height:200px;
  background:rgba(20,30,50,.88);
  border-radius:14px;
  padding:12px 12px 10px;
  box-shadow:0 0 22px rgba(0,220,255,.45);
  z-index:70010;
  cursor:pointer;
  backdrop-filter:blur(6px);
  border:1px solid rgba(0,255,255,.25);
  box-sizing:border-box;
}
#eduSmallTitle{
  margin:0 0 6px 0;
  font-size:14px;
  color:#00ffff;
  line-height:1.25;
  user-select:none;
}
#eduSmallPanel canvas{ width:100%!important; height:150px!important; }

/* ===== æ•™è‚²ç¨‹åº¦ï¼šå¤§é¢æ¿ï¼ˆflexï¼šä¸æ»¾å‹•ä¸å¡åº•ï¼‰ ===== */
#eduDetailPanel{
  position:fixed;
  top:16px;
  left:50%;
  transform:translateX(-50%);
  width:min(1100px, calc(100vw - 30px));
  height:calc(100vh - 32px);
  background:linear-gradient(145deg,#0f2027,#203a43,#2c5364);
  border-radius:16px;
  padding:14px;
  box-shadow:0 0 30px rgba(0,255,255,.35);
  border:1px solid rgba(0,255,255,.25);
  z-index:80000;
  display:none;
  overflow:hidden;
  box-sizing:border-box;
  flex-direction:column;
  gap:10px;
}
#eduDetailHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex:0 0 auto;
}
#eduDetailTitle{
  margin:0;
  font-size:18px;
  color:#00ffff;
  user-select:none;
}
#eduCloseBtn{
  border:1px solid rgba(255,255,255,.35);
  background:rgba(0,0,0,.35);
  color:#00ffff;
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
}
#eduCloseBtn:hover{ background:rgba(0,255,255,.15); }

/* æ§åˆ¶åˆ—ï¼ˆç²¾ç°¡ï¼‰ */
#eduControls{
  display:grid;
  grid-template-columns:repeat(4, minmax(160px, 1fr));
  gap:10px;
  flex:0 0 auto;
}
#eduControls .box{
  background:rgba(0,0,0,.25);
  border:1px solid rgba(0,255,255,.18);
  border-radius:12px;
  padding:10px;
  box-sizing:border-box;
}
#eduControls label{
  display:block;
  font-size:12px;
  color:#9efcff;
  margin-bottom:6px;
  user-select:none;
}
#eduControls select{
  width:100%;
  padding:7px 8px;
  border-radius:10px;
  border:1px solid rgba(0,255,255,.25);
  background:rgba(0,0,0,.35);
  color:#e5e7eb;
  outline:none;
  box-sizing:border-box;
}

/* ä¸‹é¢åœ–è¡¨å€ï¼šåƒå‰©é¤˜é«˜åº¦ */
#eduGrid{
  flex:1 1 auto;
  min-height:0;
  display:grid;
  grid-template-columns:1.2fr 1fr;
  gap:12px;
  align-items:stretch;
}
.edu-card{
  background:rgba(20,20,20,.55);
  border:1px solid rgba(0,255,255,.16);
  border-radius:14px;
  padding:12px;
  box-shadow:0 4px 14px rgba(0,255,255,.12);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:0;
  box-sizing:border-box;
}
.edu-card h4{
  margin:0 0 8px 0;
  font-size:14px;
  color:#00ffff;
  user-select:none;
  flex:0 0 auto;
}
#eduStackWrap, #eduSingleWrap{ flex:1 1 auto; min-height:0; }
#eduStackWrap canvas, #eduSingleWrap canvas{
  width:100%!important;
  height:100%!important;
}

/* RWD */
@media (max-width:980px){
  #eduControls{ grid-template-columns:repeat(2, minmax(160px, 1fr)); }
  #eduGrid{ grid-template-columns:1fr; }
  #eduSmallPanel{ width:92vw; max-width:360px; }
}
/* ä¿®æ­£ æ•™è‚²ç¨‹åº¦å¤§é¢æ¿ ä¸‹æ‹‰å¼æ¸…å–®çœ‹ä¸åˆ°æ–‡å­—å•é¡Œ */
#livabilityUI #eduDetailPanel select{
  background: rgba(15,23,42,0.95) !important;
  color: #ffffff !important;
}

/* option æ¸…å–®æœ¬é«” */
#livabilityUI #eduDetailPanel select option{
  background: #0d1b3a !important;
  color: #ffffff !important;
}

/* è¢«é¸å–çš„é …ç›® */
#livabilityUI #eduDetailPanel select option:checked{
  background: #ffca28 !important;
  color: #222222 !important;
}

/* æ»‘é¼ ç§»éå» */
#livabilityUI #eduDetailPanel select option:hover{
  background: #1e3a70 !important;
  color: #ffffff !important;
}

/* åªåœ¨äº¤é€šé—œé–‰(map-only)é¡¯ç¤ºæ•™è‚²é¢æ¿ */
body:not(.map-only) #eduSmallPanel,
body:not(.map-only) #eduDetailPanel,
body:not(.map-only) #eduOverlay{ display:none !important; }

</style>
<style id="statsBigPanelFix">
/* âœ… å¤§é¢æ¿æé«˜å±¤ç´šï¼Œé¿å…è¢«å…¶ä»– UI æ“‹ä½ */
#statsOverlay{ z-index: 90000 !important; }
#detailPanel{ z-index: 90010 !important; top: 10px !important; }
#eduDetailPanel{ z-index: 90010 !important; top: 10px !important; }

/* è‹¥æœ‰å…¶ä»–é¢æ¿/æŒ‰éˆ•æ›´é«˜å±¤ï¼Œå¯å†åŠ ä¸€å±¤ä¿éšª */
#detailPanel, #eduDetailPanel{ isolation:isolate; }
</style>
<style id="eduZIndexUltraFix">
/* âœ… æ ¹å› ï¼šä½ é é¢å…¶ä»– UIï¼ˆä¾‹å¦‚ #livabilityUI / å„é¢æ¿æŒ‰éˆ•ï¼‰z-index è¨­å¾—éå¸¸é«˜ï¼ˆç”šè‡³ 300000+ï¼‰
   æ‰€ä»¥æ•™è‚²å¤§é¢æ¿å³ä½¿ 90000 ä¹Ÿæœƒè¢«è“‹ä½ã€‚é€™è£¡æŠŠæ•™è‚²ç›¸é—œå±¤ç´šæ‹‰åˆ°æ›´é«˜ï¼Œä¸¦åœ¨é–‹å•Ÿæ™‚æŠŠå…¶ä»– UI é™å±¤ã€‚ */

/* æ•™è‚²/çµ±è¨ˆé®ç½©èˆ‡å¤§é¢æ¿ï¼šè¶…é«˜å±¤ç´š */
#statsOverlay{ z-index: 999900 !important; }
#eduOverlay{ z-index: 999900 !important; }
#eduDetailPanel{ z-index: 999910 !important; }
#detailPanel{ z-index: 999905 !important; }  /* äººå£å¤§é¢æ¿ä¹Ÿä¸€èµ·æé«˜ï¼Œé¿å…äº’ç›¸é® */

/* é–‹å•Ÿæ•™è‚²å¤§é¢æ¿æ™‚ï¼šæŠŠå…¶ä»–æµ®å‹• UI é™ä¸€å±¤ï¼ˆä¸æ”¹åŠŸèƒ½ï¼Œåªé¿å…è“‹ä½é¢æ¿ï¼‰ */
body.edu-open #uiModeToggle,
body.edu-open #modeToggleBtn,
body.edu-open #modeToggleBtn2,
body.edu-open #panel-toggle,
body.edu-open #panel-water,
body.edu-open #livabilityUI,
body.edu-open .calcite-shell,
body.edu-open .esri-ui,
body.edu-open .esri-component{
  z-index: 1000 !important;
}

/* å¦‚æœä½ æœ‰è‡ªè¨‚ä¸€å †å›ºå®šæŒ‰éˆ•å®¹å™¨ï¼Œé€™è£¡ä¹Ÿä¸€èµ·é™ */
body.edu-open .floatingBtn,
body.edu-open .floating-panel,
body.edu-open .rightPanel,
body.edu-open .leftPanel{
  z-index: 1000 !important;
}


/*-------------CMS----------------*/
/* å·¦ä¸Šè§’ CMS æŒ‰éˆ• */
#cms-toggle-btn{
  position: fixed;
  bottom: 4px;
  right: 125px; /* æ”¾åœ¨ CCTV æ—é‚Š */
z-index: 500000; /* æé«˜é¿å…è¢«è“‹ä½ */
  width: 45px;
  height: 45px;
  border-radius: 50%;
  cursor: pointer;
  background-color: #ffffff;
  color: #ff0000;
  border: 4px solid #ff0000;
  font-size: 11px;
  font-weight: bold;
  
  
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  transition: transform 0.1s ease, background-color 0.2s ease, color 0.2s ease;

  display:flex;
  align-items:center;
  justify-content:center;
}
#cms-toggle-btn:hover{ transform: scale(1.08); background-color:#f0f0f0; }
#cms-toggle-btn:active{ transform: scale(0.9); background-color:#e0e0e0; }
#cms-toggle-btn.active{ background-color:#ff0000; color:#ffffff; border-color:#ff0000; }

/* è‡ªè¨‚ CMS popup æ¡† */
.cms-popup{
  position: absolute;
  max-width: 400px;
  width: 100%;
  max-height: 60vh;
  overflow-y: auto;
  background: rgba(255,255,255,0.95);
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  display: none;
  flex-direction: column;
  z-index: 500000;
  cursor: move;
}
.cms-popup p{ margin:2px 0; font-size:14px; color:#333; }
.cms-popup strong{ font-size:16px; margin-bottom:5px; display:block; }

.cms-popup .swiper-container{ width:100%; margin-top:8px; overflow:hidden; position:relative; }
.cms-popup .swiper-wrapper{ width:100%; height:100%; }
.cms-popup .swiper-slide{
  display:grid;
  place-items:center;
  text-align:center;
  width:100%;
  color:#00aa00;
  font-weight:700;
  font-family:"Courier New", monospace;
}
.cms-popup .swiper-slide span{ white-space:normal; word-break:break-word; }

/* ç§»é™¤ç®­é ­ï¼ˆåªé™ CMSï¼‰ */
.cms-popup .swiper-button-next,
.cms-popup .swiper-button-prev{ display:none; }

/* map-onlyï¼ˆäº¤é€šé—œé–‰ï¼‰æ™‚è‡ªå‹•éš±è— */
body.map-only #cms-toggle-btn,
body.map-only #cms-popup{ display:none !important; }

</style>

<style id="themeOverride_noTech">
/* =========================================================
   âœ… åªåšã€Œé¢¨æ ¼è¦†è“‹ã€ï¼šç§»é™¤ç§‘æŠ€éœ“è™¹è‰²
   âœ… ä¸æ”¹ä»»ä½•åŠŸèƒ½/DOM/äº‹ä»¶
   ç›®æ¨™ï¼šå·¦å´äººå£/æ•™è‚²å°é¢æ¿+å¤§é¢æ¿ï¼ˆå«æŒ‰éµ/æ¨™é¡Œ/åº§æ¨™è»¸ï¼‰ã€å³å´å…¬å…±è¨­æ–½çµ±è¨ˆé¢æ¿
   ========================================================= */

:root{
  --life-bg: rgba(13,27,58,0.95);
  --life-bg2: #102a54;
  --life-border: rgba(255,255,255,0.15);
  --life-text: #ffffff;
  --life-muted: #cbd5f5;
  --life-accent: #ffca28;
  --life-accent-text: #222222;
}

/* ===== å·¦å´ï¼šäººå£/æ•™è‚²ã€Œå°é¢æ¿ã€å®¹å™¨ ===== */
#livabilityUI #statsSmallPanel,
#livabilityUI #chartContainer,
#livabilityUI #eduSmallPanel{
  background: var(--life-bg) !important;
  color: var(--life-text) !important;
  border: 1px solid var(--life-border) !important;
  box-shadow: 0 10px 24px rgba(0,0,0,0.45) !important;
}

/* å°é¢æ¿æ¨™é¡Œ */
#livabilityUI #statsSmallPanel #chartContainer h4,
#livabilityUI #statsSmallPanel #eduSmallTitle,
#livabilityUI #eduSmallTitle{
  color: var(--life-text) !important;
}

/* å°é¢æ¿ tabs / æŒ‰éµ */
#livabilityUI #statsSmallPanel .statsTab{
  background: rgba(255,255,255,0.12) !important;
  color: var(--life-text) !important;
  border: 1px solid rgba(255,255,255,0.22) !important;
  border-radius: 12px !important;
}
#livabilityUI #statsSmallPanel .statsTab.active{
  background: var(--life-accent) !important;
  color: var(--life-accent-text) !important;
  border-color: rgba(0,0,0,0.15) !important;
  font-weight: 800 !important;
}

/* ===== å·¦å´ï¼šäººå£ã€Œå¤§é¢æ¿ã€ ===== */
#livabilityUI #detailPanel{
  background: var(--life-bg) !important;
  color: var(--life-text) !important;
  border: 1px solid var(--life-border) !important;
  box-shadow: 0 18px 40px rgba(0,0,0,0.55) !important;
}

/* å¤§é¢æ¿æ¨™é¡Œï¼ˆæŠŠéœ“è™¹è—æ”¹æˆç™½å­—ï¼‰ */
#livabilityUI #detailPanel h3,
#livabilityUI #detailPanel #detailTitle{
  color: var(--life-text) !important;
}

/* å¤§é¢æ¿å…§åœ–è¡¨æ¨™é¡Œ/æ–‡å­— */
#livabilityUI #detailPanel h4,
#livabilityUI #detailPanel p,
#livabilityUI #detailPanel label,
#livabilityUI #detailPanel .small,
#livabilityUI #detailPanel *{
  color: var(--life-text);
}

/* å¤§é¢æ¿æ¨¡å¼æŒ‰éˆ•ï¼ˆä¾‹å¦‚ï¼šå°æªœæºªé‡åŠƒå€äººå£ç¸½åˆçµ±è¨ˆ/é¡¯ç¤ºæœ€å°çµ±è¨ˆå€ ç­‰ï¼‰ */
#livabilityUI #detailPanel .mode-btn,
#livabilityUI #detailPanel button,
#livabilityUI #detailPanel select,
#livabilityUI #detailPanel input{
  background: rgba(255,255,255,0.10) !important;
  color: var(--life-text) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  border-radius: 12px !important;
}
#livabilityUI #detailPanel .mode-btn.active,
#livabilityUI #detailPanel button.active{
  background: var(--life-accent) !important;
  color: var(--life-accent-text) !important;
  border-color: rgba(0,0,0,0.15) !important;
  font-weight: 800 !important;
}

/* æœå°‹å€å¡Šï¼ˆæœ€å°çµ±è¨ˆå€æœå°‹ï¼‰ */
#livabilityUI #detailPanel #areaSearchBox{
  background: rgba(255,255,255,0.06) !important;
  border: 1px solid rgba(255,255,255,0.12) !important;
  border-radius: 12px !important;
}
#livabilityUI #detailPanel #areaList{
  background: rgba(2,6,23,0.65) !important;
  color: var(--life-text) !important;
}
#livabilityUI #detailPanel #areaList option{ background:#0d1b3a; color:#fff; }

/* ===== å·¦å´ï¼šæ•™è‚²ç¨‹åº¦ã€Œå¤§é¢æ¿ã€ ===== */
#livabilityUI #eduDetailPanel{
  background: var(--life-bg) !important;
  color: var(--life-text) !important;
  border: 1px solid var(--life-border) !important;
  box-shadow: 0 18px 40px rgba(0,0,0,0.55) !important;
}
#livabilityUI #eduDetailTitle,
#livabilityUI #eduDetailPanel h3,
#livabilityUI #eduDetailPanel h4{
  color: var(--life-text) !important;
}

/* æ•™è‚²é¢æ¿æ§åˆ¶åˆ—ï¼ˆå¹´é½¡/æ€§åˆ¥/å€åŸŸä¸‹æ‹‰ï¼‰ */
#livabilityUI #eduDetailPanel select,
#livabilityUI #eduDetailPanel button,
#livabilityUI #eduDetailPanel input{
  background: rgba(255,255,255,0.10) !important;
  color: var(--life-text) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  border-radius: 12px !important;
}
#livabilityUI #eduDetailPanel button.active{
  background: var(--life-accent) !important;
  color: var(--life-accent-text) !important;
  font-weight: 800 !important;
}

/* é—œé–‰æŒ‰éˆ•ï¼ˆXï¼‰ä¿æŒä¸€è‡´ */
#livabilityUI #popCloseBtn,
#livabilityUI #eduCloseBtn{
  background: rgba(255,255,255,0.10) !important;
  color: var(--life-text) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
}
#livabilityUI #popCloseBtn:hover,
#livabilityUI #eduCloseBtn:hover{
  background: rgba(255,255,255,0.18) !important;
}

/* ===== å³å´ï¼šå…¬å…±è¨­æ–½çµ±è¨ˆé¢æ¿ï¼ˆæœ¬ä¾†å°±æ¥è¿‘lifePanelï¼Œå†ä¿éšªè¦†è“‹ä¸€æ¬¡ï¼‰ ===== */
#livabilityUI #statsPanel{
  background: var(--life-bg) !important;
  color: var(--life-text) !important;
  border: 1px solid var(--life-border) !important;
}
#livabilityUI #statsHeader{
  background: var(--life-bg2) !important;
  color: var(--life-text) !important;
}
#livabilityUI .stats-tab-btn{
  background: rgba(255,255,255,0.12) !important;
  color: var(--life-text) !important;
}
#livabilityUI .stats-tab-btn.active{
  background: var(--life-accent) !important;
  color: var(--life-accent-text) !important;
  font-weight: 800 !important;
}

/* ===== æŠŠæ‰€æœ‰ã€Œéœ“è™¹è—ã€å¼·åˆ¶å›æ”¶ï¼ˆä¿å®ˆåšæ³•ï¼‰ ===== */
#livabilityUI #statsSmallPanel [style*="#00ffff"],
#livabilityUI #detailPanel [style*="#00ffff"],
#livabilityUI #eduSmallPanel [style*="#00ffff"],
#livabilityUI #eduDetailPanel [style*="#00ffff"]{
  color: var(--life-text) !important;
}
/* ======= ä¸­å¤®æ–œé‚Šæ¨™é¡Œ ======= */
/* ======= ä¸­å¤® IOC æ–œç¿¼æ¨™é¡Œï¼ˆä¸­é–“ + å·¦å³ç¿¼æ¿ï¼‰ ======= */
#topTitleRibbon{
  position: fixed;
  top: 0px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 600000;
  display: flex;
  align-items: center;
  gap: 0;
  pointer-events: none; /* ä¸æ“‹åœ°åœ–æ“ä½œ */
  filter: drop-shadow(0 8px 18px rgba(0,0,0,.45));
}

/* ä¸­é–“ä¸»é«” */
#topTitleRibbon .ribbon-core{
  position: relative;
  height: 38px;
  min-width: 360px;
  padding: 0 34px;
  display: flex;
  align-items: center;
  justify-content: center;

  background: linear-gradient(180deg, rgba(45,212,191,.35), rgba(2,6,23,.90));
  border-top: 2px solid rgba(120,220,255,.75);
  border-left: 1px solid rgba(255,255,255,.18);
  border-right: 1px solid rgba(255,255,255,.18);

  /* ä¸‹ç·£å¾®å¼§ï¼ˆåƒä½ åœ–ä¸­é‚£ç¨®ä¸­é–“å¾®å¾®å¼§å½¢æ„Ÿï¼‰ */
  border-bottom-left-radius: 22px;
  border-bottom-right-radius: 22px;
  overflow: hidden;
}

/* ä¸­é–“ä¸Šç·£ç´°å…‰ç·š */
#topTitleRibbon .ribbon-topline{
  position: absolute;
  top: 0;
  left: 8px;
  right: 8px;
  height: 2px;
  background: rgba(160,240,255,.7);
  filter: blur(.2px);
  opacity: .9;
}

/* æ–‡å­— */
#topTitleRibbon .ribbon-text{
  font-size: 18px;
  font-weight: 800;
  letter-spacing: 2px;
  color: #eaffff;
  text-shadow: 0 1px 6px rgba(0,0,0,.65);
  white-space: nowrap;
}

/* ä¸­é–“æ·¡æ·¡ç™¼å…‰æšˆï¼ˆè®“è¦–è¦ºæ›´åƒ IOCï¼‰ */
#topTitleRibbon .ribbon-glow{
  position: absolute;
  inset: -10px 20px auto 20px;
  height: 60px;
  background: radial-gradient(closest-side, rgba(56,189,248,.45), transparent 70%);
  pointer-events: none;
}

</style>

</head>

<body class="map-only">
<!-- å…¬è»Šï¼šæ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
<button id="uiModeToggle">é–‹å•Ÿäº¤é€šä»‹é¢</button>

<!-- âœ… å³ä¸‹è§’ï¼šé»ä½é–‹é—œé¢æ¿é–‹é—œæŒ‰éˆ• -->
<button id="layerPanelToggle">åœ–å±¤é–‹é—œ</button>

<!-- âœ… CCTVï¼šäº¤é€šä»‹é¢æŒ‰éˆ• + é¢æ¿ -->
<button id="cctv-toggle-btn" aria-label="CCTV"></button>

<!-- âœ… CMSï¼šäº¤é€šä»‹é¢æŒ‰éˆ• + Popup -->
<button id="cms-toggle-btn" title="é¡¯ç¤ºæˆ–éš±è— CMS">CMS</button>
<div id="cms-popup" class="cms-popup"></div>


<div id="cctv-panel">
  <div id="cctv-scroll-body">
<h3>æ¡ƒåœ’ CCTV</h3>

  <select id="area-select">
    <option value="">è«‹é¸æ“‡å€åŸŸ</option>
  </select>

  <select id="road-select">
    <option value="">è«‹é¸æ“‡é“è·¯</option>
    <option value="ALL">æ‰€æœ‰é“è·¯ï¼ˆæ¡ƒåœ’å¸‚å…§ï¼‰</option>
  </select>

  <select id="cctvid-select" disabled>
    <option value="">è«‹é¸æ“‡ CCTV ID</option>
  </select>

  <div id="cctv-buttons-container"></div>
  <div id="cctv-videos"></div>
  <button id="back-btn">è¿”å›é“è·¯åˆ—è¡¨</button>

  <!-- âœ… é¡¯ç¤ºCCTVä½ç½®é–‹é—œï¼šæ”¾æœ€ä¸‹é¢ -->
</div>

  <div class="cctv-switch-container" id="cctv-switch-container">
    <label class="cctv-switch">
      <input type="checkbox" id="cctv-layer-toggle-switch" checked>
      <span class="cctv-slider"></span>
    </label>
    <span>é¡¯ç¤ºCCTVä½ç½®</span>
  </div>
</div>

<!-- âœ… å³ä¸‹è§’ï¼šé»ä½é–‹é—œå°é¢æ¿ï¼ˆå…¬è»Š / YouBike / EVï¼‰ -->
<div id="layerPanel">
  <div class="layer-panel-header">åœ–å±¤é–‹é—œ</div>

  <div class="layer-toggle-row">
    <span class="toggle-label">å…¬è»Šé»ä½</span>
    <label class="switch">
      <input type="checkbox" id="busToggle" checked>
      <span class="slider"></span>
    </label>
  </div>

  <div class="layer-toggle-row">
    <span class="toggle-label">YouBike é»ä½</span>
    <label class="switch">
      <input type="checkbox" id="yTogglePointsTop" checked>
      <span class="slider"></span>
    </label>
  </div>

  <div class="layer-toggle-row">
    <span class="toggle-label">EV é»ä½</span>
    <label class="switch">
      <input type="checkbox" id="evTogglePointsTop">
      <span class="slider"></span>
    </label>
  </div>
  <div class="layer-toggle-row">
    <span class="toggle-label">åœè»Šå ´é»ä½</span>
    <label class="switch">
      <input type="checkbox" id="pTogglePointsTop">
      <span class="slider"></span>
    </label>
  </div>

  <div class="layer-toggle-row">
    <span class="toggle-label">äº¤é€šäº‹æ•…é»ä½</span>
    <label class="switch">
      <input type="checkbox" id="accTogglePointsTop">
      <span class="slider"></span>
    </label>
  </div>

  <div class="layer-toggle-row">
    <span class="toggle-label">äº¤é€šæµé‡åœ–å±¤</span>
    <label class="switch">
      <input type="checkbox" id="trafficToggle">
      <span class="slider"></span>
    </label>
  </div>
</div>
<div id="topTitleRibbon" aria-hidden="true">
  <div class="ribbon-core">
    <div class="ribbon-topline"></div>
    <div class="ribbon-text">å°æªœæºªé‡åŠƒå€å®œå±…ç³»çµ±</div>
    <div class="ribbon-glow"></div>
  </div>
</div>



<div id="viewDiv"></div>
<div id="traffic2DDiv"></div>
<!---------- ç©ºæ°£å“è³ªAQI & æº«åº¦ & UV & é›¨é‡ --------->
<div id="bottomPanel">
  <div id="aqiCircle" class="circle">
    <span>AQI</span><span id="aqiValue">--</span>
    <div class="hoverTip">å¯é»æ“ŠæŸ¥çœ‹è©³ç´°è³‡è¨Š</div>
    <div id="aqiMessageHover"></div>
  </div>
  <div id="tempCircle" class="circle">
    <span>æº«åº¦</span><span id="tempValue">--</span>
    <div class="hoverTip">å¯é»æ“ŠæŸ¥çœ‹è©³ç´°è³‡è¨Š</div>
  </div>
  <div id="uvCircle" class="circle">
    <span>UV</span><span id="uvValue">--</span>
    <div class="hoverTip">å¯é»æ“ŠæŸ¥çœ‹è©³ç´°è³‡è¨Š</div>
  </div>
  <div id="rainCircle" class="circle">
    <span>é›¨é‡</span><span id="rainValue">--</span>
    <div class="hoverTip">å¯é»æ“ŠæŸ¥çœ‹è©³ç´°è³‡è¨Š</div>
  </div>
</div>

<div id="aqiTooltip" class="centerTooltip"></div>
<div id="tempTooltip" class="centerTooltip"></div>
<div id="uvTooltip" class="centerTooltip"></div>
<div id="rainTooltip" class="centerTooltip"></div>
<div id="obsTime">è§€æ¸¬æ™‚é–“: --</div>

<!-- =========================
     âœ… map-onlyï¼ˆåªæœ‰åœ°åœ–ï¼‰è¦é¡¯ç¤ºçš„å°æªœæºª UIï¼šæ•´åŒ…æ”¾é€™è£¡
     ========================= -->
<div id="livabilityUI">
  <div id="statsOverlay" aria-hidden="true"></div>
  <div id="statsSmallPanel" title="é»é¢æ¿å…§å®¹å¯é–‹å•Ÿå¤§é¢æ¿">
  <div class="statsTabs">
    <button class="statsTab active" id="tabStatsPop" type="button">äººå£çµ±è¨ˆ</button>
    <button class="statsTab" id="tabStatsEdu" type="button">æ•™è‚²ç¨‹åº¦</button>
  </div>
  <div class="statsBody">
    <div class="statsPane active" id="statsPanePop"></div>
    <div class="statsPane" id="statsPaneEdu"></div>
  </div>
</div>
  <div id="chartContainer">
<!-- é¡¯ç¤ºæœ€å°çµ±è¨ˆå€åç¨± -->
<h4 id="smallPanelTitle" style="margin:0 0 5px 0; font-size:14px;">é¸å–å€åŸŸäººå£æŠ˜ç·šåœ– (105~113å¹´)</h4>
<canvas id="populationChart"></canvas>
<!-- â­ æ–°å¢ï¼šåœ–å±¤é–‹é—œæŒ‰éˆ• -->
<button id="toggleLayerBtn">é—œé–‰æœ€å°çµ±è¨ˆå€</button>
</div>
  <div id="detailPanel">
<h3 id="detailTitle">è©³ç´°è³‡æ–™</h3>
<div id="panelModeToggle" style="text-align:center; margin-bottom:10px;">
<button class="mode-btn active" id="btnTotal">å°æªœæºªé‡åŠƒå€äººå£ç¸½åˆçµ±è¨ˆ</button>
</div>
<!-- ğŸ” æœå°‹å¼ä¸‹æ‹‰ï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰ -->
<div id="areaSearchBox">
<input id="areaSearch" placeholder="æœå°‹æœ€å°çµ±è¨ˆå€"/>
<select id="areaList" size="6"></select>
</div>
<div id="chartsGrid">
<div class="chart-block">
<h4>äººå£æ•¸æŠ˜ç·šåœ–</h4>
<canvas id="chartPop"></canvas>
<p class="trend-text" id="trendPop"></p>
</div>
<div class="chart-block">
<h4>æˆ¶æ•¸æŠ˜ç·šåœ–</h4>
<canvas id="chartHouse"></canvas>
<p class="trend-text" id="trendHouse"></p>
</div>
<div class="chart-block">
<h4>ç”·æ€§äººå£æ•¸æŠ˜ç·šåœ–</h4>
<canvas id="chartMale"></canvas>
<p class="trend-text" id="trendMale"></p>
</div>
<div class="chart-block">
<h4>å¥³æ€§äººå£æ•¸æŠ˜ç·šåœ–</h4>
<canvas id="chartFemale"></canvas>
<p class="trend-text" id="trendFemale"></p>
</div>
<!-- åœ“é¤…åœ– -->
<div id="pieContainer">
<h4>ç”·å¥³æ¯”ä¾‹åœ“é¤…åœ–</h4>
<p class="trend-text" id="trendPie"></p>
<canvas id="chartPie"></canvas>
</div>
</div>
</div>
  <div id="eduOverlay"></div>
  <div id="eduSmallPanel" title="é»ä¸€ä¸‹é–‹å•Ÿæ•™è‚²ç¨‹åº¦å¤§é¢æ¿">
  <h4 id="eduSmallTitle">æ•™è‚²ç¨‹åº¦äººå£æŠ˜ç·šåœ–ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</h4>
  <canvas id="eduSmallLine"></canvas>
</div>
  <div id="eduDetailPanel">
  <div id="eduDetailHeader">
    <h3 id="eduDetailTitle">è©³ç´°çµ±è¨ˆ</h3>
    <button id="eduCloseBtn">é—œé–‰</button>
  </div>

  <div id="eduControls" class="controls">
    <div class="box">
      <label>å€åŸŸåˆ¥</label>
      <select id="eduSelArea"></select>
    </div>
    <div class="box">
      <label>æ€§åˆ¥</label>
      <select id="eduSelSex">
        <option value="0">åˆè¨ˆ</option>
        <option value="1">ç”·</option>
        <option value="2">å¥³</option>
      </select>
    </div>
    <div class="box">
      <label>å¹´ä»½</label>
      <select id="eduSelYear"></select>
    </div>
    <div class="box">
      <label>å¹´é½¡åˆ¥ï¼ˆå³å´ç›´æ–¹åœ–ç”¨ï¼‰</label>
      <select id="eduSelAge"></select>
    </div>
  </div>

  <div id="eduGrid" class="grid">
    <div class="edu-card card">
      <h4 id="eduStackTitle">æ•™è‚²ç¨‹åº¦åˆ†å¸ƒï¼ˆå †ç–Šï¼‰</h4>
      <div id="eduStackWrap"><canvas id="eduStackBar"></canvas></div>
    </div>

    <div class="edu-card card">
      <h4 id="eduSingleBarTitle">æ•™è‚²ç¨‹åº¦ç›´æ–¹åœ–</h4>
      <div id="eduSingleWrap"><canvas id="eduSingleBar"></canvas></div>
    </div>
  </div>
</div>

  <div id="msg">ç”Ÿæˆ15åˆ†é˜æ­¥è¡Œ / è…³è¸è»Šç”Ÿæ´»åœˆæˆ–é»æ“Šå»ºç‰©æŸ¥çœ‹è³‡è¨Š</div>
  <div id="customPopup"></div>
  <div id="legend"><b>å…¬å…±è¨­æ–½åœ–ä¾‹</b></div>
  <div id="medLegend"><b>é†«ç™‚é•·ç…§åœ–ä¾‹</b></div>

  <!-- âœ… çŠ¯ç½ªäº‹ä»¶é¢æ¿ -->
  <div id="crimePanel">
  <div class="crime-panel-hd">
    <h3>äº‹ä»¶é»ä½ï¼ˆçŠ¯ç½ªï¼‰</h3>
    
  </div>

  <!-- âœ… æ–°å¢ï¼šå­¸æ ¡é»ä½é–‹é—œ -->
  <div id="schoolSwitchWrap" class="crimeSwitchRow">
    <span>å­¸æ ¡é»ä½</span>
    <label class="switch">
      <input type="checkbox" id="schoolToggle">
      <span class="slider"></span>
    </label>
  </div>

  <!-- å­¸æ ¡å‘¨é‚Šåˆ¤å®šåŠå¾‘ï¼ˆå…¬å°ºï¼‰ -->
  <div class="crimeRow">
    <label>å­¸æ ¡åŠå¾‘</label>
    <select id="schoolRadiusSelect">
      <option value="300">300m</option>
      <option value="500" selected>500m</option>
      <option value="800">800m</option>
      <option value="1000">1000m</option>
    </select>
  </div>

  <div id="crimeSwitchWrap" class="crimeSwitchRow">
    <span>çŠ¯ç½ªåœ–å±¤</span>
    <label class="switch">
      <input type="checkbox" id="crimeToggle">
      <span class="slider"></span>
    </label>
  </div>

  <div class="crimeRow">
    <label>é¡å‹</label>
    <select id="crimeTypeSelect">
      <option value="ALL">å…¨éƒ¨ï¼ˆå°æªœæºªï¼‰</option>
    </select>
  </div>

  <div class="crimeRow">
    <label>å¹´ä»½</label>
    <select id="crimeYearSelect">
      <option value="ALL">å…¨éƒ¨</option>
    </select>
  </div>

  <div class="crimeRow">
    <label>æœˆä»½</label>
    <select id="crimeMonthSelect">
      <option value="ALL">å…¨éƒ¨</option>
      <option value="1">01</option><option value="2">02</option><option value="3">03</option>
      <option value="4">04</option><option value="5">05</option><option value="6">06</option>
      <option value="7">07</option><option value="8">08</option><option value="9">09</option>
      <option value="10">10</option><option value="11">11</option><option value="12">12</option>
    </select>
  </div>

  <div class="crimeRow">
    <label>ç†±å€</label>
    <label class="switch">
      <input type="checkbox" id="crimeHeatToggle">
      <span class="slider"></span>
    </label>
  </div>

  <div class="kpiRow">
    <div class="kpiCard">
      <div class="kpiVal" id="crimeKpiTotal">0</div>
      <div class="kpiLab">ç›®å‰ç¯©é¸ç¸½æ•¸</div>
    </div>
    <div class="kpiCard">
      <div class="kpiVal" id="crimeKpiTop1">-</div>
      <div class="kpiLab">Top1 é¡å‹</div>
    </div>
  </div>

  <div class="crimeHint">
    â€» çŠ¯ç½ªäº‹ä»¶å¯ç”¨ã€Œé¡å‹/å¹´ä»½/æœˆã€åšç¯©é¸ï¼Œä¸¦åˆ‡æ›ç†±å€/é»ä½<br>
    â€» å­¸æ ¡ç†±å€ï¼šé»ã€Œè¨ˆç®—ã€å¾Œæœƒåˆ†æ‰¹ç®—æ¯é–“å­¸æ ¡ã€Œ10åˆ†é˜æ­¥è¡Œå¯é”ç¯„åœã€å…§çš„çŠ¯ç½ªå¯†åº¦ä¸¦åšæ’è¡Œæ¦œ
  </div>

  <div class="crimeSection" style="margin-top:10px;">
  <button id="btnSchoolCompute" type="button" style="width:100%; padding:10px; border-radius:12px; border:0; background:#2563eb; color:#fff; cursor:pointer;">
    è¨ˆç®—ï¼šå­¸æ ¡ 10 åˆ†é˜æ­¥è¡Œç†±å€ï¼ˆåˆ†æ‰¹ï¼‰
  </button>
  <div id="schoolComputeStatus" style="margin-top:8px; font-size:12px; opacity:.85;"></div>

  <!-- âœ… æ’è¡Œæ¦œï¼šæ”¾åœ¨è¨ˆç®—æŒ‰éˆ•ä¸‹æ–¹ï¼ˆå¯æ»¾å‹•ï¼‰ -->
  <div id="schoolRankWrap" style="margin-top:8px; display:none;">
    <div id="schoolRankList"></div>
  </div>
</div>
</div>

<!-- âœ… 15 åˆ†é˜ç”Ÿæ´»åœˆ + å®œå±…åˆ†æ•¸ï¼ˆåŒä¸€é¢æ¿ / åˆ†é ï¼‰ -->
  <div id="lifePanel">
    <div id="lifePanelHeader">
      <button id="tabIso" class="life-tab active">15 åˆ†é˜ç”Ÿæ´»åœˆ</button>
      <button id="tabLive" class="life-tab">å®œå±…åˆ†æ•¸</button>
    </div>

    <!-- Page Aï¼š15 åˆ†é˜ç”Ÿæ´»åœˆ -->
    <div id="lifeIsoPage" class="life-page active"></div>

    <!-- Page Bï¼šå®œå±…åˆ†æ•¸ -->
    <div id="lifeLivabilityPage" class="life-page">
      <div id="livabilityPanelTitle">å»ºç‰©å®œå±…åˆ†æ•¸</div>
      <div id="livabilityContent">å°šæœªé¸å–å»ºç‰©æˆ–æœªç”¢ç”Ÿ 15 åˆ†é˜ç”Ÿæ´»åœˆã€‚</div>
    </div>
  </div>

<!-- åº•åœ–æŒ‰éˆ• + é¸å–® -->
  <button id="basemapButton">
    <div class="box-streets"></div>
    <div class="box-topo"></div>
    <div class="box-satellite"></div>
    <div class="box-emap"></div>
  </button>

  <!-- è‡ªè¨‚ç¯„åœå·¥å…·ï¼šæŒ‰éˆ•ï¼ˆæ”¾åœ¨åº•åœ–æŒ‰éˆ•å³é‚Šï¼‰ -->
  <button id="rangeToolToggleBtn" title="è‡ªè¨‚ç¯„åœå·¥å…·" aria-label="è‡ªè¨‚ç¯„åœå·¥å…·">
  </button>

  <div id="basemapPanel">
    <h3>åº•åœ–</h3>
    <div class="basemap-item">
      <span>è¡—é“åœ– (OSM)</span>
      <label class="bm-switch"><input type="checkbox" data-basemap="streets"><span class="bm-slider"></span></label>
    </div>
    <div class="basemap-item">
      <span>åœ°å½¢åœ–</span>
      <label class="bm-switch"><input type="checkbox" data-basemap="topo"><span class="bm-slider"></span></label>
    </div>
    <div class="basemap-item">
      <span>è¡›æ˜Ÿåœ–</span>
      <label class="bm-switch"><input type="checkbox" data-basemap="satellite"><span class="bm-slider"></span></label>
    </div>
    <div class="basemap-item">
      <span>é€šç”¨é›»å­åœ°åœ–</span>
      <label class="bm-switch"><input type="checkbox" data-basemap="emap" checked><span class="bm-slider"></span></label>
    </div>
    <div class="basemap-item">
      <span>æ­£å°„å½±åƒ</span>
      <label class="bm-switch"><input type="checkbox" data-basemap="photo2"><span class="bm-slider"></span></label>
    </div>
  </div>

  <!-- âœ… å³å´å…±ç”¨çµ±è¨ˆé¢æ¿ -->
  <div id="statsPanel">
    <div id="statsHeader">
      <div id="statsHeaderTitle">ç”Ÿæ´»åœˆå…¬å…±è¨­æ–½çµ±è¨ˆ</div>
      <div id="statsTotalHouse" style="font-weight:bold;font-size:13px;background:rgba(255,255,255,0.2);padding:4px 0;border-radius:4px;">
        é–€ç‰Œç¸½æ•¸: 0
      </div>
      <div id="statsTabs">
        <button id="tabFacility" class="stats-tab-btn active">å…¬å…±è¨­æ–½</button>
        <button id="tabMed" class="stats-tab-btn">é†«ç™‚é•·ç…§</button>
      </div>
    </div>
    <div id="statsFacilityContainer"></div>
    <div id="statsMedContainer"></div>
  </div>
    <!-------- åœŸå£¤æ¶²åŒ– ------------>
<button id="customLayerToggleBtn" type="button" title="é¡¯ç¤º/éš±è—åœ–å±¤"></button>

<div id="customLegend">
  <div><b>åˆ†ç´šåœ–ä¾‹</b></div>
  <div class="legend-item"><div class="legend-color" style="background: rgba(0,255,0,0.5)"></div>ä½æ½›å‹¢</div>
  <div class="legend-item"><div class="legend-color" style="background: rgba(255,255,0,0.5)"></div>ä¸­æ½›å‹¢</div>
  <div class="legend-item"><div class="legend-color" style="background: rgba(255,0,0,0.5)"></div>é«˜æ½›å‹¢</div>
</div>

<!------- æ°´è³ª+æ·¹æ°´ --------->
<!-- å·¦ä¸‹è§’åœ“å½¢æŒ‰éˆ• -->
<div id="panel-toggle"></div>

<!-- å·¦ä¸‹è§’ï¼šçŠ¯ç½ªåœ“å½¢æŒ‰éˆ• -->
<div id="crime-toggle-btn"></div>

<!-- âœ… å·¦å´æ»‘å‡ºé¢æ¿é®ç½©ï¼ˆæ‰“é–‹é¢æ¿æ™‚æ“‹ä½å…¶ä»–æŒ‰éˆ•ï¼‰ -->
<div id="leftPanelMask"></div>


<!-- é¢æ¿ -->
<div id="panel-water" class="water-panel">
  <h3>
    å—å´æºªæ°´è³ªè³‡æ–™
    <button id="btn-rpi" class="btn-toggle">RPI åˆ†ç´š</button>
  </h3>
  <div class="indicators">
    <div class="indicator" id="air-indicator">æ°£æº«<br><span id="air-value">--</span></div>
    <div class="indicator" id="rpi-indicator">RPI<br><span id="rpi-value">--</span></div>
    <div class="indicator" id="water-indicator">æ°´æº«<br><span id="water-value">--</span></div>
  </div>
  <div style="display:flex; justify-content:center; margin-top:10px;">
    <button id="btn-points" class="btn-toggle" style="font-size:0.8rem; padding:4px 8px;">é¡¯ç¤ºç«™é»</button>
  </div>
  <div class="table-wrapper" id="water-table-wrapper"></div>
  <div id="rpi-panel" class="rpi-panel">
    <div class="rpi-container" id="rpi-container" style="top:180px;"></div>
  </div>
</div>

<!-- é¢æ¿ -->
<div id="flood3D_panel" class="flood3D_panel">
  <h3>æ·¹æ°´å³æ™‚è³‡æ–™</h3>
  <div id="flood3D_updateTime">è§€æ¸¬æ™‚é–“: -</div>
  <select id="flood3D_stationSelect">
    <option value="">è«‹é¸æ“‡ç›£æ¸¬ç«™</option>
  </select>
  <div id="flood3D_stationInfo">
    <div id="flood3D_basicInfo"></div>
    <img id="flood3D_depthImg" src="" alt="æ°´æ·±åœ–ç¤º">
    <div id="flood3D_depth"></div>
  </div>
</div>

<!-- è‡ªè¨‚å½ˆçª— -->
<div id="custom-popup"></div>

<!-- å·¦ä¸‹è§’æŒ‰éˆ• -->
<div id="flood3D_toggleBtn"></div>

</div>

<!-- YouBike / EV æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
<button id="modeToggleBtn">åˆ‡æ›åˆ°EVæ¨¡å¼âš¡</button>
<button id="parkingModeBtn">åœè»Šå ´ğŸ…¿</button>

<!-- YouBike å³å´é¢æ¿ -->
<div id="yRightPanel">
  <div class="panel-title youbike">
     YouBike ç§Ÿå€Ÿç«™ğŸš´â€â™‚ï¸
  </div>
  <input id="ySearchBox" placeholder="ğŸ” æœå°‹Youbikeç«™å...">
  <div id="yStationList"><div id="yStationListInner"></div></div>
</div>

<!-- YouBike å·¦å´ infoPanel -->
<div id="infoPanel">
  <div id="infoPanelClose">âœ–</div>
</div>

<!-- EV å³å´é¢æ¿ -->
<div id="evRightPanel">
  <div class="panel-title ev">
    <i class="fas fa-charging-station"></i> EV å……é›»ç«™âš¡
  </div>
  <input id="evSearchBox" placeholder="ğŸ” æœå°‹ EV ç«™å...">
  <div id="evStationList"><div id="evStationListInner"></div></div>
</div>


<!-- Parking å³å´é¢æ¿ -->
<div id="pRightPanel">
  <div class="panel-title" style="color:#2882dc;">
     åœè»Šå ´ ğŸ…¿
  </div>
  <input id="pSearchBox" placeholder="æœå°‹åœè»Šå ´..." />
  <div id="pStationList"><div id="pStationListInner"></div></div>
</div>

<!-- Parking è³‡è¨Šé¢æ¿ -->
<div id="pInfoPanel">
  <div id="pInfoPanelClose">âœ–</div>
  <div id="pInfoBody"></div>
</div>

<!-- EV å·¦å´ infoPanel -->
<div id="evInfoPanel">
  <div id="evInfoPanelClose">âœ–</div>
  <div id="evInfoPanelContent"></div>
</div>

<!-- å…¬è»Šï¼šè‡ªè¨‚å½ˆè·³è¦–çª— -->
<div id="floatingPopup">
  <div class="pop-hd">
    <span id="popTitle">è³‡è¨Š</span>
    <button class="pop-close" id="popCloseBtn">é—œé–‰</button>
  </div>
  <div class="pop-bd" id="popBody"></div>
  <div class="pop-arrow"></div>
</div>

<!-- å…¬è»Šï¼šåˆä½µé¢æ¿ -->
<div class="panel panel-combined" id="panelCombined">
  <div class="panel-header">
    <span id="panelTitle">ğŸšŒ å…¬è»Šé¢æ¿</span>
    <span class="small" id="panelHint">â€”</span>
  </div>

  <div class="panel-tools tabbar">
    <div class="tab-left">

      <button id="tabBusModule" class="active">å…¬è»Šé¢æ¿</button>
      <button id="tabAcc">äº‹æ•…</button>
    </div>

    <div class="tab-right">
      <div class="panel-legend" id="busLegend">
        <div class="legend-item">
          <img src="https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å…¬è»Š(æ­£å¸¸).png" alt="ç«™ç‰Œ">
          <span>ç«™ç‰Œ</span>
        </div>
        <div class="legend-item">
          <img src="https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å…¬è»Š(å»ç¨‹).png" alt="å»ç¨‹">
          <span>å»ç¨‹</span>
        </div>
        <div class="legend-item">
          <img src="https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å…¬è»Š(è¿”ç¨‹).png" alt="è¿”ç¨‹">
          <span>è¿”ç¨‹</span>
        </div>
      </div>
    </div>
  </div>

  
  <!-- å­åˆ†é ï¼šç«™åº / å³æ™‚å…¬è»Šï¼ˆåªåœ¨ã€Œè·¯ç·šç«™åºã€æ¨¡å¼é¡¯ç¤ºï¼‰ -->
  <div class="panel-tools tabbar subtab" id="busSubTabbar">
    <div class="tab-left">
      <button id="tabStops" class="active">ç«™åº</button>
      <button id="tabBuses">å³æ™‚å…¬è»Š</button>
    </div>
  </div>

<!-- Page Aï¼šç«™åº -->
  <div class="panel-page" id="pageStops">
    <div class="panel-tools">
      <select id="routeSelect" style="flex:1"></select>
      <button id="dir0" class="active">å»ç¨‹</button>
      <button id="dir1">è¿”ç¨‹</button>
    </div>

    <div class="table-container">
      <table class="tbl-stops">
        <colgroup>
          <col style="width:60px">
          <col>
          <col style="width:80px">
        </colgroup>
        <thead>
          <tr><th>åº</th><th>ç«™å</th><th>é ä¼°æ™‚é–“</th></tr>
        </thead>
        <tbody id="routeStops"></tbody>
        <tfoot>
          <tr><td colspan="3"><img id="routeImg" class="route-img" alt="Route Map"></td></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Page Bï¼šå…¬è»Š -->
  <div class="panel-page" id="pageBuses" style="display:none">
    <div class="table-container">
      <table class="tbl-bus">
        <colgroup>
          <col style="width:70px">
          <col style="width:70px">
          <col style="width:55px">
          <col>
          <col style="width:70px">
        </colgroup>
        <thead>
          <tr><th>è·¯ç·š</th><th>è»Šç‰Œ</th><th>æ–¹å‘</th><th>ä¸‹ä¸€ç«™</th><th>é ä¼°æ™‚é–“</th></tr>
        </thead>
        <tbody id="busTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Page Cï¼šäº¤é€šäº‹æ•…ï¼ˆæ™‚é–“è»¸ + æŠ˜ç·šåœ–ï¼‰ -->
  <div class="panel-page" id="pageAccident" style="display:none">
    <div class="acc-tools">
      <select id="accGroupSelect" title="ç¯©é¸æœ€å°çµ±è¨ˆå€">
        <option value="ALL">å…¨éƒ¨</option>
      </select>
      <div class="acc-mini">
        <div class="small">æ™‚é–“ï¼š<span id="accTimeLabel">--</span></div>
        <div class="small">é»æ•¸ï¼š<span id="accCountLabel">0</span></div>
        <div class="small">A1ï¼š<span id="accA1Label">0</span>ã€€A2ï¼š<span id="accA2Label">0</span></div>
      </div>
    </div>

    <div class="acc-chart-wrap">
      <canvas id="accChart"></canvas>
    </div>

    <div class="acc-timeline">
      <input id="accTimeSlider" type="range" min="0" max="0" value="0" step="1">
      <div class="acc-range">
        <span class="small" id="accRangeMin">--</span>
        <span class="small" id="accRangeMax">--</span>
      </div>
      <div class="small acc-hint">æ‹–æ‹‰æ™‚é–“è»¸æœƒæ›´æ–°åœ°åœ–äº‹æ•…é»ä½ï¼ˆåªé¡¯ç¤ºç•¶æœˆï¼‰</div>
    </div>
  </div>
</div>

<!-- âœ… è·¯ç·šåœ–æ”¾å¤§ Modal -->
<div id="imgModal">
  <span id="imgModalClose">Ã—</span>
  <img id="imgModalContent" />
</div>

<script>
/* =========================================================
   âœ… TDX å…±ç”¨è¨­å®š
   ========================================================= */

/* ====== TDX å…±ç”¨è¨­å®š ====== */
const CLIENT_ID = "f64114043-33b50db7-9399-4209";
const CLIENT_SECRET = "7ac0fe25-95fb-492d-929d-aa91788c46bb";

let tdxToken = "";

// å…±ç”¨ï¼šå–å¾— TDX Token
async function getTDXToken() {
  if (tdxToken) return tdxToken;
  const res = await fetch(
    "https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token",
    {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        grant_type: "client_credentials",
        client_id: CLIENT_ID,
        client_secret: CLIENT_SECRET
      })
    }
  );
  const data = await res.json();
  tdxToken = data.access_token;
  return tdxToken;
}

// å…¬è»Šç”¨ç°¡åŒ– API
async function api(url){
  const token = await getTDXToken();
  const r = await fetch(url,{headers:{Authorization:`Bearer ${token}`}})
  return r.json();
}

// YouBike ç›´æ¥å…±ç”¨åŒä¸€å€‹ Token
async function getYouBikeAccessToken() {
  return getTDXToken();
}

/* ===== å…¬è»Šåœ–ç¤º ===== */
const ICON_STOP     = "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å…¬è»Š(æ­£å¸¸).png";
const ICON_BUS_DIR0 = "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å…¬è»Š(å»ç¨‹).png";
const ICON_BUS_DIR1 = "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å…¬è»Š(è¿”ç¨‹).png";
const ICON_PARKING  = "https://static.arcgis.com/images/Symbols/Shapes/BluePin1LargeB.png"; // â† æ”¹æˆä½ è‡ªå·±çš„åœ–ç‰‡ç¶²å€ï¼ˆpng/svg/jpg éƒ½å¯ï¼‰
const PARKING_ICON_SIZE = 22;
const PARKING_ICON_SIZE_ACTIVE = 32;


require([
  "esri/Map", "esri/views/SceneView", "esri/Basemap", "esri/views/MapView", "esri/config",
  "esri/layers/SceneLayer", "esri/Graphic", "esri/layers/GraphicsLayer",
  "esri/geometry/geometryEngine", "esri/geometry/support/webMercatorUtils",
  "esri/layers/MapImageLayer", "esri/geometry/Point",
  "esri/geometry/Polygon", "esri/layers/GeoJSONLayer",
  "esri/geometry/Polyline", "esri/layers/WMTSLayer", "esri/layers/WebTileLayer",

  /* âœ… çŠ¯ç½ªç”¨ */
  "esri/layers/FeatureLayer",
  "esri/renderers/UniqueValueRenderer",
  "esri/renderers/HeatmapRenderer",
  "esri/renderers/SimpleRenderer",
  "esri/symbols/PointSymbol3D",
  "esri/symbols/LineSymbol3D",
  "esri/symbols/IconSymbol3DLayer",
  "esri/symbols/LineSymbol3DLayer"
], function (
  Map, SceneView, Basemap, MapView, esriConfig,
  SceneLayer, Graphic, GraphicsLayer,
  geometryEngine, webMercatorUtils,
  MapImageLayer, Point,
  Polygon, GeoJSONLayer,
  Polyline, WMTSLayer, WebTileLayer,

  /* âœ… çŠ¯ç½ªç”¨ */
  FeatureLayer, UniqueValueRenderer, HeatmapRenderer, SimpleRenderer,
  PointSymbol3D, LineSymbol3D, IconSymbol3DLayer, LineSymbol3DLayer
) {

  const legendDiv = document.getElementById("legend");
  const medLegendDiv = document.getElementById("medLegend");
  let currentStatsMode = "facility";

  const geojsonLayer = new GeoJSONLayer({
    url: "https://jade0815.github.io/data/å°æªœæºªæœ€å°çµ±è¨ˆå€NEW.geojson",
    elevationInfo: { mode: "on-the-ground" }
  });
  /* ========= å…±ç”¨åœ°åœ– / è¦–è§’ ========= */
  const initialCamera = {
    position: [121.3128655838495, 24.99343185685978, 600],
    tilt: 65,
    heading: 0
  };

    const map = new Map({
    basemap: "streets-relief-vector",
    ground: "world-elevation"
  });

  const view = new SceneView({
    container: "viewDiv",
    map,
    camera: initialCamera
  });
      view.popupEnabled = false;
view.when(() => {
  // ç§»é™¤ ArcGIS å…§å»º UI å…ƒä»¶
  view.ui.remove("zoom");        // å·¦ä¸Šè§’ + -
  view.ui.remove("compass");     // æŒ‡åŒ—é‡
  view.ui.remove("navigation-toggle"); // 2D/3D åˆ‡æ›
  view.ui.remove("attribution"); // å³ä¸‹è§’ Esri attribution
});

  /* =========================================================
     âœ… CCTVï¼ˆäº¤é€šä»‹é¢ï¼‰
     - åªåœ¨ã€Œäº¤é€šé–‹å•Ÿã€æ¨¡å¼é¡¯ç¤ºæŒ‰éˆ•
     - é»æŒ‰éˆ•é–‹é¢æ¿ï¼Œå¯åˆ‡æ›æ˜¯å¦é¡¯ç¤º CCTV é»ä½
     ========================================================= */

  const cctvToggleBtn = document.getElementById("cctv-toggle-btn");
  const cctvPanel = document.getElementById("cctv-panel");
  const cctvRoadSelect = document.getElementById("road-select");
  const cctvAreaSelect = document.getElementById("area-select");
  const cctvIdSelect = document.getElementById("cctvid-select");
  const cctvVideoContainer = document.getElementById("cctv-videos");
  const cctvButtonsContainer = document.getElementById("cctv-buttons-container");
  const cctvBackBtn = document.getElementById("back-btn");
  const cctvLayerToggleSwitch = document.getElementById("cctv-layer-toggle-switch");

  // CCTV åœ–å±¤
  const cctvLayer = new GraphicsLayer({ popupEnabled: false });
  map.add(cctvLayer);


  //------------- CMS -------------//
  const cmsLayer = new GraphicsLayer();
  map.add(cmsLayer);

  const cmsPopup = document.getElementById("cms-popup");
  const toggleBtnCMS = document.getElementById("cms-toggle-btn");
  let cmsVisible = false;

  const directionMap = { "N":"åŒ—", "S":"å—", "E":"æ±", "W":"è¥¿", "NE":"æ±åŒ—", "NW":"è¥¿åŒ—", "SE":"æ±å—", "SW":"è¥¿å—" };

  let cmsCachedData = null;
  let cmsLastFetchTime = 0;
  const CMS_CACHE_INTERVAL = 60 * 1000;

  let cmsTokenCache = null;
  let cmsTokenExpire = 0;

  let blinkIntervals = [];
  let cmsSwiper = null;

  // âœ… å–å¾— tokenï¼šå„ªå…ˆç”¨ä½ åŸæœ¬æ•´åˆæª”è£¡çš„ getTDXToken()/api()ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  async function cmsGetToken(){
    try{
      if (typeof getTDXToken === "function") return await getTDXToken();
    }catch(e){}
    const now = Date.now();
    if (cmsTokenCache && now < cmsTokenExpire) return cmsTokenCache;

    const clientId = "f64114043-33b50db7-9399-4209";
    const clientSecret = "7ac0fe25-95fb-492d-929d-aa91788c46bb";

    const res = await fetch("https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token", {
      method: "POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded" },
      body: `grant_type=client_credentials&client_id=${clientId}&client_secret=${clientSecret}`
    });
    const data = await res.json();
    cmsTokenCache = data.access_token;
    cmsTokenExpire = now + (Math.max(60, (data.expires_in||3600) - 60)) * 1000;
    return cmsTokenCache;
  }

  async function cmsFetch(url){
    // è‹¥æ•´ä»½æª”æ¡ˆå·²æœ‰ api(url) helperï¼Œå°±ç”¨å®ƒï¼ˆæœƒè‡ªå‹•å¸¶ tokenï¼‰
    try{
      if (typeof api === "function") return await api(url);
    }catch(e){}
    const token = await cmsGetToken();
    const res = await fetch(url, { headers:{ Authorization:`Bearer ${token}` }});
    if (!res.ok) throw new Error("CMS fetch failed: " + res.status);
    return await res.json();
  }

  toggleBtnCMS.addEventListener("click", async (e)=>{
    e.stopPropagation();
    // äº¤é€šé—œé–‰æ™‚ä¸åšäº‹ï¼ˆç¶­æŒä½ åŸæœ¬è¦å‰‡ï¼‰
    if (document.body.classList.contains("map-only")) return;

    cmsVisible = !cmsVisible;
    toggleBtnCMS.classList.toggle("active", cmsVisible);

    if(cmsVisible){
      cmsPopup.style.display = "none";
      await loadCMS();
    } else {
      cmsPopup.style.display = "none";
      cmsLayer.removeAll();
      blinkIntervals.forEach(i=>clearInterval(i));
      blinkIntervals = [];
      if (cmsSwiper) { try{ cmsSwiper.destroy(true,true); }catch(e){} cmsSwiper=null; }
    }
  });

  async function loadCMS(){
    const now = Date.now();
    if(cmsCachedData && (now - cmsLastFetchTime) < CMS_CACHE_INTERVAL){
      renderCMS(cmsCachedData);
      return;
    }
    try{
      const [baseData, liveData] = await Promise.all([
        cmsFetch("https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CMS/City/Taoyuan?$format=JSON"),
        cmsFetch("https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/Live/CMS/City/Taoyuan?$format=JSON")
      ]);
      cmsCachedData = { baseData, liveData };
      cmsLastFetchTime = now;
      renderCMS(cmsCachedData);
    }catch(err){
      console.error("è¼‰å…¥ CMS è³‡æ–™éŒ¯èª¤:", err);
      // è‹¥æœ‰èˆŠè³‡æ–™å°±å…ˆé¡¯ç¤ºèˆŠè³‡æ–™
      if(cmsCachedData) renderCMS(cmsCachedData);
    }
  }

  function makeBoxBlink(graphic, colors=["rgba(255,0,0,0.8)", "rgba(255,150,150,0.9)"]){
    let idx = 0;
    return setInterval(()=>{
      const sym = graphic.symbol.clone();
      const layer0 = sym.symbolLayers.getItemAt(0);
      layer0.outline.color = colors[idx];
      graphic.symbol = sym;
      idx = (idx + 1) % colors.length;
    }, 500);
  }

  // ç”¨ attributes å­˜è³‡æ–™ï¼Œé»æ“Šæ™‚ hitTest è®€å–
  function renderCMS({ baseData, liveData }){
    cmsLayer.removeAll();
    blinkIntervals.forEach(i=>clearInterval(i));
    blinkIntervals = [];

    const liveMap = {};
    (liveData?.CMSLives || []).forEach(live => { liveMap[live.CMSID] = live; });

    const items = (baseData?.CMSs || []);
    items.forEach(cms=>{
      const lat = Number(cms.PositionLat), lon = Number(cms.PositionLon);
      if(!lat || !lon) return;

      const live = liveMap[cms.CMSID];
      const messages = [];
      if(live?.Messages?.length){
        live.Messages.forEach(msg=>{
          const t = (msg?.Text ?? "").toString();
          messages.push((!t || t === "-99") ? "[ç†„æ»…ä¸­]" : t);
        });
      }else{
        messages.push("[ç†„æ»…ä¸­]");
      }

      const zOffset = 100;
      const pt = new Point({ longitude: lon, latitude: lat, z: zOffset });

      const boxSymbol = new PointSymbol3D({
        symbolLayers: [
          new IconSymbol3DLayer({
            resource: { primitive: "circle" },
            size: 30,
            material: { color: "white" },
            outline: { color: "red", size: 3 }
          }),
          new IconSymbol3DLayer({
            resource: { primitive: "text", text: "CMS" },
            size: 10,
            material: { color: "red" }
          })
        ]
      });

      const boxGraphic = new Graphic({
        geometry: pt,
        symbol: boxSymbol,
        attributes: {
          _type: "CMS",
          ...cms,
          _messages: messages
        }
      });
      cmsLayer.add(boxGraphic);
      blinkIntervals.push(makeBoxBlink(boxGraphic));

      const line = new Polyline({ paths: [[[lon, lat, 0],[lon, lat, zOffset]]] });
      const lineSymbol = new LineSymbol3D({
        symbolLayers: [ new LineSymbol3DLayer({ material:{ color:"red" }, size:2 }) ]
      });
      const lineGraphic = new Graphic({
        geometry: line,
        symbol: lineSymbol,
        attributes: { _type:"CMS_LINE", CMSID: cms.CMSID }
      });
      cmsLayer.add(lineGraphic);
    });
  }

  // âœ… åªè¨»å†Šä¸€æ¬¡ clickï¼ˆé¿å…ä½ åŸæœ¬ç¯„ä¾‹æ¯å€‹ CMS éƒ½è¨»å†Šä¸€æ¬¡å°è‡´çˆ†ç‚¸ï¼‰
  view.on("click", (evt)=>{
    if (!cmsVisible) return;
    if (document.body.classList.contains("map-only")) return;

    view.hitTest(evt).then((response)=>{
      const hit = response.results.find(r => r.graphic && r.graphic.layer === cmsLayer && r.graphic.attributes && r.graphic.attributes._type === "CMS");
      if(!hit){
        // é»ç©ºç™½è™•å°±é—œ popup
        cmsPopup.style.display = "none";
        return;
      }

      const g = hit.graphic;
      const a = g.attributes || {};
      const msgs = a._messages || ["[ç†„æ»…ä¸­]"];

      const screen = view.toScreen(g.geometry);
      cmsPopup.style.display = "flex";
      cmsPopup.style.left = (screen.x + 10) + "px";
      cmsPopup.style.top  = (screen.y + 10) + "px";

      cmsPopup.innerHTML = `
        <p><strong>${(a.RoadName||"")}</strong></p>
        <p>CMSç·¨è™Ÿï¼š${a.CMSID || "-"}</p>
        <p>é€£çµç·¨è™Ÿï¼š${a.LinkID || "-"}</p>
        <p>ä½ç½®é¡å‹ï¼š${a.LocationType || "-"}</p>
        <p>é“è·¯IDï¼š${a.RoadID || "-"}</p>
        <p>é“è·¯ç´šåˆ¥ï¼š${a.RoadClass || "-"}</p>
        <p>è¡Œè»Šæ–¹å‘ï¼š${directionMap[a.RoadDirection] || a.RoadDirection || "-"}</p>
        <div class="swiper-container" style="height:60px;">
          <div class="swiper-wrapper">
            ${msgs.map(m=>`<div class="swiper-slide"><span>${m}</span></div>`).join("")}
          </div>
        </div>
      `;

      if (cmsSwiper) { try{ cmsSwiper.destroy(true,true); }catch(e){} cmsSwiper=null; }
      cmsSwiper = new Swiper(cmsPopup.querySelector(".swiper-container"), {
        slidesPerView: 1,
        loop: msgs.length > 1,
        autoplay: (msgs.length > 1) ? { delay:3000, disableOnInteraction:false } : false
      });
    });
  });

  // å¯æ‹–æ›³åŠŸèƒ½ï¼ˆpopupï¼‰
  let cmsDragging = false, cmsOffsetX=0, cmsOffsetY=0;
  cmsPopup.addEventListener("mousedown", (e)=>{
    cmsDragging = true;
    cmsOffsetX = e.clientX - cmsPopup.offsetLeft;
    cmsOffsetY = e.clientY - cmsPopup.offsetTop;
    cmsPopup.style.cursor = "grabbing";
  });
  document.addEventListener("mousemove", (e)=>{
    if(!cmsDragging) return;
    cmsPopup.style.left = (e.clientX - cmsOffsetX) + "px";
    cmsPopup.style.top  = (e.clientY - cmsOffsetY) + "px";
  });
  document.addEventListener("mouseup", ()=>{
    cmsDragging = false;
    cmsPopup.style.cursor = "move";
  });

  // é»æ“Šç©ºç™½è™•é—œé–‰ popupï¼ˆä½†ä¸è¦åƒæ‰æŒ‰éˆ•é»æ“Šï¼‰
  document.addEventListener("click", (e)=>{
    if (!cmsPopup.contains(e.target) && e.target !== toggleBtnCMS) {
      cmsPopup.style.display = "none";
    }
  });

  cctvLayer.visible = false;

  const cctvTaoyuanBounds = { minLat:24.85, maxLat:25.10, minLon:121.00, maxLon:121.35 };
  const cctvTaoyuanAreas = {};
  let cctvAreaRoadMap = {};
  let cctvGraphicsArr = [];
  let cctvData = [];
  let cctvCurrent = null;
  let cctvGraphicsAdded = false;
  let cctvInited = false;
  let cctvOriginalCamera = null;

  // è¡Œæ”¿å€ GeoJSONï¼ˆåªæ‹¿é‚Šç•Œåš containsï¼‰
  const cctvAreaGeojsonUrl = "https://jade0815.github.io/data/%E6%A1%83%E5%9C%92%E5%B8%82.geojson";
  const cctvAreaLayer = new GeoJSONLayer({
    url: cctvAreaGeojsonUrl,
    outSpatialReference: { wkid: 4326 }
  });
  cctvAreaLayer.visible = false;
  map.add(cctvAreaLayer);

  function cctvExtractCCTVs(resp){
    if (!resp) return [];
    if (Array.isArray(resp)) return resp;
    if (resp.CCTVs && Array.isArray(resp.CCTVs)) return resp.CCTVs;
    if (resp.data && resp.data.CCTVs && Array.isArray(resp.data.CCTVs)) return resp.data.CCTVs;
    const arr = Object.values(resp).find(v => Array.isArray(v));
    return arr || [];
  }

  function cctvMakeGraphic(cctv){
    const lat = parseFloat(cctv.PositionLat);
    const lon = parseFloat(cctv.PositionLon);
    if (isNaN(lat) || isNaN(lon)) return null;
    return new Graphic({
      geometry: new Point({ longitude: lon, latitude: lat }),
      symbol: { type: "picture-marker", url: "https://cdn-icons-png.flaticon.com/512/3583/3583045.png", width: "30px", height: "30px" },
      attributes: cctv
    });
  }

  function cctvAddCityInfo(){
    cctvData.forEach(cctv => {
      const lat = parseFloat(cctv.PositionLat);
      const lon = parseFloat(cctv.PositionLon);
      cctv.City = "æœªçŸ¥";
      if (!isNaN(lat) && !isNaN(lon)) {
        const pt = new Point({ latitude: lat, longitude: lon });
        for (let area in cctvTaoyuanAreas) {
          if (geometryEngine.contains(cctvTaoyuanAreas[area], pt)) {
            cctv.City = area;
            break;
          }
        }
        if (cctv.City === "æœªçŸ¥") cctv.City = cctv.source || "é«˜é€Ÿå…¬è·¯";
      }
    });
  }

  function cctvBuildAreaRoadMap(){
    cctvAreaRoadMap = {};
    cctvData.forEach(c => {
      const lat = parseFloat(c.PositionLat);
      const lon = parseFloat(c.PositionLon);
      if (isNaN(lat) || isNaN(lon)) return;
      const pt = new Point({ latitude: lat, longitude: lon });
      for (let area in cctvTaoyuanAreas) {
        const polygon = cctvTaoyuanAreas[area];
        if (geometryEngine.contains(polygon, pt)) {
          if (!cctvAreaRoadMap[area]) cctvAreaRoadMap[area] = new Set();
          const roadName = (c.RoadName || c.Road || "").trim();
          if (roadName) cctvAreaRoadMap[area].add(roadName);
        }
      }
    });
  }

  async function cctvLoadData(){
    // âœ… å…±ç”¨ä½ æª”æ¡ˆè£¡çš„ getTDXToken()
    const token = await getTDXToken();
    if (!token) throw new Error("ç„¡æ³•å–å¾— TDX Token");

    const cityUrl = "https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/City/Taoyuan?$format=JSON";
    const highwayUrl = "https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/CCTV/Highway?$format=JSON";
    const [cityResp, highwayResp] = await Promise.all([
      fetch(cityUrl, { headers: { Authorization: `Bearer ${token}` } }).then(r => r.json()),
      fetch(highwayUrl, { headers: { Authorization: `Bearer ${token}` } }).then(r => r.json())
    ]);

    const cityArr = cctvExtractCCTVs(cityResp).map(c => ({ ...c, source: "æ¡ƒåœ’å¸‚å€" }));
    const highwayArr = cctvExtractCCTVs(highwayResp).map(c => ({ ...c, source: "é«˜é€Ÿå…¬è·¯" }))
      .filter(c => {
        const lat = Number(c.PositionLat), lon = Number(c.PositionLon);
        return lat>=cctvTaoyuanBounds.minLat && lat<=cctvTaoyuanBounds.maxLat &&
               lon>=cctvTaoyuanBounds.minLon && lon<=cctvTaoyuanBounds.maxLon;
      });

    cctvData = [...cityArr, ...highwayArr];

    cctvGraphicsArr = [];
    cctvData.forEach(c => {
      const g = cctvMakeGraphic(c);
      if (g) cctvGraphicsArr.push(g);
    });

    cctvBuildAreaRoadMap();
    cctvAddCityInfo();
  }

  async function cctvInit(){
    if (cctvInited) return;
    cctvInited = true;

    // å„²å­˜ CCTV å›åŸè¦–è§’
    cctvOriginalCamera = view.camera.clone();

    // 1) è¡Œæ”¿å€é¸å–®
    await cctvAreaLayer.when();
    const result = await cctvAreaLayer.queryFeatures();
    result.features.forEach(f => {
      const name = f.attributes.TOWNNAME || f.attributes.NAME || "æœªçŸ¥å€åŸŸ";
      let geom = f.geometry;
      if (geom.spatialReference?.wkid !== 4326) {
        geom = webMercatorUtils.webMercatorToGeographic(geom);
      }
      cctvTaoyuanAreas[name] = geom;

      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      cctvAreaSelect.appendChild(opt);
    });

    // 2) CCTV è³‡æ–™
    await cctvLoadData();

    console.log("âœ… CCTV åˆå§‹åŒ–å®Œæˆ");
  }

  // --- é«˜äº® ---
  let cctvHighlightedGraphic = null;
  let cctvHighlightCircle = null;

  function cctvResetHighlighted(){
    if (cctvHighlightedGraphic) {
      cctvHighlightedGraphic.symbol = {
        type: "picture-marker",
        url: "https://cdn-icons-png.flaticon.com/512/3583/3583045.png",
        width: "30px",
        height: "30px"
      };
      cctvHighlightedGraphic = null;
    }
    if (cctvHighlightCircle) {
      cctvLayer.remove(cctvHighlightCircle);
      cctvHighlightCircle = null;
    }
  }

  function cctvClosePanelAndLayer(){
    cctvPanel.style.display = "none";
    cctvVideoContainer.innerHTML = "";
    cctvButtonsContainer.innerHTML = "";
    cctvIdSelect.innerHTML = '<option value="">è«‹é¸æ“‡ CCTV ID</option>';
    cctvIdSelect.disabled = true;
    cctvBackBtn.style.display = "none";
    cctvRoadSelect.value = "";
    cctvAreaSelect.value = "";
    cctvResetHighlighted();

    // åªé—œ CCTV åœ–å±¤ï¼ˆä¸è¦å‹•åˆ°å…¶ä»–åœ–å±¤ï¼‰
    cctvLayer.visible = false;

    // å› CCTV é–‹å•Ÿæ™‚è¨˜éŒ„çš„è¦–è§’ï¼ˆå¦‚æœæœ‰ï¼‰
    if (cctvOriginalCamera) {
      try { view.goTo(cctvOriginalCamera, { duration: 220 }); } catch(e){}
    }

    cctvCurrent = null;
  }

  function cctvShowInPanel(cctv){
    cctvCurrent = cctv;
    cctvVideoContainer.innerHTML = "";
    if(!cctv) return;

    cctvResetHighlighted();

    const img = document.createElement("img");
    img.src = cctv.VideoStreamURL ? (cctv.VideoStreamURL + "?_=" + Date.now()) : "";
    img.className = "cctv-video";

    const info = document.createElement("div");
    info.className = "cctv-info";
    info.innerHTML = `
      <b>æ‰€åœ¨é„‰é®å¸‚å€ï¼š</b>${cctv.City || "æœªçŸ¥"}<br>
      <b>ä¾†æºï¼š</b>${cctv.source || "æœªçŸ¥"}<br>
      <b>è·¯åï¼š</b>${cctv.RoadName || "ç„¡"}<br>
      <b>æ–¹å‘ï¼š</b>${cctv.RoadDirection || "ç„¡"}<br>
      <b>IDï¼š</b>${cctv.CCTVID || "ç„¡"}
    `;

    cctvVideoContainer.appendChild(img);
    cctvVideoContainer.appendChild(info);

    const g = cctvGraphicsArr.find(gr => gr.attributes.CCTVID === cctv.CCTVID);
    if(g){
      cctvHighlightCircle = new Graphic({
        geometry: g.geometry,
        symbol: { type: "simple-marker", style:"circle", color:[0,0,0,0], size:"50px", outline:{ color:[0,200,255,1], width:4 } }
      });
      cctvLayer.add(cctvHighlightCircle);

      g.symbol = { type:"picture-marker", url:"https://cdn-icons-png.flaticon.com/512/3583/3583045.png", width:"45px", height:"45px" };
      cctvHighlightedGraphic = g;

      view.goTo({ center:[g.geometry.longitude, g.geometry.latitude], tilt:50, zoom:15 });
    }
  }

  // --- é¢æ¿äº‹ä»¶ ---
  cctvToggleBtn.addEventListener("click", async () => {
    // äº¤é€šé—œé–‰æ™‚ä¸åšäº‹
    if (document.body.classList.contains("map-only")) return;

    try {
      await cctvInit();
    } catch (e) {
      console.error(e);
      alert("CCTV åˆå§‹åŒ–å¤±æ•—ï¼ˆTDX Token æˆ–è³‡æ–™å–å¾—å¤±æ•—ï¼‰");
      return;
    }

    const opening = (cctvPanel.style.display === "none" || cctvPanel.style.display === "");
    if (opening) {
      cctvPanel.style.display = "flex";

      // ç¬¬ä¸€æ¬¡æ‰åŠ é»
      if (!cctvGraphicsAdded) {
        cctvGraphicsArr.forEach(g => cctvLayer.add(g));
        cctvGraphicsAdded = true;
      }

      cctvLayer.visible = true;
      cctvLayerToggleSwitch.checked = true;
    } else {
      cctvClosePanelAndLayer();
    }
  });

  cctvLayerToggleSwitch.addEventListener("change", () => {
    cctvLayer.visible = cctvLayerToggleSwitch.checked;
  });

  cctvBackBtn.addEventListener("click", () => {
    cctvButtonsContainer.style.display = "block";
    cctvVideoContainer.innerHTML = "";
    cctvBackBtn.style.display = "none";
  });

  // å€åŸŸåˆ‡æ› â†’ æ›´æ–°é“è·¯
  cctvAreaSelect.addEventListener("change", () => {
    const area = cctvAreaSelect.value;
    cctvRoadSelect.innerHTML = '<option value="">è«‹é¸æ“‡é“è·¯</option>';
    cctvIdSelect.innerHTML = '<option value="">è«‹é¸æ“‡ CCTV ID</option>';
    cctvIdSelect.disabled = true;
    cctvButtonsContainer.innerHTML = "";
    cctvVideoContainer.innerHTML = "";
    cctvBackBtn.style.display = "none";
    cctvCurrent = null;

    if (!area) {
      const allRoads = [...new Set(cctvData.map(c => (c.RoadName || c.Road || "").trim()).filter(Boolean))].sort();
      if (allRoads.length > 0) {
        const allOpt = document.createElement("option");
        allOpt.value = "ALL";
        allOpt.textContent = "æ‰€æœ‰é“è·¯ï¼ˆæ¡ƒåœ’å¸‚ï¼‰";
        cctvRoadSelect.appendChild(allOpt);
      }
      allRoads.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        cctvRoadSelect.appendChild(opt);
      });
      return;
    }

    const polygon = cctvTaoyuanAreas[area];
    if (!polygon) return;

    const roadsInArea = [...new Set(cctvData
      .filter(c => {
        const lat = parseFloat(c.PositionLat);
        const lon = parseFloat(c.PositionLon);
        const pt = new Point({ latitude: lat, longitude: lon });
        return geometryEngine.contains(polygon, pt);
      })
      .map(c => (c.RoadName || c.Road || "").trim())
      .filter(Boolean)
    )].sort();

    if (roadsInArea.length > 0) {
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = "æ‰€æœ‰é“è·¯ï¼ˆ" + area + "ï¼‰";
      cctvRoadSelect.appendChild(allOpt);
    }

    roadsInArea.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      cctvRoadSelect.appendChild(opt);
    });
  });

  // é“è·¯åˆ‡æ› â†’ æ›´æ–° ID / ç”ŸæˆæŒ‰éˆ•
  cctvRoadSelect.addEventListener("change", () => {
    const selectedRoad = cctvRoadSelect.value;
    const selectedArea = cctvAreaSelect.value;

    cctvIdSelect.innerHTML = '<option value="">è«‹é¸æ“‡ CCTV ID</option>';
    cctvVideoContainer.innerHTML = "";
    cctvButtonsContainer.innerHTML = "";
    cctvBackBtn.style.display = "none";
    cctvCurrent = null;

    if (!selectedRoad) { cctvIdSelect.disabled = true; return; }

    let list = [];
    if (selectedRoad === "ALL") {
      list = selectedArea ? cctvData.filter(c => {
        const pt = new Point({ latitude:parseFloat(c.PositionLat), longitude:parseFloat(c.PositionLon) });
        return geometryEngine.contains(cctvTaoyuanAreas[selectedArea], pt);
      }) : cctvData;
    } else {
      list = cctvData.filter(c => {
        const roadMatch = (c.RoadName || c.Road || "").trim() === selectedRoad;
        if (!selectedArea) return roadMatch;
        const pt = new Point({ latitude:parseFloat(c.PositionLat), longitude:parseFloat(c.PositionLon) });
        return roadMatch && geometryEngine.contains(cctvTaoyuanAreas[selectedArea], pt);
      });
    }

    list.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.CCTVID;
      opt.textContent = c.CCTVID;
      cctvIdSelect.appendChild(opt);
    });
    cctvIdSelect.disabled = list.length === 0;

    if (selectedRoad === "ALL") {
      cctvButtonsContainer.innerHTML = "";
      const roads = [...new Set(list.map(c => (c.RoadName || c.Road || "").trim()).filter(Boolean))].sort();

      roads.forEach(road => {
        const div = document.createElement("div");
        div.style.marginBottom = "8px";

        const title = document.createElement("div");
        title.textContent = road;
        title.style.fontWeight = "700";
        title.style.marginBottom = "4px";
        div.appendChild(title);

        list.filter(c => (c.RoadName || c.Road || "").trim() === road).forEach(c => {
          const btn = document.createElement("button");
          btn.textContent = c.CCTVID;
          btn.addEventListener("click", () => {
            cctvShowInPanel(c);
            cctvButtonsContainer.style.display = "none";
            cctvBackBtn.style.display = "block";
          });
          div.appendChild(btn);
        });

        cctvButtonsContainer.appendChild(div);
      });

      cctvButtonsContainer.style.display = "block";
    } else {
      cctvButtonsContainer.style.display = "none";
    }
  });

  cctvIdSelect.addEventListener("change", () => {
    const c = cctvData.find(x => x.CCTVID === cctvIdSelect.value);
    if (c) cctvShowInPanel(c);
    else { cctvVideoContainer.innerHTML = ""; cctvCurrent = null; }
  });

  // é»åœ°åœ–é»ä½ â†’ æ‰“é–‹é¢æ¿é¡¯ç¤º
  view.on("click", async (event) => {
    if (document.body.classList.contains("map-only")) return;
    if (!cctvGraphicsAdded) return; // é‚„æ²’è¼‰å…¥/é‚„æ²’åŠ å…¥åœ–å±¤

    const hit = await view.hitTest(event);
    const g = hit.results.find(r => r.graphic && cctvGraphicsArr.includes(r.graphic))?.graphic;
    if (!g) return;

    const cctv = cctvData.find(c => c.CCTVID === g.attributes.CCTVID);
    if (cctv) g.attributes.City = cctv.City;

    cctvShowInPanel(g.attributes);
    cctvPanel.style.display = "flex";
    cctvLayer.visible = true;
    cctvLayerToggleSwitch.checked = true;

    view.goTo({ center: [g.geometry.longitude, g.geometry.latitude], tilt: 65, zoom: 20 }, { duration: 900, easing: "in-out-expo" });
  });
    
  // âœ… å¼·åˆ¶å¥—ç”¨åˆå§‹è¦–è§’ï¼ˆé¿å…å…¶ä»–åˆå§‹åŒ–æµç¨‹æŠŠè¦–è§’å¸¶èµ°ï¼‰
  view.when(() => {
    try { view.goTo(initialCamera, { duration: 0 }); } catch(e){}
  });

/* =========================
   âœ… äººå£çµ±è¨ˆï¼ˆæ•´åˆç‰ˆï¼‰ï¼šæ²¿ç”¨åŸäººå£çµ±è¨ˆ.html çš„ UI/åœ–è¡¨é‚è¼¯
   - åªåœ¨äº¤é€šé—œé–‰(map-only)æ™‚é¡¯ç¤ºï¼ˆCSS æ§åˆ¶ï¼‰
   - å…±ç”¨ test.html æ—¢æœ‰çš„ view / geojsonLayerï¼ˆä¸å†å»ºç«‹ç¬¬äºŒå€‹ Map/SceneViewï¼‰
   ========================= */
function initPopulationStats(view, geojsonLayer){
  const __isMapOnly = () => document.body.classList.contains('map-only');
const years = ['105','106','107','108','109','110','111','112','113'];
  const yearKeys = ['P5_CNT','P6_CNT','P7_CNT','P8_CNT','P9_CNT','P_10_CNT','P_11_CNT','P_12_CNT','P_13_CNT'];
  const houseKeys = ['H5_CNT','H6_CNT','H7_CNT','H8_CNT','H9_CNT','H_10_CNT','H_11_CNT','H_12_CNT','H_13_CNT'];
  const maleKeys = ['M5_CNT','M6_CNT','M7_CNT','M8_CNT','M9_CNT','M_10_CNT','M_11_CNT','M_12_CNT','M_13_CNT'];
  const femaleKeys = ['F5_CNT','F6_CNT','F7_CNT','F8_CNT','F9_CNT','F_10_CNT','F_11_CNT','F_12_CNT','F_13_CNT'];
const populationChart = new Chart(document.getElementById('populationChart').getContext('2d'), {
  type: 'line',
  data: {
    labels: years,
    datasets: [{
      label: 'äººå£æ•¸',
      data: [],
      borderColor: '#ffffff',
      backgroundColor: 'rgba(255,255,255,0.3)',
      fill: true,
      tension: 0.3,
      pointStyle: 'circle',
      pointRadius: 6,
      pointHoverRadius: 8,
      pointBackgroundColor: '#ffffff',
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    }]
  },
  options: {
    responsive: true,
    layout: {
      padding: {
        left: 10,
        right: 10,
        top: 0,
        bottom: 20
      }
    },
    plugins: {
      tooltip: { enabled: true, mode: 'index', intersect: false }, legend: {labels: { color: '#ffffff',fort:{size:12}}}
    },
    scales: {
      x: {
        title: {
          display: true,
          text: 'å¹´ä»½',
          color: '#ffffff',      // è»¸åé¡è‰²
          font: { size: 12 }     // è»¸åå­—é«”å¤§å°
        },
        ticks: {
          color: '#ffffff',
          padding: 5
        },
        grid: { color: 'rgba(255,255,255,0.12)', drawTicks: true, drawBorder: false }
      },
      y: {
        title: {
          display: true,
          text: 'äººå£æ•¸',
          color: '#ffffff',
          font: { size: 12 }
        },
        beginAtZero: true,
        ticks: { color: '#ffffff', padding: 5 },
        grid: { color: 'rgba(255,255,255,0.12)', drawBorder: false }
      }
    }
  }
});

  function createLineChart(ctx,label,color){
    return new Chart(ctx,{
      type:'line',
      data:{labels:years,datasets:[{
        label:label,
        data:[],
        borderColor:color,
        backgroundColor:color+'33',
        fill:true,
        tension:0.3,
        pointStyle:'circle',
        pointRadius:5,
        pointHoverRadius:7,
        pointBackgroundColor:color,
        pointBorderColor:'#fff',
        pointBorderWidth:2
      }]},
      options:{
        responsive:true,
        plugins:{
          tooltip:{enabled:true, mode:'index', intersect:false}
        },
        scales:{y:{beginAtZero:true}}
      }
    });
  }

  const chartPop = createLineChart(document.getElementById('chartPop').getContext('2d'),'äººå£','#00ffff' );
  const chartHouse = createLineChart(document.getElementById('chartHouse').getContext('2d'),'æˆ¶æ•¸','#ff00ff');
  const chartMale = createLineChart(document.getElementById('chartMale').getContext('2d'),'ç”·æ€§','#00ff00');
  const chartFemale = createLineChart(document.getElementById('chartFemale').getContext('2d'),'å¥³æ€§','#ff8800');

  const chartPie = new Chart(document.getElementById('chartPie').getContext('2d'),{
    type:'pie',
    data:{labels:['ç”·æ€§','å¥³æ€§'],datasets:[{data:[0,0],backgroundColor:['rgba(135,206,250,1)','rgba(255,182,193,1)'],borderColor:'#0ff',borderWidth:2}]},
    options:{responsive:true, plugins:{legend:{position:'bottom',labels:{color:'#00ffff', font:{size:12}}}}}
  });

  
  // (å·²æ•´åˆåˆ° test.htmlï¼šgeojsonLayer èˆ‡ view å·²å­˜åœ¨)
geojsonLayer.when(()=>{
    geojsonLayer.queryExtent().then(extent=>{ if(__isMapOnly()) view.goTo(extent.extent); });
    geojsonLayer.queryFeatures({outFields:["*"]}).then(res=>{
      if(res.features.length>0){
        updateCharts(res.features[0]);
        // âœ… å–æ¶ˆã€Œåˆå§‹åŒ–è‡ªå‹•åˆ‡åˆ°ç¬¬ä¸€å€‹æœ€å°çµ±è¨ˆå€ã€ï¼šé¿å…å°é¢æ¿ä¸€é–‹å§‹ä¸æ˜¯ç¸½å’Œ

        // updatePopulationChart(res.features[0]);
}
    });
  });

  view.on("click",function(event){
    if(!__isMapOnly()) return;
    // ğŸš« æœ€å°çµ±è¨ˆå€æœªé–‹å•Ÿæ™‚ï¼Œé»åœ°åœ–ä¸æ›´æ–°äººå£çµ±è¨ˆå°é¢æ¿
    if(!(geojsonLayer && geojsonLayer.visible)) return;
    geojsonLayer.queryFeatures({geometry:event.mapPoint,spatialRelationship:"intersects",outFields:["*"]}).then(res=>{
      if(res.features.length>0){
        const f=res.features[0];
        updateCharts(f);
        updatePopulationChart(f);
      }
    });
  });

  const chartContainer = document.getElementById('chartContainer');
  const detailPanel = document.getElementById('detailPanel');
  const detailTitle = document.getElementById('detailTitle');

 function updatePopulationChart(feature){
  currentFeature = feature;

  // æ›´æ–°å°é¢æ¿æŠ˜ç·šåœ–è³‡æ–™
  populationChart.data.datasets[0].data = yearKeys.map(k => feature.attributes[k] || 0);
  populationChart.update();

  // æ›´æ–°å°é¢æ¿æ¨™é¡Œé¡¯ç¤º CODE1
  const smallPanelTitle = document.getElementById('smallPanelTitle');
  smallPanelTitle.textContent = (feature.attributes.CODE1 || "é¸å–å€åŸŸ") + " äººå£æŠ˜ç·šåœ– (105~113å¹´)";
}

function updatePopulationChartTotal(features){
  // æ¯ä¸€å¹´éƒ½å…ˆæ­¸é›¶
  const totalData = yearKeys.map(()=>0);

  features.forEach(f=>{
    yearKeys.forEach((k, i)=>{
      totalData[i] += f.attributes[k] || 0;
    });
  });

  // æ›´æ–°å°é¢æ¿æŠ˜ç·šåœ–
  populationChart.data.datasets[0].data = totalData;
  populationChart.update();

  // æ›´æ–°å°é¢æ¿æ¨™é¡Œ
  const smallPanelTitle = document.getElementById('smallPanelTitle');
  smallPanelTitle.textContent = "å°æªœæºªé‡åŠƒå€-äººå£ç¸½æ•¸æŠ˜ç·šåœ– (105~113å¹´)";

  // âš ï¸ é€™è£¡åˆ»æ„ä¸è¨­å®š currentFeature
  currentFeature = null;
}

let allFeatures = [];

// GeoJSON Layer åˆå§‹è¼‰å…¥ç¬¬ä¸€å€‹ polygon
// GeoJSON Layer åˆå§‹è¼‰å…¥
geojsonLayer.when(() => {
    geojsonLayer.queryFeatures({outFields:["*"]}).then(res => {
        if(res.features.length>0){
            allFeatures = res.features;             // âš ï¸ ç¢ºä¿åˆå§‹åŒ–
            buildAreaList(allFeatures);
            updatePopulationChartTotal(allFeatures); // å°é¢æ¿ç¸½åˆ
            // åˆå§‹ä¸é¡¯ç¤ºå¤§é¢æ¿ï¼Œç­‰å°é¢æ¿é»æ“Š
        }
    });
});

// å°é¢æ¿é»æ“Š
chartContainer.addEventListener('click', () => {
    if(allFeatures.length === 0) return; // å°šæœªè¼‰å…¥
    if(currentFeature){ 
        updateDetailPanelSingle(currentFeature);
    } else {
        updateDetailPanelTotal(allFeatures, true); // ç¸½åˆæ¨¡å¼
    }
});


  // æ›´æ–°æŠ˜ç·šåœ–è³‡æ–™ä¸¦åŠ å…¥éœ“è™¹å…‰æšˆå‹•ç•«
function updateCharts(feature){
  currentFeature = feature;
  const attr = feature.attributes;

  // æ›´æ–°æ•¸æ“š
  chartPop.data.datasets[0].data = yearKeys.map(k=>attr[k]||0);
  chartHouse.data.datasets[0].data = houseKeys.map(k=>attr[k]||0);
  chartMale.data.datasets[0].data = maleKeys.map(k=>attr[k]||0);
  chartFemale.data.datasets[0].data = femaleKeys.map(k=>attr[k]||0);

  const maleTotal = maleKeys.reduce((sum,k)=>sum+(attr[k]||0),0);
  const femaleTotal = femaleKeys.reduce((sum,k)=>sum+(attr[k]||0),0);
  chartPie.data.datasets[0].data = [maleTotal, femaleTotal];

  // åˆ·æ–°æŠ˜ç·šåœ–å‹•ç•«
  [chartPop, chartHouse, chartMale, chartFemale].forEach(chart=>{
    chart.options.animation = {duration: 800, easing: 'easeInOutQuad'};
    chart.update();
  });

  // åˆ·æ–°åœ“é¤…åœ–å‹•ç•«
  chartPie.options.animation = {animateRotate:true, animateScale:true, duration:1000};
  chartPie.update();

  // é–ƒçˆå…‰æšˆæ•ˆæœ (åˆ©ç”¨CSS filter)
  const glowCharts = document.querySelectorAll('.chart-block canvas, #pieContainer canvas');
  glowCharts.forEach(c=>{
    c.style.transition = 'filter 0.5s ease-in-out';
    c.style.filter = 'drop-shadow(0 0 10px #00ffff)';
    setTimeout(()=>c.style.filter='drop-shadow(0 0 20px #00ffff)',500);
  });

  updateTrendTexts(
    yearKeys.map(k=>feature.attributes[k]||0),
    houseKeys.map(k=>feature.attributes[k]||0),
    maleKeys.map(k=>feature.attributes[k]||0),
    femaleKeys.map(k=>feature.attributes[k]||0)
);}

// å¤§é¢æ¿æ·¡å…¥æ·¡å‡º
function showDetailPanel(){
  detailPanel.style.display='block';
  detailPanel.style.opacity=0;
  let opacity=0;
  const fadeIn = setInterval(()=>{
    opacity+=0.05;
    detailPanel.style.opacity = opacity;
    if(opacity>=1) clearInterval(fadeIn);
  },20);
}

function hideDetailPanel(){
  let opacity=1;
  const fadeOut = setInterval(()=>{
    opacity-=0.05;
    detailPanel.style.opacity = opacity;
    if(opacity<=0){
      clearInterval(fadeOut);
      detailPanel.style.display='none';
    }
  },20);
}

// é»åœ°åœ–ç©ºç™½è™•é—œé–‰å¤§é¢æ¿
view.on("click", function(event){

  // ğŸš« æœ€å°çµ±è¨ˆå€é—œé–‰æ™‚ï¼Œåœ°åœ–é»æ“Šä¸å½±éŸ¿å°é¢æ¿
  if (!isMinZoneEnabled) return;

  geojsonLayer.queryFeatures({
    geometry: event.mapPoint,
    spatialRelationship: "intersects",
    outFields: ["*"]
  }).then(result => {
    if(result.features.length > 0){
      const feature = result.features[0];
      currentFeature = feature;        // è¨˜éŒ„å–®å€é¸å–
      updatePopulationChart(feature);  // å°é¢æ¿åŒæ­¥
    } else {
      currentFeature = null;           // é»ç©ºç™½ â†’ å›åˆ°ç¸½åˆæ¨¡å¼
      updatePopulationChartTotal(allFeatures); // å°é¢æ¿é¡¯ç¤ºç¸½åˆ
      detailPanel.style.display = 'none';
    }
  });
});

/* ================= æœå°‹å¼ä¸‹æ‹‰ï¼ˆä¸å½±éŸ¿æ—¢æœ‰åŠŸèƒ½ï¼‰ ================= */

const areaSearch = document.getElementById('areaSearch');
const areaList   = document.getElementById('areaList');

// å»ºç«‹æ¸…å–®
function buildAreaList(features){
  areaList.innerHTML = '';
  features.forEach((f, i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = f.attributes.CODE1 || `å€åŸŸ ${i+1}`;
    areaList.appendChild(opt);
  });
  areaList._features = features; // æš«å­˜ç›®å‰é¡¯ç¤ºæ¸…å–®
}

// å³æ™‚æœå°‹
areaSearch.addEventListener('input', ()=>{
  const keyword = areaSearch.value.toLowerCase();
  const filtered = allFeatures.filter(f =>
    (f.attributes.CODE1 || '').toLowerCase().includes(keyword)
  );
  buildAreaList(filtered);
  areaList.style.display = 'block'; // â­ è£œé€™è¡Œ
});

areaSearch.addEventListener('focus', () => {
  areaList.style.display = 'block';
});

// é¸å–å¾Œ â†’ å‘¼å«ä½ åŸæœ¬çš„æ›´æ–°å‡½å¼
areaList.addEventListener('change', ()=>{
  const idx = areaList.selectedIndex;
  const feature = areaList._features[idx];
  if(feature){
    updateCharts(feature);
    updatePopulationChart(feature);
    detailTitle.textContent = "æœ€å°çµ±è¨ˆå€ï¼š" + (feature.attributes.CODE1 || "");
    detailPanel.style.display = 'block';
    areaList.style.display = 'none';   // â­ åŠ é€™è¡Œ
  }
});

detailPanel.addEventListener('click', e => {
  if (!e.target.closest('#areaSearchBox')) {
    areaList.style.display = 'none';
  }
});

  let panelMode = "total"; // "total" æˆ– "single"

  function updateDetailPanelTotal(features, noAnimation=false){
    panelMode = "total";

    // ç´¯åŠ å„å¹´åº¦æ•¸æ“š
    const totalData = yearKeys.map(()=>0);
    const totalHouse = houseKeys.map(()=>0);
    const totalMale = maleKeys.map(()=>0);
    const totalFemale = femaleKeys.map(()=>0);

    features.forEach(f=>{
        yearKeys.forEach((k,i)=>{ totalData[i] += f.attributes[k]||0; });
        houseKeys.forEach((k,i)=>{ totalHouse[i] += f.attributes[k]||0; });
        maleKeys.forEach((k,i)=>{ totalMale[i] += f.attributes[k]||0; });
        femaleKeys.forEach((k,i)=>{ totalFemale[i] += f.attributes[k]||0; });
    });

    // æ›´æ–°æŠ˜ç·šåœ–è³‡æ–™
    chartPop.data.datasets[0].data = totalData;
    chartHouse.data.datasets[0].data = totalHouse;
    chartMale.data.datasets[0].data = totalMale;
    chartFemale.data.datasets[0].data = totalFemale;

    // æ›´æ–°åœ“é¤…åœ–è³‡æ–™
    chartPie.data.datasets[0].data = [totalMale.reduce((a,b)=>a+b,0), totalFemale.reduce((a,b)=>a+b,0)];

    // æ›´æ–°åœ–è¡¨
    [chartPop, chartHouse, chartMale, chartFemale].forEach(c=>c.update());
    chartPie.update();

    // æ›´æ–°å¤§é¢æ¿æ¨™é¡Œ
    detailTitle.textContent = "å°æªœæºªé‡åŠƒå€äººå£ç¸½åˆçµ±è¨ˆ";

    updateTrendTexts(totalData, totalHouse, totalMale, totalFemale);

    currentFeature = null;

    // æ§åˆ¶æ˜¯å¦å‹•ç•«
    if(noAnimation){
        detailPanel.style.display='block';
        detailPanel.style.opacity = 1;
    } else {
        showDetailPanel();
    }
}

function updateDetailPanelSingle(feature){
  if(!feature) return;
  currentFeature = feature;
  updateCharts(feature);
  try{ updatePopulationChart(feature); }catch(e){}
  detailTitle.textContent = "æœ€å°çµ±è¨ˆå€ï¼š" + (feature.attributes.CODE1 || "");
  detailPanel.style.display = 'block';
}

document.getElementById("btnTotal").onclick = ()=>{ 
    updateDetailPanelTotal(allFeatures, true); // âœ… ä¸æ·¡å…¥å‹•ç•«
    try{ updatePopulationChartTotal(allFeatures); }catch(e){}
};

function generateSingleTrendText(data){
    const nYears = data.length - 1;
    const diff = data[data.length-1] - data[0];
    const percent = data[0] && nYears>0 ? ((diff / data[0]) / nYears * 100).toFixed(1) : 0;
    if(diff > 0) return `é€å¹´å¢é•·ï¼Œå¹³å‡å¢å¹…ç´„ ${percent}%`;
    else if(diff < 0) return `é€å¹´ä¸‹é™ï¼Œå¹³å‡é™å¹…ç´„ ${Math.abs(percent)}%`;
    else return 'ç¶­æŒç©©å®š';
}

function generatePieTrendText(maleTotal, femaleTotal){
    if(maleTotal === femaleTotal) return 'ç”·å¥³æ¯”ä¾‹å‡è¡¡';
    return maleTotal > femaleTotal ? 'ç”·æ€§ç•¥å¤šæ–¼å¥³æ€§' : 'å¥³æ€§ç•¥å¤šæ–¼ç”·æ€§';
}

function updateTrendTexts(popData, houseData, maleData, femaleData){
    document.getElementById('trendPop').textContent = generateSingleTrendText(popData);
    document.getElementById('trendHouse').textContent = generateSingleTrendText(houseData);
    document.getElementById('trendMale').textContent = generateSingleTrendText(maleData);
    document.getElementById('trendFemale').textContent = generateSingleTrendText(femaleData);

    const maleTotal = maleData.reduce((a,b)=>a+b,0);
    const femaleTotal = femaleData.reduce((a,b)=>a+b,0);
    document.getElementById('trendPie').textContent = generatePieTrendText(maleTotal,femaleTotal);
}
}


// âœ… ç¢ºä¿æœ€å°çµ±è¨ˆå€åœ–å±¤æœ‰åŠ å…¥ mapï¼Œæ‰æœƒè¼‰å…¥è³‡æ–™
if (geojsonLayer && map && !map.layers.includes(geojsonLayer)) {
  map.add(geojsonLayer);
// âœ… æœ€å°çµ±è¨ˆå€åœ–å±¤ï¼šé è¨­é—œé–‰ï¼ˆä½ è¦ä¸€é–‹å§‹å…ˆé—œï¼‰
geojsonLayer.visible = false;
const toggleLayerBtn = document.getElementById("toggleLayerBtn");
if(toggleLayerBtn){
  toggleLayerBtn.textContent = "é–‹å•Ÿæœ€å°çµ±è¨ˆå€";
  toggleLayerBtn.addEventListener("click", (evt) => {
    evt.stopPropagation();
    geojsonLayer.visible = !geojsonLayer.visible;
        isMinZoneEnabled = !!geojsonLayer.visible;
toggleLayerBtn.textContent = geojsonLayer.visible ? "é—œé–‰æœ€å°çµ±è¨ˆå€" : "é–‹å•Ÿæœ€å°çµ±è¨ˆå€";
  });
}

}
// âœ… äººå£çµ±è¨ˆåˆå§‹åŒ–ï¼ˆåªåšä¸€æ¬¡ï¼‰
view.when(() => {
  if (!window.__popStatsInited) {
    window.__popStatsInited = true;
    try { initPopulationStats(view, geojsonLayer); } catch(e){ console.error("äººå£çµ±è¨ˆåˆå§‹åŒ–å¤±æ•—", e); }
  }
});
    // ==============================
    // âœ… å­¸æ ¡ç†±å€ï¼ˆç©©å®šç‰ˆï¼‰ï¼šå…¨åŸŸå·¥å…·
    // - å¾å…¬å…±è¨­æ–½(å­¸æ ¡)æŠ½å‡ºå­¸æ ¡é»ä½åœ–å±¤
    // - æä¾› 10 åˆ†é˜æ­¥è¡Œ(ORS) ç­‰æ™‚åœˆè¨ˆç®— + åˆ†æ‰¹è¨ˆç®—æ’è¡Œæ¦œ
    // ==============================
    window.__schools = [];            // { name, geometryWM, lon, lat, graphic }
    window.__schoolLayer = null;      // GraphicsLayer
    window.__schoolIsoLayer = null;   // GraphicsLayer (é¡¯ç¤ºå–®ä¸€å­¸æ ¡ 10 åˆ†é˜ç¯„åœ)
    window.__schoolIsoCache = new Map(); // key -> { polyWM, areaKm2 }

    window.schoolSymbolByCount = function(count){
      let color = [34,197,94,0.95];        // ç¶ 
      if (count >= 5) color = [239,68,68,0.95];      // ç´…
      else if (count >= 2) color = [234,179,8,0.95]; // é»ƒ
      return {
        type: "simple-marker",
        style: "circle",
        color,
        size: 10,
        outline: { color: [255,255,255,0.85], width: 1 }
      };
    };

    window.ensureSchoolLayer = function(){
      if (window.__schoolLayer) return window.__schoolLayer;
      window.__schoolLayer = new GraphicsLayer({ title: "å­¸æ ¡é»ä½", visible: false });
      map.add(window.__schoolLayer);
      return window.__schoolLayer;
    };

    window.ensureSchoolIsoLayer = function(){
      if (window.__schoolIsoLayer) return window.__schoolIsoLayer;
      window.__schoolIsoLayer = new GraphicsLayer({ title: "å­¸æ ¡10åˆ†é˜ç¯„åœ", visible: true });
      map.add(window.__schoolIsoLayer);
      return window.__schoolIsoLayer;
    };

window.ensureSchoolHighlightLayer = function(){
  if (window.__schoolHighlightLayer) return window.__schoolHighlightLayer;
  window.__schoolHighlightLayer = new GraphicsLayer({ title: "å­¸æ ¡ç†±å€æ¨™è¨˜", visible: true });
  map.add(window.__schoolHighlightLayer);
  return window.__schoolHighlightLayer;
};

window.ensureSchoolSelectedLayer = function(){
  if (window.__schoolSelectedLayer) return window.__schoolSelectedLayer;
  window.__schoolSelectedLayer = new GraphicsLayer({ title: "é¸å–å­¸æ ¡æ¨™è¨˜", visible: true });
  map.add(window.__schoolSelectedLayer);
  return window.__schoolSelectedLayer;
};


    function __registerSchoolFromFacilityGraphic(g){
      try{
        if(!g || !g.attributes) return;
        const t = String(g.attributes.type || g.attributes.TYPE || "");
        if(t !== "å­¸æ ¡") return;

        const geo = webMercatorUtils.webMercatorToGeographic(g.geometry);
        const lon = geo.longitude, lat = geo.latitude;
        const name = String(g.attributes.name || g.attributes.NAME || g.attributes.åç¨± || "å­¸æ ¡");
        window.__schools.push({ name, geometryWM: g.geometry, lon, lat, graphic: null });
      }catch(e){}
    }

    // è®“å¾Œé¢è¼‰å…¥å…¬å…±è¨­æ–½æ™‚å¯ä»¥å‘¼å«
    window.__registerSchoolFromFacilityGraphic = __registerSchoolFromFacilityGraphic;

  const fieldNames = {
  section: "æ®µå°æ®µ",
  dno: "åœ°è™Ÿ",
  price: "å…¬å‘Šåœ°",
  value: "å…¬å‘Šç¾",
  area: "real_area"
  };
  const parcelLayer = new FeatureLayer({
  url: "https://services5.arcgis.com/yqmzFsAzBUNEIWLw/arcgis/rest/services/å°æªœæºª_åœ°è™Ÿ/FeatureServer/0",
  outFields: ["*"],
  visible: false,                 // é è¨­ä¸é¡¯ç¤º
  elevationInfo: { mode: "on-the-ground" }
  });

  map.add(parcelLayer);

  /* ========= YouBike / EV / åœè»Šå ´ åœ–å±¤ ========= */
  const youBikeLayer = new GraphicsLayer({ visible: false });
  const evLayer = new GraphicsLayer({ visible: false });
  const parkingLayer = new GraphicsLayer({ visible: false });
  map.addMany([youBikeLayer, evLayer, parkingLayer]);

  const yToggleTop = document.getElementById("yTogglePointsTop");
  const evToggleTop = document.getElementById("evTogglePointsTop");
  const pToggleTop = document.getElementById("pTogglePointsTop");


  let currentMode = "youbike"; // "youbike" æˆ– "ev"

  
  // ====== perf helper: debounceï¼ˆä¸æ”¹åŠŸèƒ½ï¼Œåªæ¸›å°‘é€£çºŒé‡ç¹ªï¼‰ ======
  function __debounce(fn, wait){
    let t;
    return function(...args){
      clearTimeout(t);
      t = setTimeout(()=>fn.apply(this, args), wait);
    };
  }

/* ------------------ YouBike ------------------ */
  let youBikeGraphics = [];
  let highlightedYouBikeGraphic = null;
  let youBikeHaloInterval = null;
  let youBikeClickEnabled = true;
  let pauseYouBikeAutoScroll = false;
  let __ybAutoScrollTimer = null;

  async function loadYouBikeStations() {
    try {
      const token = await getYouBikeAccessToken();
      const headers = { "Authorization": `Bearer ${token}` };
      const stationRes = await fetch("https://tdx.transportdata.tw/api/basic/v2/Bike/Station/City/Taoyuan?$format=JSON", { headers });
      const availRes = await fetch("https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Taoyuan?$format=JSON", { headers });
      const stationJson = await stationRes.json();
      const stations = stationJson.Stations || stationJson || [];
      const availJson = await availRes.json();
      const availArr = availJson.BikeAvailabilities || availJson || [];
      const availMap = new Map();
      (Array.isArray(availArr) ? availArr : []).forEach(v=>{ if(v && v.StationID) availMap.set(v.StationID, v); });
      const ybBatch = [];

      stations.forEach(st => {
        const avail = availMap.get(st.StationID) || {};
        const rent = avail.AvailableRentBikes ?? 0;
        const ret = avail.AvailableReturnBikes ?? 0;
        const capacity = st.BikesCapacity ?? 0;

        let status = "æ­£å¸¸ç§Ÿå€Ÿ";
        if (capacity === 0 || (avail.AvailableRentBikes == null && avail.AvailableReturnBikes == null)) status = "æš«åœç‡Ÿé‹";
        else if (rent === 0 && ret > 0) status = "ç„¡è»Šå¯å€Ÿ";
        else if (ret === 0 && rent > 0) status = "è»Šä½å·²æ»¿";

        let iconUrl, haloColor;
        switch (status) {
          case "æ­£å¸¸ç§Ÿå€Ÿ": iconUrl = "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ­£å¸¸ç§Ÿå€Ÿ.png"; haloColor = [0, 200, 0, 0.3]; break;
          case "ç„¡è»Šå¯å€Ÿ": iconUrl = "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ç„¡è»Šå¯å€Ÿ.png"; haloColor = [255, 0, 0, 0.3]; break;
          case "è»Šä½å·²æ»¿": iconUrl = "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/è»Šä½å·²æ»¿.png"; haloColor = [255, 165, 0, 0.3]; break;
          case "æš«åœç‡Ÿé‹": iconUrl = "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æš«åœç‡Ÿé‹.png"; haloColor = [128, 128, 128, 0.3]; break;
        }

        const youBikeHalo = new Graphic({
          geometry: new Point({
            longitude: st.StationPosition.PositionLon,
            latitude: st.StationPosition.PositionLat,
            z: 0
          }),
          symbol: {
            type: "point-3d",
            symbolLayers: [{
              type: "object",
              width: 1, depth: 1, height: 1,
              material: { color: haloColor }, anchor: "center", offsetZ: -14
            }]
          },
          attributes: { type: "halo" }
        });

        const youBikeIcon = new Graphic({
          geometry: new Point({ longitude: st.StationPosition.PositionLon, latitude: st.StationPosition.PositionLat }),
          symbol: { type: "point-3d", symbolLayers: [{ type: "icon", resource: { href: iconUrl }, size: 28 }] },
          attributes: {
            id: st.StationID, name: st.StationName.Zh_tw, address: st.StationAddress.Zh_tw,
            capacity: st.BikesCapacity, rent: rent, ret: ret, status: status,
            haloGraphic: youBikeHalo, haloColor: haloColor
          }
        });

        ybBatch.push(youBikeHalo, youBikeIcon);
        youBikeGraphics.push(youBikeIcon);
      });

      // âœ… ä¸€æ¬¡æ€§åŠ å…¥åœ–å±¤ï¼ˆå¤§é‡é»ä½æ›´é †ï¼‰
      if (ybBatch.length) youBikeLayer.addMany(ybBatch);

      updateYouBikeList();
      startYouBikeAutoScroll();
    } catch (err) { console.error(err); }
  }

  function updateYouBikeList(filter = "") {
    const listInner = document.getElementById("yStationListInner");
    listInner.innerHTML = "";
    const frag = document.createDocumentFragment();
    const filtered = youBikeGraphics.filter(g => g.attributes.name.includes(filter))
      .sort((a, b) => b.attributes.rent - a.attributes.rent);
    filtered.forEach(g => {
      const item = document.createElement("div");
      item.className = "yStationItem";
      item.innerHTML = `<strong>${g.attributes.name}</strong><span>${g.attributes.status} | å¯å€Ÿ: ${g.attributes.rent} | å¯é‚„: ${g.attributes.ret}</span>`;
      item.onclick = () => flyToYouBikeStation(g);
      frag.appendChild(item);
    });
    listInner.appendChild(frag);
  }

  async function flyToYouBikeStation(g) {
    if (!youBikeClickEnabled || currentMode !== "youbike") return;
    await view.goTo({ center: g.geometry, zoom: 18, tilt: 65 }, { duration: 160 });
    showYouBikeInfo(g.attributes, g);
    highlightYouBikeStation(g);

    if (!youBikeLayer.visible) {
      youBikeLayer.visible = true;
      yToggleTop.checked = true;
    }
  }

  function resetYouBikeHighlightAndView() {
    if (youBikeHaloInterval) {
      clearInterval(youBikeHaloInterval);
      youBikeHaloInterval = null;
    }
    if (highlightedYouBikeGraphic) {
      const g = highlightedYouBikeGraphic;
      const halo = g.attributes.haloGraphic;
      const color = g.attributes.haloColor;
      if (halo) {
        halo.symbol = {
          type: "point-3d",
          symbolLayers: [{
            type: "object",
            width: 1, depth: 1, height: 1,
            material: { color: color }, anchor: "center", offsetZ: -14
          }]
        };
      }
      const iconLayer = g.symbol.symbolLayers.find(s => s.type === "icon");
      if (iconLayer) {
        g.symbol = {
          type: "point-3d",
          symbolLayers: [{ type: "icon", resource: iconLayer.resource, size: 28 }]
        };
      }
      highlightedYouBikeGraphic = null;
    }
    view.goTo(initialCamera, { duration: 200 });
  }

  function showYouBikeInfo(attr, g) {
    const youBikeInfoPanel = document.getElementById("infoPanel");
    youBikeInfoPanel.innerHTML = `<div id="infoPanelClose">âœ–</div><b>${attr.name}</b><br><br>åœ°å€ï¼š${attr.address}<br>ç‹€æ…‹ï¼š${attr.status}<br>å¯å€Ÿè»Šè¼›ï¼š${attr.rent}<br>å¯é‚„ç©ºä½ï¼š${attr.ret}<br>ç¸½å®¹é‡ï¼š${attr.capacity}`;
    youBikeInfoPanel.style.display = "block";
    document.getElementById("infoPanelClose").onclick = () => {
      youBikeInfoPanel.style.display = "none";
      resetYouBikeHighlightAndView();
    };
  }

  function highlightYouBikeStation(g) {
    if (youBikeHaloInterval) clearInterval(youBikeHaloInterval);

    if (highlightedYouBikeGraphic) {
      const prevHalo = highlightedYouBikeGraphic.attributes.haloGraphic;
      if (prevHalo) {
        prevHalo.symbol = { type: "point-3d", symbolLayers: [{ type: "object", width: 1, depth: 1, height: 1, material: { color: highlightedYouBikeGraphic.attributes.haloColor }, anchor: "center", offsetZ: -14 }] };
      }
      const prevIcon = highlightedYouBikeGraphic.symbol.symbolLayers.find(s => s.type === "icon");
      if (prevIcon) {
        highlightedYouBikeGraphic.symbol = { type: "point-3d", symbolLayers: [{ type: "icon", resource: prevIcon.resource, size: 28 }] };
      }
    }

    g.symbol = { type: "point-3d", symbolLayers: [{ type: "icon", resource: g.symbol.symbolLayers.find(s => s.type === "icon").resource, size: 50 }] };

    const halo = g.attributes.haloGraphic;
    const color = g.attributes.haloColor;
    if (halo) {
      let size = 40, growing = true;
      youBikeHaloInterval = __ybAutoScrollTimer = __evAutoScrollTimer = setInterval(() => {
        if (growing) { size += 2; if (size >= 80) growing = false; }
        else { size -= 2; if (size <= 40) growing = true; }
        halo.geometry = new Point({ longitude: g.geometry.longitude, latitude: g.geometry.latitude - 0.0004, z: 0 });
        halo.symbol = { type: "point-3d", symbolLayers: [{ type: "object", width: size, depth: size, height: 1, material: { color: color }, anchor: "center", offsetZ: -14 }] };
      }, 50);
    }

    highlightedYouBikeGraphic = g;
  }

  view.on("click", async (event) => {
    if (currentMode !== "youbike") return;
    const hit = await view.hitTest(event);
    if (hit.results.length && hit.results[0].graphic.layer === youBikeLayer) {
      const g = hit.results[0].graphic;
      if (g.attributes && g.attributes.id) flyToYouBikeStation(g);
    }
  });

  document.getElementById("ySearchBox").oninput = __debounce((e) => {
    if (currentMode !== "youbike") return;
    updateYouBikeList(e.target.value);
  }, 120);

  function startYouBikeAutoScroll() {
    if (__ybAutoScrollTimer) return; // âœ… é¿å…é‡è¤‡å»ºç«‹ interval

    const list = document.getElementById("yStationList");
    const listInner = document.getElementById("yStationListInner");

    __ybAutoScrollTimer = setInterval(() => {
      if (currentMode !== "youbike") return;
      if (pauseYouBikeAutoScroll) return;
      const maxScroll = listInner.scrollHeight - list.clientHeight;
      if (maxScroll <= 0) return;
      let next = list.scrollTop + 1;
      if (next > maxScroll + 5) next = 0;
      list.scrollTop = next;
    }, 40);
  }


// âœ… æ»‘é¼ ç§»åˆ° YouBike é¢æ¿/æ¸…å–®/è³‡è¨Šæ¡†ï¼šåœæ­¢è‡ªå‹•æ»‘å‹•ï¼›ç§»é–‹å†ç¹¼çºŒ
(function bindYouBikeAutoScrollPause(){
  const hoverTargets = [
    document.getElementById("yRightPanel"),
    document.getElementById("yStationList"),
    document.getElementById("infoPanel"),
    document.getElementById("modeToggleBtn") // å³å´åˆ‡æ›æŒ‰éˆ•ä¹Ÿç®—
  ].filter(Boolean);

  hoverTargets.forEach(el=>{
    el.addEventListener("mouseenter", ()=>{ pauseYouBikeAutoScroll = true; });
    el.addEventListener("mouseleave", ()=>{ pauseYouBikeAutoScroll = false; });
  });
})();
  const youBikeInfoPanelDom = document.getElementById("infoPanel");
  let youBikeDragging = false, startX, startY, startLeft, startTop;

  youBikeInfoPanelDom.addEventListener("mousedown", (e)=>{
    youBikeDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    startLeft = youBikeInfoPanelDom.offsetLeft;
    startTop = youBikeInfoPanelDom.offsetTop;
    youBikeInfoPanelDom.style.opacity = "0.8";
    e.preventDefault();
  });

  document.addEventListener("mousemove", (e)=>{
    if(youBikeDragging){
      let dx = e.clientX - startX;
      let dy = e.clientY - startY;
      youBikeInfoPanelDom.style.left = (startLeft + dx) + "px";
      youBikeInfoPanelDom.style.top = (startTop + dy) + "px";
      youBikeInfoPanelDom.style.transform = "none";
    }
  });

  document.addEventListener("mouseup", ()=>{
    if(youBikeDragging){
      youBikeDragging = false;
      youBikeInfoPanelDom.style.opacity = "1";
    }
  });

  /* ------------------ EV ------------------ */
  let chargingPointsData = {};
  let connectorsData = {};
  let stationGraphics = [];
  let highlightedEvGraphic = null;
  let evHaloInterval = null;
  let evLoaded = false;
  let pauseEvAutoScroll = false;

  async function loadChargingPoints(token) {
    const url = "https://tdx.transportdata.tw/api/basic/v1/EV/ChargingPoint/City/Taoyuan?$format=JSON";
    const res = await fetch(url, { headers: { "Authorization": "Bearer " + token } });
    const data = await res.json();
    data.ChargingPoints?.forEach(cp => {
      if (!chargingPointsData[cp.StationID]) chargingPointsData[cp.StationID] = [];
      chargingPointsData[cp.StationID].push(cp);
    });
  }

  async function loadConnectors(token) {
    const url = "https://tdx.transportdata.tw/api/basic/v1/EV/Connector/City/Taoyuan?$format=JSON";
    const res = await fetch(url, { headers: { "Authorization": "Bearer " + token } });
    const data = await res.json();
    data.Connectors?.forEach(c => {
      if (!connectorsData[c.StationID]) connectorsData[c.StationID] = [];
      connectorsData[c.StationID].push(c);
    });
  }

  async function loadEvData() {
    if (evLoaded) return;
    evLoaded = true;

    try {
      const token = await getTDXToken();
      await Promise.all([loadChargingPoints(token), loadConnectors(token)]);

      const res = await fetch("https://tdx.transportdata.tw/api/basic/v1/EV/Station/City/Taoyuan?$format=JSON", { headers: { "Authorization": "Bearer " + token } });
      const data = await res.json();
      const stations = data.Stations || data;

      stations.forEach(st => {
        if (!st.PositionLat || !st.PositionLon) return;
        const point = new Point({ longitude: st.PositionLon, latitude: st.PositionLat });

        const halo = new Graphic({
          geometry: new Point({ longitude: st.PositionLon, latitude: st.PositionLat }),
          symbol: {
            type: "point-3d",
            symbolLayers: [{
              type: "object",
              width: 40, depth: 40, height: 1,
              material: { color: [0, 255, 0, 0] },
              anchor: "center", offsetZ: -14
            }]
          }
        });

        let addr = (st.Location?.Address?.City || "") + (st.Location?.Address?.Town || "") + (st.Location?.Address?.Road || "") + (st.Location?.Address?.No || "");
        if (!addr || addr.trim() === "" || addr === "nullnullnull" || addr === "NaN") addr = st.Location?.Place?.POI || "ç„¡";
        if (addr && /\d$/.test(addr)) addr += "è™Ÿ";

        const iconG = new Graphic({
          geometry: point,
          symbol: { type: "point-3d", symbolLayers: [{ type: "icon", resource: { href: "https://cdn-icons-png.flaticon.com/512/7787/7787212.png" }, size: 28 }] },
          attributes: {
            id: st.StationID,
            name: st.StationName?.Zh_tw || "æœªå‘½å",
            address: addr || "ç„¡",
            telephone: st.Telephone || "ç„¡",
            serviceTime: st.ServiceTime || "ç„¡",
            parkingRate: st.ParkingRate || "ç„¡",
            chargingRate: st.ChargingRate || "ç„¡",
            spaces: st.Spaces || "ç„¡",
            connectors: st.Connectors?.map(c => `Type${c.Type} Ã— ${c.Quantity}`).join(", ") || "ç„¡",
            desc: st.Description || "ç„¡",
            haloGraphic: halo
          }
        });

        evLayer.addMany([halo, iconG]);
        stationGraphics.push(iconG);
      });

      updateEvList();
      startEvAutoScroll();
      fetchEvLiveStatus();
      setInterval(fetchEvLiveStatus, 60000);
    } catch (err) { console.error("è¼‰å…¥ EV ç«™é»éŒ¯èª¤", err); }
  }

  function updateEvList(filter = "") {
    const listInner = document.getElementById("evStationListInner");
    listInner.innerHTML = "";
    const filtered = stationGraphics.filter(g => g.attributes.name.includes(filter));
    filtered.forEach(g => {
      const item = document.createElement("div");
      item.className = "evStationItem";
      item.innerHTML = `<strong>${g.attributes.name}</strong><div class="connectorList" id="connector-${g.attributes.id}"></div>`;
      item.onclick = () => flyToEvStation(g);
      listInner.appendChild(item);
    });
    fetchEvLiveStatus();
  }

  async function flyToEvStation(g) {
    if (currentMode !== "ev") return;
    await view.goTo({ center: g.geometry, zoom: 18, tilt: 65 }, { duration: 160 });
    showEvInfo(g.attributes);
    highlightEvStation(g);

    if (!evLayer.visible) {
      evLayer.visible = true;
      evToggleTop.checked = true;
    }
  }

  function resetEvHighlightAndView() {
    if (evHaloInterval) {
      clearInterval(evHaloInterval);
      evHaloInterval = null;
    }
    if (highlightedEvGraphic) {
      const g = highlightedEvGraphic;
      const halo = g.attributes.haloGraphic;
      if (halo) {
        halo.symbol = {
          type: "point-3d",
          symbolLayers: [{
            type: "object",
            width: 40, depth: 40, height: 1,
            material: { color: [0, 255, 0, 0] }, anchor: "center", offsetZ: -14
          }]
        };
      }
      g.symbol = {
        type: "point-3d",
        symbolLayers: [{ type: "icon", resource: { href: "https://cdn-icons-png.flaticon.com/512/7787/7787212.png" }, size: 28 }]
      };
      highlightedEvGraphic = null;
    }
    view.goTo(initialCamera, { duration: 200 });
  }

  function showEvInfo(attr) {
    const box = document.getElementById("evInfoPanel");
    const content = document.getElementById("evInfoPanelContent");
    content.innerHTML = `
      <div class="infoLine"><span class="infoIcon">ğŸ·ï¸</span><span class="infoText"><b>${attr.name}</b></span></div>
      <div class="infoLine"><span class="infoIcon">ğŸ“</span><span class="infoText">${attr.address}</span></div>
      <div class="infoLine"><span class="infoIcon">â˜ï¸</span><span class="infoText">${attr.telephone}</span></div>
      <div class="infoLine"><span class="infoIcon">ğŸ•’</span><span class="infoText">æœå‹™æ™‚é–“ï¼š${attr.serviceTime}</span></div>
      <div class="infoLine"><span class="infoIcon">ğŸ…¿ï¸</span><span class="infoText">åœè»Šè²»ï¼š${attr.parkingRate}</span></div>
      <div class="infoLine"><span class="infoIcon">âš¡</span><span class="infoText">å……é›»è²»ç‡ï¼š${attr.chargingRate}</span></div>
      <div class="infoLine"><span class="infoIcon">ğŸš—</span><span class="infoText">è»Šä½æ•¸ï¼š${attr.spaces}</span></div>
      <div class="infoLine"><span class="infoIcon">ğŸ”Œ</span><span class="infoText">æ¥é ­ï¼š${attr.connectors}</span></div>
      <div class="infoButtons">
        <button id="showCPBtn">å……é›»æ¨è³‡è¨Š</button>
        <button id="showConnectorBtn">å……é›»æ§è³‡è¨Š</button>
      </div>
      <div id="cpDetails" style="display:none;"></div>
      <div id="connectorDetails" style="display:none;"></div>
    `;
    box.style.display = "block";

    document.getElementById("showCPBtn").onclick = () => {
      const cpDiv = document.getElementById("cpDetails");
      const connDiv = document.getElementById("connectorDetails");
      if (cpDiv.style.display === "block") cpDiv.style.display = "none";
      else { cpDiv.style.display = "block"; connDiv.style.display = "none"; showEvChargingPoints(attr); }
    };
    document.getElementById("showConnectorBtn").onclick = () => {
      const cpDiv = document.getElementById("cpDetails");
      const connDiv = document.getElementById("connectorDetails");
      if (connDiv.style.display === "block") connDiv.style.display = "none";
      else { connDiv.style.display = "block"; cpDiv.style.display = "none"; showEvConnectors(attr); }
    };
  }

  function showEvChargingPoints(attr) {
    const cpDiv = document.getElementById("cpDetails");
    cpDiv.innerHTML = "";
    const cps = chargingPointsData[attr.id] || [];
    if (cps.length === 0) { cpDiv.innerHTML = "ç„¡å……é›»æ¨è©³ç´°è³‡è¨Š"; return; }
    cps.forEach(cp => {
      const div = document.createElement("div"); div.style.marginBottom = "6px";
      const id = cp.ChargingPointID || "ç„¡"; const floor = cp.Floor || "ç„¡";
      const payment = cp.Payment && Object.keys(cp.Payment).length > 0 ? Object.keys(cp.Payment).filter(k => cp.Payment[k]).join(", ") || "ç„¡" : "ç„¡";
      const startType = cp.StartType && Object.keys(cp.StartType).length > 0 ? Object.keys(cp.StartType).filter(k => cp.StartType[k]).join(", ") || "ç„¡" : "ç„¡";
      div.innerHTML = `<b>å……é›»æ¨ID:</b> ${id}<br><b>æ¨“å±¤:</b> ${floor}<br><b>æ”¯ä»˜æ–¹å¼:</b> ${payment}<br><b>å•Ÿå‹•æ–¹å¼:</b> ${startType}`;
      cpDiv.appendChild(div);
    });
  }

  const connectorTypeMap = { 1: "CCS1", 2: "CCS2", 3: "CHAdeMO", 4: "Tesla TPC", 5: "J1772(Type1)", 6: "Mennekes(Type2)", 254: "Others", 255: "Unknown" };
  function showEvConnectors(attr) {
    const connDiv = document.getElementById("connectorDetails");
    connDiv.innerHTML = "";
    const conns = connectorsData[attr.id] || [];
    if (conns.length === 0) { connDiv.innerHTML = "ç„¡å……é›»æ§è³‡æ–™"; return; }
    conns.forEach(c => {
      const div = document.createElement("div"); div.style.marginBottom = "6px";
      const typeText = connectorTypeMap[c.Type] || c.Type || "ç„¡";
      div.innerHTML = `<b>å……é›»æ§IDï¼š</b>${c.ConnectorID || "ç„¡"}<br><b>é¡å‹ï¼š</b>${c.Type} (${typeText})<br><b>é›»å£“ï¼š</b>${c.Voltage || "ç„¡"}<br><b>é¡å®šé›»æµï¼š</b>${c.CurrentRating || "ç„¡"}<br><b>é¡å®šåŠŸç‡ï¼š</b>${c.PowerRating || "ç„¡"}<br><b>æ¨“å±¤ï¼š</b>${c.Floor || "ç„¡"}`;
      connDiv.appendChild(div);
    });
  }

  document.getElementById("evInfoPanelClose").onclick = () => {
    document.getElementById("evInfoPanel").style.display = "none";
    resetEvHighlightAndView();
  };

  const evInfoPanelDom = document.getElementById("evInfoPanel");
  let evOffsetX = 0, evOffsetY = 0, evDragging = false;
  evInfoPanelDom.addEventListener("mousedown", (e) => {
    evDragging = true; evOffsetX = e.clientX - evInfoPanelDom.offsetLeft; evOffsetY = e.clientY - evInfoPanelDom.offsetTop; evInfoPanelDom.style.cursor = "grabbing";
  });
  document.addEventListener("mousemove", (e) => {
    if (evDragging) {
      evInfoPanelDom.style.left = (e.clientX - evOffsetX) + "px";
      evInfoPanelDom.style.top = (e.clientY - evOffsetY) + "px";
      evInfoPanelDom.style.transform = "none";
    }
  });
  document.addEventListener("mouseup", () => { evDragging = false; evInfoPanelDom.style.cursor = "move"; });

  function highlightEvStation(g) {
    if (evHaloInterval) clearInterval(evHaloInterval);
    if (highlightedEvGraphic) {
      const prevHalo = highlightedEvGraphic.attributes.haloGraphic;
      if (prevHalo) {
        prevHalo.symbol = { type: "point-3d", symbolLayers: [{ type: "object", width: 40, depth: 40, height: 1, material: { color: [0, 255, 0, 0] }, anchor: "center", offsetZ: -14 }] };
      }
      highlightedEvGraphic.symbol = { type: "point-3d", symbolLayers: [{ type: "icon", resource: { href: "https://cdn-icons-png.flaticon.com/512/7787/7787212.png" }, size: 28 }] };
    }

    highlightedEvGraphic = g;
    g.symbol = { type: "point-3d", symbolLayers: [{ type: "icon", resource: { href: "https://cdn-icons-png.flaticon.com/512/7787/7787212.png" }, size: 50 }] };

    const halo = g.attributes.haloGraphic;
    if (!halo) return;
    halo.geometry = new Point({ longitude: g.geometry.longitude, latitude: g.geometry.latitude - 0.0004, z: 0 });

    const baseSize = 50;
    const baseAlpha = 0.3;
    halo.symbol = { type: "point-3d", symbolLayers: [{ type: "object", width: baseSize, depth: baseSize, height: 1, material: { color: [0, 255, 0, baseAlpha] }, anchor: "center", offsetZ: -14 }] };

    let frame = 0;
    evHaloInterval = setInterval(() => {
      frame += 0.05;
      const scale = 1 + 0.2 * Math.sin(frame);
      const opacity = baseAlpha + 0.15 * (Math.sin(frame) * 0.5 + 0.5);
      halo.symbol = { type: "point-3d", symbolLayers: [{ type: "object", width: baseSize * scale, depth: baseSize * scale, height: 1, material: { color: [0, 255, 0, opacity] }, anchor: "center", offsetZ: -14 }] };
    }, 60);
  }

  view.on("click", async (event) => {
    if (currentMode !== "ev") return;
    const hit = await view.hitTest(event);
    if (hit.results.length && hit.results[0].graphic.layer === evLayer) {
      const g = hit.results[0].graphic;
      if (g.attributes && g.attributes.id) {
        await flyToEvStation(g);
        highlightEvStation(g);
      }
    }
  });

  document.getElementById("evSearchBox").oninput = (e) => {
    if (currentMode !== "ev") return;
    updateEvList(e.target.value);
  };

  function startEvAutoScroll() {
    const list = document.getElementById("evStationList");
    const listInner = document.getElementById("evStationListInner");

    setInterval(() => { 
      if (currentMode !== "ev") return;
      if (pauseEvAutoScroll) return;

      const maxScroll = listInner.scrollHeight - list.clientHeight;
      if (maxScroll <= 0) return;

      let next = list.scrollTop + 1; 
      if (next > maxScroll + 5) next = 0; 

      list.scrollTop = next; 
    }, 40);
  }


// âœ… æ»‘é¼ ç§»åˆ° EV é¢æ¿/æ¸…å–®/è³‡è¨Šæ¡†ï¼šåœæ­¢è‡ªå‹•æ»‘å‹•ï¼›ç§»é–‹å†ç¹¼çºŒ
(function bindEvAutoScrollPause(){
  const hoverTargets = [
    document.getElementById("evRightPanel"),
    document.getElementById("evStationList"),
    document.getElementById("evInfoPanel"),
    document.getElementById("modeToggleBtn")
  ].filter(Boolean);

  hoverTargets.forEach(el=>{
    el.addEventListener("mouseenter", ()=>{ pauseEvAutoScroll = true; });
    el.addEventListener("mouseleave", ()=>{ pauseEvAutoScroll = false; });
  });
})();

  // =========================
  // âœ… åœè»Šå ´ï¼šé«˜äº®/å›åŸè¦–è§’ï¼ˆé—œé–‰è³‡è¨Šçª—è¦å›åˆ°åŸå§‹ä½ç½®ï¼‰
  // =========================
  function setParkingSymbolSize(g, px){
    if (!g || !g.symbol) return;
    const s = g.symbol;
    if (s.type === "picture-marker") {
      s.width  = `${px}px`;
      s.height = `${px}px`;
      g.symbol = s;
    } else if (typeof s.size !== "undefined") {
      s.size = px;
      g.symbol = s;
    }
  }

  function resetParkingHighlightAndView(){
    if (highlightedParkingGraphic) {
      setParkingSymbolSize(highlightedParkingGraphic, PARKING_ICON_SIZE);
      highlightedParkingGraphic = null;
    }
    try { view.goTo(initialCamera); } catch(e){}
  }
  function getStatusText(status) {
    switch (status) {
      case 1: return "å¯ä½¿ç”¨ (Available)";
      case 2: return "ä¸å¯ä½¿ç”¨ (UnAvailable) - ä½”ç”¨/å……é›»ä¸­";
      default: return "ä¸å¯ä½¿ç”¨ (UnAvailable) - ç•°å¸¸æ•…éšœ";
    }
  }

  async function fetchEvLiveStatus() {
    try {
      const token = await getTDXToken();
      const url = "https://tdx.transportdata.tw/api/basic/v1/EV/ConnectorLiveStatus/City/Taoyuan?$format=JSON";
      const res = await fetch(url, { headers: { "Authorization": "Bearer " + token } });
      const data = await res.json();
      if (!data.LiveStatuses) return;

      stationGraphics.forEach(g => {
        const div = document.getElementById(`connector-${g.attributes.id}`);
        if (div) div.innerHTML = "";
      });

      data.LiveStatuses.forEach(conn => {
        const div = document.getElementById(`connector-${conn.StationID}`);
        if (!div) return;
        let cls = "status-3";
        if (conn.ConnectorStatus === 1) cls = "status-1";
        else if (conn.ConnectorStatus === 2) cls = "status-2";

        const span = document.createElement("span");
        span.className = `connector ${cls}`;

        let charged;
        if (conn.ConnectorStatus === 1) charged = "0 kWh";
        else if (conn.ChargedKWH != null) charged = conn.ChargedKWH + " kWh";
        else charged = "ç„¡è³‡æ–™";

        span.addEventListener("mouseenter", (e) => {
          const tooltip = document.createElement("div");
          tooltip.className = "tooltip";
          const dotColor = window.getComputedStyle(span).backgroundColor;
          let statusClass = "available";
          if (dotColor.includes("255, 152, 0")) statusClass = "charging";
          else if (dotColor.includes("244, 67, 54")) statusClass = "error";
          tooltip.classList.add(statusClass);
          const statusText = getStatusText(conn.ConnectorStatus);
          tooltip.innerText = `${conn.ConnectorID}\nç‹€æ…‹ï¼š${statusText}\nå·²å……é›»ï¼š${charged}`;
          document.body.appendChild(tooltip);
          const rect = e.target.getBoundingClientRect();
          tooltip.style.left = rect.left + window.scrollX + 20 + "px";
          tooltip.style.top = rect.top + window.scrollY - 10 + "px";
          tooltip.style.opacity = "1";
          tooltip.style.transform = "translateY(0)";
          span._tooltip = tooltip;
        });
        span.addEventListener("mousemove", (e) => {
          if (span._tooltip) { span._tooltip.style.left = e.pageX + 15 + "px"; span._tooltip.style.top = e.pageY + 10 + "px"; }
        });
        span.addEventListener("mouseleave", () => {
          if (span._tooltip) {
            const tooltip = span._tooltip;
            tooltip.style.opacity = "0";
            tooltip.style.transform = "translateY(-4px)";
            setTimeout(() => { tooltip.remove(); }, 150);
            span._tooltip = null;
          }
        });

        div.appendChild(span);
      });
    } catch (err) {
      console.error("è¼‰å…¥å……é›»æ§ç‹€æ…‹éŒ¯èª¤", err);
    }
  }

  /* -------------- YouBike / EV æ¨¡å¼åˆ‡æ›é‚è¼¯ -------------- */
  const toggleBtn = document.getElementById("modeToggleBtn");
  const yRightPanel = document.getElementById("yRightPanel");
  const evRightPanel = document.getElementById("evRightPanel");
  const yInfo = document.getElementById("infoPanel");
  const evInfo = document.getElementById("evInfoPanel");

  function updateToggleBtn() {
    if (currentMode === "youbike") {
      toggleBtn.textContent = "åˆ‡æ›åˆ°EVæ¨¡å¼âš¡";
      toggleBtn.style.background = "#4caf50";
      toggleBtn.style.color = "white";
    } else {
      toggleBtn.textContent = "åˆ‡å›YouBikeæ¨¡å¼ğŸš´â€â™‚ï¸";
      toggleBtn.style.background = "#ff9800";
      toggleBtn.style.color = "white";
    }
  }

  toggleBtn.onclick = () => {
    // è‹¥ç›®å‰åœ¨åœè»Šå ´æ¨¡å¼ï¼Œå…ˆé€€å‡ºåœè»Šå ´å†åˆ‡æ› YouBike/EV
    if (currentMode === "parking") {
      exitParkingMode("youbike");
    }

    if (currentMode === "youbike") {
      currentMode = "ev";
      yRightPanel.style.display = "none";
      yInfo.style.display = "none";
      evRightPanel.style.display = "flex";
      youBikeClickEnabled = false;

      youBikeLayer.visible = false;
      yToggleTop.checked = false;

      evLayer.visible = true;
      evToggleTop.checked = true;

      if (!evLoaded) loadEvData();
    } else {
      currentMode = "youbike";
      yRightPanel.style.display = "flex";
      evRightPanel.style.display = "none";
      evInfo.style.display = "none";
      youBikeClickEnabled = true;

      youBikeLayer.visible = true;
      yToggleTop.checked = true;

      evLayer.visible = false;
      evToggleTop.checked = false;
    }

    updateToggleBtn();
  };

  updateToggleBtn();

  /* =========================
     âœ… åœè»Šå ´ï¼ˆParkingï¼‰è³‡æ–™ï¼šOffStreet CarPark + å³æ™‚ç©ºä½
     ========================= */
  let parkingLoaded = false;
  let parkingGraphics = [];
  let highlightedParkingGraphic = null;

  async function loadParkingData() {
    try {
      const token = await getTDXToken();
      const headers = { "Authorization": `Bearer ${token}` };

      const carparkRes = await fetch("https://tdx.transportdata.tw/api/basic/v1/Parking/OffStreet/CarPark/City/Taoyuan?$format=JSON", { headers });
      const availRes = await fetch("https://tdx.transportdata.tw/api/basic/v1/Parking/OffStreet/ParkingAvailability/City/Taoyuan?$format=JSON", { headers });

      const carparkJson = await carparkRes.json();
      const availJson = await availRes.json();

      const carparks = carparkJson.CarParks || [];
      const avails = availJson.ParkingAvailabilities || [];

      const availMap = new Map();
      avails.forEach(a => {
        if (!a || !a.CarParkID) return;
        availMap.set(a.CarParkID, a);
      });

      // æ¸…ç©ºèˆŠåœ–å±¤
      parkingLayer.removeAll();
      parkingGraphics = [];
      const pkBatch = [];

      carparks.forEach(cp => {
        const pos = cp.CarParkPosition || {};
        const lat = pos.PositionLat, lon = pos.PositionLon;
        if (lat == null || lon == null) return;

        const a = availMap.get(cp.CarParkID) || {};
        const total = (a.TotalSpaces != null) ? a.TotalSpaces : null;
        const avail = (a.AvailableSpaces != null) ? a.AvailableSpaces : null;

        let status = "æœªçŸ¥";
        if (avail == null || total == null) status = "æœªæä¾›å³æ™‚ç©ºä½";
        else if (avail <= 0) status = "å·²æ»¿";
        else if (avail / Math.max(total, 1) <= 0.15) status = "å°‡æ»¿";
        else status = "å°šæœ‰ç©ºä½";

        const symbol = { type: "picture-marker", url: ICON_PARKING, width: `${PARKING_ICON_SIZE}px`, height: `${PARKING_ICON_SIZE}px` };

        const g = new Graphic({
          geometry: { type: "point", latitude: lat, longitude: lon },
          symbol,
          attributes: {
            _type: "parking",
            id: cp.CarParkID,
            name: (cp.CarParkName && (cp.CarParkName.Zh_tw || cp.CarParkName.En)) || cp.CarParkID,
            address: cp.Address || "",
            tel: cp.Telephone || "",
            fare: cp.FareDescription || cp.FareURL || "",
            total: total,
            available: avail,
            status: status,
            updateTime: (a.DataCollectTime || availJson.UpdateTime || carparkJson.UpdateTime || "")
          }
        });

        pkBatch.push(g);
        parkingGraphics.push(g);
      });

      parkingLoaded = true;
      updateParkingList("");
    } catch (err) {
      console.error("è¼‰å…¥åœè»Šå ´è³‡æ–™éŒ¯èª¤", err);
    }
  }

  function updateParkingList(keyword) {
    const listInner = document.getElementById("pStationListInner");
    if (!listInner) return;
    listInner.innerHTML = "";

    const k = (keyword || "").trim().toLowerCase();

    parkingGraphics
      .filter(g => {
        const n = String(g.attributes.name || "").toLowerCase();
        const a = String(g.attributes.address || "").toLowerCase();
        return !k || n.includes(k) || a.includes(k);
      })
      .slice(0, 300)
      .forEach(g => {
        const div = document.createElement("div");
        div.className = "pStationItem";
        const total = g.attributes.total;
        const avail = g.attributes.available;
        const occText = (total == null || avail == null) ? "ç©ºä½ï¼š--" : `ç©ºä½ï¼š${avail}/${total}`;
        div.innerHTML = `<strong>${g.attributes.name}</strong><span>${occText}ï½œ${g.attributes.status}</span>`;
        div.onclick = () => flyToParking(g);
        listInner.appendChild(div);
      });
  }

  async function flyToParking(g) {
    try {
      if (!g) return;

      // é«˜äº®ï¼šæ”¾å¤§é»
      if (highlightedParkingGraphic) {
        setParkingSymbolSize(highlightedParkingGraphic, PARKING_ICON_SIZE);
      }
      setParkingSymbolSize(g, PARKING_ICON_SIZE_ACTIVE);
      highlightedParkingGraphic = g;

      await view.goTo({ target: g.geometry, zoom: 16, tilt: 55 }, { duration: 800 });
      showParkingInfo(g);
    } catch (e) {}
  }

  function showParkingInfo(g) {
    const panel = document.getElementById("pInfoPanel");
    const body = document.getElementById("pInfoBody");
    if (!panel || !body) return;

    const total = g.attributes.total;
    const avail = g.attributes.available;
    const occText = (total == null || avail == null) ? "ç©ºä½ï¼šæœªæä¾›" : `ç©ºä½ï¼š${avail}/${total}`;
    const ut = g.attributes.updateTime ? `<div style="opacity:.85;font-size:12px;">æ›´æ–°æ™‚é–“ï¼š${g.attributes.updateTime}</div>` : "";

    body.innerHTML = `
      <div style="font-weight:700;font-size:15px;margin-bottom:6px;">${g.attributes.name}</div>
      <div>${occText}ï½œ${g.attributes.status}</div>
      ${g.attributes.address ? `<div>åœ°å€ï¼š${g.attributes.address}</div>` : ""}
      ${g.attributes.tel ? `<div>é›»è©±ï¼š${g.attributes.tel}</div>` : ""}
      ${g.attributes.fare ? `<div style="margin-top:6px;opacity:.9;">æ”¶è²»ï¼š${g.attributes.fare}</div>` : ""}
      ${ut}
    `;
    panel.style.display = "block";
  }

  // åœè»Šå ´ï¼šåœ°åœ–é»æ“Š
  view.on("click", async (event) => {
    if (currentMode !== "parking") return;
    const hit = await view.hitTest(event);
    const r = hit.results && hit.results.find(x => x.graphic && x.graphic.layer === parkingLayer);
    if (r && r.graphic) flyToParking(r.graphic);
  });

  document.getElementById("pSearchBox").oninput = (e) => {
    if (currentMode !== "parking") return;
    updateParkingList(e.target.value);
  };

  // é—œé–‰åœè»Šå ´è³‡è¨Šé¢æ¿
  const pClose = document.getElementById("pInfoPanelClose");
  if (pClose) pClose.onclick = () => {
    const panel = document.getElementById("pInfoPanel");
    if (panel) panel.style.display = "none";
    resetParkingHighlightAndView(); // âœ… é—œé–‰è³‡è¨Šçª—å›åŸå§‹è¦–è§’
  };

  // åœè»Šå ´è³‡è¨Šé¢æ¿å¯æ‹–æ›³ï¼ˆæ²¿ç”¨ä½ ä¹‹å‰çš„æ‹–æ›³é‚è¼¯å¯«æ³•ï¼‰
  (function enableParkingDrag(){
    const box = document.getElementById("pInfoPanel");
    if (!box) return;
    let dragging = false, sx=0, sy=0, ox=0, oy=0;
    box.addEventListener("mousedown", (e)=>{
      if (e.target && e.target.id === "pInfoPanelClose") return;
      dragging = true;
      sx = e.clientX; sy = e.clientY;
      const rect = box.getBoundingClientRect();
      ox = rect.left; oy = rect.top;
      box.style.left = ox + "px";
      box.style.top = oy + "px";
      box.style.bottom = "auto";
      box.style.transform = "none";
      e.preventDefault();
    });
    window.addEventListener("mousemove", (e)=>{
      if(!dragging) return;
      const nx = ox + (e.clientX - sx);
      const ny = oy + (e.clientY - sy);
      box.style.left = nx + "px";
      box.style.top  = ny + "px";
    });
    window.addEventListener("mouseup", ()=> dragging=false);
  })();

  /* =========================
     âœ… åœè»Šå ´æ¨¡å¼åˆ‡æ›æŒ‰éˆ•ï¼ˆæ”¾åœ¨ EV ä¸‹æ–¹ï¼‰
     ========================= */
  const parkingBtn = document.getElementById("parkingModeBtn");
  const pRightPanel = document.getElementById("pRightPanel");
  const pInfoPanel = document.getElementById("pInfoPanel");

    // ===== åœè»Šå ´ï¼šæ¸…å–®è‡ªå‹•æ»¾å‹•ï¼ˆè¡Œç‚ºæ¯”ç…§ YouBike/EVï¼‰ =====
  let parkingAutoScrollTimer = null;
  let pauseParkingAutoScroll = false;

  function startParkingAutoScroll(){
    if (parkingAutoScrollTimer) return;
    const list = document.getElementById("pStationList");
    const listInner = document.getElementById("pStationListInner");
    if (!list || !listInner) return;

    parkingAutoScrollTimer = setInterval(() => {
      if (currentMode !== "parking") return;
      if (pauseParkingAutoScroll) return;

      const maxScroll = listInner.scrollHeight - list.clientHeight;
      if (maxScroll <= 0) return;

      let next = list.scrollTop + 1;
      if (next > maxScroll + 5) next = 0;
      list.scrollTop = next;
    }, 40);
  }

  // æ»‘é¼ ç§»å…¥åœè»Šå ´é¢æ¿/æ¸…å–®/è³‡è¨Šçª—ï¼šæš«åœè‡ªå‹•æ»¾å‹•ï¼›ç§»å‡ºï¼šç¹¼çºŒ
  (function bindParkingAutoScrollPause(){
    const targets = [
      document.getElementById("pRightPanel"),
      document.getElementById("pStationList"),
      document.getElementById("pInfoPanel"),
      document.getElementById("parkingModeBtn")
    ].filter(Boolean);

    targets.forEach(el => {
      el.addEventListener("mouseenter", () => pauseParkingAutoScroll = true);
      el.addEventListener("mouseleave", () => pauseParkingAutoScroll = false);
    });
  })();

function enterParkingMode(){
    // å…ˆæ”¶æ‰å…¶ä»–è³‡è¨Šçª—ä¸¦å›åŸè¦–è§’
    try { if (yInfo) yInfo.style.display = "none"; } catch(e){}
    try { if (evInfo) evInfo.style.display = "none"; } catch(e){}
    try { if (pInfoPanel) pInfoPanel.style.display = "none"; } catch(e){}
    resetParkingHighlightAndView();

    currentMode = "parking";

    
    startParkingAutoScroll();
// é¢æ¿é¡¯ç¤º
    if (yRightPanel) yRightPanel.style.display = "none";
    if (evRightPanel) evRightPanel.style.display = "none";
    if (pRightPanel) pRightPanel.style.display = "flex";
    if (yInfo) yInfo.style.display = "none";
    if (evInfo) evInfo.style.display = "none";

    // åœ–å±¤ / é–‹é—œ
    youBikeClickEnabled = false;
    try { youBikeLayer.visible = false; yToggleTop.checked = false; } catch(e){}
    try { evLayer.visible = false; evToggleTop.checked = false; } catch(e){}
    try { parkingLayer.visible = true; if (pToggleTop) pToggleTop.checked = true; } catch(e){}

    // è¼‰å…¥è³‡æ–™
    if (!parkingLoaded) loadParkingData();
    else updateParkingList(document.getElementById("pSearchBox")?.value || "");
  }

  function exitParkingMode(toMode){
    currentMode = toMode || "youbike";

    if (pRightPanel) pRightPanel.style.display = "none";
    if (pInfoPanel) pInfoPanel.style.display = "none";
    resetParkingHighlightAndView();
    try { parkingLayer.visible = false; if (pToggleTop) pToggleTop.checked = false; } catch(e){}

    if (currentMode === "ev") {
      if (evRightPanel) evRightPanel.style.display = "flex";
      if (yRightPanel) yRightPanel.style.display = "none";
      try { evLayer.visible = true; evToggleTop.checked = true; } catch(e){}
      if (!evLoaded) loadEvData();
    } else {
      currentMode = "youbike";
      if (yRightPanel) yRightPanel.style.display = "flex";
      if (evRightPanel) evRightPanel.style.display = "none";
      youBikeClickEnabled = true;
      try { youBikeLayer.visible = true; yToggleTop.checked = true; } catch(e){}
      try { evLayer.visible = false; evToggleTop.checked = false; } catch(e){}
    }
    updateToggleBtn();
  }

  if (parkingBtn) {
    parkingBtn.onclick = () => {
      if (currentMode === "parking") {
        // å›åˆ°ä½ ä¸Šä¸€å€‹æ¨¡å¼ï¼šå„ªå…ˆå› EVï¼ˆå¦‚æœ EV é–‹é—œåŸæœ¬é–‹è‘—ï¼‰ï¼Œå¦å‰‡å› YouBike
        const goEv = (evToggleTop && evToggleTop.checked);
        exitParkingMode(goEv ? "ev" : "youbike");
        parkingBtn.textContent = "åœè»Šå ´ğŸ…¿";
        } else {
        enterParkingMode();
        parkingBtn.textContent = "é€€å‡ºåœè»Šå ´";
        }
    };
  }

  // åœè»Šå ´é»ä½é–‹é—œï¼ˆåœ–å±¤é¢æ¿ï¼‰
  if (pToggleTop) {
    pToggleTop.onchange = () => {
      const on = !!pToggleTop.checked;
      try { parkingLayer.visible = on; } catch(e){}
      if (on && !parkingLoaded) loadParkingData();
      // è‹¥ä½¿ç”¨è€…ç›´æ¥åœ¨åœ–å±¤é¢æ¿æ‰“é–‹åœè»Šå ´ï¼Œé †ä¾¿åˆ‡åˆ°åœè»Šå ´æ¨¡å¼ï¼Œé¿å…é¢æ¿/é»æ“Šä¸ä¸€è‡´
      if (on && currentMode !== "parking") enterParkingMode();
      if (!on && currentMode === "parking") exitParkingMode("youbike");
    };
  }

  yToggleTop.addEventListener("change", (e) => {
    youBikeLayer.visible = e.target.checked;
  });
  evToggleTop.addEventListener("change", (e) => {
    if (e.target.checked && !evLoaded) {
      loadEvData();
    }
    evLayer.visible = e.target.checked;
  });

    /* =========================
     âœ… äº¤é€šäº‹æ•…ï¼ˆæ™‚é–“è»¸ + æŠ˜ç·šåœ–ï¼‰
     ========================= */
  const ACC_GEOJSON_URL = "https://jade0815.github.io/data/106_113å°æªœæºªäº¤é€šäº‹æ•….geojson";
  
  const ACC_GEOJSON_URL_2024 = "https://jade0815.github.io/data/113äº¤é€šäº‹æ•…å°æªœæºª.geojson";
const MINZONE_GEOJSON_URL = "https://jade0815.github.io/data/å°æªœæºªæœ€å°çµ±è¨ˆå€NEW.geojson";

  const accToggleTop   = document.getElementById("accTogglePointsTop");
  const tabAccDom      = document.getElementById("tabAcc");
  const pageAccidentDom= document.getElementById("pageAccident");

  const accGroupSelect = document.getElementById("accGroupSelect");
  const accTimeSlider  = document.getElementById("accTimeSlider");
  const accTimeLabel   = document.getElementById("accTimeLabel");
  const accCountLabel  = document.getElementById("accCountLabel");
  
  const accA1Label     = document.getElementById("accA1Label");
  const accA2Label     = document.getElementById("accA2Label");
const accRangeMin    = document.getElementById("accRangeMin");
  const accRangeMax    = document.getElementById("accRangeMax");

  let accidentLoaded = false;
  let accidentFeaturesRaw = [];   // åŸå§‹ featuresï¼ˆå« properties/geometryï¼‰
  let accidentFeaturesScope = []; // åªä¿ç•™ã€å°æªœæºªç¯„åœå…§ã€çš„ features
  let accidentFeatures = [];      // ç›®å‰ä½¿ç”¨çš„ featuresï¼ˆ= accidentFeaturesScopeï¼‰
  let accMonths = [];          // ["YYYY-MM", ...] é€£çºŒæœˆä»½è»¸
  let accMonthIndexByKey = {}; // "YYYY-MM" -> idx
  let accChart = null;
  /* =========================
   âœ… äº¤é€šäº‹æ•…ï¼šæœˆä»½è§£æ / åœ–è¡¨ / é»ä½ï¼ˆv20 ä¿®æ­£ï¼šæŠ˜ç·šåœ–ç„¡å€¼ï¼‰
   - å…¼å®¹å¤šç¨®æ—¥æœŸæ¬„ä½èˆ‡æ ¼å¼ï¼ˆYYYY-MM-DD, YYYY/MM/DD, YYYYMMDD, æ°‘åœ‹ yyyMMddï¼‰
   - refreshAccidentUI æœƒä¾ç›®å‰ accidentFeatures é‡æ–°å»ºç«‹æœˆä»½è»¸ï¼Œé¿å…åˆ‡æ›æœ€å°çµ±è¨ˆå€å¾Œåœ–è¡¨å…¨ 0
   ========================= */

  function normalizeMonthKeyFromParts(year, month){
    const y = Number(year);
    const m = Number(month);
    if(!Number.isFinite(y) || !Number.isFinite(m) || m < 1 || m > 12) return null;
    const mm = String(m).padStart(2,"0");
    return `${y}-${mm}`;
  }

  // âœ… æ”¯æ´ï¼šYYYY-MM-DD / YYYY/MM/DD / YYYYMMDD / æ°‘åœ‹(3ä½å¹´)+MM+DD / ç›´æ¥çµ¦ YYYY-MM
  function yyyymmddToMonthKey(v){
    if(v == null) return null;
    const s0 = String(v).trim();
    if(!s0) return null;

    // å·²æ˜¯ YYYY-MM
    const m1 = s0.match(/^(\d{4})[-\/](\d{1,2})$/);
    if(m1) return normalizeMonthKeyFromParts(m1[1], m1[2]);

    // YYYY-MM-DD or YYYY/MM/DD
    const m2 = s0.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
    if(m2) return normalizeMonthKeyFromParts(m2[1], m2[2]);

    // YYYYMMDD
    const m3 = s0.match(/^(\d{4})(\d{2})(\d{2})$/);
    if(m3) return normalizeMonthKeyFromParts(m3[1], m3[2]);

    // æ°‘åœ‹ yyyMMddï¼ˆä¾‹å¦‚ 1130105, 1121231ï¼‰
    const m4 = s0.match(/^(\d{3})(\d{2})(\d{2})$/);
    if(m4){
      const y = Number(m4[1]) + 1911;
      return normalizeMonthKeyFromParts(y, m4[2]);
    }

    // å…¶ä»–å«æ—¥æœŸå­—ä¸²ï¼šå˜—è©¦æŠ“ YYYY + MM
    const m5 = s0.match(/(20\d{2})[^0-9]?(\d{1,2})/);
    if(m5) return normalizeMonthKeyFromParts(m5[1], m5[2]);

    return null;
  }

  // å¾ properties å˜—è©¦æŠ½å‡ºæœˆä»½ keyï¼ˆæ›´è€é«’è³‡æ–™ï¼‰
  function extractAccMonthKey(p){
    if(!p) return null;

    // å¸¸è¦‹æ¬„ä½ï¼ˆä½ åŸæœ¬æœ‰ Date/date/DATE/Yearï¼‰
    const candidates = [
      "Date","date","DATE","ç™¼ç”Ÿæ—¥æœŸ","ç™¼ç”Ÿæ™‚é–“","OCC_DATE","OCCDATE","ç™¼ç”Ÿæ—¥",
      "å¹´æœˆ","YM","YearMonth","MONTH_KEY","month_key",
      "Year","YEAR","å¹´","Month","MONTH","æœˆ"
    ];

    // 1) å…ˆå¾å€™é¸æ¬„ä½é€ä¸€è©¦
    for(const k of candidates){
      if(p[k] == null) continue;

      // è‹¥åŒæ™‚æœ‰ Year+Month
      if((k === "Year" || k === "YEAR" || k === "å¹´") && (p.Month != null || p.MONTH != null || p["æœˆ"] != null)){
        const yRaw = p[k];
        const mRaw = (p.Month != null ? p.Month : (p.MONTH != null ? p.MONTH : p["æœˆ"]));
        // æ°‘åœ‹å¹´å¯èƒ½æ˜¯ 113
        const yy = Number(yRaw);
        const year = (yy < 1900 ? yy + 1911 : yy);
        const mk = normalizeMonthKeyFromParts(year, mRaw);
        if(mk) return mk;
      }

      const mk = yyyymmddToMonthKey(p[k]);
      if(mk) return mk;
    }

    // 2) é€€è€Œæ±‚å…¶æ¬¡ï¼šæƒææ‰€æœ‰æ¬„ä½å€¼æ‰¾æ—¥æœŸ
    for(const kk in p){
      const mk = yyyymmddToMonthKey(p[kk]);
      if(mk) return mk;
    }

    return null;
  }

  function buildContinuousMonths(minKey, maxKey){
    const mA = String(minKey||"").match(/^(\d{4})-(\d{2})$/);
    const mB = String(maxKey||"").match(/^(\d{4})-(\d{2})$/);
    if(!mA || !mB) return [];
    let y = Number(mA[1]), m = Number(mA[2]);
    const y2 = Number(mB[1]), m2 = Number(mB[2]);
    const out = [];
    for(let guard=0; guard<600; guard++){
      out.push(`${y}-${String(m).padStart(2,"0")}`);
      if(y === y2 && m === m2) break;
      m++;
      if(m>12){ m=1; y++; }
    }
    return out;
  }

  // âœ… é‡å»ºæœˆä»½è»¸ + slider ç¯„åœ + æŠ˜ç·šåœ– + ä¾ç›®å‰ slider é¡¯ç¤ºé»ä½
  function refreshAccidentUI(){
    const keys = [];
    for(const f of (accidentFeatures || [])){
      const p = f.properties || {};
      const mk = extractAccMonthKey(p);
      if(mk) keys.push(mk);
    }
    keys.sort();
    const minKey = keys[0] || "2017-01";
    const maxKey = keys[keys.length-1] || minKey;

    accMonths = buildContinuousMonths(minKey, maxKey);
    accMonthIndexByKey = {};
    accMonths.forEach((k,i)=> accMonthIndexByKey[k]=i);

    if(accRangeMin) accRangeMin.textContent = minKey;
    if(accRangeMax) accRangeMax.textContent = maxKey;

    if(accTimeSlider){
      accTimeSlider.min = 0;
      accTimeSlider.max = Math.max(0, accMonths.length - 1);
      // è‹¥åŸæœ¬ value è¶…ç•Œï¼Œæ‹‰å›æœ€æ–°
      const v = parseInt(accTimeSlider.value || "0",10);
      if(!Number.isFinite(v) || v > accTimeSlider.max) accTimeSlider.value = accTimeSlider.max;
      if(v < 0) accTimeSlider.value = 0;
    }

    // ç®—æŠ˜ç·šåœ– + é‡ç•«
    accCounts = computeMonthlyCounts("ALL");
    rebuildAccChart();

    // é¡¯ç¤ºé»ä½
    const idx = parseInt(accTimeSlider?.value || "0",10);
    renderAccidentPoints(idx);
  }

  function getAccType(p){
    // äº‹æ•…åš´é‡åº¦/é¡åˆ¥æ¬„ä½å¯èƒ½æœ‰å¤šç¨®å‘½åï¼šAccType / A1A2 / A1_A2 / Type / Severity... ç­‰
    const raw = (
      // âœ… ä½ çš„äº‹æ•…è³‡æ–™ä¸»è¦æ¬„ä½ï¼šAccident_t (A1/A2)
      p?.Accident_t ?? p?.ACCIDENT_T ??
      // å…¶ä»–å¯èƒ½å‘½å
      p?.AccType ?? p?.ACTYPE ?? p?.äº‹æ•…é¡å‹ ?? p?.A1A2 ?? p?.A1_A2 ??
      p?.A1A2é¡åˆ¥ ?? p?.A1A2_TYPE ?? p?.TYPE ?? p?.Type ?? p?.severity ?? p?.Severity ?? ""
    );


    const t = String(raw).trim().toUpperCase();

    // å¸¸è¦‹æ–‡å­—/ä»£ç¢¼
    if(t.includes("A1")) return "A1";
    if(t.includes("A2")) return "A2";

    // æœ‰äº›è³‡æ–™ç”¨æ•¸å­— 1/2 æˆ– "1é¡" "2é¡"
    if(t === "1" || t === "A1é¡" || t.includes("1é¡")) return "A1";
    if(t === "2" || t === "A2é¡" || t.includes("2é¡")) return "A2";

    // æœ‰äº›è³‡æ–™ç”¨ã€Œæ­»äº¡/å—å‚·ã€æˆ–ã€Œè‡´æ­»/å—å‚·ã€
    if(t.includes("æ­»äº¡") || t.includes("è‡´æ­»") || t.includes("FATAL")) return "A1";
    if(t.includes("å—å‚·") || t.includes("INJUR")) return "A2";

    return "OTHER";
  }

  function computeMonthlyCounts(groupType){
    // âœ… æŠ˜ç·šåœ–åªå‘ˆç¾ã€Œäº‹æ•…ç¸½æ•¸ã€ï¼ˆä¸å†ç”¨ A1/A2 ç•«ç·šï¼‰
    const arr = new Array(accMonths.length).fill(0);
    for(const f of (accidentFeatures || [])){
      const p = f.properties || {};
      const mk = extractAccMonthKey(p);
      if(!mk) continue;
      const idx = accMonthIndexByKey[mk];
      if(idx === undefined) continue;
      arr[idx] += 1;
    }
    return arr;
  }


  function rebuildAccChart(){
    const canvas = document.getElementById("accChart");
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    if(!ctx) return;

    try{ if(accChart) accChart.destroy(); }catch(e){}
    accChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: accMonths,
        datasets: [{
          label: "äº‹æ•…æ•¸é‡",
          data: accCounts || [],
          borderColor: "#3b82f6",                 // âœ… è—è‰²æŠ˜ç·š
          backgroundColor: "rgba(59,130,246,0.12)",
          tension: 0.25,
          fill: true,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  function renderAccidentPoints(monthIdx){
    const on = !!accToggleTop?.checked;
    if(!on){
      try{ accidentLayer?.removeAll(); }catch(e){}
      return;
    }
    const mk = accMonths[monthIdx] || null;

    // çµ±è¨ˆï¼šæœ¬æœˆä»½ç¸½æ•¸ / A1 / A2
    let total = 0, a1 = 0, a2 = 0;

    try{ accidentLayer?.removeAll(); }catch(e){}

    if(!mk){
      if(accTimeLabel) accTimeLabel.textContent = "â€”";
      if(accCountLabel) accCountLabel.textContent = "0";
      if(accA1Label) accA1Label.textContent = "0";
      if(accA2Label) accA2Label.textContent = "0";
      return;
    }

    for(const f of (accidentFeatures || [])){
      const p = f.properties || {};
      const fmk = extractAccMonthKey(p);
      if(fmk !== mk) continue;

      const g = f.geometry;
      if(!g || g.type !== "Point") continue;
      const coords = g.coordinates || [];
      const lon = Number(coords[0]), lat = Number(coords[1]);
      if(!Number.isFinite(lon) || !Number.isFinite(lat)) continue;
      // âœ… æœ¬æœˆä»½é»ä½ç¸½æ•¸
      total++;
      const t = getAccType(p);
      if(t === "A1") a1++;
      if(t === "A2") a2++;

      // å»ºç«‹é»ä½ Graphic
      try{
        const pt = new Point({ longitude: lon, latitude: lat });
        const sym = {
          type: "simple-marker",
          style: "circle",
          size: 6,
          color: [59,130,246,0.9],
          outline: { color: [255,255,255,0.7], width: 1 }
        };
        accidentLayer.add(new Graphic({ geometry: pt, symbol: sym, attributes: p }));
      }catch(e){}
    }

    if(accTimeLabel) accTimeLabel.textContent = mk;
    if(accCountLabel) accCountLabel.textContent = String(total);
    if(accA1Label) accA1Label.textContent = String(a1);
    if(accA2Label) accA2Label.textContent = String(a2);
  }

  
  let accCurrentMonthKey = null;


  // âœ… æœ€å°çµ±è¨ˆå€ï¼ˆç”¨ä¾†åšä¸‹æ‹‰ç¯©é¸èˆ‡çµ±è¨ˆï¼‰
  let minZonesLoaded = false;
  let minZones = [];
let isMinZoneEnabled = false; // æœ€å°çµ±è¨ˆå€æ˜¯å¦é–‹å•Ÿ // { label, polyWM }

  function pickZoneLabel(props){
    if(!props) return "";
    // âœ… å„ªå…ˆä½¿ç”¨ CODE1ï¼ˆæ¯å€‹æœ€å°çµ±è¨ˆå€çš„ä»£ç¢¼ï¼Œæœƒå½¼æ­¤ä¸åŒï¼‰
    if(props.CODE1 != null && String(props.CODE1).trim() !== "") return String(props.CODE1).trim();

    // æ¬¡å„ªå…ˆï¼šCODEBASE / U_ID / FIDï¼ˆé¿å…åªé¡¯ç¤ºæ¡ƒåœ’å€ï¼‰
    const fallbacks = ["CODEBASE","U_ID","FID","ID","id"];
    for(const k of fallbacks){
      if(props[k] != null && String(props[k]).trim() !== "") return String(props[k]).trim();
    }

    // æœ€å¾Œæ‰å›å‚³è¡Œæ”¿å€æ¬„ä½ï¼ˆé€šå¸¸æœƒå…¨éƒ¨ä¸€æ¨£ï¼Œä¸å»ºè­°ï¼‰
    if(props.TOWN) return String(props.TOWN).trim();
    if(props.COUNTY) return String(props.COUNTY).trim();
    return "";
}

function detectMinZoneLabelKey(features){
  const candidates = [
    "æœ€å°çµ±è¨ˆå€","MIN_ZONE","MINZONE","çµ±è¨ˆå€","çµ±è¨ˆå€å","STAT_NAME","STATNM",
    "TNAME","NAME","name","ZoneName","ZONENAME","ZONE_NAME",
    "VILLAGE","VILLNAME","VILL_NM","æ‘é‡Œ","é‡Œ","é‡Œåˆ¥"
  ,"CODE1","CODEBASE"
  ];
  const sample = (features || []).slice(0, 400);
  let bestKey = null;
  let bestScore = -1;

  for(const k of candidates){
    const vals = new Set();
    for(const f of sample){
      const v = f && f.properties ? f.properties[k] : null;
      if(v == null) continue;
      const s = String(v).trim();
      if(!s) continue;
      vals.add(s);
    }
    // å¿…é ˆè¦æœ‰è¶³å¤ è®ŠåŒ–ï¼Œé¿å…å…¨éƒ½ã€Œæ¡ƒåœ’å€ã€
    if(vals.size <= 1) continue;

    const avgLen = Array.from(vals).reduce((a,s)=>a+s.length,0) / vals.size;
    const score = vals.size * 10 + avgLen; // ä¸»è¦çœ‹ distinctï¼Œå…¶æ¬¡çœ‹å­—ä¸²é•·åº¦
    if(score > bestScore){
      bestScore = score;
      bestKey = k;
    }
  }
  return bestKey;
}


  async function loadMinZones(){
    if(minZonesLoaded) return;
    minZonesLoaded = true;
    try{
      const res = await fetch(MINZONE_GEOJSON_URL);
      const gj = await res.json();
      const feats = (gj && gj.features) ? gj.features : [];
      const __labelKey = detectMinZoneLabelKey(feats);
      // âœ… å…ˆæŠ½å‡º CODE1 æ¸…å–®ï¼ˆå°±ç®—å¹¾ä½•è½‰æ›å¤±æ•—ï¼Œä¹Ÿè‡³å°‘èƒ½é¡¯ç¤ºä¸‹æ‹‰ï¼‰
      const codeList = [];
      try{
        const seen = new Set();
        for(const f of feats){
          const p = (f && f.properties) ? f.properties : {};
          const code = (p.CODE1 != null ? String(p.CODE1).trim() : "");
          if(code && !seen.has(code)) { seen.add(code); codeList.push(code); }
        }
      }catch(e){}
      const out = [];
      for(const f of feats){
        const g = f.geometry;
        if(!g) continue;
        const props = f.properties || {};
        const label = (props.CODE1 != null && String(props.CODE1).trim() !== "")
          ? String(props.CODE1).trim()
          : ( (__labelKey && props[__labelKey]!=null) ? String(props[__labelKey]).trim() : pickZoneLabel(props) )
          || "æœªå‘½åæœ€å°çµ±è¨ˆå€";

        // æ”¯æ´ Polygon / MultiPolygon
        const polys = [];
        if(g.type === "Polygon"){
          polys.push(g.coordinates);
        }else if(g.type === "MultiPolygon"){
          for(const p of g.coordinates) polys.push(p);
        }else{
          continue;
        }

        for(const polyCoords of polys){
          // polyCoords: [ [ [lon,lat],... ] , holes... ] åªå– outer ring
          const ringsLonLat = (polyCoords[0] || []).map(c => [c[0], c[1]]);
          if(ringsLonLat.length < 3) continue;
          const poly4326 = new Polygon({ rings: ringsLonLat, spatialReference:{ wkid:4326 }});
          const polyWM = webMercatorUtils.geographicToWebMercator(poly4326);
          out.push({ label, polyWM });
        }
      }
      minZones = out;
    
      // âœ… åŒæ­¥ã€Œäº‹æ•…é¢æ¿ã€ä¸‹æ‹‰ï¼šæœ€å°çµ±è¨ˆå€é¸å–®ï¼ˆé¡¯ç¤º CODE1ï¼‰
      try{
        const sel = document.getElementById("accGroupSelect");
        if(sel){
          const keepAll = sel.querySelector('option[value="ALL"]') || (()=>{ 
            const o=document.createElement("option"); o.value="ALL"; o.textContent="å…¨éƒ¨"; return o; 
          })();
          sel.innerHTML = "";
          sel.appendChild(keepAll);
          const list = (codeList && codeList.length) ? codeList : (minZones||[]).map(z=>z.label).filter(Boolean);
          for(const code of list){
            const opt = document.createElement("option");
            opt.value = code;
            opt.textContent = code;
            sel.appendChild(opt);
          }

          // âœ… åˆæ¬¡è¼‰å…¥ï¼šé è¨­é¸ã€Œå…¨éƒ¨ã€
          if(!sel.dataset._initAllDone){
            sel.value = "ALL";
            sel.dataset._initAllDone = "1";
          }

        }
      }catch(e){}
}catch(e){
      minZones = [];
    }
  }

  function findZoneLabel(ptWM){
    if(!minZones || !minZones.length) return "";
    let ptObj = ptWM;
    try{
      // âœ… ç¢ºä¿æ˜¯ ArcGIS Point ç‰©ä»¶ï¼ˆé¿å… geometryEngine.contains å¤±æ•ˆï¼‰
      if(ptWM && ptWM.type === "point"){
        ptObj = new Point(ptWM);
      }
    }catch(e){}
    for(const z of minZones){
      try{
        if(z && z.polyWM && geometryEngine.contains(z.polyWM, ptObj)) return z.label;
      }catch(e){}
    }
    return "";
  }

  async function loadAccidents(){
    if(accidentLoaded) return;
    accidentLoaded = true;

    // å…ˆè¼‰å…¥æœ€å°çµ±è¨ˆå€ï¼Œæ‰èƒ½åšç¯„åœå…§æ¨™è¨»/çµ±è¨ˆ
    try{ await loadMinZones(); }catch(e){}

    try{
      // âœ… äº‹æ•…è³‡æ–™ï¼šä¸»æª” + 2024 è£œæª”ï¼ˆåˆä½µï¼‰
      const [gjA, gjB] = await Promise.all([
        fetch(ACC_GEOJSON_URL).then(r => r.json()),
        fetch(ACC_GEOJSON_URL_2024).then(r => r.json())
      ]);
      const featsA = (gjA && gjA.features) ? gjA.features : [];
      const featsB = (gjB && gjB.features) ? gjB.features : [];
      accidentFeaturesRaw = featsA.concat(featsB);

      // å…ˆæš«ç”¨ rawï¼Œç­‰å°æªœæºªç¯„åœ union å®Œæˆå¾Œå†éæ¿¾
      accidentFeaturesScope = accidentFeaturesRaw;
      accidentFeatures = accidentFeaturesScope;

            // âœ… è‹¥å°æªœæºªç¯„åœå·²å®Œæˆï¼Œå…ˆéæ¿¾æˆã€ç¯„åœå…§ã€äº‹æ•…
      if (typeof rebuildAccidentScopeIfReady === "function") rebuildAccidentScopeIfReady();

// å»ºç«‹æœˆä»½è»¸
      const keys = [];
      for(const f of accidentFeatures){
        const p = f.properties || {};
        const mk = yyyymmddToMonthKey(p.Date || p.date || p.DATE || p.Year);
        if(mk) keys.push(mk);
      }
      keys.sort();
      const minKey = keys[0] || "2017-01";
      const maxKey = keys[keys.length-1] || minKey;

      accMonths = buildContinuousMonths(minKey, maxKey);
      accMonthIndexByKey = {};
      accMonths.forEach((k,i)=> accMonthIndexByKey[k]=i);

      if(accRangeMin) accRangeMin.textContent = minKey;
      if(accRangeMax) accRangeMax.textContent = maxKey;

      // slider è¨­å®š
      if(accTimeSlider){
        accTimeSlider.min = 0;
        accTimeSlider.max = Math.max(0, accMonths.length - 1);
        accTimeSlider.value = accTimeSlider.max; // é è¨­æœ€æ–°æœˆä»½
      }

      // åˆæ¬¡ç®—åœ–
      accCounts = computeMonthlyCounts("ALL");
      rebuildAccChart();

      // é¡¯ç¤ºé»ä½ï¼šä¾ slider
      renderAccidentPoints(parseInt(accTimeSlider?.value || "0",10));

    }catch(err){
      console.error("äº¤é€šäº‹æ•… GeoJSON è¼‰å…¥å¤±æ•—", err);
      accidentLoaded = false;
    }
  }

  // slider / group äº‹ä»¶
  if(accTimeSlider){
    accTimeSlider.addEventListener("input", ()=>{
      const idx = parseInt(accTimeSlider.value, 10);
      renderAccidentPoints(idx);
    });
  }
  // âœ… æœ€å°çµ±è¨ˆå€ä¸‹æ‹‰ï¼šç”¨é‚Šç•Œç¯©é¸äº‹æ•…é»ä½ï¼Œå†é‡å»ºæœˆä»½è»¸/æŠ˜ç·šåœ–
  function filterAccidentsByMinZoneLabel(label){
    const code = (label || "ALL");
    if(code === "ALL") return accidentFeaturesScope;

    const z = (minZones || []).find(x => x && x.label === code);
    if(!z || !z.polyWM) return accidentFeaturesScope;

    const out = [];
    for(const f of (accidentFeaturesScope || [])){
      const g = f.geometry;
      if(!g || g.type !== "Point") continue;
      const coords = g.coordinates || [];
      const lon = Number(coords[0]), lat = Number(coords[1]);
      if(!Number.isFinite(lon) || !Number.isFinite(lat)) continue;

      try{
        const pt4326 = new Point({ longitude: lon, latitude: lat, spatialReference: { wkid: 4326 } });
        const ptWM0 = webMercatorUtils.geographicToWebMercator(pt4326);
        const ptWM = new Point(ptWM0);
        if(geometryEngine.contains(z.polyWM, ptWM)) out.push(f);
      }catch(e){}
    }
    return out;
  }

  if(accGroupSelect){
    accGroupSelect.addEventListener("change", ()=>{
      // 1) ä¾æœ€å°çµ±è¨ˆå€é‚Šç•Œç¯©é¸äº‹æ•…
      accidentFeatures = filterAccidentsByMinZoneLabel(accGroupSelect.value);
      // 2) ä¾ç¯©é¸å¾Œè³‡æ–™é‡å»ºæœˆä»½è»¸ + æŠ˜ç·šåœ– + é»ä½
      refreshAccidentUI();
    });
  }

  // å³ä¸‹è§’åœ–å±¤é–‹é—œï¼šäº¤é€šäº‹æ•…
  if(accToggleTop){
    accToggleTop.addEventListener("change", async (e)=>{
      const isMapOnly = document.body.classList.contains("map-only");
      if(isMapOnly){
        accidentLayer.visible = false;
        return;
      }
      const on = !!e.target.checked;
      if(on && !accidentLoaded) await loadAccidents();
      accidentLayer.visible = on;
      if(on){
        const idx = parseInt(accTimeSlider?.value || "0",10);
        renderAccidentPoints(idx);
      }else{
        accidentLayer.removeAll();
      }
    });
  }

/* ========= å…¬è»Šç³»çµ± ========= */
  let routeInfo = {};
  let routeStopsMap = {};
  let etaMap = {};
  let nearStopByPlate = {};
  let nearStopUIDSet = new Set();

  let selectedRouteUID = "";
  let selectedDir = 0;

  let lastActiveStopUID = null;
  let lastActiveBusPlate = null;

  const etaKey = (stopUID, routeUID, dir) => `${stopUID}_${routeUID}_${dir}`;
  function fmtETA(obj){
    if(!obj) return "â€”";
    if(typeof obj.EstimateTime === "number"){
      const min = Math.ceil(obj.EstimateTime / 60);
      if(min <= 0) return "é€²ç«™ä¸­";
      return `${min} åˆ†é˜`;
    }
    if(obj.NextBusTime){
      const now = new Date();
      const t = new Date(obj.NextBusTime);
      if(!isNaN(t.getTime())){
        const diffMin = Math.ceil((t - now) / 60000);
        if(diffMin <= 0) return "é€²ç«™ä¸­";
        return `${diffMin} åˆ†é˜`;
      }
    }
    return "â€”";
  }

  /* Tab åˆ‡æ› */
    /* âœ… é¢æ¿åˆ‡æ›ï¼šè·¯ç·šç«™åºï¼ˆå…§å«ï¼šç«™åº/å³æ™‚å…¬è»Šï¼‰ â†” äº‹æ•… */
    const tabBusModule = document.getElementById("tabBusModule");
    const tabAcc  = document.getElementById("tabAcc");

    const busSubTabbar = document.getElementById("busSubTabbar");
    const tabStops = document.getElementById("tabStops");
    const tabBuses = document.getElementById("tabBuses");

    const pageStops    = document.getElementById("pageStops");
    const pageBuses    = document.getElementById("pageBuses");
    const pageAccident = document.getElementById("pageAccident");

    // ç«™åºé é¢ä¸Šæ–¹ï¼šè·¯ç·šé¸æ“‡ï¼ˆä¸­å£¢åˆ°æ¡ƒåœ’é‚£ä¸€åˆ—ï¼‰
    const routeToolsBar = document.querySelector("#pageStops .panel-tools");


    const panelTitle = document.getElementById("panelTitle");
    const panelHint  = document.getElementById("panelHint");
    const busLegend  = document.getElementById("busLegend");

    function showStopsTab(){
      if(panelHint) panelHint.style.display = "";
      tabStops.classList.add("active");
      tabBuses.classList.remove("active");
      pageStops.style.display = "flex";
      if(routeToolsBar) routeToolsBar.style.display = "flex";
      pageBuses.style.display = "none";
      if(panelTitle) panelTitle.textContent = "ğŸšŒ å…¬è»Šé¢æ¿";
      if(busLegend) busLegend.style.display = "";
      if(panelHint) panelHint.style.display = "";
      try{ updateRouteHint(); }catch(e){}
    }
    function showBusesTab(){
      tabBuses.classList.add("active");
      tabStops.classList.remove("active");
      pageBuses.style.display = "flex";
      if(routeToolsBar) routeToolsBar.style.display = "none";

      // âœ… åˆ‡åˆ°ã€Œäº‹æ•…ã€åˆ†é ï¼šä¸Šæ–¹å³å´ä¸é¡¯ç¤ºèµ·è¨–é»
      if(panelHint) panelHint.style.display = "none";
      pageStops.style.display = "none";
      if(panelTitle) panelTitle.textContent = "ğŸšŒ å³æ™‚å…¬è»Š";
      if(busLegend) busLegend.style.display = "";
      if(panelHint) panelHint.style.display = "";
      if(panelHint) panelHint.textContent = `æ›´æ–°ï¼š${new Date().toLocaleTimeString()}`;
    }

    function showBusModule(){
      // âœ… å›åˆ°å…¬è»Šæ¨¡çµ„ï¼šæ¢å¾©é¡¯ç¤ºèµ·è¨–é»
      if(panelHint) panelHint.style.display = "";
      tabBusModule.classList.add("active");
      tabAcc.classList.remove("active");
      if(busSubTabbar) busSubTabbar.style.display = "";
      pageAccident.style.display = "none";
      // ä¾ç›®å‰å­åˆ†é ç‹€æ…‹é¡¯ç¤º
      if(tabBuses.classList.contains("active")){
        showBusesTab();
      }else{
        showStopsTab();
      }
    }

    function showAccTab(){
      tabAcc.classList.add("active");
      tabBusModule.classList.remove("active");
      if(busSubTabbar) busSubTabbar.style.display = "none";
      pageAccident.style.display = "flex";
      pageStops.style.display = "none";
      pageBuses.style.display = "none";
      if(panelTitle) panelTitle.textContent = "ğŸš§ äº¤é€šäº‹æ•…";
      if(busLegend) busLegend.style.display = "none";

      if(routeToolsBar) routeToolsBar.style.display = "none";

      // âœ… åˆ‡åˆ°ã€Œäº‹æ•…ã€åˆ†é ï¼šä¸Šæ–¹å³å´ä¸é¡¯ç¤ºèµ·è¨–é»
      if(panelHint) panelHint.style.display = "none";

      try{ refreshAccidentUI(); }catch(e){}

      // åˆ‡åˆ°äº‹æ•…æ™‚ï¼šè‡ªå‹•è¼‰å…¥ + è®“é»ä½ä¾ç¸½é–‹é—œæ±ºå®šé¡¯ç¤º
      try{
        if(accToggleTop && !accToggleTop.checked){
          accToggleTop.checked = true;
        }
        if(!accidentLoaded) loadAccidents();
        accidentLayer.visible = !!accToggleTop.checked;
      }catch(e){}
    }

    // å¤–å±¤åˆ‡æ›ï¼ˆå…©å€‹ï¼‰
    tabBusModule.onclick = ()=>{ showBusModule(); };
    tabAcc.onclick = ()=>{ showAccTab(); };

    // å…§å±¤åˆ‡æ›ï¼ˆç«™åº / å³æ™‚å…¬è»Šï¼‰
    tabStops.onclick = ()=>{ showStopsTab(); };
    tabBuses.onclick = ()=>{ showBusesTab(); };

  /* è‡ªè¨‚å½ˆè·³è¦–çª— */
  const popupEl = document.getElementById("floatingPopup");
  const popTitleEl = document.getElementById("popTitle");
  const popBodyEl = document.getElementById("popBody");

  let popupWorldPoint = null;

  function hideFloatingPopup(){
    popupEl.style.display = "none";
    popupWorldPoint = null;
  }
  function showFloatingPopup(view, worldPoint, title, html){
    popupWorldPoint = worldPoint;
    popTitleEl.textContent = title;
    popBodyEl.innerHTML = html;
    popupEl.style.display = "block";
    updateFloatingPopupPosition(view);
  }
  function updateFloatingPopupPosition(view){
    if(!popupWorldPoint) return;
    const sp = view.toScreen(popupWorldPoint);
    if(!sp) return;

    const x = sp.x;
    const y = sp.y - 14;

    popupEl.style.left = x + "px";
    popupEl.style.top  = y + "px";
    popupEl.style.transform = "translate(-50%, -100%)";

    const rect = popupEl.getBoundingClientRect();
    const pad = 10;
    let dx = 0, dy = 0;
    if(rect.left < pad) dx = pad - rect.left;
    if(rect.right > window.innerWidth - pad) dx = (window.innerWidth - pad) - rect.right;
    if(rect.top < pad) dy = pad - rect.top;
    if(rect.bottom > window.innerHeight - pad) dy = (window.innerHeight - pad) - rect.bottom;
    if(dx || dy){
      popupEl.style.left = (x + dx) + "px";
      popupEl.style.top  = (y + dy) + "px";
    }
  }

  document.getElementById("popCloseBtn").onclick = ()=> {
    // é—œé–‰äººå£å¤§é¢æ¿ï¼šå›åˆ°åˆå§‹è¦–è§’/å–æ¶ˆé«˜äº®
    resetViewAndHighlight();

    // âœ… é—œé–‰äººå£å¤§é¢æ¿å¾Œï¼Œå°é¢æ¿å¼·åˆ¶å›åˆ°ã€Œäººå£ç¸½æ•¸æŠ˜ç·šåœ–ã€åˆå§‹ç‹€æ…‹
    try{
      if (typeof updatePopulationChartTotal === "function" && Array.isArray(allFeatures) && allFeatures.length){
        updatePopulationChartTotal(allFeatures);
      }
    }catch(e){}
  };

  /* å…¬è»Šåœ–å±¤ */
  const stopsLayer = new GraphicsLayer();
  const busesLayer = new GraphicsLayer();
  map.addMany([stopsLayer, busesLayer]);


  /* äº¤é€šäº‹æ•…åœ–å±¤ï¼ˆæ™‚é–“è»¸ï¼‰ */
  const accidentLayer = new GraphicsLayer();
  map.add(accidentLayer);


// ===== CORS è®€å–è¼”åŠ©ï¼ˆGitHub Releases æœƒæ“‹ CORSï¼‰=====
async function __fetchJsonSmart(url){
  // 1) ç›´é€£
  try{
    const r = await fetch(url, { cache: "no-store" });
    if(r.ok) return await r.json();
  }catch(e){}

  // 2) AllOriginsï¼ˆå¸¸ç”¨ CORS proxyï¼‰
  const p1 = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
  try{
    const r = await fetch(p1, { cache: "no-store" });
    if(r.ok) return await r.json();
  }catch(e){}

  // 3) isomorphic-git CORS proxyï¼ˆå‚™æ´ï¼‰
  const p2 = "https://cors.isomorphic-git.org/" + url;
  try{
    const r = await fetch(p2, { cache: "no-store" });
    if(r.ok) return await r.json();
  }catch(e){}

  throw new Error("JSON ä¸‹è¼‰å¤±æ•—ï¼ˆå¯èƒ½è¢« CORS é˜»æ“‹ï¼‰");
}

// âœ… å®œå±…åˆ†æ•¸ç”¨ï¼šäº¤é€šäº‹æ•…è³‡æ–™ï¼ˆåªè¨ˆç®—ã€ä¸å±•ç¤ºï¼‰
const ACCIDENT_GEOJSON_URL = "https://jade0815.github.io/data/113äº¤é€šäº‹æ•…å°æªœæºª.geojson";
let __accidentPts4326 = null;   // Array<Point> in wkid 4326

async function __fetchJsonWithFallback(url){
  const candidates = [
    url,
    "https://api.allorigins.win/raw?url=" + encodeURIComponent(url),
    "https://r.jina.ai/http://" + url.replace(/^https?:\/\//, ""),
    "https://r.jina.ai/https://" + url.replace(/^https?:\/\//, "")
  ];
  for(const u of candidates){
    try{
      const res = await fetch(u, { cache: "no-store" });
      if(!res.ok) continue;
      // allorigins/jina may return text; parse robustly
      const text = await res.text();
      try{
        return JSON.parse(text);
      }catch(_){
        // Some proxies may wrap; try to locate first '{' or '['
        const idxObj = text.indexOf('{');
        const idxArr = text.indexOf('[');
        const idx = (idxObj === -1) ? idxArr : (idxArr === -1 ? idxObj : Math.min(idxObj, idxArr));
        if(idx >= 0){
          const sliced = text.slice(idx).trim();
          return JSON.parse(sliced);
        }
      }
    }catch(e){
      // try next
    }
  }
  throw new Error("ç„¡æ³•å–å¾—äº‹æ•… GeoJSONï¼ˆå¯èƒ½è¢« CORS æ“‹æˆ–ç¶²å€ä¸å­˜åœ¨ï¼‰");
}

async function __loadAccidentsForScoreOnce(){
  if(__accidentPts4326) return __accidentPts4326;
  try{
    const gj = await __fetchJsonWithFallback(ACCIDENT_GEOJSON_URL);
    const feats = Array.isArray(gj.features) ? gj.features : [];
    const pts = [];
    for(const f of feats){
      const g = f.geometry;
      if(!g || g.type !== "Point" || !Array.isArray(g.coordinates)) continue;
      const lon = g.coordinates[0], lat = g.coordinates[1];
      if(!Number.isFinite(lon) || !Number.isFinite(lat)) continue;
      pts.push(new Point({ longitude: lon, latitude: lat }));
    }
    __accidentPts4326 = pts;
    return __accidentPts4326;
  }catch(e){
    console.error("äº‹æ•…è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ˆå®œå±…åˆ†æ•¸ï¼‰", e);
    __accidentPts4326 = [];
    return __accidentPts4326;
  }
}


function __toWM(geom){
  if(!geom) return null;
  try{
    const wkid = geom.spatialReference && geom.spatialReference.wkid;
    if(wkid === 102100 || wkid === 3857) return geom;
    if(wkid === 4326) return webMercatorUtils.geographicToWebMercator(geom);
    return geom;
  }catch(e){
    return geom;
  }
}

function __countLayerPointsIn(polyWM, layer, filterFn){
  if(!polyWM || !layer) return 0;
  let c = 0;
  layer.graphics.forEach(g=>{
    if(!g || !g.geometry || g.geometry.type !== "point") return;
    if(filterFn && !filterFn(g)) return;
    const ptWM = __toWM(g.geometry);
    try{ if(ptWM && geometryEngine.contains(polyWM, ptWM)) c++; }catch(e){}
  });
  return c;
}

  const stopGraphics = {};
  const busGraphics  = {};

  const busToggle = document.getElementById("busToggle");

  function stopSymbol(mode){
    let size = 18;
    if(mode === "near") size = 24;
    if(mode === "active") size = 34;
    return {
      type: "point-3d",
      symbolLayers: [{
        type: "icon",
        resource: { href: ICON_STOP },
        size,
        billboardMode: "face-camera",
        verticalOffset: { screenLength: 6, maxWorldLength: 30, minWorldLength: 3 }
      }]
    };
  }

  function busSymbol(direction, mode="normal"){
    const href = direction === 0 ? ICON_BUS_DIR0 : ICON_BUS_DIR1;
    const size = (mode === "active") ? 44 : 32;
    return {
      type: "point-3d",
      symbolLayers: [{
        type: "icon",
        resource: { href },
        size,
        billboardMode: "face-camera",
        verticalOffset: { screenLength: 10, maxWorldLength: 40, minWorldLength: 4 }
      }]
    };
  }

  function updateRouteHint(){
    const r = routeInfo[selectedRouteUID];
    if(!r){ panelHint.textContent = "â€”"; return; }
    panelHint.textContent = `${r.DepartureStopNameZh || ""} â†’ ${r.DestinationStopNameZh || ""}`;
  }

  function setDirUI(d){
    selectedDir = d;
    document.getElementById("dir0").classList.toggle("active", d === 0);
    document.getElementById("dir1").classList.toggle("active", d === 1);
  }

  function clearActiveStop(){
    if(!lastActiveStopUID) return;
    const g = stopGraphics[lastActiveStopUID];
    if(g) g.symbol = stopSymbol(nearStopUIDSet.has(lastActiveStopUID) ? "near" : "normal");
    lastActiveStopUID = null;
  }

  function clearActiveBus(){
    if(!lastActiveBusPlate) return;
    const g = busGraphics[lastActiveBusPlate];
    if(g){
      const dir = g.attributes?.Direction ?? 0;
      g.symbol = busSymbol(dir, "normal");
    }
    lastActiveBusPlate = null;
  }

  function applyNearStyles(){
    Object.keys(stopGraphics).forEach(uid=>{
      if(uid === lastActiveStopUID) return;
      stopGraphics[uid].symbol = stopSymbol(nearStopUIDSet.has(uid) ? "near" : "normal");
    });
  }

  function buildRouteSelect(){
    const sel = document.getElementById("routeSelect");
    const uids = Object.keys(routeInfo).sort((a,b)=>{
      const an = routeInfo[a]?.RouteName?.Zh_tw ?? a;
      const bn = routeInfo[b]?.RouteName?.Zh_tw ?? b;
      return an.localeCompare(bn, "zh-Hant");
    });
    sel.innerHTML = "";
    uids.forEach(uid=>{
      const opt = document.createElement("option");
      opt.value = uid;
      opt.textContent = routeInfo[uid]?.RouteName?.Zh_tw ?? uid;
      sel.appendChild(opt);
    });
    if(!selectedRouteUID && uids.length) selectedRouteUID = uids[0];
    sel.value = selectedRouteUID;
  }

  function rebuildStopsLayerForSelected(){
    clearActiveStop();
    stopsLayer.removeAll();
    Object.keys(stopGraphics).forEach(k=>delete stopGraphics[k]);

    const list = routeStopsMap[`${selectedRouteUID}_${selectedDir}`] || [];
    list.forEach(s=>{
      if(!s.StopPosition) return;
      const pt = new Point({
        longitude: s.StopPosition.PositionLon,
        latitude: s.StopPosition.PositionLat
      });
      const g = new Graphic({
        geometry: pt,
        symbol: stopSymbol("normal"),
        attributes: {
          StopUID: s.StopUID,
          StopID: s.StopID,
          StopName: s.StopName?.Zh_tw ?? "",
          StopSequence: s.StopSequence ?? null
        }
      });
      stopsLayer.add(g);
      stopGraphics[s.StopUID] = g;
    });
  }

  function renderRouteStopsPanel(){
    const tbody = document.getElementById("routeStops");
    tbody.innerHTML = "";
    const list = routeStopsMap[`${selectedRouteUID}_${selectedDir}`];

    if(!list || !list.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="3">æ­¤è·¯ç·š/æ–¹å‘æ²’æœ‰ç«™åºè³‡æ–™</td>`;
      tbody.appendChild(tr);
      return;
    }

    const img = document.getElementById("routeImg");
    img.src = routeInfo[selectedRouteUID]?.RouteMapImageUrl || "";
    img.style.display = img.src ? "block" : "none";

    [...list].sort((a,b)=>(a.StopSequence??0)-(b.StopSequence??0)).forEach(s=>{
      const etaObj = etaMap[etaKey(s.StopUID, selectedRouteUID, selectedDir)];
      const tr = document.createElement("tr");
      tr.dataset.stopuid = s.StopUID;
      tr.innerHTML = `
        <td>${s.StopSequence ?? ""}</td>
        <td>${s.StopName?.Zh_tw ?? ""}</td>
        <td>${fmtETA(etaObj)}</td>
      `;
      tr.onclick = ()=> focusStop(s.StopUID);
      tbody.appendChild(tr);
    });
  }

  function setRouteUI(routeUID, dir){
    if(!routeInfo[routeUID]) return;
    selectedRouteUID = routeUID;
    document.getElementById("routeSelect").value = routeUID;
    setDirUI(dir);
    updateRouteHint();
    renderRouteStopsPanel();
    rebuildStopsLayerForSelected();
    applyNearStyles();
  }

  async function focusStop(stopUID){
    if(document.body.classList.contains("map-only")) return;

    const g = stopGraphics[stopUID];
    if(!g) return;

    showStopsTab();

    clearActiveStop();
    lastActiveStopUID = stopUID;
    g.symbol = stopSymbol("active");

    const list = routeStopsMap[`${selectedRouteUID}_${selectedDir}`] || [];
    const s = list.find(x=>x.StopUID === stopUID);
    const etaObj = s ? etaMap[etaKey(s.StopUID, selectedRouteUID, selectedDir)] : null;

    const html = `
      <b>ç«™åï¼š</b>${s?.StopName?.Zh_tw ?? g.attributes.StopName}<br>
      <b>StopUIDï¼š</b>${s?.StopUID ?? ""}<br>
      <b>StopIDï¼š</b>${s?.StopID ?? ""}<br>
      <b>ç«™åºï¼š</b>${s?.StopSequence ?? ""}<br>
      <b>é ä¼°æ™‚é–“ï¼š</b>${fmtETA(etaObj)}
    `;

    await view.goTo({ target: g.geometry, zoom: 17, tilt: 65 }, { duration: 150 });
    showFloatingPopup(view, g.geometry, "ç«™ç‰Œè³‡è¨Š", html);
  }

  async function focusBusGraphic(g){
    if(document.body.classList.contains("map-only")) return;

    const a = g.attributes || {};

    if (a.RouteUID) {
      showStopsTab();
      setRouteUI(a.RouteUID, a.Direction ?? 0);
    }

    clearActiveBus();
    lastActiveBusPlate = a.PlateNumb || null;
    g.symbol = busSymbol(a.Direction ?? 0, "active");

    const html = `
      <b>è·¯ç·šï¼š</b>${a.RouteName ?? ""}<br>
      <b>è»Šç‰Œï¼š</b>${a.PlateNumb ?? ""}<br>
      <b>æ–¹å‘ï¼š</b>${(a.Direction===0)?'å»ç¨‹':'è¿”ç¨‹'}<br>
      <b>é€Ÿåº¦ï¼š</b>${a.Speed ?? 0} km/h<br>
      <b>è³‡æ–™æ›´æ–°ï¼š</b>${a.UpdateTime ?? "â€”"}<br>
      <b>ä¸‹ä¸€ç«™ï¼š</b>${a.NextStopName ?? "â€”"}<br>
      <b>é ä¼°æ™‚é–“ï¼š</b>${a.ETA ?? "â€”"}
    `;

    await view.goTo({ target: g.geometry, zoom: 17, tilt: 65 }, { duration: 150 });
    showFloatingPopup(view, g.geometry, "å…¬è»Šè³‡è¨Š", html);
  }

  function updateBusesLayerAndPanel(buses){
    const tb = document.getElementById("busTable");
    tb.innerHTML = "";

    const alive = new Set();

    buses.forEach(b=>{
      if(!b.BusPosition || !b.PlateNumb) return;

      alive.add(b.PlateNumb);

      const near = nearStopByPlate[b.PlateNumb];
      const etaObj = near ? etaMap[etaKey(near.StopUID, b.RouteUID, b.Direction)] : null;
      const etaText = fmtETA(etaObj);

      const pt = new Point({
        longitude: b.BusPosition.PositionLon,
        latitude: b.BusPosition.PositionLat
      });

      let g = busGraphics[b.PlateNumb];
      if(!g){
        g = new Graphic({ geometry: pt, symbol: busSymbol(b.Direction, "normal"), attributes: {} });
        busesLayer.add(g);
        busGraphics[b.PlateNumb] = g;
      } else {
        g.geometry = pt;
        const isActive = (lastActiveBusPlate === b.PlateNumb);
        g.symbol = busSymbol(b.Direction, isActive ? "active" : "normal");
      }

      g.attributes = {
        PlateNumb: b.PlateNumb,
        RouteUID: b.RouteUID,
        RouteName: b.RouteName?.Zh_tw ?? "",
        Direction: b.Direction,
        Speed: b.Speed ?? 0,
        UpdateTime: b.UpdateTime ?? "â€”",
        NextStopName: near?.StopName?.Zh_tw ?? "â€”",
        ETA: etaText
      };

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="route-link">${b.RouteName?.Zh_tw ?? "â€”"}</span></td>
        <td>${b.PlateNumb}</td>
        <td><span class="badge ${b.Direction===0?'dir0':'dir1'}">${b.Direction===0?'å»ç¨‹':'è¿”ç¨‹'}</span></td>
        <td>${near?.StopName?.Zh_tw ?? "â€”"}</td>
        <td>${etaText}</td>
      `;

      tr.querySelector(".route-link").onclick = (ev)=>{
        ev.stopPropagation();
        if(document.body.classList.contains("map-only")) return;
        if(b.RouteUID){
          showStopsTab();
          setRouteUI(b.RouteUID, b.Direction ?? 0);
        }
      };

      tr.onclick = async ()=>{
        if(document.body.classList.contains("map-only")) return;
        await focusBusGraphic(g);
      };

      tb.appendChild(tr);
    });

    Object.keys(busGraphics).forEach(plate=>{
      if(!alive.has(plate)){
        busesLayer.remove(busGraphics[plate]);
        delete busGraphics[plate];
      }
    });

    if(pageBuses.style.display !== "none"){
      panelHint.textContent = `æ›´æ–°ï¼š${new Date().toLocaleTimeString()}`;
    }
  }

  async function loadStaticOnce(){
    const [routes, stopOfRoute] = await Promise.all([
      api("https://tdx.transportdata.tw/api/basic/v2/Bus/Route/City/Taoyuan?$format=JSON"),
      api("https://tdx.transportdata.tw/api/basic/v2/Bus/StopOfRoute/City/Taoyuan?$format=JSON")
    ]);

    routeInfo = {};
    routes.forEach(r=> routeInfo[r.RouteUID] = r);

    routeStopsMap = {};
    stopOfRoute.forEach(r=>{
      routeStopsMap[`${r.RouteUID}_${r.Direction}`] = r.Stops || [];
    });

    buildRouteSelect();
    updateRouteHint();
    renderRouteStopsPanel();
    rebuildStopsLayerForSelected();
  }

  async function loadDynamic(){
    const [buses, nearStops, etaData] = await Promise.all([
      api("https://tdx.transportdata.tw/api/basic/v2/Bus/RealTimeByFrequency/City/Taoyuan?$format=JSON"),
      api("https://tdx.transportdata.tw/api/basic/v2/Bus/RealTimeNearStop/City/Taoyuan?$format=JSON"),
      api("https://tdx.transportdata.tw/api/basic/v2/Bus/EstimatedTimeOfArrival/City/Taoyuan?$format=JSON")
    ]);

    nearStopByPlate = {};
    nearStopUIDSet = new Set();
    nearStops.forEach(n=>{
      if(n.PlateNumb) nearStopByPlate[n.PlateNumb] = n;
      if(n.StopUID) nearStopUIDSet.add(n.StopUID);
    });

    etaMap = {};
    etaData.forEach(e=>{
      if(e.StopUID && e.RouteUID){
        etaMap[etaKey(e.StopUID, e.RouteUID, e.Direction)] = e;
      }
    });

    renderRouteStopsPanel();
    applyNearStyles();
    updateBusesLayerAndPanel(buses);

    if(pageStops.style.display !== "none"){
      updateRouteHint();
    }
  }

  document.getElementById("routeSelect").onchange = (e)=>{
    if(document.body.classList.contains("map-only")) return;
    selectedRouteUID = e.target.value;
    updateRouteHint();
    renderRouteStopsPanel();
    rebuildStopsLayerForSelected();
    applyNearStyles();
    hideFloatingPopup();
  };
  document.getElementById("dir0").onclick = ()=>{
    if(document.body.classList.contains("map-only")) return;
    setDirUI(0);
    updateRouteHint();
    renderRouteStopsPanel();
    rebuildStopsLayerForSelected();
    applyNearStyles();
    hideFloatingPopup();
  };
  document.getElementById("dir1").onclick = ()=>{
    if(document.body.classList.contains("map-only")) return;
    setDirUI(1);
    updateRouteHint();
    renderRouteStopsPanel();
    rebuildStopsLayerForSelected();
    applyNearStyles();
    hideFloatingPopup();
  };

  view.on("click", async (event)=>{
    if(document.body.classList.contains("map-only")) return;

    const hit = await view.hitTest(event);
    if(!hit.results?.length) return;

    const stopHit = hit.results.find(r => r.graphic?.layer === stopsLayer);
    if(stopHit){
      const uid = stopHit.graphic.attributes?.StopUID;
      if(uid) await focusStop(uid);
      return;
    }
    const busHit = hit.results.find(r => r.graphic?.layer === busesLayer);
    if(busHit){
      await focusBusGraphic(busHit.graphic);
      return;
    }
  });

  view.watch("camera", ()=> updateFloatingPopupPosition(view));
  window.addEventListener("resize", ()=> updateFloatingPopupPosition(view));

  /* ====== å…¬è»Šï¼šæ¢å¾©åŸè¦–è§’ï¼†å¤§å° ====== */
  function resetViewAndHighlight(){
    clearActiveStop();
    clearActiveBus();
    hideFloatingPopup();
    view.goTo(initialCamera, { duration: 220 });
  }

  /* =========================
     âœ… æ¨¡å¼åˆ‡æ›ï¼šåªæœ‰åœ°åœ– â†” å…¬è»Š/äº¤é€šä»‹é¢
     ========================= */
  const modeBtn = document.getElementById("uiModeToggle");
  /* =========================================================
     âœ… äº¤é€šé–‹/é—œï¼šåªé é€™ä¸€å¥—ï¼ˆä¸å†ä½¿ç”¨ toggle å›å‚³å€¼åˆ¤æ–·ï¼‰
     - é è¨­ï¼šäº¤é€šé—œé–‰ï¼ˆbody æœ‰ map-onlyï¼‰
     - æŒ‰éˆ•ï¼šé–‹å•Ÿäº¤é€š / é—œé–‰äº¤é€š
     ========================================================= */
  function closeTrafficUI(){
  // âœ… é—œé–‰äº¤é€šæ™‚ä¹Ÿé—œé–‰äº¤é€šæµé‡åœ–å±¤
  try { document.getElementById("trafficToggle").checked = false; } catch(e){}
  try { setTrafficVisible(false); } catch(e){}

    document.body.classList.add("map-only");

    // åœ–å±¤
    try { stopsLayer.visible = false; } catch(e){}
    try { busesLayer.visible = false; } catch(e){}
    try { youBikeLayer.visible = false; } catch(e){}
    try { evLayer.visible = false; } catch(e){}

    try { accidentLayer.visible = false; } catch(e){}
    
    try { trafficLayer.visible = false; } catch(e){}
    try { const tcb = document.getElementById("trafficToggle"); if(tcb) tcb.checked = false; } catch(e){}
// é¢æ¿/æŒ‰éˆ•
    const idsHide = ["panelCombined","yRightPanel","evRightPanel","pRightPanel","infoPanel","evInfoPanel","pInfoPanel","floatingPopup","modeToggleBtn","parkingModeBtn"];
    idsHide.forEach(id => { const el=document.getElementById(id); if(el) el.style.display="none"; });

    
    // âœ… äº¤é€šå·¥å…·æŒ‰éˆ•ï¼ˆCCTV / CMSï¼‰é—œé–‰
    try { const cctvBtn = document.getElementById("cctv-toggle-btn"); if (cctvBtn) cctvBtn.style.display = "none"; } catch(e){}
    try { const cmsBtn  = document.getElementById("cms-toggle-btn");  if (cmsBtn)  cmsBtn.style.display  = "none"; } catch(e){}
    try { const cmsPop  = document.getElementById("cms-popup");       if (cmsPop)  cmsPop.style.display  = "none"; } catch(e){}
    try { const cctvPan = document.getElementById("cctv-panel");      if (cctvPan) cctvPan.style.display = "none"; } catch(e){}
// åœ–å±¤é¢æ¿ï¼ˆé»ä½é–‹é—œï¼‰
    if (typeof layerPanel !== "undefined" && layerPanel) layerPanel.style.display = "none";
    if (typeof layerPanelToggle !== "undefined" && layerPanelToggle) layerPanelToggle.style.display = "none";

    // ç”Ÿæ´»åœˆ/è‡ªè¨‚ç¯„åœ UI é¡¯ç¤º
    if (typeof livabilityUIRoot !== "undefined" && livabilityUIRoot) livabilityUIRoot.style.display = "block";

    // æŒ‰éˆ•æ–‡å­—
    if (typeof modeBtn !== "undefined" && modeBtn) modeBtn.textContent = "é–‹å•Ÿäº¤é€šä»‹é¢";

    // æ”¶æ‰å…¬è»Šè‡ªè¨‚å½ˆçª—ï¼ˆè‹¥æœ‰ï¼‰
    try { hideFloatingPopup(); } catch(e){}
  }

  function openTrafficUI(){
    document.body.classList.remove("map-only");


    // âœ… é¡¯ç¤ºäº¤é€šå·¥å…·æŒ‰éˆ•ï¼ˆCCTV / CMSï¼‰
    try { const cctvBtn = document.getElementById("cctv-toggle-btn"); if (cctvBtn) cctvBtn.style.display = "block"; } catch(e){}
    try { const cmsBtn  = document.getElementById("cms-toggle-btn");  if (cmsBtn)  cmsBtn.style.display  = "flex"; } catch(e){}

    // ç”Ÿæ´»åœˆ/è‡ªè¨‚ç¯„åœ UI éš±è—
    if (typeof livabilityUIRoot !== "undefined" && livabilityUIRoot) livabilityUIRoot.style.display = "none";

    // å…¬è»Šåœ–å±¤ï¼šä¾ busToggle
    const busOn = (typeof busToggle !== "undefined" && busToggle) ? !!busToggle.checked : true;
    try { stopsLayer.visible = busOn; } catch(e){}
    try { busesLayer.visible = busOn; } catch(e){}

    // YouBike/EVï¼šä¾é ‚éƒ¨é–‹é—œ
    const yOn = (typeof yToggleTop !== "undefined" && yToggleTop) ? !!yToggleTop.checked : true;
    const evOn = (typeof evToggleTop !== "undefined" && evToggleTop) ? !!evToggleTop.checked : false;
    try { youBikeLayer.visible = yOn; } catch(e){}
    try { evLayer.visible = evOn; } catch(e){}


    const pOn = (typeof pToggleTop !== "undefined" && pToggleTop) ? !!pToggleTop.checked : false;
    try { parkingLayer.visible = pOn; } catch(e){}

    // äº¤é€šäº‹æ•…ï¼šä¾é ‚éƒ¨é–‹é—œ
    const accOn = (typeof accToggleTop !== "undefined" && accToggleTop) ? !!accToggleTop.checked : false;
    try {
      if (accOn && !accidentLoaded) loadAccidents();
      accidentLayer.visible = accOn;
    } catch(e){}
    // é¡¯ç¤ºå…¬è»Šé¢æ¿
    const pc = document.getElementById("panelCombined");
    if (pc) pc.style.display = "flex";

    // é¡¯ç¤º YouBike / EV / åœè»Šå ´ å³å´é¢æ¿ï¼ˆä¾ currentModeï¼‰
    const yPanel = document.getElementById("yRightPanel");
    const evPanel = document.getElementById("evRightPanel");
    const pPanel = document.getElementById("pRightPanel");
    if (typeof currentMode !== "undefined" && currentMode === "ev") {
      if (evPanel) evPanel.style.display = "flex";
      if (yPanel) yPanel.style.display = "none";
      if (pPanel) pPanel.style.display = "none";
    } else if (typeof currentMode !== "undefined" && currentMode === "parking") {
      if (pPanel) pPanel.style.display = "flex";
      if (yPanel) yPanel.style.display = "none";
      if (evPanel) evPanel.style.display = "none";
    } else {
      if (yPanel) yPanel.style.display = "flex";
      if (evPanel) evPanel.style.display = "none";
      if (pPanel) pPanel.style.display = "none";
    }

    // é¡¯ç¤º YouBike/EV æ¨¡å¼åˆ‡æ›æŒ‰éˆ•
    const mtb = document.getElementById("modeToggleBtn");
    if (mtb) mtb.style.display = "block";
    const pmb = document.getElementById("parkingModeBtn");
    if (pmb) pmb.style.display = "block";

    // é¡¯ç¤ºåœ–å±¤é¢æ¿åˆ‡æ›æŒ‰éˆ•ï¼ˆä½ èªªè¦ä¿ç•™ã€Œé–‹å•Ÿ/é—œé–‰äº¤é€šã€å°±å¥½ï¼Œå¯è‡ªè¡Œæ”¹æˆ noneï¼‰
    if (typeof layerPanelToggle !== "undefined" && layerPanelToggle) layerPanelToggle.style.display = "block";
    if (typeof layerPanel !== "undefined" && layerPanel) layerPanel.style.display = (typeof layerPanelVisible !== "undefined" && layerPanelVisible) ? "block" : "none";

    // æŒ‰éˆ•æ–‡å­—
    if (typeof modeBtn !== "undefined" && modeBtn) modeBtn.textContent = "é—œé–‰äº¤é€šä»‹é¢";
  }

  const layerPanel = document.getElementById("layerPanel");
  const layerPanelToggle = document.getElementById("layerPanelToggle");
  let mapOnly = false;

  /* å³ä¸‹è§’å°é¢æ¿é–‹é—œ */
  let layerPanelVisible = true;
  layerPanelToggle.onclick = () => {
    layerPanelVisible = !layerPanelVisible;
    layerPanel.style.display = layerPanelVisible ? "block" : "none";
    layerPanelToggle.textContent = layerPanelVisible ? "åœ–å±¤é–‹é—œ" : "åœ–å±¤é–‹é—œ (é—œ)";
  };

  function applyMode(){
    document.body.classList.toggle("map-only", mapOnly);

    if(mapOnly){
      stopsLayer.visible = false;
      busesLayer.visible = false;
      hideFloatingPopup();
      clearActiveStop();
      clearActiveBus();
      modeBtn.textContent = "é–‹å•Ÿäº¤é€šä»‹é¢";
    }else{
      const on = busToggle.checked;
      stopsLayer.visible = on;
      busesLayer.visible = on;
      modeBtn.textContent = "é—œé–‰äº¤é€šä»‹é¢";
    }
  }

  modeBtn.onclick = () => {
    const cam = view.camera.clone();
    const trafficClosedNow = document.body.classList.contains("map-only");

    if (trafficClosedNow) {
      openTrafficUI();
    } else {
      closeTrafficUI();
    }

    // âœ… ä¸è¦äº‚è·³è¦–è§’ï¼šä¿æŒåŸæœ¬ç›¸æ©Ÿ
    requestAnimationFrame(() => {
      view.camera = cam;
      try { updateFloatingPopupPosition(view); } catch(e){}
    });
  };

  busToggle.addEventListener("change", (e)=>{
    const isMapOnly = document.body.classList.contains("map-only");
    if(isMapOnly){
      stopsLayer.visible = false;
      busesLayer.visible = false;
      return;
    }
    const on = e.target.checked;
    stopsLayer.visible = on;
    busesLayer.visible = on;
  });

  /* âœ… è·¯ç·šåœ–æ”¾å¤§åŠŸèƒ½ */
  const routeImgEl = document.getElementById("routeImg");
  const imgModal = document.getElementById("imgModal");
  const imgModalContent = document.getElementById("imgModalContent");
  const imgModalClose = document.getElementById("imgModalClose");

  routeImgEl.addEventListener("click", () => {
    if (!routeImgEl.src) return;
    imgModal.style.display = "block";
    imgModalContent.src = routeImgEl.src;
  });

  imgModalClose.addEventListener("click", () => {
    imgModal.style.display = "none";
  });

  imgModal.addEventListener("click", (e) => {
    if (e.target === imgModal) {
      imgModal.style.display = "none";
    }
  });

  /* ===== åˆå§‹åŒ– ===== */
  view.when(async ()=>{
    loadYouBikeStations();
    await loadStaticOnce();
    await loadDynamic();
    setInterval(loadDynamic, 30000);
busToggle.checked = true;

    // âœ… åˆå§‹åŒ–ï¼šäº¤é€šé—œé–‰ï¼ˆé¿å…å…ˆé¡¯ç¤ºäº¤é€šå†è·³ï¼‰
    closeTrafficUI();

});
/*--------------å…¬å…±--------------*/
const popupDiv = document.getElementById("customPopup");
  
  function __crimePopupHideAndReturn(){
    try{ popupDiv.style.display = "none"; }catch(e){}
    try{
      if(__crimePopupReturnCam){
        view.goTo(__crimePopupReturnCam, { duration: 350 });
      }
    }catch(e){}
  }

/* =========================
   âœ… å®œå±…åˆ†æ•¸ï¼šåˆ¤å®šç­‰ç´š & ç³»çµ±å›æ‡‰ï¼ˆ0-100ï¼‰
   ========================= */
function getScoreLevel(score){
  const s = Number(score) || 0;
  if (s >= 80) return { level:"å„ªè‰¯", color:"ğŸŸ¢", desc:"é é«˜æ–¼æ¡ƒåœ’å€å¹³å‡" };
  if (s >= 60) return { level:"è‰¯å¥½", color:"ğŸŸ¡", desc:"é«˜æ–¼æ¡ƒåœ’å€å¹³å‡" };
  if (s >= 40) return { level:"æ™®é€š", color:"ğŸŸ¡", desc:"æ¥è¿‘æ¡ƒåœ’å€å¹³å‡" };
  if (s >= 20) return { level:"éœ€æ”¹å–„", color:"ğŸŸ ", desc:"ä½æ–¼æ¡ƒåœ’å€å¹³å‡" };
  return { level:"å±éšªï¼ä¸è¶³", color:"ğŸ”´", desc:"é ä½æ–¼æ¡ƒåœ’å€å¹³å‡" };
}


function getTotalLivabilityAssessment(score){
  const s = Math.max(0, Math.min(100, Number(score) || 0));

  if (s >= 90) {
    return {
      level: "ğŸŒŸè¶…ç´šå®œå±…",
      color: "ğŸŸ¢",
      desc: "å„é¢å‘çš†å„ªï¼Œ15åˆ†é˜åŸå¸‚å…¸ç¯„",
      detail: "æ²»å®‰ã€äº¤é€šå®‰å…¨ã€ç½å®³é¢¨éšªã€å…¬å…±è¨­æ–½ã€é†«ç™‚ã€æ•™è‚²èˆ‡åŸºç¤è¨­æ–½çš†é”é«˜æ°´æº–ï¼Œç”Ÿæ´»æ©Ÿèƒ½å®Œæ•´ã€é€šå‹¤èˆ‡ç…§è­·å‹å–„ï¼Œé©åˆå®¶åº­ã€é•·è€…èˆ‡è‚²å…’æ—ç¾¤é•·æœŸå®šå±…ã€‚"
    };
  }
  if (s >= 80) {
    return {
      level: "ğŸ†é«˜å®œå±…",
      color: "ğŸŸ¢",
      desc: "ç¶œåˆè¡¨ç¾å„ªç•°ï¼Œå°‘æ•¸é¢å‘éœ€å¾®èª¿",
      detail: "å¤šæ•¸æŒ‡æ¨™æ˜é¡¯å„ªæ–¼æ¡ƒåœ’å€å¹³å‡ï¼Œç”Ÿæ´»æ©Ÿèƒ½æˆç†Ÿã€å±…ä½å“è³ªç©©å®šï¼Œåƒ…å°‘æ•¸é¢å‘ä»æœ‰å¾®å¹…æ”¹å–„ç©ºé–“ã€‚ç”Ÿæ´»æ©Ÿèƒ½å®Œå–„ï¼Œé€šå‹¤ã€é†«ç™‚èˆ‡å…¬å…±æœå‹™å–å¾—å®¹æ˜“ï¼Œå¼·çƒˆæ¨è–¦ä½œç‚ºä¸»è¦å±…ä½å€åŸŸã€‚å»ºè­°é‡å°è¼ƒå¼±é¢å‘åšè£œå¼·ï¼Œå¯é€²ä¸€æ­¥æå‡æ•´é«”å®œå±…æ€§ã€‚"
    };
  }
  if (s >= 70) {
    return {
      level: "âœ…å®œå±…",
      color: "ğŸŸ¡",
      desc: "å¤§å¤šæ•¸é¢å‘é”æ¨™ï¼Œå°‘æ•¸éœ€æ”¹å–„",
      detail: "åŸºæœ¬ç”Ÿæ´»åœˆæ¢ä»¶è‰¯å¥½ï¼Œé©åˆä¸€èˆ¬å®¶åº­èˆ‡ä¸Šç­æ—ã€‚è‹¥èƒ½å¢åŠ é—œéµè¨­æ–½å¯†åº¦æˆ–æ”¹å–„é€šå‹¤/åœè»Šä¾¿åˆ©æ€§ï¼Œæ•´é«”é«”é©—æœƒæ›´å®Œæ•´ã€‚"
    };
  }
  if (s >= 60) {
    return {
      level: "âš ï¸æ™®é€šå®œå±…",
      color: "ğŸŸ¡",
      desc: "åŸºæœ¬éœ€æ±‚å¯æ»¿è¶³ï¼Œä½†æœ‰æ˜é¡¯çŸ­æ¿",
      detail: "å±…ä½æ¢ä»¶å°šå¯ï¼Œä½†åœ¨å…¬å…±è¨­æ–½ã€é†«ç™‚è³‡æºæˆ–äº¤é€šå®‰å…¨ç­‰é¢å‘å¯èƒ½å‡ºç¾ä¸è¶³æˆ–ä¸å‡ã€‚å»ºè­°ä¾è‡ªèº«éœ€æ±‚ï¼ˆå°±å­¸ã€å°±é†«ã€é€šå‹¤ï¼‰å¯©æ…è©•ä¼°ã€‚"
    };
  }
  if (s >= 50) {
    return {
      level: "ğŸŸ ä½å®œå±…",
      color: "ğŸŸ ",
      desc: "å¤šé¢å‘ä¸è¶³ï¼Œè¼ƒä¸åˆ©é•·æœŸå±…ä½",
      detail: "ç”Ÿæ´»æ©Ÿèƒ½èˆ‡å®‰å…¨/æœå‹™è³‡æºå¯èƒ½ä¸è¶³ï¼Œå°å®¶åº­ã€é•·è€…èˆ‡å­¸é½¡å…’ç«¥ç›¸å°ä¸å‹å–„ã€‚è¼ƒé©åˆçŸ­æœŸå±…ä½ã€é€šå‹¤æ—æˆ–æœ‰ç‰¹å®šéœ€æ±‚æ—ç¾¤ã€‚"
    };
  }
  if (s >= 40) {
    return {
      level: "ğŸš¨ä¸å®œå±…",
      color: "ğŸ”´",
      desc: "ç”Ÿæ´»å“è³ªæ˜é¡¯ä½æ–¼å¹³å‡",
      detail: "å¯èƒ½å­˜åœ¨æ²»å®‰ã€äº¤é€šäº‹æ•…æˆ–ç½å®³é¢¨éšªç­‰æ˜é¡¯å•é¡Œï¼Œä¸”å…¬å…±æœå‹™ä¾›çµ¦ä¸è¶³ã€‚å»ºè­°å„ªå…ˆæ”¹å–„å¼±é …å¾Œï¼Œå†è©•ä¼°é•·æœŸå±…ä½ã€‚"
    };
  }
  return {
    level: "âŒåš´é‡ä¸å®œå±…",
    color: "ğŸ”´",
    desc: "å­˜åœ¨é‡å¤§ç”Ÿæ´»é¢¨éšªï¼Œä¸å»ºè­°å±…ä½",
    detail: "æ•´é«”æ¢ä»¶ä¸è¶³ï¼Œå¯èƒ½åŒæ™‚é¢è‡¨é«˜é¢¨éšªèˆ‡è³‡æºåŒ±ä¹ã€‚å»ºè­°é¿å…ä½œç‚ºå±…ä½é¸å€ï¼Œé™¤éå·²å®Œæˆæ˜ç¢ºæ”¹å–„èˆ‡é¢¨éšªæ§ç®¡ã€‚"
  };
}


const livabilityMessages = {
  stability: [
    [80,"ğŸŸ¢ æ¥µç©©å®š","ç”Ÿæ´»åœˆæ•´é«”å®‰å…¨ç©©å®šï¼Œæ²»å®‰ã€äº¤é€šã€ç½å®³é˜²è­·çš†å„ªæ–¼æ¡ƒåœ’å€å¹³å‡ï¼Œé©åˆå®¶åº­å±…ä½ã€‚"],
    [60,"ğŸŸ¡ ç©©å®š","ç”Ÿæ´»åœˆå®‰å…¨ç©©å®šï¼Œå¤§å¤šæ•¸é¢å‘å„ªæ–¼å¹³å‡ï¼Œé©åˆä¸€èˆ¬å±…ä½ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","ç”Ÿæ´»åœˆå®‰å…¨æ™®é€šï¼Œèˆ‡æ¡ƒåœ’å€å¹³å‡æ°´æº–ç›¸ç•¶ï¼Œå»ºè­°æŒçºŒé—œæ³¨ã€‚"],
    [20,"ğŸŸ  ä¸ç©©å®š","ç”Ÿæ´»åœˆç©©å®šæ€§åä½ï¼Œå»ºè­°åŠ å¼·æ²»å®‰æˆ–äº¤é€šå®‰å…¨ç®¡ç†ã€‚"],
    [0 ,"ğŸ”´ é«˜é¢¨éšª","ç”Ÿæ´»åœˆç©©å®šæ€§åš´é‡ä¸è¶³ï¼Œå­˜åœ¨é‡å¤§å®‰å…¨éš±æ‚£ï¼Œè«‹ç«‹å³æ”¹å–„ã€‚"]
  ],
  crime: [
    [80,"ğŸŸ¢ æ¥µå®‰å…¨","æ²»å®‰å„ªç•°ï¼ŒçŠ¯ç½ªç‡é ä½æ–¼æ¡ƒåœ’å€å¹³å‡ï¼Œç¤¾å€å®‰å…¨æ„Ÿæ¥µä½³ã€‚"],
    [60,"ğŸŸ¡ å®‰å…¨","æ²»å®‰è‰¯å¥½ï¼ŒçŠ¯ç½ªç‡ä½æ–¼æ¡ƒåœ’å€å¹³å‡ï¼Œé©åˆå±…ä½ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","æ²»å®‰æ™®é€šï¼ŒçŠ¯ç½ªç‡èˆ‡æ¡ƒåœ’å€å¹³å‡ç›¸ç•¶ã€‚"],
    [20,"ğŸŸ  éœ€æ”¹å–„","æ²»å®‰åå¼±ï¼ŒçŠ¯ç½ªç‡é«˜æ–¼å¹³å‡ï¼Œå»ºè­°åŠ å¼·å·¡é‚ã€‚"],
    [0 ,"ğŸ”´ å±éšª","æ²»å®‰åš´é‡æƒ¡åŒ–ï¼ŒçŠ¯ç½ªç‡é é«˜æ–¼å¹³å‡ï¼Œå­˜åœ¨å®‰å…¨å¨è„…ï¼"]
  ],
  traffic: [
    [80,"ğŸŸ¢ æ¥µå®‰å…¨","äº¤é€šäº‹æ•…ç‡æ¥µä½ï¼Œé“è·¯å®‰å…¨å„ªç•°ï¼Œé©åˆé§•é§›èˆ‡è¡Œäººã€‚"],
    [60,"ğŸŸ¡ å®‰å…¨","äº¤é€šå®‰å…¨è‰¯å¥½ï¼Œäº‹æ•…ç‡ä½æ–¼å¹³å‡ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","äº¤é€šå®‰å…¨æ™®é€šï¼Œäº‹æ•…ç‡èˆ‡å¹³å‡ç›¸ç•¶ã€‚"],
    [20,"ğŸŸ  å±éšª","äº¤é€šäº‹æ•…é »ç™¼ï¼Œå»ºè­°æ”¹å–„è™ŸèªŒèˆ‡è·¯æ³ã€‚"],
    [0 ,"ğŸ”´ é«˜é¢¨éšª","äº¤é€šäº‹æ•…åš´é‡ï¼Œé“è·¯å®‰å…¨å ªæ†‚ï¼Œç«‹å³æ”¹å–„ï¼"]
  ],
  disaster: [
    [80,"ğŸŸ¢ æ¥µå®‰å…¨","ç½å®³é¢¨éšªæ¥µä½ï¼Œé˜²ç½èƒ½åŠ›å„ªç•°ã€‚"],
    [60,"ğŸŸ¡ å®‰å…¨","ç½å®³é¢¨éšªä½æ–¼å¹³å‡ï¼Œé˜²ç½æªæ–½å®Œå–„ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","ç½å®³é¢¨éšªæ™®é€šï¼Œèˆ‡å¹³å‡ç›¸ç•¶ã€‚"],
    [20,"ğŸŸ  ä¸­é¢¨éšª","ç½å®³é«˜é¢¨éšªé¢ç©åé«˜ï¼Œå»ºè­°å¼·åŒ–é˜²ç½ã€‚"],
    [0 ,"ğŸ”´ é«˜é¢¨éšª","ç½å®³é¢¨éšªåš´é‡ï¼Œå¤§é¢ç©é«˜é¢¨éšªå€ï¼Œç·Šæ€¥æ”¹å–„ï¼"]
  ],
  facility: [
    [80,"ğŸŸ¢ è¨­æ–½è±å¯Œ","å…¬å…±è¨­æ–½å¯†åº¦æ¥µé«˜ï¼Œç”Ÿæ´»ä¾¿åˆ©åº¦å„ªç•°ã€‚"],
    [60,"ğŸŸ¡ è¨­æ–½å……è¶³","å…¬å…±è¨­æ–½å……è¶³ï¼Œæ—¥å¸¸ç”Ÿæ´»ä¾¿åˆ©ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","å…¬å…±è¨­æ–½æ™®é€šï¼ŒåŸºæœ¬éœ€æ±‚æ»¿è¶³ã€‚"],
    [20,"ğŸŸ  è¨­æ–½ä¸è¶³","å…¬å…±è¨­æ–½ç¨€å°‘ï¼Œç”Ÿæ´»ä¸ä¾¿ï¼Œå»ºè­°å¢è¨­ã€‚"],
    [0 ,"ğŸ”´ åš´é‡ç¼ºä¹","å…¬å…±è¨­æ–½åš´é‡ä¸è¶³ï¼Œå½±éŸ¿ç”Ÿæ´»å“è³ªï¼"]
  ],
  medical: [
    [80,"ğŸŸ¢ é†«ç™‚å®Œå–„","é†«ç™‚è³‡æºè±å¯Œï¼Œæ€¥è¨ºå¸¸è¨ºçš†å……è¶³ã€‚"],
    [60,"ğŸŸ¡ é†«ç™‚è‰¯å¥½","é†«ç™‚è³‡æºå„ªæ–¼å¹³å‡ï¼Œç”Ÿç—…æœ‰ä¿éšœã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","é†«ç™‚è³‡æºæ™®é€šï¼ŒåŸºæœ¬ç…§è­·å¯åŠã€‚"],
    [20,"ğŸŸ  é†«ç™‚ä¸è¶³","é†«ç™‚è³‡æºä¸è¶³ï¼Œå»ºè­°è£œå¼·è¨ºæ‰€ã€‚"],
    [0 ,"ğŸ”´ é†«ç™‚è’æ¼ ","é†«ç™‚è³‡æºåš´é‡ç¼ºä¹ï¼Œç·Šæ€¥å°±é†«å›°é›£ï¼"]
  ],
  education: [
    [80,"ğŸŸ¢ æ•™è‚²å„ªè³ª","å­¸æ ¡å……è¶³ï¼‹é«˜å­¸æ­·äººå£ï¼Œæ•™è‚²ç’°å¢ƒå„ªç•°ã€‚"],
    [60,"ğŸŸ¡ æ•™è‚²è‰¯å¥½","æ•™è‚²è³‡æºå„ªæ–¼å¹³å‡ï¼Œé©åˆè‚²å…’ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","æ•™è‚²è³‡æºæ™®é€šï¼ŒåŸºæœ¬æ•™è‚²ç„¡è™ã€‚"],
    [20,"ğŸŸ  æ•™è‚²ä¸è¶³","å­¸æ ¡æˆ–å­¸æ­·åä½ï¼Œå»ºè­°æ”¹å–„ã€‚"],
    [0 ,"ğŸ”´ æ•™è‚²å¼±å‹¢","æ•™è‚²è³‡æºåš´é‡ä¸è¶³ï¼Œå½±éŸ¿ä¸‹ä¸€ä»£ç™¼å±•ï¼"]
  ],
  eduInst: [
    [80,"ğŸŸ¢ å­¸æ ¡å……è¶³","å­¸æ ¡åˆ†å¸ƒå¯†é›†ï¼Œæ•™è‚²æ©Ÿæ§‹é‡èƒ½ä½³ã€‚"],
    [60,"ğŸŸ¡ è‰¯å¥½","å­¸æ ¡æ•¸é‡å„ªæ–¼å¹³å‡ï¼Œå­¸å€è³‡æºå°šä½³ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","å­¸æ ¡æ•¸é‡æ™®é€šï¼ŒåŸºæœ¬å°±å­¸éœ€æ±‚å¯æ»¿è¶³ã€‚"],
    [20,"ğŸŸ  åå°‘","å­¸æ ¡æ•¸é‡åå°‘ï¼Œå»ºè­°å¼·åŒ–å‘¨é‚Šå­¸æ ¡é…ç½®ã€‚"],
    [0 ,"ğŸ”´ ä¸è¶³","å­¸æ ¡è³‡æºç¨€å°‘ï¼Œå¯èƒ½å½±éŸ¿å°±å­¸ä¾¿åˆ©æ€§ï¼"]
  ],
  eduLevel: [
    [80,"ğŸŸ¢ é«˜å­¸æ­·","å±…æ°‘æ•™è‚²ç¨‹åº¦å„ªç•°ï¼Œå¤§å­¸ä»¥ä¸Šäººå£çœ¾å¤šã€‚"],
    [60,"ğŸŸ¡ è‰¯å¥½","æ•™è‚²ç¨‹åº¦å„ªæ–¼å¹³å‡ï¼Œç¤¾å€ç´ è³ªé«˜ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","æ•™è‚²ç¨‹åº¦æ™®é€šï¼Œèˆ‡å…¨å€ç›¸ç•¶ã€‚"],
    [20,"ğŸŸ  åä½","æ•™è‚²ç¨‹åº¦åä½ï¼Œç¤¾å€ç™¼å±•å—é™ã€‚"],
    [0 ,"ğŸ”´ ä½å­¸æ­·","æ•™è‚²ç¨‹åº¦åš´é‡åä½ï¼ŒäººåŠ›è³‡æœ¬ä¸è¶³ã€‚"]
  ],
  infra: [
    [80,"ğŸŸ¢ åŸºç¤è¨­æ–½å®Œå–„","å…¬å…±é‹è¼¸ï¼‹åœè»Šè³‡æºçš†å„ªï¼Œäº¤é€šç”Ÿæ´»ä¾¿åˆ©ã€‚"],
    [60,"ğŸŸ¡ è‰¯å¥½","åŸºç¤è¨­æ–½å„ªæ–¼å¹³å‡ï¼Œé€šå‹¤æ–¹ä¾¿ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","åŸºç¤è¨­æ–½æ™®é€šï¼ŒåŸºæœ¬é€šå‹¤å¯è¡Œã€‚"],
    [20,"ğŸŸ  éœ€æ”¹å–„","åŸºç¤è¨­æ–½ä¸è¶³ï¼Œå»ºè­°å¢è¨­å…¬è»Šç«™æˆ–åœè»Šè³‡æºã€‚"],
    [0 ,"ğŸ”´ äº¤é€šä¸ä¾¿","åŸºç¤è¨­æ–½åš´é‡ç¼ºä¹ï¼Œå½±éŸ¿ç”Ÿæ´»å“è³ªï¼"]
  ],
  publicTrans: [
    [80,"ğŸŸ¢ äº¤é€šä¾¿åˆ©","å…¬è»Šç«™å¯†é›†ï¼Œå…¬å…±é‹è¼¸æ¥µä¾¿åˆ©ã€‚"],
    [60,"ğŸŸ¡ è‰¯å¥½","å…¬è»Šç«™å……è¶³ï¼Œå‡ºé–€æ–¹ä¾¿ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","å…¬è»Šç«™æ™®é€šï¼ŒåŸºæœ¬é€šå‹¤å¯è¡Œã€‚"],
    [20,"ğŸŸ  äº¤é€šä¸ä¾¿","å…¬è»Šç«™ç¨€å°‘ï¼Œä¾è³´ç§å®¶è»Šã€‚"],
    [0 ,"ğŸ”´ äº¤é€šå­¤å³¶","å¹¾ä¹ç„¡å…¬è»Šï¼Œäº¤é€šåš´é‡ä¸ä¾¿ï¼"]
  ],
  parkingInfo: [
    [80,"ğŸŸ¢ åœè»Šå……è¶³","YouBikeã€EVã€åœè»Šå ´è±å¯Œï¼Œåœè»Šç„¡è™ã€‚"],
    [60,"ğŸŸ¡ è‰¯å¥½","åœè»Šè³‡æºå……è¶³ï¼Œå…±äº«è»Šè¼›æ–¹ä¾¿ã€‚"],
    [40,"ğŸŸ¡ æ™®é€š","åœè»Šè³‡æºæ™®é€šï¼ŒåŸºæœ¬éœ€æ±‚æ»¿è¶³ã€‚"],
    [20,"ğŸŸ  åœè»Šå›°é›£","åœè»Šä½ä¸è¶³ï¼Œå…±äº«è»Šè¼›ç¨€å°‘ã€‚"],
    [0 ,"ğŸ”´ åœè»Šè’æ¼ ","å®Œå…¨ç„¡åœè»Šè³‡æºï¼Œäº¤é€šä¸ä¾¿ï¼"]
  ]
};

function getIndicatorMessage(type, score){
  const s = Number(score) || 0;
  const list = livabilityMessages[type] || [];
  for(const [limit, title, msg] of list){
    if(s >= limit) return { title, msg };
  }
  return { title:"", msg:"" };
}

const livabilityContent = document.getElementById("livabilityContent");
  let activeFacility = null;
  let activeMed = null;
  let lastBuilding = null;

  // âœ… æ¬Šé‡ï¼ˆå…¬å…±è¨­æ–½ *0.25ã€é†«ç™‚ *0.25ã€æ²»å®‰ *0.25ï¼‰
  const FAC_WEIGHT = 0.25;
  const MED_SCORE_WEIGHT = 0.25;
  const CRIME_WEIGHT = 0.25;   // âœ… æ²»å®‰æ¬Šé‡
  const MED_WEIGHT = { "é†«é™¢": 4, "è—¥å±€": 1, "è€äººé•·ç…§æ©Ÿæ§‹": 3 };

  // =========================
  // âœ… çŠ¯ç½ªäº‹ä»¶ï¼ˆCrime Layerï¼‰
  // =========================
  const CRIME_GEOJSON_URL = "https://jade0815.github.io/data/çŠ¯ç½ª.geojson";

  const crimeToggle = document.getElementById("crimeToggle");
  const crimeTypeSelect = document.getElementById("crimeTypeSelect");
  const crimeYearSelect = document.getElementById("crimeYearSelect");
  const crimeMonthSelect = document.getElementById("crimeMonthSelect");
  const crimeHeatToggle = document.getElementById("crimeHeatToggle");

  const crimeKpiTotal = document.getElementById("crimeKpiTotal");
  const crimeKpiTop1  = document.getElementById("crimeKpiTop1");
  const HEAT_MIN_COUNT = 15;

  let crimeLayer = null;
  let crimeLayerView = null;
  let crimeLoaded = false;
  let CRIME_15MIN = 0;      // âœ… 15 åˆ†é˜(æˆ–è‡ªè¨‚ç¯„åœ)å…§çŠ¯ç½ªæ•¸
  let CRIME_TAOYUAN = 0;    // âœ… æ¡ƒåœ’å€çŠ¯ç½ªæ•¸ï¼ˆç•¶åˆ†æ¯ç”¨ï¼‰

  const CRIME_COLORS = {
    "æ©Ÿè»Šç«Šç›œ": [255, 193, 7, 1],
    "æ±½è»Šç«Šç›œ": [0, 188, 212, 1],
    "ä½å®…ç«Šç›œ": [233, 30, 99, 1],
    "è‡ªè¡Œè»Šç«Šç›œ": [76, 175, 80, 1],
    "å…¶ä»–": [158, 158, 158, 1]
  };

  function formatYMD(num) {
    const s = (num == null) ? "" : String(num);
    if (s.length !== 8) return s || "-";
    return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
  }

  // âœ… è®“çŠ¯ç½ªé»ä½ã€Œåƒå…¬å…±è¨­æ–½ã€ä¸æ˜“è¢« 3D å»ºç‰©é®ä½ï¼šPoint-3D + verticalOffset + callout
  function crimeIconSymbol(colorRGBA) {
    return {
      type: "point-3d",
      symbolLayers: [{
        type: "icon",
        resource: { primitive: "circle" },
        material: { color: colorRGBA },
        outline: { color: [0,0,0,0.85], size: 1 },
        size: 10
      }],
      verticalOffset: {
        screenLength: 18,
        maxWorldLength: 60,
        minWorldLength: 10
      },
      callout: { type: "line", color: [0,0,0,0.35], size: 1 }
    };
  }

  function buildCrimeRendererUnique() {
    const infos = Object.keys(CRIME_COLORS).map(k => ({
      value: k,
      symbol: crimeIconSymbol(CRIME_COLORS[k]),
      label: k
    }));

    return new UniqueValueRenderer({
      field: "type",
      defaultSymbol: crimeIconSymbol(CRIME_COLORS["å…¶ä»–"]),
      uniqueValueInfos: infos
    });

// âœ… çŠ¯ç½ªé¢æ¿å³ä¸Šè§’ Xï¼šåªé—œé–‰é¢æ¿ï¼ˆä¸å½±éŸ¿å…¶ä»–é¢æ¿ï¼‰
const crimePanelCloseX = document.getElementById("crimePanelCloseX");
if (crimePanelCloseX) {
  crimePanelCloseX.onclick = () => {
    const p = document.getElementById("crimePanel");
    if (p) p.style.display = "none";
  };
}

// âœ… å­¸æ ¡é»ä½é–‹é—œï¼šé¡¯ç¤º/éš±è—å­¸æ ¡ä¸¦æ›´æ–°ç†±å€é¡è‰²
const schoolToggle = document.getElementById("schoolToggle");
const schoolRadiusSelect = document.getElementById("schoolRadiusSelect");

async function refreshSchoolHotspots(){
  if (!window.__schoolLayer || !schoolToggle?.checked) return;
  // å¦‚æœçŠ¯ç½ªè³‡æ–™é‚„æ²’è¼‰å…¥ï¼Œå°±å…ˆç¢ºä¿è¼‰å…¥ï¼ˆä¸ä¸€å®šè¦é¡¯ç¤ºçŠ¯ç½ªåœ–å±¤ï¼‰
  try { if (!crimeLayer) await loadCrimeLayerOnce(); } catch(e){}

  const radiusM = Number(schoolRadiusSelect?.value || 500);

  // é€æ ¡ç®—åŠå¾‘å…§çŠ¯ç½ªæ•¸ï¼Œä¸¦ä»¥é¡è‰²æ¨™ç¤º
  const ge = geometryEngine;
  const out = [];
  for (const g of window.__schoolLayer.graphics.items) {
    const buf = ge.geodesicBuffer(g.geometry, radiusM, "meters");
    const where = (typeof buildWhereFromUI === "function") ? buildWhereFromUI() : "1=1";
    let cnt = 0;
    try{
      cnt = await crimeLayer.queryFeatureCount({ where, geometry: buf, spatialRelationship: "intersects" });
    }catch(e){ cnt = 0; }

    // ç°¡å–®åˆ†ç´šï¼š0=ç¶ , 1~2=é»ƒ, >=3=ç´…
    let color = [34,197,94,0.9];
    if (cnt >= 3) color = [239,68,68,0.9];
    else if (cnt >= 1) color = [234,179,8,0.9];

    g.symbol = new SimpleMarkerSymbol({
      style: "circle",
      color,
      size: 10,
      outline: { color: [255,255,255,0.9], width: 1 }
    });
    g.attributes = g.attributes || {};
    g.attributes.crime_cnt = cnt;
    out.push(cnt);
  }
}

async function ensureSchoolLayer(){
  if (window.__schoolLayer) return window.__schoolLayer;

  // âœ… ç›´æ¥ç”¨ä½ ç¾æœ‰ã€Œå…¬å…±è¨­æ–½ã€çš„å­¸æ ¡é»ä½ä¾†åšï¼ˆé¿å…ä½ é‚„è¦å†æº–å‚™ school geojsonï¼‰
  window.__schoolLayer = new GraphicsLayer({ title: "å­¸æ ¡é»ä½" });
  map.add(window.__schoolLayer);

  // âœ… éåŒæ­¥æŠŠå­¸æ ¡é»ä½è£œé€²ä¾†ï¼ˆé¿å…åœ¨é async function å…§ä½¿ç”¨ await é€ æˆæ•´é  JS æ›æ‰ï¼‰
  (async () => {
    try{
      const lyr = window.facilityLayer || window.publicFacilityLayer || null;
      if (!lyr || !lyr.queryFeatures) return;

      const q = lyr.createQuery();
      q.where = "1=1";
      q.outFields = ["*"];
      q.returnGeometry = true;

      const res = await lyr.queryFeatures(q);
      const feats = (res && res.features) ? res.features : [];

      const isSchool = (a) => {
        const t = String(
          a?.type ?? a?.TYPE ?? a?.category ?? a?.CATEGORY ?? a?.é¡åˆ¥ ?? a?.é¡å‹ ?? a?.name ?? a?.NAME ?? ""
        );
        return (
          t.includes("å­¸æ ¡") || t.includes("åœ‹å°") || t.includes("åœ‹ä¸­") || t.includes("é«˜ä¸­") ||
          t.includes("é«˜è·") || t.includes("å¤§å­¸") || t.includes("å¹¼å…’åœ’") || t.includes("å¹¼ç¨šåœ’")
        );
      };

      const iconUrl = "https://cdn-icons-png.flaticon.com/512/1670/1670306.png";

      window.__schoolLayer.removeAll();

      feats.filter(f => isSchool(f.attributes || {})).forEach(f=>{
        const g = new Graphic({
          geometry: f.geometry,
          attributes: {
            ...(f.attributes || {}),
            __isSchool: 1
          },
          symbol: {
            type: "picture-marker",
            url: iconUrl,
            width: "28px",
            height: "28px"
          }
        });
        window.__schoolLayer.add(g);
      });

    }catch(e){
      console.warn("ensureSchoolLayer: query schools failed", e);
    }
  })();

  return window.__schoolLayer;
}

if (schoolToggle) {
  schoolToggle.onchange = async () => {
    const lyr = await window.ensureSchoolLayer();
    lyr.visible = schoolToggle.checked;
    if (lyr.visible) await refreshSchoolHotspots();
  };
}
if (schoolRadiusSelect) {
  schoolRadiusSelect.onchange = async () => {
    if (schoolToggle?.checked) await refreshSchoolHotspots();
  };
}

  }

  function buildCrimeHeatRenderer() {
    return new HeatmapRenderer({
      radius: 24,
      minDensity: 0,
      maxDensity: 0.02,
      colorStops: [
        { ratio: 0.00, color: [0,   0,   0,   0.00] },
        { ratio: 0.12, color: [0, 120, 255, 0.28] },
        { ratio: 0.30, color: [0, 255, 255, 0.40] },
        { ratio: 0.50, color: [0, 255,   0, 0.50] },
        { ratio: 0.70, color: [255, 255,  0, 0.65] },
        { ratio: 0.85, color: [255, 140,  0, 0.80] },
        { ratio: 1.00, color: [255,   0,  0, 0.95] }
      ]
    });
  }

  function applyCrimeHeatmap(on) {
    if (!crimeLayer) return;

    if (on) {
      crimeLayer.featureReduction = null;
      const r = buildCrimeHeatRenderer();
      r.referenceScale = view.scale;
      crimeLayer.renderer = r;
    } else {
      crimeLayer.featureReduction = null;
      crimeLayer.renderer = buildCrimeRendererUnique();
    }
  }

  function buildWhereFromUI() {
    const wheres = ["1=1"];
    const t = crimeTypeSelect.value;
    const y = crimeYearSelect.value;
    const m = crimeMonthSelect.value;

    if (t !== "ALL") wheres.push(`type = '${t.replaceAll("'", "''")}'`);
    const yi = parseInt(y,10);
    const mi = parseInt(m,10);

    if (y !== "ALL" && y !== "" && Number.isFinite(yi)) wheres.push(`year = ${yi}`);
    if (m !== "ALL" && m !== "" && Number.isFinite(mi)) wheres.push(`month = ${mi}`);

    return wheres.join(" AND ");
  }

  async function updateCrimeFilterAndKPI() {
  if (!crimeLayer) return;
  const where = buildWhereFromUI();

  // âœ… è‹¥ç›®å‰æœ‰ã€Œ15åˆ†é˜ç”Ÿæ´»åœˆ / è‡ªè¨‚ç¯„åœã€å°±ä»¥è©²ç¯„åœè¨ˆç®—ï¼ˆä¾‹å¦‚ï¼šä»¥å­¸æ ¡ç‚ºä¸­å¿ƒçš„ bufferï¼‰
  let areaGeom = null;
  try {
    const polys = [];
    if (typeof isochroneLayer !== "undefined" && isochroneLayer) {
      isochroneLayer.graphics.forEach(g => {
        if (g.geometry && g.geometry.type === "polygon") polys.push(g.geometry);
      });
    }
    if (typeof drawLayer !== "undefined" && drawLayer) {
      drawLayer.graphics.forEach(g => {
        if (g.geometry && g.geometry.type === "polygon") polys.push(g.geometry);
      });
    }
    if (polys.length > 0) areaGeom = geometryEngine.union(polys);
  } catch(e) {}


  // âœ… å³ä½¿åœ–å±¤æ²’é¡¯ç¤ºï¼Œä¹Ÿæ›´æ–° filter/definitionExpressionï¼ˆæ–¹ä¾¿ queryï¼‰
  if (crimeLayerView) crimeLayerView.filter = { where };
  crimeLayer.definitionExpression = where;

  // KPIï¼šç¸½ç­†æ•¸
  try {
    const total = await crimeLayer.queryFeatureCount(areaGeom ? { where, geometry: areaGeom, spatialRelationship: "intersects" } : { where });
    crimeKpiTotal.textContent = total.toLocaleString("zh-TW");

    // ç†±å€ï¼šç­†æ•¸å¤ªå°‘å°±ä¸çµ¦ç†±é»
    if (crimeHeatToggle.checked && total < HEAT_MIN_COUNT) {
      crimeHeatToggle.checked = false;
      applyCrimeHeatmap(false);
    }
  } catch (e) {
    crimeKpiTotal.textContent = "-";
  }

  // KPIï¼šæœ€å¤šé¡å‹
  try {
    const q = crimeLayer.createQuery();
    if (areaGeom) { q.geometry = areaGeom; q.spatialRelationship = "intersects"; }
    q.where = where;
    q.outFields = ["type"];
    q.returnGeometry = false;
    q.num = 20000;
    const r = await crimeLayer.queryFeatures(q);

    const freq = {};
    r.features.forEach(f => {
      const tp = (f.attributes.type || "å…¶ä»–").trim() || "å…¶ä»–";
      freq[tp] = (freq[tp] || 0) + 1;
    });

    let topType = "-";
    let topVal = -1;
    Object.keys(freq).forEach(k => {
      if (freq[k] > topVal) { topVal = freq[k]; topType = k; }
    });

    if (crimeTypeSelect.value === "ALL") crimeKpiTop1.textContent = "å…¨éƒ¨";
    else crimeKpiTop1.textContent = (topVal <= 0) ? "-" : topType;

  } catch (e) {
    crimeKpiTop1.textContent = "-";
  }

  // âœ… ç¯©é¸è®Šäº† â†’ å®œå±…(æ²»å®‰)è¦è·Ÿè‘—é‡ç®—
  computeAccessibilityForBuilding();
}

  function buildCrimePopupHTML(a){
    const fid   = (a.FID != null && a.FID !== "") ? a.FID : "-";
    const type  = (a.type || "-").toString().trim() || "-";
    const year  = (a.year != null) ? a.year : "-";
    const date  = formatYMD(a.date);
    const bcode = (a.breau_code || "").toString().trim() || "-";
    const breau = (a.breau || "").toString().trim() || "-";
    const station = (a.station || "").toString().trim() || "-";
    const lat = (a.lat != null) ? Number(a.lat).toFixed(6) : "-";
    const lon = (a.lon != null) ? Number(a.lon).toFixed(6) : "-";

    return `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <div style="font-weight:700;">çŠ¯ç½ªäº‹ä»¶</div>
        <button id="popupCloseBtn" style="border:none;background:transparent;font-size:16px;cursor:pointer;line-height:1;">âœ•</button>
      </div>
      <table class="popup-table">
        <tr><th>FID</th><td>${fid}</td></tr>
        <tr><th>é¡å‹</th><td>${type}</td></tr>
        <tr><th>å¹´ä»½</th><td>${year}</td></tr>
        <tr><th>æ—¥æœŸ</th><td>${date}</td></tr>
        <tr><th>åˆ†å±€ä»£ç¢¼</th><td>${bcode}</td></tr>
        <tr><th>åˆ†å±€</th><td>${breau}</td></tr>
        <tr><th>æ´¾å‡ºæ‰€</th><td>${station}</td></tr>
        <tr><th>ç·¯åº¦</th><td>${lat}</td></tr>
        <tr><th>ç¶“åº¦</th><td>${lon}</td></tr>
      </table>
    `;
  }

  /* è®“è‡ªè¨‚å½ˆè·³è¦–çª—å¯æ‹–æ›³ */
  function makeDraggable(el) {
    let isDown = false;
    let startX, startY, startLeft, startTop;

    el.addEventListener("mousedown", function (e) {
      const closeBtn = document.getElementById("popupCloseBtn");
      if (closeBtn && e.target === closeBtn) return;
      isDown = true;
      el.style.cursor = "move";
      startX = e.clientX;
      startY = e.clientY;
      const rect = el.getBoundingClientRect();
      startLeft = rect.left;
      startTop = rect.top;

      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onUp);
      e.preventDefault();
    });

    function onMove(e) {
      if (!isDown) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      el.style.left = (startLeft + dx) + "px";
      el.style.top  = (startTop + dy) + "px";
    }

    function onUp() {
      isDown = false;
      el.style.cursor = "default";
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
    }
  }
  makeDraggable(popupDiv);

  function positionPopupAtPoint(mapPoint) {
  const screenPoint = view.toScreen(mapPoint);
  popupDiv.style.display = "block";

  const w = popupDiv.offsetWidth;
  const h = popupDiv.offsetHeight;

  // âœ… æ°¸é é¡¯ç¤ºåœ¨é»ä½å³å´
  let left = screenPoint.x + 12;
  let top  = screenPoint.y - h / 2;

  // é‚Šç•Œé˜²å‘†ï¼šé¿å…è¶…å‡ºè¦–çª—
  const maxLeft = window.innerWidth  - w - 10;
  const maxTop  = window.innerHeight - h - 10;

  if (left < 10) left = 10;
  if (left > maxLeft) left = maxLeft;
  if (top  < 10) top  = 10;
  if (top  > maxTop)  top  = maxTop;

  popupDiv.style.left = left + "px";
  popupDiv.style.top  = top  + "px";
}


  async function fetchFullCrimeFeatureFromGraphic(g){
    if (!crimeLayer || !g) return g;
    const oid = g.attributes?.OID;
    if (oid == null) return g;

    const q = crimeLayer.createQuery();
    q.objectIds = [oid];
    q.outFields = ["*"];
    q.returnGeometry = true;

    const r = await crimeLayer.queryFeatures(q);
    return r.features?.[0] || g;
  }

  let __crimePopupReturnCam = null;
let __rankReturnCam = null;

// ===== æ¸…é™¤å­¸æ ¡é«˜äº®åœ“åœˆ / ç·©è¡å€ =====
function clearSchoolHighlight(){
  try{
    if(window.__schoolHighlightCircle && window.__schoolLayer){
      __schoolLayer.remove(__schoolHighlightCircle);
      __schoolHighlightCircle = null;
    }
    if(window.__schoolHighlightBuffer && window.__schoolLayer){
      __schoolLayer.remove(__schoolHighlightBuffer);
      __schoolHighlightBuffer = null;
    }
  }catch(e){}
}

async function showCrimePopup(feature){
    popupDiv.innerHTML = buildCrimePopupHTML(feature.attributes || {});
    popupDiv.style.display = "block";

    // âœ… è¨˜ä½é»æ“Šå‰çš„ç›¸æ©Ÿä½ç½®ï¼šé—œé–‰å½ˆçª—è¦å›åˆ°åŸä½
    __crimePopupReturnCam = view.camera.clone();

    const btn = document.getElementById("popupCloseBtn");
    if(btn){
      btn.onclick = async (e)=>{
        e.stopPropagation();
        popupDiv.style.display = "none";
        // âœ… é—œé–‰çŠ¯ç½ªå½ˆè·³è¦–çª—ï¼šå›åˆ°é»æ“Šå‰çš„åŸå§‹è¦–è§’ï¼ˆé»ä½ or æ’è¡Œæ¦œï¼‰
        try{
          const cam = __crimePopupReturnCam || __rankReturnCam;
          clearSchoolHighlight();
          if(cam) await view.goTo(cam, { duration: 350 });
        }catch(err){}
        __crimePopupReturnCam = null;
        __rankReturnCam = null;
      };
    }

    const geom = feature.geometry;
    await view.goTo({ target: geom, zoom: 18, tilt: 65 }, { duration: 800 });
    positionPopupAtPoint(geom);
  }

  async function loadCrimeLayerOnce() {
    if (crimeLoaded) return;
    crimeLoaded = true;
      try{ updateSchoolHotspots(); }catch(e){}

    const res = await fetch(CRIME_GEOJSON_URL);
    const gj = await res.json();

    const source = [];
    let oid = 1;

    const typeSet = new Set();

    (gj.features || []).forEach(f => {
      if (!f || !f.geometry || f.geometry.type !== "Point") return;
      const p = f.properties || {};
      const coords = f.geometry.coordinates || [];
      const lon = coords[0], lat = coords[1];

      const dateNum = p.date;
      const month = (dateNum && String(dateNum).length === 8)
        ? parseInt(String(dateNum).slice(4,6), 10)
        : (p.month || null);

      if (p.type) typeSet.add(String(p.type).trim());

      const ptGeo = new Point({ longitude: lon, latitude: lat, spatialReference: { wkid: 4326 } });
      const ptWM  = webMercatorUtils.geographicToWebMercator(ptGeo);

      source.push({
        geometry: ptWM,
        attributes: {
          OID: oid++,
          FID: p.FID ?? p.fid ?? null,
          type: (p.type || "å…¶ä»–").trim(),
          year: (p.year != null) ? Number(p.year) : null,
          month: month,
          date: p.date ?? null,
          breau_code: (p.breau_code || "").trim(),
          breau: (p.breau || "").trim(),
          station: (p.station || "").trim(),
          lat: (p.lat != null) ? Number(p.lat) : lat,
          lon: (p.lon != null) ? Number(p.lon) : lon
        }
      });
    });

    [...typeSet].sort().forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      crimeTypeSelect.appendChild(opt);
    });

    // âœ… åªé¡¯ç¤º 2015~2024
    for(let y = 2015; y <= 2024; y++){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      crimeYearSelect.appendChild(opt);
    }

    crimeLayer = new FeatureLayer({
      title: "çŠ¯ç½ªäº‹ä»¶",
      source,
      objectIdField: "OID",
      fields: [
        { name: "OID", type: "oid" },
        { name: "FID", type: "integer" },
        { name: "type", type: "string" },
        { name: "year", type: "integer" },
        { name: "month", type: "integer" },
        { name: "date", type: "integer" },
        { name: "breau_code", type: "string" },
        { name: "breau", type: "string" },
        { name: "station", type: "string" },
        { name: "lat", type: "double" },
        { name: "lon", type: "double" }
      ],
      outFields: ["*"],
      renderer: buildCrimeRendererUnique(),
      popupEnabled: false,
      // âœ… åƒå…¬å…±è¨­æ–½ä¸€æ¨£ã€Œæµ®èµ·ä¾†ã€é¿å…è¢« 3D å»ºç‰©é®
      elevationInfo: { mode: "relative-to-ground", offset: 25 }
    });

    map.add(crimeLayer);
    crimeLayerView = await view.whenLayerView(crimeLayer);
    // âœ… é è¨­å…ˆä¸é¡¯ç¤ºï¼ˆä½†è³‡æ–™å·²è¼‰å…¥ï¼Œæ²»å®‰è¨ˆç®—ç…§è·‘ï¼‰
    crimeLayer.visible = false;

    applyCrimeHeatmap(crimeHeatToggle.checked);

    // âœ… é è¨­å¹´ä»½ï¼šå„ªå…ˆ 2024ï¼Œæ²’æœ‰å°±å›åˆ° ALLï¼ˆé¿å… value ä¸å­˜åœ¨å°è‡´ year=NaNï¼‰
    try {
      const prefer = "2024";
      const opts = Array.from(crimeYearSelect?.options || []);
      const hasPrefer = opts.some(o => o.value === prefer);
      const hasALL = opts.some(o => o.value === "ALL");
      crimeYearSelect.value = hasPrefer ? prefer : (hasALL ? "ALL" : (opts[0]?.value || "ALL"));
    } catch(e) {
      crimeYearSelect.value = "ALL";
    }
    await updateCrimeFilterAndKPI();
  }

  crimeToggle.addEventListener("change", async (e) => {
    const on = e.target.checked;
    if (on) {
      await loadCrimeLayerOnce();
      crimeLayer.visible = true;
      await updateCrimeFilterAndKPI();
    } else {
      if (crimeLayer) crimeLayer.visible = false;
      popupDiv.style.display = "none";
      computeAccessibilityForBuilding(); // âœ… é—œé–‰çŠ¯ç½ªåœ–å±¤ä¹Ÿé‡ç®—ä¸€æ¬¡
    }
  });

  crimeTypeSelect.addEventListener("change", updateCrimeFilterAndKPI);
  crimeYearSelect.addEventListener("change", updateCrimeFilterAndKPI);
  crimeMonthSelect.addEventListener("change", updateCrimeFilterAndKPI);

  crimeHeatToggle.addEventListener("change", (e) => {
    applyCrimeHeatmap(e.target.checked);
    updateCrimeFilterAndKPI();
  });

  // =========================
  // âœ… ä»¥ä¸‹é–‹å§‹ï¼šä½ åŸæœ¬çš„ç¨‹å¼ï¼ˆä¿æŒåŠŸèƒ½ï¼‰
  // =========================
  const TAOYUAN_POLY_URL = "https://jade0815.github.io/data/æ¡ƒåœ’å€.geojson";
  let taoyuanUnionWM = null;
  let taoyuanReady = false;
  let facilityReady = false;
  let medReady = false;

  let N_TAOYUAN_FAC = 0;
  let N_TAOYUAN_MED = 0;
  let N_TAOYUAN_BYTYPE = { "é†«é™¢": 0, "è—¥å±€": 0, "è€äººé•·ç…§æ©Ÿæ§‹": 0 };

  async function loadTaoyuanPolygon() {
    try {
      const res = await fetch(TAOYUAN_POLY_URL);
      const data = await res.json();
      const polysWM = [];

      data.features.forEach(f => {
        if (!f.geometry) return;

        if (f.geometry.type === "Polygon") {
          f.geometry.coordinates.forEach(ringSet => {
            const poly4326 = new Polygon({ rings: ringSet, spatialReference: { wkid: 4326 } });
            polysWM.push(webMercatorUtils.geographicToWebMercator(poly4326));
          });
        } else if (f.geometry.type === "MultiPolygon") {
          f.geometry.coordinates.forEach(polyCoords => {
            polyCoords.forEach(ringSet => {
              const poly4326 = new Polygon({ rings: ringSet, spatialReference: { wkid: 4326 } });
              polysWM.push(webMercatorUtils.geographicToWebMercator(poly4326));
            });
          });
        }
      });

      if (polysWM.length > 0) {
        taoyuanUnionWM = geometryEngine.union(polysWM);
        taoyuanReady = true;
        tryComputeTaoyuanDenominators();
      }
    } catch (e) {
      console.error("âŒ æ¡ƒåœ’å€ polygon è¼‰å…¥å¤±æ•—ï¼š", e);
    }
  }

  
  // âœ… 15 åˆ†é˜ç”Ÿæ´»åœˆ + å®œå±…åˆ†æ•¸ï¼ˆåŒä¸€é¢æ¿ / åˆ†é ï¼‰
  const tabIso  = document.getElementById("tabIso");
  const tabLive = document.getElementById("tabLive");
  const isoPage = document.getElementById("lifeIsoPage");
  const livePage= document.getElementById("lifeLivabilityPage");

  function switchLifeTab(type){
    if (!tabIso || !tabLive || !isoPage || !livePage) return;
    const isoOn = (type === "iso");
    tabIso.classList.toggle("active", isoOn);
    tabLive.classList.toggle("active", !isoOn);
    isoPage.classList.toggle("active", isoOn);
    livePage.classList.toggle("active", !isoOn);
  }

  if (tabIso)  tabIso.addEventListener("click",  (e)=>{ e.stopPropagation(); switchLifeTab("iso"); });
  if (tabLive) tabLive.addEventListener("click", (e)=>{ e.stopPropagation(); switchLifeTab("live"); });

  // é è¨­ï¼šå…ˆé¡¯ç¤º 15 åˆ†é˜ç”Ÿæ´»åœˆ
  switchLifeTab("iso");

  function tryComputeTaoyuanDenominators() {
    if (!taoyuanReady || !taoyuanUnionWM) return;

    if (facilityReady) {
      let facCount = 0;
      facilityLayer.graphics.forEach(pt => {
        if (!pt.geometry) return;
        if (geometryEngine.contains(taoyuanUnionWM, pt.geometry)) facCount++;
      });
      N_TAOYUAN_FAC = facCount;
    }

    if (medReady) {
      const byType = { "é†«é™¢": 0, "è—¥å±€": 0, "è€äººé•·ç…§æ©Ÿæ§‹": 0 };
      medLayer.graphics.forEach(pt => {
        if (!pt.geometry) return;
        if (!geometryEngine.contains(taoyuanUnionWM, pt.geometry)) return;
        const t = pt.attributes?.medType || "è€äººé•·ç…§æ©Ÿæ§‹";
        byType[t] = (byType[t] || 0) + 1;
      });
      N_TAOYUAN_BYTYPE = byType;
      N_TAOYUAN_MED = (byType["é†«é™¢"]||0) + (byType["è—¥å±€"]||0) + (byType["è€äººé•·ç…§æ©Ÿæ§‹"]||0);
    }

    computeAccessibilityForBuilding();
  }

  function resetLivabilityPanel() {
    livabilityContent.innerHTML = "å°šæœªé¸å–å»ºç‰©æˆ–æœªç”¢ç”Ÿ 15 åˆ†é˜ç”Ÿæ´»åœˆã€‚";
  }

  let isoEnabled = false;
  let isoMode = "foot-walking";
  function getModeText() { return isoMode === "foot-walking" ? "æ­¥è¡Œ" : "è…³è¸è»Š"; }

  function updateLivabilityPanel(params) {
    const {
      building,
      fac15Total, facXiao, facQing,
      medCounts15, Cb,
      NtaoyuanFac, NtaoyuanMed,
      scoreFac100, scoreFacWeighted,
      scoreMed100, scoreMedWeighted,

      // âœ… æ–°å¢ï¼šæ²»å®‰
      crimeScore100,
      crimeScore, // å·²ç¶“æ˜¯ Ã—0.25 çš„çµæœï¼ˆ0~0.25ï¼‰
      CRIME_15MIN, CRIME_TAOYUAN,
      totalScore

,
stability100 = 0,
trafficSafety100 = 0,
disasterSafety100 = 0,
ACC_15MIN = 0,
ACC_TAOYUAN = 0,

education100 = 0,
eduInst100 = 0,
eduLevel100 = 0,
school15 = 0,
schoolTY = 0,

infra100 = 0,
publicTrans100 = 0,
parkingInfo100 = 0,
bus15 = 0,
busTY = 0,
y15 = 0,
yTY = 0,
ev15 = 0,
evTY = 0,
p15 = 0,
pTY = 0
    } = params;

    const floors = (building?.attributes && building.attributes["æ¨“"] != null) ? building.attributes["æ¨“"] : "-";
    const height = (building?.attributes && building.attributes["heght"] != null) ? building.attributes["heght"] : "-";
    const ownership = (building?.attributes && (building.attributes['åœŸåœ°ä½¿ç”¨'] || building.attributes['æ‰€æœ‰æ¬Š'] || building.attributes['Ownership'] || building.attributes['owner'])) || 'â€”';
    const modeLabel = (window.currentIsoModeLabel || window.currentModeLabel || 'æ­¥è¡Œ');
    const use = (building?.attributes && building.attributes["Use_"] != null) ? building.attributes["Use_"] : "-";

    const cHos  = medCounts15?.["é†«é™¢"] || 0;
    const cPha  = medCounts15?.["è—¥å±€"] || 0;
    const cCare = medCounts15?.["è€äººé•·ç…§æ©Ÿæ§‹"] || 0;

    const denomFacText = (NtaoyuanFac > 0) ? `Næ¡ƒåœ’å€(å…¬å…±è¨­æ–½) = ${NtaoyuanFac}` : `Næ¡ƒåœ’å€(å…¬å…±è¨­æ–½) å°šæœªè¨ˆç®—`;
    const denomMedText = (NtaoyuanMed > 0) ? `Næ¡ƒåœ’å€(é†«ç™‚) = ${NtaoyuanMed}ï¼ˆä¸åŠ æ¬Šï¼‰` : `Næ¡ƒåœ’å€(é†«ç™‚) å°šæœªè¨ˆç®—`;

    
    // ======================
    // âœ… åˆ†æ•¸åˆ¤å®šèˆ‡ç³»çµ±å›æ‡‰ï¼ˆæ–‡å­—ï¼‰
    // ======================
    const overallAssess = getTotalLivabilityAssessment(totalScore);

    const msgStability = getIndicatorMessage("stability", stability100);
    const msgCrime     = getIndicatorMessage("crime", crimeScore100);
    const msgTraffic   = getIndicatorMessage("traffic", trafficSafety100);
    const msgDisaster  = getIndicatorMessage("disaster", disasterSafety100);

    const msgFacility  = getIndicatorMessage("facility", scoreFac100);
    const msgMedical   = getIndicatorMessage("medical", scoreMed100);

    const msgEducation = getIndicatorMessage("education", education100);
    const msgEduInst   = getIndicatorMessage("eduInst", eduInst100);
    const msgEduLevel  = getIndicatorMessage("eduLevel", eduLevel100);

    const msgInfra     = getIndicatorMessage("infra", infra100);
    const msgPubTrans  = getIndicatorMessage("publicTrans", publicTrans100);
    const msgParking   = getIndicatorMessage("parkingInfo", parkingInfo100);

livabilityContent.innerHTML = `
      <div style="margin-top:6px;margin-bottom:8px;text-align:center;">
        <div style="font-size:13px;letter-spacing:1px;color:#ffca28;font-weight:900;">å»ºç‰©å®œå±…åˆ†æ•¸</div>
        <div style="margin-top:3px;font-size:46px;line-height:1;color:#ffca28;font-weight:900;">
          ${Math.round(Math.max(0, Math.min(100, totalScore)))}
        </div>
        <div style="margin-top:6px;font-size:12px;color:#9ca3af;line-height:1.35;">
          ï¼ˆ0.25Ã—ç©©å®šæ€§ + 0.2Ã—é†«ç™‚ä¿å¥ + 0.25Ã—æ–‡åŒ–èˆ‡ç’°å¢ƒ + 0.1Ã—æ•™è‚² + 0.2Ã—åŸºç¤è¨­æ–½ï¼‰
        </div>

        <div style="margin-top:8px;font-size:13px;color:#e5e7eb;font-weight:900;">
          è©•ç´šï¼š${overallAssess.color} ${overallAssess.level}
          <span style="font-weight:700;opacity:0.9;">ï¼ˆ${overallAssess.desc}ï¼‰</span>
        </div>
        <div style="margin-top:6px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:10px;font-size:12px;line-height:1.5;color:#e5e7eb;">${overallAssess.detail}</div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.15);margin:10px 0;">

      <div style="font-size:15px;font-weight:900;color:#e5e7eb;margin-bottom:6px;">å»ºç‰©è³‡è¨Š</div>
      <div style="font-size:13px;line-height:1.55;color:#e5e7eb;">
        <div>æ¨“å±¤æ•¸ï¼š<b>${floors}</b>ï¼ˆæ¨“ï¼‰</div>
        <div>é«˜åº¦ï¼š<b>${height}</b>ï¼ˆmï¼‰</div>
        <div>åœŸåœ°æ‰€æœ‰æ¬Šï¼š<b>${ownership}</b></div>
        <div>15 åˆ†é˜æ¨¡å¼ï¼š<b>${modeLabel}</b></div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.15);margin:12px 0;">

      <div style="font-size:15px;font-weight:900;color:#e5e7eb;margin-bottom:8px;">å®œå±…åˆ†æ•¸ç´°é …</div>

      <div style="display:flex;flex-direction:column;gap:10px;">

        <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:12px;">
          <div style="font-weight:900;color:#e5e7eb;">ç©©å®šæ€§åˆ†æ•¸ï¼ˆ%ï¼‰ï¼š<span style="color:#ffca28;">${stability100.toFixed(2)}</span></div>
          <div style="height:8px;border-radius:999px;background:rgba(255,255,255,0.12);margin-top:8px;overflow:hidden;">
            <div style="height:100%;width:${Math.max(0,Math.min(100,stability100))}%;background:#ffca28;"></div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.12);margin:10px 0;">

          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
            <div style="flex:1;">
              <div style="color:#e5e7eb;font-weight:800;">äº¤é€šå®‰å…¨åˆ†æ•¸ï¼ˆ%ï¼‰ï¼š${trafficSafety100.toFixed(2)}</div>
              <div style="font-size:12px;color:#cbd5e1;margin-top:2px;">ç”Ÿæ´»åœˆå…§äº¤é€šäº‹æ•…ä»¶æ•¸ï¼š${ACC_15MIN}</div>
              <div style="font-size:12px;color:#cbd5e1;">æ¡ƒåœ’å€äº¤é€šäº‹æ•…ä»¶æ•¸ï¼š${ACC_TAOYUAN}</div>
              <div style="height:7px;border-radius:999px;background:rgba(255,255,255,0.10);margin-top:6px;overflow:hidden;">
                <div style="height:100%;width:${Math.max(0,Math.min(100,trafficSafety100))}%;background:#4caf50;"></div>
              </div>
            </div>

            <div style="flex:1;">
              <div style="color:#e5e7eb;font-weight:800;">ç½å®³å®‰å…¨åˆ†æ•¸ï¼ˆ%ï¼‰ï¼š${disasterSafety100.toFixed(2)}</div>
              <div style="font-size:12px;color:#cbd5e1;margin-top:2px;">ï¼ˆåœŸå£¤æ¶²åŒ–é«˜æ½›å‹¢æ¯”ä¾‹ï¼›ç„¡è³‡æ–™è¦–ç‚º 0ï¼‰</div>
              <div style="height:7px;border-radius:999px;background:rgba(255,255,255,0.10);margin-top:20px;overflow:hidden;">
                <div style="height:100%;width:${Math.max(0,Math.min(100,disasterSafety100))}%;background:#4caf50;"></div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div style="color:#e5e7eb;font-weight:800;">æ²»å®‰åˆ†æ•¸ï¼ˆ%ï¼‰ï¼š${crimeScore100.toFixed(2)}</div>
            <div style="font-size:12px;color:#cbd5e1;margin-top:2px;">ç”Ÿæ´»åœˆå…§çŠ¯ç½ªæ•¸ï¼š${CRIME_15MIN}</div>
            <div style="font-size:12px;color:#cbd5e1;">æ¡ƒåœ’å€çŠ¯ç½ªæ•¸ï¼š${CRIME_TAOYUAN}</div>
            <div style="height:7px;border-radius:999px;background:rgba(255,255,255,0.10);margin-top:6px;overflow:hidden;">
              <div style="height:100%;width:${Math.max(0,Math.min(100,crimeScore100))}%;background:#4caf50;"></div>
            </div>
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:12px;">
          <div style="font-weight:900;color:#e5e7eb;">é†«ç™‚ä¿å¥åˆ†æ•¸ï¼ˆ%ï¼‰ï¼š<span style="color:#ffca28;">${scoreMed100.toFixed(2)}</span></div>
          <div style="height:8px;border-radius:999px;background:rgba(255,255,255,0.12);margin-top:8px;overflow:hidden;">
            <div style="height:100%;width:${Math.max(0,Math.min(100,scoreMed100))}%;background:#ffca28;"></div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.12);margin:10px 0;">

          <div style="font-size:12px;color:#e5e7eb;line-height:1.5;">
            <div>ğŸ¥ ç”Ÿæ´»åœˆå…§é†«é™¢æ•¸é‡ï¼š${medCounts15?.["é†«é™¢"] ?? 0}ï¼ˆÃ—4ï¼‰</div>
            <div>ğŸ’Š ç”Ÿæ´»åœˆå…§è—¥å±€æ•¸é‡ï¼š${medCounts15?.["è—¥å±€"] ?? 0}ï¼ˆÃ—1ï¼‰</div>
            <div>ğŸ§“ ç”Ÿæ´»åœˆå…§é•·ç…§ï¼š${medCounts15?.["è€äººé•·ç…§æ©Ÿæ§‹"] ?? 0}ï¼ˆÃ—3ï¼‰</div>
            <div style="margin-top:6px;color:#cbd5e1;">ä¸‰ç¨®é†«ç™‚è¨­æ–½ç”Ÿæ´»åœˆå…§åŠ æ¬Šå’Œï¼š${Cb.toFixed(2)}</div>
            <div style="color:#cbd5e1;">æ¡ƒåœ’å€é†«ç™‚è¨­æ–½åŠ æ¬Šç¸½å’Œï¼š${((window.__livability && typeof window.__livability.CbTY === "number") ? window.__livability.CbTY : 0).toFixed(2)}</div>
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:12px;">
          <div style="font-weight:900;color:#e5e7eb;">æ–‡åŒ–èˆ‡ç’°å¢ƒåˆ†æ•¸ï¼ˆ%ï¼‰ï¼š<span style="color:#ffca28;">${scoreFac100.toFixed(2)}</span></div>
          <div style="height:8px;border-radius:999px;background:rgba(255,255,255,0.12);margin-top:8px;overflow:hidden;">
            <div style="height:100%;width:${Math.max(0,Math.min(100,scoreFac100))}%;background:#ffca28;"></div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.12);margin:10px 0;">

          <div style="font-size:12px;color:#e5e7eb;line-height:1.5;">
            <div>ç”Ÿæ´»åœˆå…§å¯é”å…¬å…±è¨­æ–½æ•¸é‡ï¼š${fac15Total}</div>
            <div>æ¡ƒåœ’å€å…§å…¬å…±è¨­æ–½æ•¸é‡ = ${NtaoyuanFac || 0}</div>
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:12px;">
          <div style="font-weight:900;color:#e5e7eb;">æ•™è‚²åˆ†æ•¸ï¼ˆ%ï¼‰ï¼š<span style="color:#ffca28;">${education100.toFixed(2)}</span></div>
          <div style="height:8px;border-radius:999px;background:rgba(255,255,255,0.12);margin-top:8px;overflow:hidden;">
            <div style="height:100%;width:${Math.max(0,Math.min(100,education100))}%;background:#ffca28;"></div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.12);margin:10px 0;">

          <div style="color:#e5e7eb;font-weight:800;">æ•™è‚²æ©Ÿæ§‹åˆ†æ•¸ï¼ˆ%ï¼‰ï¼š${eduInst100.toFixed(2)}</div>
          <div style="height:7px;border-radius:999px;background:rgba(255,255,255,0.10);margin-top:6px;overflow:hidden;">
            <div style="height:100%;width:${Math.max(0,Math.min(100,eduInst100))}%;background:#4caf50;"></div>
          </div>
          <div style="font-size:12px;color:#cbd5e1;margin-top:4px;">å­¸æ ¡æ•¸é‡ï¼ˆç”Ÿæ´»åœˆ/æ¡ƒåœ’å€ï¼‰ï¼š${school15} / ${schoolTY}</div>

          <div style="margin-top:10px;color:#e5e7eb;font-weight:800;">æ•™è‚²ç¨‹åº¦åˆ†æ•¸ï¼ˆ%ï¼‰ï¼š${eduLevel100.toFixed(2)}</div>
          <div style="height:7px;border-radius:999px;background:rgba(255,255,255,0.10);margin-top:6px;overflow:hidden;">
            <div style="height:100%;width:${Math.max(0,Math.min(100,eduLevel100))}%;background:#4caf50;"></div>
          </div>

          <div style="margin-top:10px;font-size:12px;color:#e5e7eb;">
            <div style="color:#cbd5e1;margin-bottom:4px;">æ•™è‚²ç¨‹åº¦æ¬Šé‡</div>
            <div style="display:grid;grid-template-columns:1fr auto;gap:4px 10px;max-width:220px;">
              <div>å°å­¸ä»¥ä¸‹</div><div>0.2</div>
              <div>åœ‹ä¸­</div><div>0.4</div>
              <div>é«˜ä¸­</div><div>0.6</div>
              <div>å¤§å­¸</div><div>0.8</div>
              <div>ç¢©åšå£«</div><div>1.0</div>
            </div>
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:12px;">
          <div style="font-weight:900;color:#e5e7eb;">åŸºç¤è¨­æ–½åˆ†æ•¸ï¼ˆ%ï¼‰ï¼š<span style="color:#ffca28;">${infra100.toFixed(2)}</span></div>
          <div style="height:8px;border-radius:999px;background:rgba(255,255,255,0.12);margin-top:8px;overflow:hidden;">
            <div style="height:100%;width:${Math.max(0,Math.min(100,infra100))}%;background:#ffca28;"></div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.12);margin:10px 0;">

          <div style="color:#e5e7eb;font-weight:800;">å…¬å…±é‹è¼¸åˆ†å¸ƒåˆ†æ•¸ï¼ˆ%ï¼‰ï¼š${publicTrans100.toFixed(2)}</div>
          <div style="height:7px;border-radius:999px;background:rgba(255,255,255,0.10);margin-top:6px;overflow:hidden;position:relative;">
            <div style="height:100%;width:${Math.max(0,Math.min(100,publicTrans100))}%;background:#4caf50;"></div>
            <!-- ä¸­ç·šï¼ˆ50%ï¼‰ -->
            <div style="position:absolute;left:50%;top:0;bottom:0;width:2px;background:rgba(255,255,255,0.25);"></div>
          </div>
          <div style="font-size:12px;color:#cbd5e1;margin-top:4px;">å…¬è»Šç«™ç‰Œï¼ˆç”Ÿæ´»åœˆ/æ¡ƒåœ’å€ï¼‰ï¼š${bus15} / ${busTY}</div>

          <div style="margin-top:10px;color:#e5e7eb;font-weight:800;">åœè»Šè³‡è¨Šåˆ†æ•¸ï¼ˆ%ï¼‰ï¼š${parkingInfo100.toFixed(2)}</div>
          <div style="height:7px;border-radius:999px;background:rgba(255,255,255,0.10);margin-top:6px;overflow:hidden;">
            <div style="height:100%;width:${Math.max(0,Math.min(100,parkingInfo100))}%;background:#4caf50;"></div>
          </div>

          <div style="margin-top:8px;font-size:12px;color:#e5e7eb;line-height:1.55;">
            <div>YouBikeç§Ÿå€Ÿç«™æ•¸é‡ï¼ˆç”Ÿæ´»åœˆ/æ¡ƒåœ’å€ï¼‰ï¼š${y15} / ${yTY}</div>
            <div>EVå……é›»ç«™æ•¸é‡ï¼ˆç”Ÿæ´»åœˆ/æ¡ƒåœ’å€ï¼‰ï¼š${ev15} / ${evTY}</div>
            <div>åœè»Šå ´ï¼ˆç”Ÿæ´»åœˆ/æ¡ƒåœ’å€ï¼‰ï¼š${p15} / ${pTY}</div>
          </div>
        </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.15);margin:12px 0;">

      <div style="font-size:14px;font-weight:900;color:#e5e7eb;margin-bottom:6px;">ç³»çµ±åˆ¤å®šèˆ‡å»ºè­°</div>
      <div style="display:flex;flex-direction:column;gap:8px;font-size:12px;line-height:1.5;color:#e5e7eb;">
        <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:10px;">
          <div style="font-weight:900;">ç©©å®šæ€§ï¼š${msgStability.title}</div>
          <div style="opacity:0.95;margin-top:2px;">${msgStability.msg}</div>
        </div>

        <div style="display:flex;gap:8px;">
          <div style="flex:1;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:10px;">
            <div style="font-weight:900;">æ²»å®‰ï¼š${msgCrime.title}</div>
            <div style="opacity:0.95;margin-top:2px;">${msgCrime.msg}</div>
          </div>
          <div style="flex:1;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:10px;">
            <div style="font-weight:900;">äº¤é€šå®‰å…¨ï¼š${msgTraffic.title}</div>
            <div style="opacity:0.95;margin-top:2px;">${msgTraffic.msg}</div>
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:10px;">
          <div style="font-weight:900;">ç½å®³å®‰å…¨ï¼š${msgDisaster.title}</div>
          <div style="opacity:0.95;margin-top:2px;">${msgDisaster.msg}</div>
        </div>

        <div style="display:flex;gap:8px;">
          <div style="flex:1;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:10px;">
            <div style="font-weight:900;">å…¬å…±è¨­æ–½ï¼š${msgFacility.title}</div>
            <div style="opacity:0.95;margin-top:2px;">${msgFacility.msg}</div>
          </div>
          <div style="flex:1;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:10px;">
            <div style="font-weight:900;">é†«ç™‚è³‡æºï¼š${msgMedical.title}</div>
            <div style="opacity:0.95;margin-top:2px;">${msgMedical.msg}</div>
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:10px;">
          <div style="font-weight:900;">æ•™è‚²ï¼š${msgEducation.title}</div>
          <div style="opacity:0.95;margin-top:2px;">${msgEducation.msg}</div>
          <div style="margin-top:6px;opacity:0.95;">
            <div>â€¢ æ•™è‚²æ©Ÿæ§‹ï¼š${msgEduInst.title}</div>
            <div>â€¢ æ•™è‚²ç¨‹åº¦ï¼š${msgEduLevel.title}</div>
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:10px;">
          <div style="font-weight:900;">åŸºç¤è¨­æ–½ï¼š${msgInfra.title}</div>
          <div style="opacity:0.95;margin-top:2px;">${msgInfra.msg}</div>
          <div style="margin-top:6px;opacity:0.95;">
            <div>â€¢ å…¬å…±é‹è¼¸ï¼š${msgPubTrans.title}</div>
            <div>â€¢ åœè»Šè³‡è¨Šï¼š${msgParking.title}</div>
          </div>
        </div>
      </div>


      </div>
    `;
    // âœ… æœ‰ç”¢ç”Ÿ/æ›´æ–°å®œå±…åˆ†æ•¸å…§å®¹æ™‚ï¼Œè‡ªå‹•åˆ‡åˆ°ã€Œå®œå±…åˆ†æ•¸ã€åˆ†é 
    try { switchLifeTab("live"); } catch(e) {}
    // âœ… æ›´æ–°å®œå±…åˆ†æ•¸å¾Œåœåœ¨æœ€ä¸Šæ–¹ï¼ˆé¡¯ç¤ºç¸½åˆ†ï¼‰
    try {
      requestAnimationFrame(() => {
        if (!livePage) return;
        livePage.scrollTop = 0;
      });
    } catch(e) {}
}

  /* åº•åœ–è¨­å®š */
  const streetsLayer = new WebTileLayer({ urlTemplate: "https://tile.openstreetmap.org/{z}/{x}/{y}.png", title: "OSM Streets" });
  const topoLayer = "topo";
  const satelliteLayer = "satellite";
  const emapLayer = new WMTSLayer({
    url: "https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible",
    title: "EMAP", style: "default", tileMatrixSet: "GoogleMapsCompatible", format: "image/png"
  });
  const photo2Layer = new WebTileLayer({
    urlTemplate: "https://wmts.nlsc.gov.tw/wmts/PHOTO2/default/GoogleMapsCompatible/{z}/{y}/{x}.jpg",
    title: "PHOTO2", opacity: 1, elevationInfo: { mode: "on-the-ground" }
  });

  map.add(emapLayer, 0);

  const basemapDict = { streets: streetsLayer, topo: topoLayer, satellite: satelliteLayer, emap: emapLayer, photo2: photo2Layer };

  const basemapButton = document.getElementById("basemapButton");
  const basemapPanel = document.getElementById("basemapPanel");

  basemapButton.addEventListener("click", () => {
    basemapPanel.style.display = basemapPanel.style.display === "block" ? "none" : "block";
  });

  document.querySelectorAll('#basemapPanel input[type="checkbox"]').forEach(input => {
    input.addEventListener("change", function () {
      const selectedBasemap = this.dataset.basemap;

      if (map.layers.includes(emapLayer)) map.remove(emapLayer);
      if (map.layers.includes(photo2Layer)) map.remove(photo2Layer);
      if (map.layers.includes(streetsLayer)) map.remove(streetsLayer);

      if (selectedBasemap === "emap") map.add(emapLayer, 0);
      else if (selectedBasemap === "photo2") map.add(photo2Layer, 0);
      else if (selectedBasemap === "streets") map.add(streetsLayer, 0);
      else map.basemap = basemapDict[selectedBasemap];

      document.querySelectorAll('#basemapPanel input[type="checkbox"]').forEach(cb => {
        cb.checked = cb.dataset.basemap === selectedBasemap;
      });
    });
  });

  /* åœ–å±¤è¨­å®š */
  const buildingLayer = new SceneLayer({
    url: "https://services5.arcgis.com/yqmzFsAzBUNEIWLw/arcgis/rest/services/%E5%B0%8F%E6%AA%9C%E6%BA%AA3D%E5%BB%BA%E7%89%A95/SceneServer",
    popupEnabled: false,
    renderer: {
      type: "simple",
      symbol: {
        type: "mesh-3d",
        symbolLayers: [{ type: "fill", material: { color: [200, 200, 200, 0.8] } }]
      },
      visualVariables: [{
        type: "color",
        field: "æ¨“",
        stops: [
          { value: 3,  color: [144, 238, 144, 0.9] },
          { value: 6,  color: [135, 206, 250, 0.9] },
          { value: 10, color: [255, 200, 87, 0.9] },
          { value: 20, color: [186, 85, 211, 0.9] }
        ]
      }]
    }
  });
  map.add(buildingLayer);

  const houseLayer = new GraphicsLayer({ visible: false });
  const facilityLayer = new GraphicsLayer();
  const medLayer = new GraphicsLayer();
  const isochroneLayer = new GraphicsLayer();
  const drawLayer = new GraphicsLayer();
  map.addMany([houseLayer, isochroneLayer, drawLayer, facilityLayer, medLayer]);

  const apiKeyTraffic = "AAPTxy8BH1VEsoebNVZXo8HurG35MoS3OvUYxFcNeS2m5JxU1AR5TGUGDBXLI8BTgkxZ8XFImL07ZrGjzL88WXWEeWRV8XgMpTRASIkKUh0ATXQcRJOdOlXp6pGgL1lW_A12BvA801o1IIFBe3DJnCBgWnqcjShpc8t_b3Nc2o75ulf6Di9mM2btfpa_fZkHZi3362RlCmTwfSMmk_mZT6jTEwVBJqm1EBVk4O9pS9-p8xE.AT1_7VueP0OE";

// âœ… äº¤é€šæµé‡ï¼šSceneView ä¸æ”¯æ´ MapImageLayerï¼Œæ”¹ç”¨ 2D MapView è¦†è“‹é¡¯ç¤ºï¼ˆåªç•«äº¤é€šç·šï¼‰

/* =========================
   âœ… äº¤é€šæµé‡åœ–å±¤ï¼ˆ3D ç›´æ¥ç–Šåœ¨ SceneViewï¼‰
   - ä¸ç”¨ 2D Overlayï¼Œé¿å… basemap / container / SR å•é¡Œ
   ========================= */
const trafficLayer = new MapImageLayer({
  title: "World Traffic",
  url: "https://traffic.arcgis.com/arcgis/rest/services/World/Traffic/MapServer",
  opacity: 1,
  apiKey: apiKeyTraffic,
  elevationInfo: { mode: "relative-to-scene", offset: 100 },
  visible: false
});
map.add(trafficLayer);

document.getElementById("trafficToggle").addEventListener("change", (e) => {
  trafficLayer.visible = e.target.checked;
});


/* å…¬å…±è¨­æ–½é¡è‰² / åœ–ç¤º / åˆ†é¡ */
  const typeColors = {
    "æ¶ˆé˜²æ “":"red","è¦çš®åº—åˆ°åº—":"gold","ç‰¹åŠ›å±‹":"teal","å®œå¾—åˆ©":"lightseagreen",
    "MiaCbon":"darkgreen","èœœé„°(å°ç³–)":"lime","POYAå¯¶é›…":"deeppink","å±ˆè‡£æ°":"hotpink","åº·æ˜¯ç¾":"pink","ç‡¦å¤":"magenta",
    "å®¶æ¨‚ç¦(è¶…å¸‚)":"limegreen","å°åŒ—ç™¾è²¨":"darkgreen","å…¨è¯ç¦åˆ©ä¸­å¿ƒ":"seagreen","ç¾å»‰ç¤¾":"forestgreen",
    "çµ±ä¸€è¶…å•†(7-11)":"orange","å…¨å®¶":"orangered","OK":"gold","èŠçˆ¾å¯Œ":"darkorange",
    "å¯ºå»Ÿ":"purple","ç’°ä¿æ¨™ç« æ—…é¤¨":"purple","æ¡ƒæ¨‚è³‡æ”¶ç«™":"green","å­¸æ ¡":"#3f51b5",
    "ç„¡éšœç¤™å»æ‰€":"gray","å¥³å»æ‰€":"lightgray","ç”·å»æ‰€":"darkgray","æ€§åˆ¥å‹å–„å»æ‰€":"silver","è¦ªå­å»æ‰€":"lightpink","æ··åˆå»æ‰€":"pink",
    "å…¬æœ‰å¸‚å ´":"å…¬æœ‰å¸‚å ´","OK mini":"skyblue","éƒµå±€":"blue","æ–°ç«¹è²¨é‹":"mediumblue","é»‘è²“å®…æ€¥ä¾¿":"navy",
    "21é¢¨å‘³é¤¨":"brown","SUBWAY":"olive","è‚¯å¾·åŸº":"goldenrod","é ‚å‘±å‘±":"tan",
    "éº¥ç•¶å‹":"saddlebrown","æ¼¢å ¡ç‹":"peru","æ‘©æ–¯æ¼¢å ¡":"chocolate",
    "å°ç£å¤§å“¥å¤§":"cyan","é å‚³":"deepskyblue","ä¸­è¯é›»ä¿¡":"dodgerblue",
    "æ‹¿å¡é‡ŒæŠ«è–©":"coral","é”ç¾æ¨‚":"salmon","å¿…å‹å®¢":"tomato",
    "å®¶æ¨‚ç¦(é‡è²©)":"red","æ„›è²·æ¡ƒåœ’å€":"darkred","å°å¡‘çŸ³æ²¹":"black","å°ç£ä¸­æ²¹":"dimgray"
  };

  const typeIcons = {
    "çµ±ä¸€è¶…å•†(7-11)": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/7-11.png",
    "å…¨å®¶": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å…¨å®¶.png",
    "OK": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ok.png",
    "èŠçˆ¾å¯Œ": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/èŠçˆ¾å¯Œ.png",
    "å…¨è¯ç¦åˆ©ä¸­å¿ƒ": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å…¨è¯.png",
    "å°åŒ—ç™¾è²¨": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å°åŒ—ç™¾è²¨.png",
    "ç¾å»‰ç¤¾": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ç¾è¯ç¤¾.png",
    "å®¶æ¨‚ç¦(è¶…å¸‚)": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å®¶æ¨‚ç¦è¶…å¸‚.png",
    "å®¶æ¨‚ç¦(é‡è²©)": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å®¶æ¨‚ç¦é‡è²©.png",
    "æ„›è²·æ¡ƒåœ’å€": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ„›è²·.png",
    "å°ç£ä¸­æ²¹": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ä¸­æ²¹.png",
    "å°å¡‘çŸ³æ²¹": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å°å¡‘çŸ³æ²¹.png",
    "éƒµå±€": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/éƒµå±€.png",
    "æ–°ç«¹è²¨é‹": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ–°ç«¹è²¨é‹.png",
    "é»‘è²“å®…æ€¥ä¾¿": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/é»‘è²“å®…æ€¥ä¾¿.png",
    "OK mini": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ok_mini.png",
    "è¦çš®åº—åˆ°åº—": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/è¦çš®åº—åˆ°åº—.png",
    "éº¥ç•¶å‹": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/éº¥ç•¶å‹.png",
    "è‚¯å¾·åŸº": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/è‚¯å¾·åŸº.png",
    "é ‚å‘±å‘±": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/é ‚å‘±å‘±.png",
    "æ‘©æ–¯æ¼¢å ¡": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ‘©æ–¯æ¼¢å ¡.png",
    "æ¼¢å ¡ç‹": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ¼¢å ¡ç‹.png",
    "SUBWAY": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/subway.png",
    "é”ç¾æ¨‚": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/é”ç¾æ¨‚.png",
    "å¿…å‹å®¢": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å¿…å‹å®¢.png",
    "æ‹¿å¡é‡ŒæŠ«è–©": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ‹¿å¡é‡ŒæŠ«è–©.png",
    "POYAå¯¶é›…": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å¯¶é›….png",
    "å±ˆè‡£æ°": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å±ˆè‡£æ°.png",
    "åº·æ˜¯ç¾": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/åº·æ˜¯ç¾.png",
    "ç‡¦å¤": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ç‡¦å¤.png",
    "å¯ºå»Ÿ": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å¯ºå»Ÿ.png",
    "å­¸æ ¡": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/school.png",
    "æ¶ˆé˜²æ “": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ¶ˆé˜²æ “.png",
    "ç„¡éšœç¤™å»æ‰€": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ç„¡éšœç¤™å»æ‰€.png",
    "ç”·å»æ‰€": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ç”·å»æ‰€.png",
    "å¥³å»æ‰€": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å¥³å»æ‰€.png",
    "æ€§åˆ¥å‹å–„å»æ‰€": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ€§åˆ¥å‹å–„å»æ‰€.png",
    "è¦ªå­å»æ‰€": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/è¦ªå­å»æ‰€.png",
    "æ··åˆå»æ‰€": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ··å’Œå»æ‰€.png",
    "ç’°ä¿æ¨™ç« æ—…é¤¨": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ç’°ä¿æ¨™ç« æ—…é¤¨.png",
    "æ¡ƒæ¨‚è³‡æ”¶ç«™": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/æ¡ƒæ¨‚è³‡å›æ”¶ç«™.png",
    "ç‰¹åŠ›å±‹": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ç‰¹åŠ›å±‹.png",
    "å®œå¾—åˆ©": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å®œå¾—åˆ©.png",
    "MiaCbon": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/MiaCbon.png",
    "èœœé„°(å°ç³–)": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/èœœé„°(å°ç³–).png",
    "å…¬æœ‰å¸‚å ´":"https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å…¬æœ‰å¸‚å ´.png",
    "21é¢¨å‘³é¤¨":"https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/21plus.png",
    "å°ç£å¤§å“¥å¤§":"https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/å°ç£å¤§å“¥å¤§.png",
    "é å‚³":"https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/é å‚³.png",
    "ä¸­è¯é›»ä¿¡":"https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/ä¸­è¯é›»ä¿¡.png"
  };

  const medTypeIcons = {
    "é†«é™¢": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/é†«é™¢.png",
    "è—¥å±€": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/è—¥å±€.png",
    "è€äººé•·ç…§æ©Ÿæ§‹": "https://cdn.jsdelivr.net/gh/jade0815/Bicycle@main/é•·ç…§æ©Ÿæ§‹.png"
  };

  function getFacilitySymbol(type) {
    const iconUrl = typeIcons[type];
    if (iconUrl) {
      return { type: "picture-marker", url: iconUrl, width: "20px", height: "20px", outline: { color: "black", width: 1 } };
    }
    return { type: "simple-marker", color: typeColors[type] || "gray", size: 10, outline: { color: "black", width: 1 } };
  }

  function getMedSymbol(type) {
    const iconUrl = medTypeIcons[type];
    if (iconUrl) {
      return { type: "picture-marker", url: iconUrl, width: "22px", height: "22px", outline: { color: [0,0,0,1], width: 1 } };
    }
    return { type: "simple-marker", color: [0, 191, 165, 1], size: 10, outline: { color: [255, 255, 255, 1], width: 1 } };
  }

  const facilityFieldAlias = {
    "é–€å¸‚åº—": "é–€å¸‚åº—è™Ÿ", "é–€å¸‚_1": "é–€å¸‚åº—å", "é–€å¸‚é›»": "é–€å¸‚é›»è©±",
    "é–€å¸‚é›»è©±2": "é–€å¸‚é›»è©±2", "é–€å¸‚_12": "é–€å¸‚é›»è©±2", "ç‡Ÿæ¥­æ™‚": "ç‡Ÿæ¥­æ™‚é–“",
    "æ¥æ”¶å‚³": "å‚³çœŸ", "é–€å¸‚å‚³": "é–€å¸‚å‚³çœŸ", "é–€å¸‚å“": "é–€å¸‚å“ç‰Œ",
    "é–€å¸‚åœ°": "é–€å¸‚åœ°å€", "çµ±ä¸€ç·¨": "çµ±ä¸€ç·¨è™Ÿ"
  };

  function buildAttributesTableHTML(attrs) {
    let html = "<table class='popup-table'>";
    Object.keys(attrs).forEach(key => {
      const val = attrs[key] == null ? "" : attrs[key];
      const label = facilityFieldAlias[key] || key;
      html += `<tr><th>${label}</th><td>${val}</td></tr>`;
    });
    html += "</table>";
    return html;
  }

  function resetFacilitySymbol(g) {
    if (!g || !g.attributes || !g.attributes.type) return;
    g.symbol = getFacilitySymbol(g.attributes.type);
  }
  function resetMedSymbol(g) {
    if (!g || !g.attributes) return;
    const t = g.attributes.medType || "è€äººé•·ç…§æ©Ÿæ§‹";
    g.symbol = getMedSymbol(t);
  }

  function showFacilityPopup(graphic) {
    if (activeFacility && activeFacility !== graphic) resetFacilitySymbol(activeFacility);
    if (activeMed) { resetMedSymbol(activeMed); activeMed = null; }
    activeFacility = graphic;

    const attrs = graphic.attributes || {};
    const type = attrs.type;
    const baseSymbol = getFacilitySymbol(type);

    if (baseSymbol.type === "picture-marker") {
      graphic.symbol = { type: "picture-marker", url: baseSymbol.url, width: "30px", height: "30px", outline: baseSymbol.outline };
    } else {
      graphic.symbol = { type: "simple-marker", color: baseSymbol.color, size: 18, outline: baseSymbol.outline };
    }

    const title = attrs["é–€å¸‚_1"] || attrs["é–€å¸‚åº—"] || attrs["name"] || attrs["type"] || "å…¬å…±è¨­æ–½";
    const tableHtml = buildAttributesTableHTML(attrs);

    popupDiv.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <div style="font-weight:bold;">${title}</div>
        <button id="popupCloseBtn" style="border:none;background:transparent;font-size:16px;cursor:pointer;line-height:1;">âœ•</button>
      </div>
      ${tableHtml}
    `;

    document.getElementById("popupCloseBtn").onclick = (e) => {
      e.stopPropagation();
      popupDiv.style.display = "none";
      if (activeFacility) { resetFacilitySymbol(activeFacility); activeFacility = null; }
      if (activeMed) { resetMedSymbol(activeMed); activeMed = null; }
      view.goTo(initialCamera);
    };

    view.goTo({ target: graphic.geometry, tilt: 65, zoom: 18 }, { duration: 1000 })
      .then(() => positionPopupAtPoint(graphic.geometry));
  }

  function showMedPopup(graphic) {
    if (activeMed && activeMed !== graphic) resetMedSymbol(activeMed);
    if (activeFacility) { resetFacilitySymbol(activeFacility); activeFacility = null; }
    activeMed = graphic;

    const attrs = graphic.attributes || {};
    const medType = attrs.medType || "é†«ç™‚é•·ç…§";
    const baseSymbol = getMedSymbol(medType);

    if (baseSymbol.type === "picture-marker") {
      graphic.symbol = { type: "picture-marker", url: baseSymbol.url, width: "32px", height: "32px", outline: baseSymbol.outline };
    } else {
      graphic.symbol = { type: "simple-marker", color: baseSymbol.color, size: 18, outline: baseSymbol.outline };
    }

    const title = attrs["åç¨±"] || attrs["è—¥å±€å"] || attrs["æ©Ÿæ§‹åç¨±"] || attrs["é†«äº‹æ©Ÿæ§‹é¡åˆ¥"] || medType;
    const tableHtml = buildAttributesTableHTML(attrs);

    popupDiv.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <div style="font-weight:bold;">${title}</div>
        <button id="popupCloseBtn" style="border:none;background:transparent;font-size:16px;cursor:pointer;line-height:1;">âœ•</button>
      </div>
      ${tableHtml}
    `;

    document.getElementById("popupCloseBtn").onclick = (e) => {
      e.stopPropagation();
      popupDiv.style.display = "none";
      if (activeMed) { resetMedSymbol(activeMed); activeMed = null; }
      if (activeFacility) { resetFacilitySymbol(activeFacility); activeFacility = null; }
      view.goTo(initialCamera);
    };

    view.goTo({ target: graphic.geometry, tilt: 65, zoom: 18 }, { duration: 1000 })
      .then(() => positionPopupAtPoint(graphic.geometry));
  }

  // âœ… bigCategoryï¼ˆåŸæ¨£ä¿ç•™ï¼‰
  const bigCategory = {
    "æ¶ˆé˜²æ “": "æ¶ˆé˜²æ “","è¦çš®åº—åˆ°åº—":"è¦çš®åº—åˆ°åº—",
    "ç‰¹åŠ›å±‹":"å®¶å±…","å®œå¾—åˆ©":"å®¶å±…",
    "POYAå¯¶é›…":"è—¥å¦ã€ç¾å¦ç”Ÿæ´»ç”¨å“","å±ˆè‡£æ°":"è—¥å¦ã€ç¾å¦ç”Ÿæ´»ç”¨å“","åº·æ˜¯ç¾":"è—¥å¦ã€ç¾å¦ç”Ÿæ´»ç”¨å“",
    "ç‡¦å¤":"ç‡¦å¤",
    "å®¶æ¨‚ç¦(è¶…å¸‚)":"è¶…å¸‚","å°åŒ—ç™¾è²¨":"è¶…å¸‚","å…¨è¯ç¦åˆ©ä¸­å¿ƒ":"è¶…å¸‚","ç¾å»‰ç¤¾":"è¶…å¸‚","MiaCbon":"è¶…å¸‚","èœœé„°(å°ç³–)":"è¶…å¸‚",
    "çµ±ä¸€è¶…å•†(7-11)":"ä¾¿åˆ©å•†åº—","å…¨å®¶":"ä¾¿åˆ©å•†åº—","OK":"ä¾¿åˆ©å•†åº—","èŠçˆ¾å¯Œ":"ä¾¿åˆ©å•†åº—",
    "å¯ºå»Ÿ":"å¯ºå»Ÿ","ç’°ä¿æ¨™ç« æ—…é¤¨":"ç’°ä¿æ¨™ç« æ—…é¤¨","æ¡ƒæ¨‚è³‡æ”¶ç«™":"æ¡ƒæ¨‚è³‡æ”¶ç«™ç«™é»","å­¸æ ¡":"å­¸æ ¡",
    "ç„¡éšœç¤™å»æ‰€":"å»æ‰€","å¥³å»æ‰€":"å»æ‰€","ç”·å»æ‰€":"å»æ‰€","æ€§åˆ¥å‹å–„å»æ‰€":"å»æ‰€","è¦ªå­å»æ‰€":"å»æ‰€","æ··åˆå»æ‰€":"å»æ‰€",
    "å…¬æœ‰å¸‚å ´":"å…¬æœ‰å¸‚å ´",
    "OK mini":"ç‰©æµ","éƒµå±€":"ç‰©æµ","æ–°ç«¹è²¨é‹":"ç‰©æµ","é»‘è²“å®…æ€¥ä¾¿":"ç‰©æµ",
    "21é¢¨å‘³é¤¨":"é€Ÿé£Ÿåº—","SUBWAY":"é€Ÿé£Ÿåº—","è‚¯å¾·åŸº":"é€Ÿé£Ÿåº—","é ‚å‘±å‘±":"é€Ÿé£Ÿåº—",
    "éº¥ç•¶å‹":"é€Ÿé£Ÿåº—","æ¼¢å ¡ç‹":"é€Ÿé£Ÿåº—","æ‘©æ–¯æ¼¢å ¡":"é€Ÿé£Ÿåº—",
    "å°ç£å¤§å“¥å¤§":"é€šè¨Šè¡Œ","é å‚³":"é€šè¨Šè¡Œ","ä¸­è¯é›»ä¿¡":"é€šè¨Šè¡Œ",
    "æ‹¿å¡é‡ŒæŠ«è–©":"æŠ«è–©","é”ç¾æ¨‚":"æŠ«è–©","å¿…å‹å®¢":"æŠ«è–©",
    "å®¶æ¨‚ç¦(é‡è²©)":"å¤§è³£å ´","æ„›è²·æ¡ƒåœ’å€":"å¤§è³£å ´","å°å¡‘çŸ³æ²¹":"åŠ æ²¹ç«™","å°ç£ä¸­æ²¹":"åŠ æ²¹ç«™"
  };

  /* å°æªœæºªç¯„åœ union å¹¾ä½•ï¼ˆWebMercatorï¼‰ */
  const boundaryLayer = new GraphicsLayer();
  map.add(boundaryLayer);
  let boundaryUnionWM = null;

  fetch("https://jade0815.github.io/data/xiaoguaixi.geojson")
    .then(res => res.json())
    .then(data => {
      const polysWM = [];
      data.features.forEach(f => {
        if (f.geometry.type === "Polygon") {
          const rings = f.geometry.coordinates[0].map(c => [c[0], c[1]]);
          addExtrudePolygon(rings, polysWM);
        } else if (f.geometry.type === "MultiPolygon") {
          f.geometry.coordinates.forEach(polygon => {
            const rings = polygon[0].map(c => [c[0], c[1]]);
            addExtrudePolygon(rings, polysWM);
          });
        }
      });
      if (polysWM.length > 0) boundaryUnionWM = geometryEngine.union(polysWM);

      // âœ… è‹¥äº‹æ•…å·²è¼‰å…¥ï¼Œæ”¹ç”¨ã€å°æªœæºªç¯„åœå…§ã€è³‡æ–™ä¸¦é‡ç•«åœ–è¡¨/é»ä½
      try{ if (typeof rebuildAccidentScopeIfReady === "function") rebuildAccidentScopeIfReady(); }catch(e){}
      try{ if(accidentLoaded){ refreshAccidentUI(); } }catch(e){}

    });

  function addExtrudePolygon(rings, polysWM) {
    const poly4326 = new Polygon({ rings, spatialReference: { wkid: 4326 } });
    const polyWM = webMercatorUtils.geographicToWebMercator(poly4326);
    polysWM.push(polyWM);
    const g = new Graphic({
      geometry: poly4326,
      symbol: {
        type: "polygon-3d",
        symbolLayers: [{
          type: "extrude",
          size: 200,
          material: { color: [0, 0, 255, 0] },
          edges: { type: "solid", color: [0, 0, 200, 0] }
        }]
      }
    });
    boundaryLayer.add(g);
  }

  function isInsideXiaoguaixi(pointWM) {
    if (!boundaryUnionWM) return false;
    return geometryEngine.contains(boundaryUnionWM, pointWM);
  }

  /* âœ… å…¬å…±è¨­æ–½åœ–ä¾‹ & çµ±è¨ˆï¼ˆåŸæ¨£ä¿ç•™ï¼‰ */
  const legendStatus = {};
  const medLegendStatus = {};
  const categories = {};
  Object.keys(bigCategory).forEach(type => {
    const big = bigCategory[type];
    if (!categories[big]) categories[big] = [];
    categories[big].push(type);
  });

  Object.keys(bigCategory).forEach(type => {
    const big = bigCategory[type];
    let bigDiv = legendDiv.querySelector(`.legend-category[data-big="${big}"]`);
    if (!bigDiv) {
      bigDiv = document.createElement("div");
      bigDiv.className = "legend-category";
      bigDiv.dataset.big = big;
      const title = document.createElement("b");
      title.textContent = big;
      bigDiv.appendChild(title);
      legendDiv.appendChild(bigDiv);
    }

    const itemDiv = document.createElement("div");
    itemDiv.className = "legend-item";

    const iconUrl = typeIcons[type];
    let iconElement;
    if (iconUrl) {
      iconElement = document.createElement("img");
      iconElement.src = iconUrl;
      iconElement.className = "legend-icon";
    } else {
      iconElement = document.createElement("div");
      iconElement.className = "legend-color";
      iconElement.style.backgroundColor = typeColors[type] || "gray";
    }

    const label = document.createElement("span");
    label.textContent = type;

    itemDiv.appendChild(iconElement);
    itemDiv.appendChild(label);
    bigDiv.appendChild(itemDiv);

    legendStatus[type] = false;
    label.style.color = "lightgray";
    iconElement.style.opacity = 0.3;

    itemDiv.onclick = () => {
      const visible = !legendStatus[type];
      legendStatus[type] = visible;
      label.style.color = visible ? "black" : "lightgray";
      iconElement.style.opacity = visible ? 1 : 0.3;
      facilityLayer.graphics.forEach(g => {
        if (g.attributes.type === type) g.visible = visible;
      });
      if (!visible && activeFacility && activeFacility.attributes.type === type) {
        popupDiv.style.display = "none";
        resetFacilitySymbol(activeFacility);
        activeFacility = null;
        view.goTo(initialCamera);
      }
    };
  });

  /* âœ… å³å´çµ±è¨ˆé¢æ¿å…ƒç´  */
  const facilityStatsContainer = document.getElementById("statsFacilityContainer");
  const medStatsContainer = document.getElementById("statsMedContainer");
  const totalHouseDiv = document.getElementById("statsTotalHouse");
  const tabFacility = document.getElementById("tabFacility");
  const tabMed = document.getElementById("tabMed");
  const statsHeaderTitle = document.getElementById("statsHeaderTitle");

  const bigCountSpans = {};
  const subCountSpans = {};
  const medTypeSpans = {};
  let medTotalSpan;

  Object.keys(categories).forEach(big => {
    const bigWrap = document.createElement("div");
    bigWrap.style.marginBottom = "6px";

    const title = document.createElement("div");
    title.className = "big-cat-title";
    title.textContent = big + " ";
    const bigSpan = document.createElement("span");
    bigSpan.textContent = "(0)";
    bigSpan.style.color = "#FFC55A";
    bigCountSpans[big] = bigSpan;
    title.appendChild(bigSpan);

    const subDiv = document.createElement("div");
    subDiv.style.display = "none";
    subDiv.style.marginTop = "2px";
    title.onclick = () => {
      subDiv.style.display = subDiv.style.display === "none" ? "block" : "none";
    };

    categories[big].forEach(type => {
      const row = document.createElement("div");
      row.className = "sub-cat-row";

      const btn = document.createElement("button");
      btn.textContent = type;
      btn.style.background = typeColors[type] || "gray";

      const countSpan = document.createElement("span");
      countSpan.textContent = "0";
      subCountSpans[type] = countSpan;

      let visible = false;
      btn.style.opacity = 0.5;
      btn.onclick = () => {
        visible = !visible;
        btn.style.opacity = visible ? "1" : "0.5";
        facilityLayer.graphics.forEach(g => {
          if (g.attributes.type === type) g.visible = visible;
        });
      };

      row.appendChild(btn);
      row.appendChild(countSpan);
      subDiv.appendChild(row);
    });

    bigWrap.appendChild(title);
    bigWrap.appendChild(subDiv);
    facilityStatsContainer.appendChild(bigWrap);
  });

  medTotalSpan = document.createElement("div");
  medTotalSpan.textContent = "ç¸½æ•¸: 0";
  medTotalSpan.style.fontWeight = "bold";
  medTotalSpan.style.fontSize = "13px";
  medTotalSpan.style.background = "rgba(255,255,255,0.2)";
  medTotalSpan.style.padding = "4px 0";
  medTotalSpan.style.borderRadius = "4px";
  medTotalSpan.style.marginBottom = "4px";
  medStatsContainer.appendChild(medTotalSpan);

  const medTypesList = ["é†«é™¢", "è—¥å±€", "è€äººé•·ç…§æ©Ÿæ§‹"];
  medTypesList.forEach(type => {
    const row = document.createElement("div");
    row.className = "sub-cat-row";

    const btn = document.createElement("button");
    btn.textContent = type;
    btn.style.background = "#009688";

    const countSpan = document.createElement("span");
    countSpan.textContent = "0";
    countSpan.style.color = "#FFC55A";
    medTypeSpans[type] = countSpan;

    let visible = false;
    btn.style.opacity = 0.5;
    btn.onclick = () => {
      visible = !visible;
      btn.style.opacity = visible ? "1" : "0.5";
      medLayer.graphics.forEach(g => {
        const t = g.attributes.medType;
        if (t === type) g.visible = visible;
      });
    };

    row.appendChild(btn);
    row.appendChild(countSpan);
    medStatsContainer.appendChild(row);
  });

  medLegendDiv.innerHTML = "<b>é†«ç™‚é•·ç…§åœ–ä¾‹</b>";
  medTypesList.forEach(type => {
    const itemDiv = document.createElement("div");
    itemDiv.className = "legend-item";

    const icon = document.createElement("img");
    icon.className = "legend-icon";
    icon.src = medTypeIcons[type];

    const label = document.createElement("span");
    label.textContent = type;

    itemDiv.appendChild(icon);
    itemDiv.appendChild(label);
    medLegendDiv.appendChild(itemDiv);

    medLegendStatus[type] = false;
    label.style.color = "lightgray";
    icon.style.opacity = 0.3;

    itemDiv.onclick = () => {
      const visible = !medLegendStatus[type];
      medLegendStatus[type] = visible;
      label.style.color = visible ? "black" : "lightgray";
      icon.style.opacity = visible ? 1 : 0.3;
      medLayer.graphics.forEach(g => {
        const t = g.attributes.medType;
        if (t === type) g.visible = visible;
      });
    };
  });

  legendDiv.style.display = "none";
  medLegendDiv.style.display = "none";

  const toggleLegendBtn = document.createElement("button");
  toggleLegendBtn.textContent = "é¡¯ç¤ºåœ–ä¾‹";
  Object.assign(toggleLegendBtn.style, {
    position: "fixed",
    bottom: "195px",
    right: "170px",
    padding: "4px 8px",
    fontSize: "12px",
    background: "#0079c1",
    color: "#fff",
    border: "none",
    borderRadius: "7px",
    cursor: "pointer",
    zIndex: 1001,
    transition: "all 0.2s ease-in-out"
  });
  toggleLegendBtn.onmouseover = () => { toggleLegendBtn.style.background = "#005a8c"; toggleLegendBtn.style.transform = "scale(1.1)"; };
  toggleLegendBtn.onmouseout  = () => { toggleLegendBtn.style.background = "#0079c1"; toggleLegendBtn.style.transform = "scale(1)"; };
  toggleLegendBtn.onclick = () => {
    if (currentStatsMode === "facility") {
      if (legendDiv.style.display === "none") {
        legendDiv.style.display = "block";
        medLegendDiv.style.display = "none";
        toggleLegendBtn.textContent = "éš±è—åœ–ä¾‹";
      } else {
        legendDiv.style.display = "none";
        toggleLegendBtn.textContent = "é¡¯ç¤ºåœ–ä¾‹";
      }
    } else {
      if (medLegendDiv.style.display === "none") {
        medLegendDiv.style.display = "block";
        legendDiv.style.display = "none";
        toggleLegendBtn.textContent = "éš±è—åœ–ä¾‹";
      } else {
        medLegendDiv.style.display = "none";
        toggleLegendBtn.textContent = "é¡¯ç¤ºåœ–ä¾‹";
      }
    }
  };
  toggleLegendBtn.id = "toggleLegendBtn"; // âœ… çµ¦å®ƒ id æ–¹ä¾¿æ§åˆ¶
document.getElementById("livabilityUI").appendChild(toggleLegendBtn);

  function switchStatsMode(mode) {
    currentStatsMode = mode;
    if (mode === "facility") {
      statsHeaderTitle.textContent = "ç”Ÿæ´»åœˆå…¬å…±è¨­æ–½çµ±è¨ˆ";
      tabFacility.classList.add("active");
      tabMed.classList.remove("active");
      facilityStatsContainer.style.display = "block";
      medStatsContainer.style.display = "none";
    } else {
      statsHeaderTitle.textContent = "ç”Ÿæ´»åœˆé†«ç™‚é•·ç…§çµ±è¨ˆ";
      tabMed.classList.add("active");
      tabFacility.classList.remove("active");
      facilityStatsContainer.style.display = "none";
      medStatsContainer.style.display = "block";
    }
    legendDiv.style.display = "none";
    medLegendDiv.style.display = "none";
    toggleLegendBtn.textContent = "é¡¯ç¤ºåœ–ä¾‹";
  }
  tabFacility.onclick = () => switchStatsMode("facility");
  tabMed.onclick = () => switchStatsMode("med");
  switchStatsMode("facility");

  /* è¼‰å…¥å…¬å…±è¨­æ–½ */
  fetch("https://jade0815.github.io/data/å…¬å…±è¨­æ–½.geojson")
    .then(res => res.json())
    .then(data => {
      data.features.forEach(f => {
        if (f.properties && f.properties.type && f.geometry && f.geometry.type === "Point") {
          const ptGeo = new Point({
            longitude: f.geometry.coordinates[0],
            latitude: f.geometry.coordinates[1],
            spatialReference: { wkid: 4326 }
          });
          const ptWM = webMercatorUtils.geographicToWebMercator(ptGeo);

          const g = new Graphic({
            geometry: ptWM,
            symbol: getFacilitySymbol(f.properties.type),
            attributes: f.properties,
            elevationInfo: { mode: "relative-to-ground", offset: 10 },
            visible: false
          });
          facilityLayer.add(g);
          // âœ… å­¸æ ¡ï¼šç™»éŒ„åˆ°å…¨åŸŸæ¸…å–® + åŠ åˆ°å­¸æ ¡åœ–å±¤ï¼ˆä¸æœƒè§¸ç™¼å¤§é‡è¨ˆç®—ï¼‰
          try{
            if (window.__registerSchoolFromFacilityGraphic) window.__registerSchoolFromFacilityGraphic(g);
            if (g.attributes && String(g.attributes.type||"") === "å­¸æ ¡") {
              const sl = window.ensureSchoolLayer && window.ensureSchoolLayer();
              if (sl) {
                const sg = new Graphic({
                  geometry: ptWM,
                  symbol: (window.schoolSymbolByCount?window.schoolSymbolByCount(0):undefined),
                  attributes: Object.assign({}, f.properties, { schoolName: (f.properties.name||f.properties.NAME||"å­¸æ ¡") })
                });
                sl.add(sg);
              }
            }
          }catch(e){}
          // âœ… å¦å¤–æŠŠã€Œå­¸æ ¡ã€æ‹‰å‡ºæˆç¨ç«‹åœ–å±¤ï¼ˆçµ¦çŠ¯ç½ªç†±å€åˆ†æç”¨ï¼‰
          if (f.properties.type === "å­¸æ ¡") {
            const sl = window.ensureSchoolLayer && window.ensureSchoolLayer();
            if (sl) {
              const sg = new Graphic({
                geometry: ptWM,
                symbol: (window.schoolSymbolByCount?window.schoolSymbolByCount(0):undefined),
                attributes: Object.assign({}, f.properties, { crimeCount: 0 })
              });
              sl.add(sg);
              schoolPointsReady = true;
            }
          }

        }
      });

      facilityReady = true;
      tryComputeTaoyuanDenominators();
    });

  /* âœ… è¼‰å…¥é†«ç™‚é•·ç…§ */
  fetch("https://jade0815.github.io/data/é†«ç™‚èˆ‡é•·ç…§.geojson")
    .then(res => res.json())
    .then(data => {
      data.features.forEach(f => {
        if (!f.geometry || f.geometry.type !== "Point") return;

        const attrs = f.properties || {};
        const rawText = [attrs.type, attrs["é¡åˆ¥"], attrs["é†«äº‹æ©Ÿæ§‹é¡åˆ¥"], attrs["è—¥å±€å"], attrs["æ©Ÿæ§‹åç¨±"], attrs["åç¨±"]]
          .filter(v => v != null && v.toString().trim() !== "")
          .join(" ");
        const text = rawText.toString();

        let typeNorm = "è€äººé•·ç…§æ©Ÿæ§‹";
        if (text.indexOf("è—¥") >= 0) typeNorm = "è—¥å±€";
        else if (text.indexOf("é†«") >= 0 || text.indexOf("é™¢") >= 0) typeNorm = "é†«é™¢";

        attrs.medType = typeNorm;

        const ptGeo = new Point({
          longitude: f.geometry.coordinates[0],
          latitude: f.geometry.coordinates[1],
          spatialReference: { wkid: 4326 }
        });
        const ptWM = webMercatorUtils.geographicToWebMercator(ptGeo);

        const g = new Graphic({
          geometry: ptWM,
          symbol: getMedSymbol(typeNorm),
          attributes: attrs,
          elevationInfo: { mode: "relative-to-ground", offset: 10 },
          visible: false
        });
        medLayer.add(g);
      });

      medReady = true;
      tryComputeTaoyuanDenominators();
    })
    .catch(err => console.error("é†«ç™‚é•·ç…§è¼‰å…¥å¤±æ•—ï¼š", err));

  /* è¼‰å…¥é–€ç‰Œ */
  fetch("https://jade0815.github.io/data/å°æªœæºªé–€ç‰Œ114.geojson")
    .then(res => res.json())
    .then(data => {
      data.features.forEach(f => {
        const ptGeo = new Point({
          longitude: f.geometry.coordinates[0],
          latitude: f.geometry.coordinates[1],
          spatialReference: { wkid: 4326 }
        });
        const ptWM = webMercatorUtils.geographicToWebMercator(ptGeo);
        const g = new Graphic({ geometry: ptWM, attributes: f.properties });
        houseLayer.add(g);
      });
    });


  // âœ… ç”Ÿæ´»åœˆ/è‡ªè¨‚ç¯„åœ UI çš„å›ºå®šå®¹å™¨ï¼ˆé¿å…é¢æ¿è·‘åˆ°é é¢æœ€ä¸‹æ–¹ï¼‰
  let livabilityUIRoot = document.getElementById("livabilityUI");
  if (!livabilityUIRoot) {
    livabilityUIRoot = document.createElement("div");
    livabilityUIRoot.id = "livabilityUI";
    document.body.appendChild(livabilityUIRoot);
  }

  /* Iso é¢æ¿ï¼ˆåŸæ¨£ä¿ç•™ï¼‰ */
  const isoPanel = document.createElement("div");
  isoPanel.id = "isoPanel";
  isoPanel.innerHTML = `
    <div style="font-weight:bold;text-align:center;margin-bottom:4px;">15 åˆ†é˜ç”Ÿæ´»åœˆ</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <span>åŠŸèƒ½ï¼š</span>
      <button id="isoToggleBtn" style="padding:3px 8px;border-radius:4px;border:none;cursor:pointer;background:#555;color:#fff;font-size:12px;"></button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span>äº¤é€šæ–¹å¼ï¼š</span>
      <div style="display:flex;gap:4px;">
        <button id="isoWalkBtn" style="padding:2px 6px;border-radius:4px;border:none;cursor:pointer;background:#00bcd4;color:#fff;font-size:12px;">æ­¥è¡Œ</button>
        <button id="isoBikeBtn" style="padding:2px 6px;border-radius:4px;border:none;cursor:pointer;background:#444;color:#fff;font-size:12px;">è…³è¸è»Š</button>
      </div>
    </div>
    <div style="margin-top:6px;font-size:11px;color:#ffd54f;">
      â€» å‹¾é¸å¾Œï¼Œé»é¸ã€å°æªœæºªç¯„åœå…§çš„å»ºç‰©ã€‘å³å¯ç”Ÿæˆ 15 åˆ†é˜ç”Ÿæ´»åœˆã€‚
    </div>
  `;
  const isoMount = document.getElementById("lifeIsoPage") || livabilityUIRoot;
  isoMount.appendChild(isoPanel);

  const isoToggleBtn = document.getElementById("isoToggleBtn");
  const isoWalkBtn = document.getElementById("isoWalkBtn");
  const isoBikeBtn = document.getElementById("isoBikeBtn");

  function updateIsoButtonLabel() {
    isoToggleBtn.textContent = `${getModeText()}ï¼š${isoEnabled ? "é–‹å•Ÿ" : "é—œé–‰"}`;
    isoToggleBtn.style.background = isoEnabled ? "#4caf50" : "#555";
  }
  updateIsoButtonLabel();

  isoWalkBtn.onclick = () => {
    isoMode = "foot-walking";
    isoWalkBtn.style.background = "#00bcd4";
    isoBikeBtn.style.background = "#444";
    updateIsoButtonLabel();
    if (isoEnabled) document.getElementById("msg").innerHTML = "15åˆ†é˜æ­¥è¡Œç”Ÿæ´»åœˆ åŠŸèƒ½å·²é–‹å•Ÿ\nè«‹é»ã€å°æªœæºªç¯„åœå…§çš„å»ºç‰©ã€‘";
  };
  isoBikeBtn.onclick = () => {
    isoMode = "cycling-regular";
    isoBikeBtn.style.background = "#00bcd4";
    isoWalkBtn.style.background = "#444";
    updateIsoButtonLabel();
    if (isoEnabled) document.getElementById("msg").innerHTML = "15åˆ†é˜è…³è¸è»Šç”Ÿæ´»åœˆ åŠŸèƒ½å·²é–‹å•Ÿ\nè«‹é»ã€å°æªœæºªç¯„åœå…§çš„å»ºç‰©ã€‘";
  };

  isoToggleBtn.onclick = () => {
    isoEnabled = !isoEnabled;
    updateIsoButtonLabel();


    // âœ… äº’æ–¥ï¼šè‹¥è¦é–‹å•Ÿ 15 åˆ†é˜ç”Ÿæ´»åœˆï¼Œè€Œè‡ªè¨‚ç¯„åœé¢æ¿æ­£åœ¨é–‹å•Ÿï¼Œå…ˆé—œé–‰è‡ªè¨‚ç¯„åœä¸¦æ¸…é™¤è‡ªè¨‚åœ–å½¢
    try{
      const customPanelEl = document.getElementById("customPanel");
      const rangeBtnEl = document.getElementById("rangeToolToggleBtn");
      if (isoEnabled && customPanelEl && customPanelEl.style.display === "block") {
        customPanelEl.style.display = "none";
        if (rangeBtnEl) rangeBtnEl.classList.remove("active");

        // æ¸…é™¤è‡ªè¨‚é»/ç·š/é¢ï¼ˆå« bufferï¼‰é¿å…æ®˜ç•™
        if (typeof drawLayer !== "undefined" && drawLayer && typeof drawLayer.removeAll === "function") {
          drawLayer.removeAll();
        }
        if (typeof isDrawing !== "undefined") isDrawing = false;
        if (typeof currentDrawPoints !== "undefined") currentDrawPoints = [];
        if (typeof currentDrawGraphic !== "undefined") currentDrawGraphic = null;

        // åŒæ­¥æŠŠå·¥å…·ç‹€æ…‹é—œé–‰
        if (typeof customDrawEnabled !== "undefined") customDrawEnabled = false;
        if (typeof customToggleBtn !== "undefined" && customToggleBtn) {
          customToggleBtn.textContent = "é—œé–‰";
          customToggleBtn.style.background = "#555";
        }

        if (typeof updateStats === "function") updateStats();
        if (typeof computeAccessibilityForBuilding === "function") computeAccessibilityForBuilding();
        const msgEl = document.getElementById("msg");
        if (msgEl) msgEl.textContent = "å·²åˆ‡æ›ç‚º 15 åˆ†é˜ç”Ÿæ´»åœˆï¼šè‡ªè¨‚ç¯„åœå·²é—œé–‰ä¸¦æ¸…é™¤è‡ªè¨‚åœ–å½¢ã€‚";
      }
    }catch(e){}
    isochroneLayer.removeAll();
    popupDiv.style.display = "none";
    if (activeFacility) { resetFacilitySymbol(activeFacility); activeFacility = null; }
    if (activeMed) { resetMedSymbol(activeMed); activeMed = null; }
    view.goTo(initialCamera);

    Object.keys(subCountSpans).forEach(type => subCountSpans[type].textContent = "0");
    Object.keys(bigCountSpans).forEach(big => bigCountSpans[big].textContent = "(0)");
    if (medTotalSpan) medTotalSpan.textContent = "ç¸½æ•¸: 0";
    Object.keys(medTypeSpans).forEach(t => medTypeSpans[t].textContent = "0");
    totalHouseDiv.textContent = "é–€ç‰Œç¸½æ•¸: 0";
    lastBuilding = null;
    resetLivabilityPanel();

    if (isoEnabled) {
      document.getElementById("msg").innerHTML = `15åˆ†é˜${getModeText()}ç”Ÿæ´»åœˆ åŠŸèƒ½å·²é–‹å•Ÿ\nè«‹é»ã€å°æªœæºªç¯„åœå…§çš„å»ºç‰©ã€‘`;
    } else {
      document.getElementById("msg").innerHTML = "15åˆ†é˜æ­¥è¡Œ / è…³è¸è»Šç”Ÿæ´»åœˆ åŠŸèƒ½å·²é—œé–‰";
    }
  };

  /* è‡ªè¨‚ç¯„åœå·¥å…·ï¼ˆé» / ç·š / é¢ + buffer + æ¸…é™¤ï¼‰ */
  let customDrawEnabled = false;
  let drawMode = "point";
  let isDrawing = false;
  let currentDrawPoints = [];
  let currentDrawGraphic = null;
  let bufferInput;

  const customPanel = document.createElement("div");
  customPanel.id = "customPanel";
  customPanel.innerHTML = `
    <div style="font-weight:bold;margin-bottom:6px;text-align:center;">è‡ªè¨‚ç¯„åœå·¥å…·</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <span>ç‹€æ…‹ï¼š</span>
      <button id="customToggleBtn" style="padding:3px 8px;border-radius:4px;border:none;cursor:pointer;background:#555;color:#fff;font-size:12px;">é—œé–‰</button>
    </div>
    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
      <span>ç¹ªè£½é¡å‹ï¼š</span>
      <div style="display:flex;gap:4px;">
        <button id="drawPointBtn" style="padding:2px 6px;border-radius:4px;border:none;cursor:pointer;background:#00bcd4;color:#fff;font-size:12px;">é»</button>
        <button id="drawLineBtn" style="padding:2px 6px;border-radius:4px;border:none;cursor:pointer;background:#444;color:#fff;font-size:12px;">ç·š</button>
        <button id="drawPolyBtn" style="padding:2px 6px;border-radius:4px;border:none;cursor:pointer;background:#444;color:#fff;font-size:12px;">é¢</button>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <span>Buffer (å…¬å°º)ï¼š</span>
      <input id="bufferInput" type="number" value="100" min="1" style="width:70px;font-size:12px;border-radius:4px;border:1px solid #888;padding:2px 4px;"/>
    </div>
    <div style="font-size:11px;color:#ffd54f;margin-bottom:6px;">
      â€» åªèƒ½åœ¨å°æªœæºªç¯„åœå…§é»æ“Šï¼›ç·š / é»æœƒä¾ buffer ç”¢ç”Ÿç¯„åœã€‚
    </div>
    <button id="clearDrawBtn" style="width:100%;padding:4px 0;border-radius:4px;border:none;cursor:pointer;background:#e53935;color:#fff;font-size:12px;">æ¸…é™¤è‡ªè¨‚ç¯„åœ</button>
  `;
  livabilityUIRoot.appendChild(customPanel);
  // âœ… è‡ªè¨‚ç¯„åœå·¥å…·ï¼šæŒ‰éˆ•é–‹é—œï¼ˆæŒ‰éˆ•åœ¨åº•åœ–å³é‚Šï¼‰
  const rangeToolToggleBtn = document.getElementById("rangeToolToggleBtn");

  function positionCustomPanelNextToBtn(){
    if(!rangeToolToggleBtn) return;
    const r = rangeToolToggleBtn.getBoundingClientRect();
    // é è¨­ï¼šé¢æ¿åœ¨æŒ‰éˆ•å³å´ï¼Œç•¥å¾€ä¸Šå°é½Š
    let left = r.right + 6;
    let top  = Math.max(60, r.top - 22);

    // å³é‚Šçˆ†å‡ºè¦–çª—å°±æ”¹æ”¾å·¦å´
    const panelW = 210;
    const pad = 10;
    if(left + panelW + pad > window.innerWidth){
      left = Math.max(pad, r.left - panelW - 6);
    }
    // ä¸‹æ–¹çˆ†å‡ºå°±å¾€ä¸Šæ¨
    const panelH = customPanel.offsetHeight || 260;
    if(top + panelH + pad > window.innerHeight){
      top = Math.max(pad, window.innerHeight - panelH - pad);
    }

    customPanel.style.left = `${left}px`;
    customPanel.style.top  = `${top}px`;
  }

  if(rangeToolToggleBtn){
    rangeToolToggleBtn.addEventListener("click", () => {
      const isOpen = customPanel.style.display === "block";
      if(isOpen){
        customPanel.style.display = "none";
        rangeToolToggleBtn.classList.remove("active");

// âœ… è‹¥æŠŠè‡ªè¨‚ç¯„åœé¢æ¿æ•´å€‹é—œé–‰ï¼šåŒæ­¥æ¸…é™¤é»/ç·š/é¢ï¼ˆå« bufferï¼‰é¿å…æ®˜ç•™
try{
  if (typeof drawLayer !== "undefined" && drawLayer && typeof drawLayer.removeAll === "function") {
    drawLayer.removeAll();
  }
  isDrawing = false;
  currentDrawPoints = [];
  currentDrawGraphic = null;

  // åŒæ­¥æŠŠå·¥å…·ç‹€æ…‹é—œé–‰ï¼ˆä½†ä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½ï¼‰
  customDrawEnabled = false;
  if (customToggleBtn) {
    customToggleBtn.textContent = "é—œé–‰";
    customToggleBtn.style.background = "#555";
  }

  if (typeof updateStats === "function") updateStats();
  if (typeof computeAccessibilityForBuilding === "function") computeAccessibilityForBuilding();
  const msgEl = document.getElementById("msg");
  if (msgEl) msgEl.textContent = "è‡ªè¨‚ç¯„åœé¢æ¿å·²é—œé–‰ï¼Œå·²æ¸…é™¤è‡ªè¨‚é»ï¼ç·šï¼é¢èˆ‡ bufferã€‚";
}catch(e){}
      }else{

// âœ… è‹¥è‡ªè¨‚ç¯„åœé¢æ¿è¦é–‹å•Ÿï¼Œä¸” 15 åˆ†é˜ç”Ÿæ´»åœˆåŠŸèƒ½ç›®å‰ç‚ºé–‹å•Ÿï¼Œå‰‡å…ˆå¼·åˆ¶é—œé–‰ 15 åˆ†é˜ç”Ÿæ´»åœˆ
if (typeof isoEnabled !== "undefined" && isoEnabled) {
  isoEnabled = false;
  if (typeof updateIsoButtonLabel === "function") updateIsoButtonLabel();


  // âœ… äº’æ–¥ä½†ä¸ã€Œé—œæ‰é¢æ¿ã€ï¼šç¶­æŒ 15 åˆ†é˜ç”Ÿæ´»åœˆåˆ†é ä»å¯è¦‹ï¼ˆåªæ˜¯åŠŸèƒ½æš«åœï¼‰
  try{ if(typeof switchLifeTab === "function") switchLifeTab("iso"); }catch(e){}
  // æ¸…é™¤ç”Ÿæ´»åœˆåœ–å±¤èˆ‡å½ˆçª—/é«˜äº®
  if (typeof isochroneLayer !== "undefined" && isochroneLayer && typeof isochroneLayer.removeAll === "function") {
    isochroneLayer.removeAll();
  }
  if (typeof popupDiv !== "undefined" && popupDiv) popupDiv.style.display = "none";
  if (typeof activeFacility !== "undefined" && activeFacility && typeof resetFacilitySymbol === "function") {
    resetFacilitySymbol(activeFacility);
    activeFacility = null;
  }
  if (typeof activeMed !== "undefined" && activeMed && typeof resetMedSymbol === "function") {
    resetMedSymbol(activeMed);
    activeMed = null;
  }
  if (typeof view !== "undefined" && view && typeof view.goTo === "function" && typeof initialCamera !== "undefined") {
    view.goTo(initialCamera);
  }

  // é‡ç½®çµ±è¨ˆ/é¢æ¿é¡¯ç¤ºï¼ˆç¶­æŒèˆ‡åŸæœ¬ 15 åˆ†é˜é—œé–‰è¡Œç‚ºä¸€è‡´ï¼‰
  if (typeof subCountSpans !== "undefined") Object.keys(subCountSpans).forEach(type => subCountSpans[type].textContent = "0");
  if (typeof bigCountSpans !== "undefined") Object.keys(bigCountSpans).forEach(big => bigCountSpans[big].textContent = "(0)");
  if (typeof medTotalSpan !== "undefined" && medTotalSpan) medTotalSpan.textContent = "ç¸½æ•¸: 0";
  if (typeof medTypeSpans !== "undefined") Object.keys(medTypeSpans).forEach(t => medTypeSpans[t].textContent = "0");
  if (typeof totalHouseDiv !== "undefined" && totalHouseDiv) totalHouseDiv.textContent = "é–€ç‰Œç¸½æ•¸: 0";
  if (typeof lastBuilding !== "undefined") lastBuilding = null;
  if (typeof resetLivabilityPanel === "function") resetLivabilityPanel();

  const msgEl = document.getElementById("msg");
  if (msgEl) msgEl.innerHTML = "15åˆ†é˜æ­¥è¡Œ / è…³è¸è»Šç”Ÿæ´»åœˆ åŠŸèƒ½å·²é—œé–‰";
}

        // åŒæ™‚æŠŠåº•åœ–é¢æ¿æ”¶èµ·ï¼ˆé¿å…é‡ç–Šï¼‰
        const basemapPanel = document.getElementById("basemapPanel");
        if(basemapPanel) basemapPanel.style.display = "none";

        customPanel.style.display = "block";
        rangeToolToggleBtn.classList.add("active");
        positionCustomPanelNextToBtn();
      }
    });

    window.addEventListener("resize", () => {
      if(customPanel.style.display === "block") positionCustomPanelNextToBtn();
    });
  }


  const customToggleBtn = document.getElementById("customToggleBtn");
  const drawPointBtn = document.getElementById("drawPointBtn");
  const drawLineBtn = document.getElementById("drawLineBtn");
  const drawPolyBtn = document.getElementById("drawPolyBtn");
  const clearDrawBtn = document.getElementById("clearDrawBtn");
  bufferInput = document.getElementById("bufferInput");

  function setModeButtonStyle() {
    drawPointBtn.style.background = (drawMode === "point") ? "#00bcd4" : "#444";
    drawLineBtn.style.background = (drawMode === "line") ? "#00bcd4" : "#444";
    drawPolyBtn.style.background = (drawMode === "polygon") ? "#00bcd4" : "#444";
  }

  function enableCustomDrawWithMode(mode, msgText) {
    drawMode = mode;
    setModeButtonStyle();
    customDrawEnabled = true;
    customToggleBtn.textContent = "é–‹å•Ÿ";
    customToggleBtn.style.background = "#4caf50";

    isoEnabled = false;
    updateIsoButtonLabel();
    isochroneLayer.removeAll();
    lastBuilding = null;
    resetLivabilityPanel();

    isDrawing = false;
    currentDrawPoints = [];
    currentDrawGraphic = null;

    document.getElementById("msg").textContent = msgText;
  }

  drawPointBtn.onclick = () => enableCustomDrawWithMode("point", "è‡ªè¨‚ç¯„åœï¼šé»æ¨¡å¼\nåªèƒ½åœ¨å°æªœæºªç¯„åœå…§é»æ“Šï¼Œæœƒç•«ç´…é»ï¼‹è—è‰² buffer åœ“ã€‚");
  drawLineBtn.onclick  = () => enableCustomDrawWithMode("line",  "è‡ªè¨‚ç¯„åœï¼šç·šæ¨¡å¼\nåªèƒ½åœ¨å°æªœæºªç¯„åœå…§é€£çºŒé»æ“Šï¼Œé›™æ“Šå®Œæˆå¾Œä¾ buffer ç”¢ç”Ÿç¯„åœå¸¶ã€‚");
  drawPolyBtn.onclick  = () => enableCustomDrawWithMode("polygon","è‡ªè¨‚ç¯„åœï¼šé¢æ¨¡å¼\nåªèƒ½åœ¨å°æªœæºªç¯„åœå…§é€£çºŒé»æ“Šï¼Œé›™æ“Šå®Œæˆå¤šé‚Šå½¢ã€‚");

  customToggleBtn.onclick = () => {
    customDrawEnabled = !customDrawEnabled;
    if (customDrawEnabled) {
      customToggleBtn.textContent = "é–‹å•Ÿ";
      customToggleBtn.style.background = "#4caf50";
      document.getElementById("msg").textContent = "è‡ªè¨‚ç¯„åœå·¥å…·å·²é–‹å•Ÿï¼Œè«‹å…ˆé¸ã€Œé»ï¼ç·šï¼é¢ã€ï¼Œå†åœ¨å°æªœæºªç¯„åœå…§é»æ“Šã€‚";
      isDrawing = false; currentDrawPoints = []; currentDrawGraphic = null;
    } else {
      customToggleBtn.textContent = "é—œé–‰";
      customToggleBtn.style.background = "#555";
      document.getElementById("msg").textContent = "è‡ªè¨‚ç¯„åœå·¥å…·å·²é—œé–‰ã€‚";
      isDrawing = false; currentDrawPoints = []; currentDrawGraphic = null;
    }
  };

  clearDrawBtn.onclick = () => {
    drawLayer.removeAll();
    isDrawing = false;
    currentDrawPoints = [];
    currentDrawGraphic = null;
    updateStats();
    document.getElementById("msg").textContent = "å·²æ¸…é™¤è‡ªè¨‚é»ï¼ç·šï¼é¢èˆ‡ bufferï¼Œçµ±è¨ˆå·²é‡ç½®ã€‚";
    computeAccessibilityForBuilding();
  };

  function getBufferDistance() {
    let d = parseFloat(bufferInput.value);
    if (isNaN(d) || d <= 0) d = 100;
    return d;
  }

  function handleCustomDrawClick(event) {
    if (!customDrawEnabled || isoEnabled) return;
    const mapPoint = event.mapPoint;

    if (!boundaryUnionWM) {
      document.getElementById("msg").textContent = "å°æªœæºªç¯„åœå°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™å†è©¦ã€‚";
      return;
    }
    if (!isInsideXiaoguaixi(mapPoint)) {
      document.getElementById("msg").textContent = "âš ï¸ åªèƒ½åœ¨å°æªœæºªç¯„åœå…§ä½¿ç”¨è‡ªè¨‚ç¯„åœå·¥å…·ï¼Œè«‹é»å›è—è‰²å€åŸŸå…§ã€‚";
      return;
    }

    const bufferDist = getBufferDistance();

    if (drawMode === "point") {
      drawLayer.removeAll();
      const geoPoint = webMercatorUtils.webMercatorToGeographic(mapPoint);
      const bufferGeomGeo = geometryEngine.geodesicBuffer(geoPoint, bufferDist, "meters");
      const bufferGeomWM = webMercatorUtils.geographicToWebMercator(bufferGeomGeo);

      const centerGraphic = new Graphic({
        geometry: mapPoint,
        symbol: { type: "simple-marker", color: [255, 0, 0, 1], size: 10, outline: { color: [255, 255, 255, 1], width: 1 } }
      });
      const bufferGraphic = new Graphic({
        geometry: bufferGeomWM,
        symbol: { type: "simple-fill", color: [0, 0, 255, 0.15], outline: { color: [0, 0, 255, 1], width: 2 } }
      });
      drawLayer.addMany([bufferGraphic, centerGraphic]);
      updateStats();
      computeAccessibilityForBuilding();
      document.getElementById("msg").textContent = `è‡ªè¨‚ç¯„åœï¼ˆé» buffer ${bufferDist} å…¬å°ºï¼‰çµ±è¨ˆå®Œæˆ âœ…`;
      return;
    }

    if (drawMode === "line") {
      if (!isDrawing) {
        isDrawing = true;
        currentDrawPoints = [];
        if (currentDrawGraphic) { drawLayer.remove(currentDrawGraphic); currentDrawGraphic = null; }
      }
      currentDrawPoints.push([mapPoint.x, mapPoint.y]);
      const polyline = new Polyline({ paths: [currentDrawPoints], spatialReference: { wkid: 102100 } });

      if (!currentDrawGraphic) {
        currentDrawGraphic = new Graphic({
          geometry: polyline,
          symbol: { type: "simple-line", color: [0, 0, 255, 1], width: 2 }
        });
        drawLayer.add(currentDrawGraphic);
      } else {
        currentDrawGraphic.geometry = polyline;
      }
      return;
    }

    if (drawMode === "polygon") {
      if (!isDrawing) {
        isDrawing = true;
        currentDrawPoints = [];
        if (currentDrawGraphic) { drawLayer.remove(currentDrawGraphic); currentDrawGraphic = null; }
      }
      currentDrawPoints.push([mapPoint.x, mapPoint.y]);
      if (currentDrawPoints.length >= 2) {
        const ring = currentDrawPoints.concat([currentDrawPoints[0]]);
        const poly = new Polygon({ rings: [ring], spatialReference: { wkid: 102100 } });

        if (!currentDrawGraphic) {
          currentDrawGraphic = new Graphic({
            geometry: poly,
            symbol: { type: "simple-fill", color: [0, 0, 255, 0.08], outline: { color: [0, 0, 255, 1], width: 1 } }
          });
          drawLayer.add(currentDrawGraphic);
        } else {
          currentDrawGraphic.geometry = poly;
        }
      }
    }
  }

  function finishCustomDrawing() {
    if (!customDrawEnabled || !isDrawing) return;
    const bufferDist = getBufferDistance();

    if (drawMode === "line") {
      if (currentDrawPoints.length < 2) {
        document.getElementById("msg").textContent = "è‡ªè¨‚ç¯„åœï¼ˆç·šï¼‰è‡³å°‘éœ€è¦ 2 å€‹é»ã€‚";
        return;
      }
      const line = new Polyline({ paths: [currentDrawPoints], spatialReference: { wkid: 102100 } });
      const bufferGeom = geometryEngine.buffer(line, bufferDist, "meters");

      drawLayer.removeAll();
      drawLayer.addMany([
        new Graphic({
          geometry: bufferGeom,
          symbol: { type: "simple-fill", color: [0, 0, 255, 0.18], outline: { color: [0, 0, 255, 1], width: 2 } }
        }),
        new Graphic({
          geometry: line,
          symbol: { type: "simple-line", color: [255, 255, 255, 1], width: 2 }
        })
      ]);

      isDrawing = false;
      currentDrawPoints = [];
      currentDrawGraphic = null;

      updateStats();
      computeAccessibilityForBuilding();
      document.getElementById("msg").textContent = `è‡ªè¨‚ç¯„åœï¼ˆç·š buffer ${bufferDist} å…¬å°ºï¼‰çµ±è¨ˆå®Œæˆ âœ…`;
      return;
    }

    if (drawMode === "polygon") {
      if (currentDrawPoints.length < 3) {
        document.getElementById("msg").textContent = "è‡ªè¨‚ç¯„åœï¼ˆé¢ï¼‰è‡³å°‘éœ€è¦ 3 å€‹é»ã€‚";
        return;
      }
      const ring = currentDrawPoints.concat([currentDrawPoints[0]]);
      const poly = new Polygon({ rings: [ring], spatialReference: { wkid: 102100 } });

      drawLayer.removeAll();
      drawLayer.add(new Graphic({
        geometry: poly,
        symbol: { type: "simple-fill", color: [0, 0, 255, 0.18], outline: { color: [0, 0, 255, 1], width: 2 } }
      }));
      isDrawing = false;
      currentDrawPoints = [];
      currentDrawGraphic = null;

      updateStats();
      computeAccessibilityForBuilding();
      document.getElementById("msg").textContent = "è‡ªè¨‚ç¯„åœï¼ˆé¢ï¼‰çµ±è¨ˆå®Œæˆ âœ…";
    }
  }

  /* å»ºç‰© popup */
  let highlightHandle1 = null;

  async function showBuildingPopup(building, event) {

    const layerView = await view.whenLayerView(buildingLayer);
    if (highlightHandle1) highlightHandle1.remove();
    highlightHandle1 = layerView.highlight(building.attributes.OBJECTID);

    // ===== å»ºç‰©åŸºæœ¬è³‡è¨Š =====
    const buildingContent = `
      <b>æ¨“å±¤æ•¸ï¼š</b>${building.attributes["æ¨“"] || "-"}<br>
      <b>é«˜åº¦ï¼š</b>${building.attributes["heght"] || "-"}<br>
      <b>åœŸåœ°ä½¿ç”¨ï¼š</b>${building.attributes["Use_"] || "-"}
    `;

    // ===== é–€ç‰Œçµ±è¨ˆ =====
    let houseCount = 0;
    houseLayer.graphics.forEach(h => {
      if (geometryEngine.contains(building.geometry, h.geometry)) houseCount++;
    });
    const houseContent = `<b>é–€ç‰Œæ•¸é‡ï¼š</b>${houseCount}`;

    // ===== æŸ¥è©¢åœ°è™Ÿ polygon =====
    let parcelHTML = "<div>æŸ¥ç„¡åœ°è™Ÿè³‡æ–™</div>";
    try {
      const q = parcelLayer.createQuery();
      q.geometry = building.geometry;
      q.spatialRelationship = "intersects";
      q.outFields = ["*"];
      q.returnGeometry = true;

      const r = await parcelLayer.queryFeatures(q);
      if (r.features.length > 0) {
        const p = r.features[0].attributes;
        parcelHTML = `
          <table class="popup-table">
            <tr><th>æ®µå°æ®µ</th><td>${p[fieldNames.section] || "-"}</td></tr>
            <tr><th>åœ°è™Ÿ</th><td>${p[fieldNames.dno] || "-"}</td></tr>
            <tr><th>å…¬å‘Šåœ°åƒ¹ (å…ƒ/ã¡)</th><td>${p[fieldNames.price] || "-"}</td></tr>
            <tr><th>å…¬å‘Šç¾å€¼ (å…ƒ/ã¡)</th><td>${p[fieldNames.value] || "-"}</td></tr>
            <tr><th>å…¬å‘Šé¢ç© (ã¡)</th><td>${p[fieldNames.area] || "-"}</td></tr>
          </table>
        `;
      }
    } catch (e) {
      console.error("åœ°è™ŸæŸ¥è©¢å¤±æ•—", e);
    }

    // ===== çµ„åˆ Tabs =====
    popupDiv.innerHTML = "";

    const tabsDiv = document.createElement("div");
    tabsDiv.className = "popup-tabs";

    const tab1 = document.createElement("div");
    tab1.className = "popup-tab active";
    tab1.textContent = "å»ºç‰©è³‡è¨Š";

    const tab2 = document.createElement("div");
    tab2.className = "popup-tab";
    tab2.textContent = "é–€ç‰Œçµ±è¨ˆ";

    const tab3 = document.createElement("div");
    tab3.className = "popup-tab";
    tab3.textContent = "åœ°è™Ÿè³‡è¨Š";

    tabsDiv.append(tab1, tab2, tab3);

    const c1 = document.createElement("div");
    c1.className = "popup-content active";
    c1.innerHTML = buildingContent;

    const c2 = document.createElement("div");
    c2.className = "popup-content";
    c2.innerHTML = houseContent;

    const c3 = document.createElement("div");
    c3.className = "popup-content";
    c3.innerHTML = parcelHTML;

    popupDiv.append(tabsDiv, c1, c2, c3);

    tab1.onclick = () => { tab1.classList.add("active"); tab2.classList.remove("active"); tab3.classList.remove("active"); c1.classList.add("active"); c2.classList.remove("active"); c3.classList.remove("active"); };
    tab2.onclick = () => { tab2.classList.add("active"); tab1.classList.remove("active"); tab3.classList.remove("active"); c2.classList.add("active"); c1.classList.remove("active"); c3.classList.remove("active"); };
    tab3.onclick = () => { tab3.classList.add("active"); tab1.classList.remove("active"); tab2.classList.remove("active"); c3.classList.add("active"); c1.classList.remove("active"); c2.classList.remove("active"); };

    positionPopupAtPoint(event.mapPoint);
  }

  // âœ… å®œå±…åˆ†æ•¸è¨ˆç®—ï¼ˆå«æ²»å®‰é€²åº¦æ¢ï¼‰
  async function computeAccessibilityForBuilding() {
    if (!lastBuilding) { resetLivabilityPanel(); return; }

    const isoPolys = [];
    isochroneLayer.graphics.forEach(g => {
      if (g.geometry && g.geometry.type === "polygon") isoPolys.push(g.geometry);
    });
    drawLayer.graphics.forEach(g => {
      if (g.geometry && g.geometry.type === "polygon") isoPolys.push(g.geometry);
    });

    if (isoPolys.length === 0) {
      livabilityContent.innerHTML = "å·²é¸å–å»ºç‰©ï¼Œä½†å°šæœªç”¢ç”Ÿ 15 åˆ†é˜ç”Ÿæ´»åœˆæˆ–è‡ªè¨‚ç¯„åœã€‚";
      return;
    }
    // ======================
// âœ… æ²»å®‰ï¼šç®—ã€Œ15åˆ†é˜(æˆ–è‡ªè¨‚ç¯„åœ)å…§ã€çŠ¯ç½ªæ•¸
// ======================
CRIME_15MIN = 0;
CRIME_TAOYUAN = 0;

try {
  // æ²’è¼‰å…¥å°±å…ˆè¼‰å…¥ï¼ˆå°±ç®— crimeToggle æ²’é–‹ä¹Ÿæœƒç®—ï¼‰
  if (!crimeLayer) await loadCrimeLayerOnce();

  const where = buildWhereFromUI();

  // 15 åˆ†é˜ç¯„åœï¼ˆæˆ–è‡ªè¨‚ç¯„åœï¼‰å¯èƒ½æœ‰å¤šå€‹ polygonï¼šç”¨ union åˆæˆä¸€å€‹æŸ¥è©¢å¹¾ä½•
  const unionIso = geometryEngine.union(isoPolys);

  // âœ… 15åˆ†é˜(æˆ–è‡ªè¨‚ç¯„åœ)å…§çŠ¯ç½ªæ•¸
  CRIME_15MIN = await crimeLayer.queryFeatureCount({
    where,
    geometry: unionIso,
    spatialRelationship: "intersects"
  });

  // âœ… æ¡ƒåœ’å€çŠ¯ç½ªæ•¸ï¼ˆåŒæ¨£å¥—ç”¨ç¯©é¸æ¢ä»¶ç•¶åˆ†æ¯ï¼‰
  if (taoyuanUnionWM) {
    CRIME_TAOYUAN = await crimeLayer.queryFeatureCount({
      where,
      geometry: taoyuanUnionWM,
      spatialRelationship: "intersects"
    });
  } else {
    CRIME_TAOYUAN = await crimeLayer.queryFeatureCount({ where });
  }
  } catch (e) {
    CRIME_15MIN = 0;
    CRIME_TAOYUAN = 0;
  }

    let fac15Total = 0;
    let facXiao = 0;
    let facQing = 0;

    facilityLayer.graphics.forEach(pt => {
      if (!pt.geometry) return;
      const inIso = isoPolys.some(poly => geometryEngine.contains(poly, pt.geometry));
      if (!inIso) return;

      fac15Total++;

      let inXiao = false;
      if (boundaryUnionWM) {
        try { inXiao = geometryEngine.contains(boundaryUnionWM, pt.geometry); } catch(e){ inXiao = false; }
      }
      if (inXiao) facXiao++; else facQing++;
    });

    const medCounts15 = { "é†«é™¢": 0, "è—¥å±€": 0, "è€äººé•·ç…§æ©Ÿæ§‹": 0 };
    let Cb = 0;

    medLayer.graphics.forEach(pt => {
      if (!pt.geometry) return;
      const inIso = isoPolys.some(poly => geometryEngine.contains(poly, pt.geometry));
      if (!inIso) return;

      const t = pt.attributes?.medType || "è€äººé•·ç…§æ©Ÿæ§‹";
      medCounts15[t] = (medCounts15[t] || 0) + 1;
      Cb += (MED_WEIGHT[t] || 0);
    });

    const NtaoyuanFac = N_TAOYUAN_FAC;
    const NtaoyuanMed = N_TAOYUAN_MED; // ä¸åŠ æ¬Šç¸½æ•¸ï¼ˆé¡¯ç¤ºç”¨ï¼‰

    // ====== âœ… å®œå±…åˆ†æ•¸è¨ˆç®—ç”¨äººå£ï¼ˆå›ºå®šå°æªœæºªï¼‰ ======
    const POP_LIFE = 5203;      // å°æªœæºªç”Ÿæ´»åœˆäººå£
    const POP_TAOYUAN = 478284; // æ¡ƒåœ’å€äººå£

    // ====== âœ… æ¡ƒåœ’å€é†«ç™‚è¨­æ–½ã€ŒåŠ æ¬Šç¸½å’Œã€(CbTY) ======
    const CbTY = ((N_TAOYUAN_BYTYPE["é†«é™¢"]||0) * (MED_WEIGHT["é†«é™¢"]||0))
             + ((N_TAOYUAN_BYTYPE["è—¥å±€"]||0) * (MED_WEIGHT["è—¥å±€"]||0))
             + ((N_TAOYUAN_BYTYPE["è€äººé•·ç…§æ©Ÿæ§‹"]||0) * (MED_WEIGHT["è€äººé•·ç…§æ©Ÿæ§‹"]||0));
    // âœ… å°‡åŠ æ¬Šé†«ç™‚ç¸½å’Œæš«å­˜åˆ°å…¨åŸŸï¼Œä¾›é¢æ¿é¡¯ç¤ºä½¿ç”¨ï¼ˆé¿å… scope å•é¡Œï¼‰
    window.__livability = window.__livability || {};
    window.__livability.CbTY = CbTY;

    const scoreFac100 = (()=>{
      const facPerLife = fac15Total / Math.max(1, POP_LIFE);
      const facPerTY   = NtaoyuanFac / Math.max(1, POP_TAOYUAN);
      if (facPerTY <= 0) return 0;
      return Math.min(100, (facPerLife / facPerTY) * 100);
    })();
    const scoreFacWeighted = scoreFac100 * FAC_WEIGHT;

    const scoreMed100 = (()=>{
      const medPerLife = Cb / Math.max(1, POP_LIFE);
      const medPerTY   = CbTY / Math.max(1, POP_TAOYUAN);
      if (medPerTY <= 0) return 0;
      return Math.min(100, (medPerLife / medPerTY) * 100);
    })();
    const scoreMedWeighted = scoreMed100 * MED_SCORE_WEIGHT;

// âœ… æ²»å®‰ï¼ˆä¾ä½ çš„å…¬å¼ï¼šæ¯äººçŠ¯ç½ªç‡ï¼‰
const crimeRateLife = CRIME_15MIN / Math.max(1, POP_LIFE);
const crimeRateTY   = CRIME_TAOYUAN / Math.max(1, POP_TAOYUAN);
const avgCrimeRate  = (crimeRateLife + crimeRateTY) / 2;
const crimeScore100 = (1 - Math.min(1, (crimeRateLife / Math.max(1e-12, avgCrimeRate)))) * 100;

// âœ… äº¤é€šäº‹æ•…åˆ†æ•¸ï¼ˆå®œå±…è¨ˆç®—ç”¨ï¼Œä¸å±•ç¤ºã€ä¸ä¾è³´é–‹å•Ÿäº‹æ•…é¢æ¿ï¼‰
// éœ€æ±‚ï¼šç”Ÿæ´»åœˆäº‹æ•…æ•¸åªçµ±è¨ˆ 113 å¹´ï¼ˆ=2024ï¼‰æ•´å¹´é»ä½ç¸½æ•¸ï¼ˆåœ¨ 15 åˆ†é˜ç”Ÿæ´»åœˆå…§ï¼‰ï¼›æ¡ƒåœ’å€äº‹æ•…é‡ = 408ï¼ˆä½ æä¾›ï¼‰
let ACC_15MIN = 0, ACC_TAOYUAN = 91823;

async function __getAccidentFeaturesForScore(){
  // ç”¨ window ä¿ç•™å¿«å–ï¼Œé¿å…æ¯æ¬¡ç®—åˆ†éƒ½é‡æŠ“
  window.__accScoreCache = window.__accScoreCache || { loaded:false, features:[] };
  if(window.__accScoreCache.loaded) return window.__accScoreCache.features || [];

  // 1) å„ªå…ˆï¼šæ²¿ç”¨æ—¢æœ‰äº‹æ•…è³‡æ–™ï¼ˆå³ä½¿ä¸é–‹äº‹æ•…é¢æ¿ï¼Œä¹Ÿä¸»å‹•è¼‰å…¥ï¼‰
  try{
    if(typeof loadAccidents === "function") await loadAccidents();
    if(Array.isArray(accidentFeaturesRaw) && accidentFeaturesRaw.length){
      window.__accScoreCache.features = accidentFeaturesRaw;
      window.__accScoreCache.loaded = true;
      return accidentFeaturesRaw;
    }
  }catch(e){}

  // 2) å¾Œå‚™ï¼šç›´æ¥æŠ“ã€Œæ¡ƒåœ’å€äº¤é€šäº‹æ•…é»ä½ã€(ä½ çµ¦çš„ v1/default.geojson)
  // GitHub Release é€£çµåœ¨ file:// æœƒé‡åˆ° CORSï¼Œæ‰€ä»¥ç”¨ CDN / raw ä½œæ›¿ä»£ä¾†æº
  const ACC_SCORE_URLS = [
    ACCIDENT_GEOJSON_URL,
    "https://api.allorigins.win/raw?url=" + encodeURIComponent(ACCIDENT_GEOJSON_URL),
    "https://r.jina.ai/http://" + ACCIDENT_GEOJSON_URL.replace(/^https?:\/\//,"")
  ];

  for(const url of ACC_SCORE_URLS){
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) continue;
      const gj = await res.json();
      const feats = (gj && gj.features) ? gj.features : [];
      if(feats.length){
        window.__accScoreCache.features = feats;
        window.__accScoreCache.loaded = true;
        return feats;
      }
    }catch(e){}
  }

  window.__accScoreCache.features = [];
  window.__accScoreCache.loaded = true;
  return [];
}

try{
  const feats = await __getAccidentFeaturesForScore();
  const unionIsoWM = geometryEngine.union(isoPolys);

  // 113å¹´ = è¥¿å…ƒ 2024ï¼ˆè³‡æ–™æ¬„ä½å¯èƒ½æ˜¯ 113 æˆ– 2024ï¼Œå…©ç¨®éƒ½æ¥å—ï¼‰
  const TARGET_YEAR_AD = 2024;
  const TARGET_YEAR_ROC = 113;

  const getYear = (f)=>{
    const p = (f && f.properties) ? f.properties : {};
    // å¸¸è¦‹ï¼šyear / å¹´åº¦ / Year / çµ±è¨ˆå¹´ï¼›æˆ– Date/date=YYYYMMDD
    const y = p.year ?? p.YEAR ?? p.å¹´åº¦ ?? p.Year ?? p.çµ±è¨ˆå¹´ ?? p.stat_year;
    const n = Number(y);
    if(Number.isFinite(n)) return n;

    const d = p.date ?? p.Date ?? p.DATE;
    const ds = String(d||"");
    if(ds.length>=4 && /^\d{4}/.test(ds)) return Number(ds.slice(0,4));
    if(ds.length>=3 && /^\d{3}/.test(ds)) return Number(ds.slice(0,3)); // 113xxxx
    return NaN;
  };

  for(const f of feats){
    const g = f && f.geometry;
    if(!g) continue;

    // æ”¯æ´ GeoJSON Pointï¼ˆgeometry.coordinatesï¼‰æˆ– ArcGIS JSONï¼ˆgeometry.x/yï¼‰
    let lon=null, lat=null;
    if(g.type === "Point" && Array.isArray(g.coordinates)){
      lon = Number(g.coordinates[0]); lat = Number(g.coordinates[1]);
    }else if(g.x != null && g.y != null){
      lon = Number(g.x); lat = Number(g.y);
    }
    if(!Number.isFinite(lon) || !Number.isFinite(lat)) continue;

    const yy = getYear(f);
    const isTarget = (yy===TARGET_YEAR_AD || yy===TARGET_YEAR_ROC);
    if(!isTarget) continue;

    const pWM = __toWM(new Point({ longitude: lon, latitude: lat }));
    try{ if(unionIsoWM && pWM && geometryEngine.contains(unionIsoWM, pWM)) ACC_15MIN++; }catch(e){}
  }
}catch(e){
  ACC_15MIN = 0; // äº‹æ•…è³‡æ–™è¼‰å…¥å¤±æ•—æ™‚å°±ç•¶ 0
}

const accRateLife = ACC_15MIN / Math.max(1, POP_LIFE);
const accRateTY   = ACC_TAOYUAN / Math.max(1, POP_TAOYUAN);
const avgAccRate  = (accRateLife + accRateTY) / 2;
const trafficSafety100 = (1 - Math.min(1, (accRateLife / Math.max(1e-12, avgAccRate)))) * 100;

// âœ… ç½å®³å®‰å…¨ï¼ˆåœŸå£¤æ¶²åŒ–ï¼‰ï¼šæ²’è³‡æ–™â†’é«˜é¢¨éšªé¢ç©=0 â†’ åˆ†æ•¸=100
let disasterSafety100 = 100;
try{
  if (customGraphicsLayer && customGraphicsLayer.graphics && customGraphicsLayer.graphics.length > 0){
    const unionIsoWM = geometryEngine.union(isoPolys);
    const isoArea = Math.max(1, Math.abs(geometryEngine.geodesicArea(unionIsoWM, "square-meters")));
    const tyArea  = taoyuanUnionWM ? Math.max(1, Math.abs(geometryEngine.geodesicArea(taoyuanUnionWM, "square-meters"))) : 1;

    let highIso = 0, highTY = 0;
    customGraphicsLayer.graphics.forEach(gr=>{
      const poly = gr.geometry;
      if(!poly || poly.type !== "polygon") return;
      const cls = gr.attributes?.["åˆ†ç´š"] || gr.attributes?.riskClass || "";
      if (cls !== "é«˜æ½›å‹¢") return;
      try{
        const i1 = unionIsoWM ? geometryEngine.intersect(poly, unionIsoWM) : null;
        if(i1) highIso += Math.abs(geometryEngine.geodesicArea(i1, "square-meters"));
      }catch(e){}
      try{
        const i2 = taoyuanUnionWM ? geometryEngine.intersect(poly, taoyuanUnionWM) : null;
        if(i2) highTY += Math.abs(geometryEngine.geodesicArea(i2, "square-meters"));
      }catch(e){}
    });

    const riskIso = highIso / isoArea;
    const riskTY  = highTY  / tyArea;
    const avgRisk = (riskIso + riskTY) / 2;
    disasterSafety100 = (1 - Math.min(1, (riskIso / Math.max(1e-9, avgRisk)))) * 100;
  }
}catch(e){ disasterSafety100 = 100; }

const stability100 = (crimeScore100 + trafficSafety100 + disasterSafety100) / 3;

// âœ… æ•™è‚²æ©Ÿæ§‹ï¼šå­¸æ ¡é»ä½ï¼ˆå¾å…¬å…±è¨­æ–½æŠ“ type=å­¸æ ¡ï¼‰
const unionIsoWM = geometryEngine.union(isoPolys);
let school15 = 0, schoolTY = 0;
facilityLayer.graphics.forEach(g=>{
  const t = (g.attributes && (g.attributes.type || g.attributes.facType)) ? (g.attributes.type || g.attributes.facType) : "";
  if (t !== "å­¸æ ¡") return;
  const ptWM = __toWM(g.geometry);
  try{ if(unionIsoWM && ptWM && geometryEngine.contains(unionIsoWM, ptWM)) school15++; }catch(e){}
  try{ if(taoyuanUnionWM && ptWM && geometryEngine.contains(taoyuanUnionWM, ptWM)) schoolTY++; }catch(e){}
});
const eduInst100 = (()=>{
  const schPerLife = school15 / Math.max(1, POP_LIFE);
  const schPerTY   = schoolTY / Math.max(1, POP_TAOYUAN);
  if (schPerTY <= 0) return 0;
  return Math.min(100, (schPerLife / schPerTY) * 100);
})();

// âœ… æ•™è‚²ç¨‹åº¦ï¼šç•¢æ¥­äººå£ Ã· æ¡ƒåœ’å€ç¸½äººå£ Ã— æ¬Šé‡ Ã—100
const EDU_W = { "å°å­¸ä»¥ä¸‹":0.2, "åœ‹ä¸­":0.4, "é«˜ä¸­":0.6, "å¤§å­¸":0.8, "ç¢©åšå£«":1.0 };
const TAOYUAN_DISTRICT_TOTAL_POP = 478284; // 2025å¹´11æœˆæ¡ƒåœ’å€äººå£ï¼ˆæˆ¶ç±ï¼‰
let eduLevel100 = 0;
try{
  // âœ… å„ªå…ˆæ²¿ç”¨æ•™è‚²ç¨‹åº¦é¢æ¿å·²ç¶“æ•´ç†å¥½çš„ storeï¼ˆå¦‚æœæœ‰ï¼‰
  const denomPop = Math.max(1, TAOYUAN_DISTRICT_TOTAL_POP);

  const calcFromAgg = (agg)=>{
    if(!agg || !agg.grad) return 0;
    let s = 0;
    for(const [k,v] of Object.entries(EDU_W)){
      const n = Number(agg.grad[k] || 0);
      if(!Number.isFinite(n)) continue;
      s += (n / denomPop) * v * 100;
    }
    return Math.max(0, s);
  };

  if(window.__eduStore && typeof window.__eduAreas === "function" && typeof window.__eduGetAgg === "function"){
    const areas = window.__eduAreas();
    const tyKey = areas.find(a => a === "æ¡ƒåœ’å€") || areas.find(a => (a||"").includes("æ¡ƒåœ’"));
    // âœ… æœ€æ–°å¹´ï¼šç›´æ¥å–æœ€å¤§ï¼ˆä½ è¦æ±‚ã€Œç®—æœ€æ–°é‚£ä¸€å¹´ã€ï¼‰
    let useYear = null;
    if(tyKey){
      const mY = window.__eduStore.get(tyKey);
      if(mY){
        const ys = Array.from(mY.keys()).map(s=>parseInt(s,10)).filter(Number.isFinite);
        if(ys.length) useYear = String(Math.max(...ys));
      }
    }
    const aggTY = (tyKey && useYear) ? window.__eduGetAgg(tyKey, useYear) : null;
    eduLevel100 = calcFromAgg(aggTY);
  }else{
    // âœ… æ²’æœ‰æ•™è‚²é¢æ¿ store çš„è©±ï¼šç›´æ¥ç”¨ä½ æä¾›çš„ GeoJSON é‡æ–°å½™æ•´ï¼ˆé¿å…ç®—ä¸åˆ°ï¼‰
    const EDU_GEOJSON_URL = "https://jade0815.github.io/data/106%E5%B9%B4~113%E6%95%99%E8%82%B2%E7%A8%8B%E5%BA%A6%E8%A8%BB%E8%A8%98.geojson";
    if(!window.__eduScoreCache){
      const res = await fetch(EDU_GEOJSON_URL, { cache: "no-store" });
      const gj = await res.json();
      const feats = Array.isArray(gj.features) ? gj.features : [];

      // cache çµæ§‹ï¼šyear -> area -> gradCounts(level)
      const cache = new Map();
      const getProp = (p, keys)=>{ for(const k of keys){ if(p && p[k]!=null) return p[k]; } return null; };

      for(const f of feats){
        const p = f && f.properties ? f.properties : {};
        const area = String(getProp(p, ["å€","è¡Œæ”¿å€","area","AREA","Area","name","Name"]) || "").trim();
        if(!area) continue;

        const yearRaw = getProp(p, ["year","YEAR","å¹´åº¦","Year","çµ±è¨ˆå¹´","stat_year"]);
        const yNum = Number(yearRaw);
        const year = Number.isFinite(yNum) ? yNum : NaN;
        if(!Number.isFinite(year)) continue;

        // æ•™è‚²ç¨‹åº¦é¡åˆ¥
        const lvl = String(getProp(p, ["æ•™è‚²ç¨‹åº¦","ç¨‹åº¦","edu","EDU","edu_level","level"]) || "").trim();
        if(!lvl) continue;

        // ç•¢æ¥­/åœ¨å­¸ï¼šè‹¥æ¬„ä½å­˜åœ¨å°±åªæŠ“ã€Œç•¢æ¥­ã€
        const gradFlag = String(getProp(p, ["ç•¢æ¥­åˆ¥","ç‹€æ…‹","state","Status","grad"]) || "");
        if(gradFlag && !gradFlag.includes("ç•¢æ¥­")) continue;

        const valRaw = getProp(p, ["äººå£æ•¸","äººæ•¸","value","count","COUNT","ç¸½è¨ˆ"]);
        const val = Number(valRaw);
        if(!Number.isFinite(val)) continue;

        if(!cache.has(year)) cache.set(year, new Map());
        const mA = cache.get(year);
        if(!mA.has(area)) mA.set(area, {grad:{}});
        const obj = mA.get(area);
        obj.grad[lvl] = (obj.grad[lvl] || 0) + val;
      }
      window.__eduScoreCache = cache;
    }

    // æœ€æ–°å¹´
    const years = Array.from(window.__eduScoreCache.keys()).filter(Number.isFinite);
    const useYear = years.length ? Math.max(...years) : null;
    const mA = (useYear!=null) ? window.__eduScoreCache.get(useYear) : null;

    // æ¡ƒåœ’å€ï¼ˆæ‰¾æœ€æ¥è¿‘çš„ keyï¼‰
    let tyAgg = null;
    if(mA){
      const keys = Array.from(mA.keys());
      const tyKey = keys.find(k => k==="æ¡ƒåœ’å€") || keys.find(k => (k||"").includes("æ¡ƒåœ’"));
      if(tyKey) tyAgg = mA.get(tyKey);
    }
    eduLevel100 = calcFromAgg(tyAgg);
  }
}catch(e){
  eduLevel100 = 0;
}

const education100 = (eduInst100 + eduLevel100) / 2;

// âœ… åŸºç¤è¨­æ–½ï¼šå…¬è»Šç«™ç‰Œ +ï¼ˆYouBike/EV/åœè»Šå ´ï¼‰
try{
  if(typeof loadYouBikeStations === "function" && youBikeLayer && youBikeLayer.graphics.length === 0) await loadYouBikeStations();
  if(typeof loadEvData === "function" && evLayer && evLayer.graphics && evLayer.graphics.length === 0) await loadEvData();
  if(typeof loadParkingData === "function" && parkingLayer && parkingLayer.graphics && parkingLayer.graphics.length === 0) await loadParkingData();
  if(typeof initStations === "function" && stopsLayer && stopsLayer.graphics.length === 0) { try{ initStations(); }catch(e){} }
}catch(e){}

const notHalo = (g)=> !(g.attributes && g.attributes.type === "halo");

const y15  = __countLayerPointsIn(unionIsoWM, youBikeLayer, notHalo);
const yTY  = __countLayerPointsIn(taoyuanUnionWM, youBikeLayer, notHalo);
const ev15 = __countLayerPointsIn(unionIsoWM, evLayer, notHalo);
const evTY = __countLayerPointsIn(taoyuanUnionWM, evLayer, notHalo);
const p15  = __countLayerPointsIn(unionIsoWM, parkingLayer, notHalo);
const pTY  = __countLayerPointsIn(taoyuanUnionWM, parkingLayer, notHalo);
const bus15 = __countLayerPointsIn(unionIsoWM, stopsLayer, null);
const busTY = __countLayerPointsIn(taoyuanUnionWM, stopsLayer, null);

// âœ… åŸºç¤è¨­æ–½ï¼ˆä¾ä½ æŒ‡å®šçš„ã€Œå¯†åº¦æ¯”ã€ç®—æ³•ï¼‰
// å…¬å…±é‹è¼¸åˆ†å¸ƒåˆ†æ•¸ = (å…¬è»Šç«™å¯†åº¦_ç”Ÿæ´»åœˆ / å…¬è»Šç«™å¯†åº¦_æ¡ƒåœ’å€) Ã—100
// åœè»Šè³‡è¨Šåˆ†æ•¸     = (åœè»Šè³‡è¨Šå¯†åº¦_ç”Ÿæ´»åœˆ / åœè»Šè³‡è¨Šå¯†åº¦_æ¡ƒåœ’å€) Ã—100
// åŸºç¤è¨­æ–½åˆ†æ•¸     = 1/2Ã—å…¬å…±é‹è¼¸åˆ†å¸ƒåˆ†æ•¸ + 1/2Ã—åœè»Šè³‡è¨Šåˆ†æ•¸
const __safeKm2 = (geomWM)=>{
  try{
    if(!geomWM) return 0.000001;
    return Math.max(0.000001, Math.abs(geometryEngine.geodesicArea(geomWM, "square-kilometers")));
  }catch(e){ return 0.000001; }
};

// --- ç”Ÿæ´»åœˆ / æ¡ƒåœ’å€ é¢ç©ï¼ˆkmÂ²ï¼‰ç”¨ geodesicAreaï¼Œé¿å…æœªå®šç¾©å‡½å¼é€ æˆæ•´é æ›æ‰ ---
let _unionIsoWM = null;
try{
  if (typeof unionIsoWM !== "undefined" && unionIsoWM) {
    _unionIsoWM = unionIsoWM;
  } else if (typeof isoPolys !== "undefined" && Array.isArray(isoPolys) && isoPolys.length) {
    _unionIsoWM = geometryEngine.union(isoPolys);
  }
}catch(e){ _unionIsoWM = null; }

const publicTrans100 = (()=>{
  const busPerLife = bus15 / Math.max(1, POP_LIFE);
  const busPerTY   = busTY / Math.max(1, POP_TAOYUAN);
  if (busPerTY <= 0) return 0;
  return Math.min(100, (busPerLife / busPerTY) * 100);
})();

// åœè»Šè³‡è¨Šï¼šYouBike + EV + åœè»Šå ´ï¼ˆå…ˆåŠ ç¸½å†ç®—æ¯”ä¾‹ï¼‰
const park15 = y15 + ev15 + p15;
const parkTY = yTY + evTY + pTY;

const parkingInfo100 = (()=>{
  const parkPerLife = park15 / Math.max(1, POP_LIFE);
  const parkPerTY   = parkTY / Math.max(1, POP_TAOYUAN);
  if (parkPerTY <= 0) return 0;
  return Math.min(100, (parkPerLife / parkPerTY) * 100);
})();

// âœ… åŸºç¤è¨­æ–½åˆ†æ•¸ = 1/2 Ã— å…¬å…±é‹è¼¸åˆ†å¸ƒåˆ†æ•¸ + 1/2 Ã— åœè»Šè³‡è¨Šåˆ†æ•¸
const infra100 = (publicTrans100 + parkingInfo100) / 2;

// âœ… æœ€çµ‚å®œå±…æ€§ç¸½åˆ†ï¼ˆ0~100ï¼‰ï¼šç©©å®šæ€§/å…¬å…±è¨­æ–½/é†«ç™‚/æ•™è‚²/åŸºç¤è¨­æ–½ï¼ˆç­‰æ¬Šé‡ï¼‰
const totalScore = (stability100 + scoreFac100 + scoreMed100 + education100 + infra100) / 5;



// ç‚ºäº†ç›¸å®¹åŸæœ¬é¢æ¿æ¬„ä½ï¼ˆä¿ç•™èˆŠé€²åº¦æ¢ï¼‰
const crimeScore = (crimeScore100 / 100) * CRIME_WEIGHT;

updateLivabilityPanel({

      building: lastBuilding,
      fac15Total, facXiao, facQing,
      medCounts15, Cb,
      NtaoyuanFac, NtaoyuanMed,
      scoreFac100, scoreFacWeighted,
      scoreMed100, scoreMedWeighted,
      crimeScore100, crimeScore,
      CRIME_15MIN, CRIME_TAOYUAN,
      totalScore,
      // âœ… æ–°å¢ï¼šæ•™è‚² / åŸºç¤è¨­æ–½ï¼ˆå«å­åˆ†æ•¸èˆ‡æ•¸é‡ï¼‰
      education100,
      infra100,
      publicTrans100,
      parkingInfo100,
      bus15, busTY,
      y15, yTY,
      ev15, evTY,
      p15, pTY
      ,
// âœ… æ–°å¢ï¼šç©©å®šæ€§/æ•™è‚²/åŸºç¤è¨­æ–½ï¼ˆ100åˆ†åˆ¶ï¼‰
stability100,
trafficSafety100,
disasterSafety100,
ACC_15MIN, ACC_TAOYUAN,

education100,
eduInst100,
eduLevel100,
school15, schoolTY,

infra100,
publicTrans100,
parkingInfo100,
bus15, busTY,
y15, yTY,
ev15, evTY,
p15, pTY
    });
  }

  // =========================
  // âœ… åªç•™ã€Œä¸€å€‹ã€click äº‹ä»¶ï¼šçŠ¯ç½ªå„ªå…ˆ
  // =========================
  view.on("click", async function (event) {
    try {

      /* âœ… å­¸æ ¡ä¸­å¿ƒæŒ‘é¸ï¼ˆå„ªå…ˆæ–¼æ‰€æœ‰ hitTest/çŠ¯ç½ª/å»ºç‰©é»æ“Šï¼‰ */
      if (isPickingSchoolCenter) {
        isPickingSchoolCenter = false;
        if (crimeSchoolPickBtn) crimeSchoolPickBtn.textContent = "é»åœ°åœ–é¸ä½ç½®";

        try {
          const radius = parseFloat((crimeSchoolRadiusSel && crimeSchoolRadiusSel.value) ? crimeSchoolRadiusSel.value : "800");
          const center = event.mapPoint;

          // è½‰æˆ WebMercator æ‰èƒ½ç”¨ meters buffer
          const centerWM = center.spatialReference && center.spatialReference.wkid === 102100
            ? center
            : webMercatorUtils.geographicToWebMercator(center);

          const bufferGeom = geometryEngine.buffer(centerWM, radius, "meters");

          // ç”¨åŒä¸€å€‹ drawLayerï¼šè®“å¾Œé¢ updateStats() / computeAccessibilityForBuilding() è‡ªå‹•åƒåˆ°
          drawLayer.removeAll();
          drawLayer.addMany([
            new Graphic({
              geometry: bufferGeom,
              symbol: { type: "simple-fill", color: [0, 0, 255, 0.18], outline: { color: [0, 0, 255, 1], width: 2 } }
            }),
            new Graphic({
              geometry: centerWM,
              symbol: { type: "simple-marker", color: [255, 0, 0, 1], size: 10, outline: { color: [255,255,255,1], width: 1 } }
            })
          ]);

          const msgEl = document.getElementById("msg");
          if (msgEl) msgEl.textContent = `âœ… å·²å»ºç«‹ã€Œå­¸æ ¡ä¸­å¿ƒã€åŠå¾‘ ${radius}m ç¯„åœï¼Œå¯æŸ¥çœ‹é™„è¿‘çŠ¯ç½ª/çµ±è¨ˆ`;

          updateStats();
          computeAccessibilityForBuilding();

          // å¦‚æœçŠ¯ç½ªåœ–å±¤å·²è¼‰å…¥ï¼Œé †ä¾¿æ›´æ–° KPIï¼ˆæœƒè‡ªå‹•å¥—ç”¨ç¯„åœï¼‰
          if (typeof updateCrimeFilterAndKPI === "function") {
            try { await updateCrimeFilterAndKPI(); } catch(e){}
          }

          return;
        } catch (e) {
          console.error("å»ºç«‹å­¸æ ¡ä¸­å¿ƒç¯„åœå¤±æ•—ï¼š", e);
        }
      }


      // âœ… çŠ¯ç½ªé»ä½å„ªå…ˆ
      if (crimeLayer && crimeToggle.checked && crimeLayer.visible) {

        if (crimeHeatToggle.checked) {
          const q = crimeLayer.createQuery();
          q.geometry = event.mapPoint;
          q.distance = 80;
          q.units = "meters";
          q.returnGeometry = true;
          q.outFields = ["*"];
          q.num = 1;

          const r = await crimeLayer.queryFeatures(q);
          if (r.features.length) {
            await showCrimePopup(r.features[0]);
            return;
          }
        } else {
          const hitCrime = await view.hitTest(event);
          const rrCrime = hitCrime.results.find(x => x.graphic && x.graphic.layer === crimeLayer);
          if (rrCrime) {
            const full = await fetchFullCrimeFeatureFromGraphic(rrCrime.graphic);
            await showCrimePopup(full);
            return;
          }
        }
      }

      if (customDrawEnabled && !isoEnabled) {
        handleCustomDrawClick(event);
        return;
      }

      if (isoEnabled) {
        if (!boundaryUnionWM) {
          document.getElementById("msg").textContent = "å°æªœæºªç¯„åœå°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™å†è©¦ã€‚";
          return;
        }

        const query = buildingLayer.createQuery();
        query.geometry = event.mapPoint;
        query.spatialRelationship = "intersects";
        query.returnGeometry = true;
        query.outFields = ["*"];
        const result = await buildingLayer.queryFeatures(query);

        if (result.features.length === 0) {
          document.getElementById("msg").textContent = "âš ï¸ 15åˆ†é˜ç”Ÿæ´»åœˆåªèƒ½é»åœ¨å»ºç‰©ä¸Šï¼Œè«‹é»é¸å»ºç‰©ã€‚";
          return;
        }

        const building = result.features[0];
        const center = (building.geometry.extent && building.geometry.extent.center) ? building.geometry.extent.center : building.geometry;

        if (!isInsideXiaoguaixi(center)) {
          document.getElementById("msg").textContent = "âš ï¸ è©²å»ºç‰©ä¸åœ¨å°æªœæºªç¯„åœå…§ï¼Œç„¡æ³•ç”Ÿæˆ 15 åˆ†é˜ç”Ÿæ´»åœˆã€‚";
          return;
        }

        const geo = webMercatorUtils.webMercatorToGeographic(center);
        lastBuilding = building;

        document.getElementById("msg").textContent =
          `ç”Ÿæˆ 15åˆ†é˜${getModeText()}ç”Ÿæ´»åœˆï¼ˆå»ºç‰©ä¸­å¿ƒï¼‰ï¼š\nç¶“åº¦: ${geo.longitude.toFixed(6)}, ç·¯åº¦: ${geo.latitude.toFixed(6)}`;

        await getIsochrone(geo.longitude, geo.latitude, isoMode);
        computeAccessibilityForBuilding();
        return;
      }

      const hit = await view.hitTest(event);
      const facilityResult = hit.results.find(r => r.graphic && r.graphic.layer === facilityLayer);
      const medResult = hit.results.find(r => r.graphic && r.graphic.layer === medLayer);

      if (facilityResult) { showFacilityPopup(facilityResult.graphic); return; }
      if (medResult) { showMedPopup(medResult.graphic); return; }

      const query = buildingLayer.createQuery();
      query.geometry = event.mapPoint;
      query.spatialRelationship = "intersects";
      query.returnGeometry = true;
      query.outFields = ["*"];
      const result = await buildingLayer.queryFeatures(query);

      if (result.features.length > 0) {
        const building = result.features[0];
        await showBuildingPopup(building, event);
        lastBuilding = building;
        computeAccessibilityForBuilding();
      } else {
        if (highlightHandle1) { highlightHandle1.remove(); highlightHandle1 = null; }
        if (popupDiv.style.display === "block") {
          popupDiv.style.display = "none";
          if (activeFacility) { resetFacilitySymbol(activeFacility); activeFacility = null; }
          if (activeMed) { resetMedSymbol(activeMed); activeMed = null; }
          view.goTo(initialCamera);
        }
      }
    } catch (err) { console.error(err); }
  });

  view.on("double-click", function (event) {
    if (customDrawEnabled && !isoEnabled && drawMode !== "point") {
      event.stopPropagation();
      finishCustomDrawing();
    }
  });

  /* Isochrone API */
  async function getIsochrone(lon, lat, mode) {
    const url = `https://api.openrouteservice.org/v2/isochrones/${mode}`;
    const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjExMzNhMTliYWE1OTQzZDViYTI0MTgzZjQwNmM2YzM5IiwiaCI6Im11cm11cjY0In0=";
    const body = { locations: [[lon, lat]], range: [900] };

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Authorization": apiKey, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok){
        let msg = "";
        try{ msg = await res.text(); }catch(e){}
        throw new Error("ORS ç­‰æ™‚åœˆå¤±æ•—ï¼š" + res.status + (msg ? (" " + msg.slice(0,200)) : ""));
      }
      if (!res.ok) throw new Error("ORS API å›å‚³éŒ¯èª¤ï¼š" + res.status);

      const geojson = await res.json();
      isochroneLayer.removeAll();

      geojson.features.forEach(f => {
        const polygons = (f.geometry.type === "Polygon") ? [f.geometry.coordinates] : f.geometry.coordinates;
        polygons.forEach(ringsArray =>
          ringsArray.forEach(rings => {
            const poly4326 = new Polygon({ rings, spatialReference: { wkid: 4326 } });
            const polyWM = webMercatorUtils.geographicToWebMercator(poly4326);
            isochroneLayer.add(new Graphic({
              geometry: polyWM,
              symbol: { type: "simple-fill", color: [0, 0, 255, 0.2], outline: { color: [0, 0, 255, 1], width: 2 } }
            }));
          })
        );
      });

      const ptGeo = new Point({ x: lon, y: lat, spatialReference: { wkid: 4326 } });
      const ptWM = webMercatorUtils.geographicToWebMercator(ptGeo);
      isochroneLayer.add(new Graphic({ geometry: ptWM, symbol: { type: "simple-marker", color: "red", size: 12 } }));

      updateStats();
      document.getElementById("msg").textContent =
        `å®Œæˆ âœ…\n15åˆ†é˜${getModeText()}ç”Ÿæ´»åœˆ é»åº§æ¨™:\nç¶“åº¦: ${lon.toFixed(6)}, ç·¯åº¦: ${lat.toFixed(6)}`;

      computeAccessibilityForBuilding();
    } catch (err) {
      console.error(err);
      document.getElementById("msg").textContent = "15åˆ†é˜ç”Ÿæ´»åœˆ ç”Ÿæˆå¤±æ•—ï¼š" + err.message;
    }
  }

  /* âœ… çµ±è¨ˆï¼šå…¬å…±è¨­æ–½ + é†«ç™‚é•·ç…§ + é–€ç‰Œ */
  function updateStats() {
    const allPolysWM = [];
    isochroneLayer.graphics.forEach(g => { if (g.geometry && g.geometry.type === "polygon") allPolysWM.push(g.geometry); });
    drawLayer.graphics.forEach(g => { if (g.geometry && g.geometry.type === "polygon") allPolysWM.push(g.geometry); });

    if (allPolysWM.length === 0) {
      Object.keys(subCountSpans).forEach(type => subCountSpans[type].textContent = "0");
      Object.keys(bigCountSpans).forEach(big => bigCountSpans[big].textContent = "(0)");
      Object.keys(medTypeSpans).forEach(t => medTypeSpans[t].textContent = "0");
      if (medTotalSpan) medTotalSpan.textContent = "ç¸½æ•¸: 0";
      totalHouseDiv.textContent = "é–€ç‰Œç¸½æ•¸: 0";

      facilityLayer.graphics.forEach(pt => {
        const type = pt.attributes && pt.attributes.type;
        if (!type) return;
        pt.symbol = getFacilitySymbol(type);
      });
      medLayer.graphics.forEach(pt => {
        const t = pt.attributes.medType || "è€äººé•·ç…§æ©Ÿæ§‹";
        pt.symbol = getMedSymbol(t);
      });
      return;
    }

    const facilityCounts = {};
    facilityLayer.graphics.forEach(pt => {
      if (!pt.attributes || !pt.attributes.type) return;
      const type = pt.attributes.type.trim();
      const big = bigCategory[type] || "å…¶ä»–";
      const inside = allPolysWM.some(poly => geometryEngine.contains(poly, pt.geometry));
      if (inside) {
        if (!facilityCounts[big]) facilityCounts[big] = {};
        facilityCounts[big][type] = (facilityCounts[big][type] || 0) + 1;
        pt.symbol = { type: "simple-marker", color: "yellow", size: 12, outline: { color: "black", width: 1 } };
      } else {
        pt.symbol = getFacilitySymbol(type);
      }
    });

    Object.keys(subCountSpans).forEach(type => {
      const big = bigCategory[type] || "å…¶ä»–";
      const num = facilityCounts[big]?.[type] || 0;
      subCountSpans[type].textContent = num;
    });

    Object.keys(bigCountSpans).forEach(big => {
      let total = 0;
      if (facilityCounts[big]) Object.values(facilityCounts[big]).forEach(n => total += n);
      bigCountSpans[big].textContent = `(${total})`;
    });

    const medCounts = { "é†«é™¢": 0, "è—¥å±€": 0, "è€äººé•·ç…§æ©Ÿæ§‹": 0 };
    medLayer.graphics.forEach(pt => {
      if (!pt.geometry) return;
      const type = pt.attributes.medType || "è€äººé•·ç…§æ©Ÿæ§‹";
      const inside = allPolysWM.some(poly => geometryEngine.contains(poly, pt.geometry));
      if (inside) {
        medCounts[type] = (medCounts[type] || 0) + 1;
        pt.symbol = { type: "picture-marker", url: medTypeIcons[type], width: "26px", height: "26px", outline: { color: [0,0,0,1], width: 1 } };
      } else {
        pt.symbol = getMedSymbol(type);
      }
    });

    let medTotal = 0;
    Object.keys(medTypeSpans).forEach(t => {
      const num = medCounts[t] || 0;
      medTypeSpans[t].textContent = num;
      medTotal += num;
    });
    if (medTotalSpan) medTotalSpan.textContent = `ç¸½æ•¸: ${medTotal}`;

    let houseCount = 0;
    houseLayer.graphics.forEach(h => {
      const inside = allPolysWM.some(poly => geometryEngine.contains(poly, h.geometry));
      if (inside) houseCount++;
    });
    totalHouseDiv.textContent = `é–€ç‰Œç¸½æ•¸: ${houseCount}`;
  }

  // âœ… å•Ÿå‹•
  // âœ… å•Ÿå‹•
  loadTaoyuanPolygon();
  loadCrimeLayerOnce();   // âœ… å…ˆæŠŠçŠ¯ç½ªè³‡æ–™è¼‰å…¥ï¼ˆä¸ç”¨é–‹é»ä½ä¹Ÿèƒ½ç®—ï¼‰
  resetLivabilityPanel();

  //----------------ç©ºæ°£å“è³ªAQI & æº«åº¦ & UV & é›¨é‡-------------------------
const aqiCircle = document.getElementById("aqiCircle");
const tempCircle = document.getElementById("tempCircle");
const uvCircle = document.getElementById("uvCircle");
const rainCircle = document.getElementById("rainCircle");

const aqiValue = document.getElementById("aqiValue");
const tempValue = document.getElementById("tempValue");
const uvValue = document.getElementById("uvValue");
const rainValue = document.getElementById("rainValue");

const aqiTooltip = document.getElementById("aqiTooltip");
const tempTooltip = document.getElementById("tempTooltip");
const uvTooltip = document.getElementById("uvTooltip");
const rainTooltip = document.getElementById("rainTooltip");
const obsTimeDiv = document.getElementById("obsTime");
const aqiMessageHover = document.getElementById("aqiMessageHover");

let openTooltip = null;

// AQI é¡è‰²
function getAQIColor(aqi){
  const v = parseInt(aqi,10);
  if(isNaN(v)) return "#CCCCCC";
  if(v<=50) return "#00E400";
  if(v<=100) return "#FFD740";
  if(v<=150) return "#FF7E00";
  if(v<=200) return "#FF0000";
  if(v<=300) return "#8F3F97";
  return "#7E0023";
}

// AQI è¨Šæ¯
function getAQIMessage(aqi){
  const v = parseInt(aqi, 10);
  if (isNaN(v)) return "â“ è³‡æ–™ä¸å®Œæ•´";
  if (v <= 50) return "ğŸŒ¿ ç©ºæ°£è¶…æ£’ï¼å»å…¬åœ’æ•£æ­¥å§ ğŸ˜";
  if (v <= 100) return "ğŸ™‚ ç©ºæ°£æ™®é€šï¼Œæˆ´å£ç½©æœƒæ›´å®‰å¿ƒ ğŸ˜·";
  if (v <= 150) return "ğŸ¤” ç©ºæ°£æœ‰é»ç³Ÿï¼Œæˆ´å£ç½©æ›´å¥½ ğŸ‘";
  if (v <= 200) return "ğŸ˜· ç©ºæ°£å·®ï¼Œå£ç½©æ˜¯å¿…é ˆçš„ï¼";
  if (v <= 300) return "ğŸš¨ ç©ºæ°£å¾ˆå·®ï¼Œæ¸›å°‘å¤–å‡ºï¼æˆ´å£ç½© ğŸ˜·";
  return "ğŸ›‘ ç©ºæ°£æ¥µå·®ï¼Œå¾…åœ¨å®¤å…§æœ€å®‰å…¨ ğŸ ";
}

// AQI è©³ç´°
function getAQIDetailHTML(station){
  return `
    <p>PM10: ${station.pm10||"--"} Î¼g/mÂ³</p>
    <p>PM2.5: ${station["pm2.5"]||"--"} Î¼g/mÂ³</p>
    <p>Oâ‚ƒ: ${station.o3||"--"} ppb</p>
    <p>CO: ${station.co||"--"} ppm</p>
    <p>NOâ‚‚: ${station.no2||"--"} ppb</p>
    <p>SOâ‚‚: ${station.so2||"--"} ppb</p>
  `;
}

// å¤©æ°£å°æ‡‰ emoji
const weatherIcons = {
  "å¤šé›²": "â›…",
  "æ™´": "â˜€ï¸",
  "é™°": "â˜ï¸",
  "å°é›¨": "ğŸŒ¦",
  "é›¨": "ğŸŒ§",
  "é›·é™£é›¨": "â›ˆ",
  "é›ª": "â„ï¸"
};

// AQI
async function fetchAQI(){
  try{
    const res = await fetch("https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=477f0cbf-5bb3-4227-a115-c23b3ceb9e66");
    const json = await res.json();
    const station = json.records.find(r=>r.sitename==="æ¡ƒåœ’");
    if(!station) return;

    aqiValue.textContent = station.aqi||"--";
    const color = getAQIColor(station.aqi);
    aqiCircle.style.background=color;
    aqiCircle.style.boxShadow=`0 0 4px ${color},0 0 8px ${color}`;
    obsTimeDiv.textContent = station.publishtime ? `è§€æ¸¬æ™‚é–“: ${station.publishtime}` : "è§€æ¸¬æ™‚é–“: --";

    aqiCircle.onclick=(e)=>{
      e.stopPropagation();
      if(openTooltip && openTooltip!==aqiTooltip){ openTooltip.style.display="none"; }
      if(aqiTooltip.style.display==="block"){ aqiTooltip.style.display="none"; openTooltip=null; }
      else{ aqiTooltip.style.display="block"; aqiTooltip.innerHTML=getAQIDetailHTML(station); openTooltip=aqiTooltip; }
    };

    // AQI æ»‘é¼  hover æ‰é¡¯ç¤ºè¨Šæ¯
    aqiCircle.addEventListener("mouseenter",()=>{
      const color = getAQIColor(station.aqi);
      aqiMessageHover.style.background = color;
      aqiMessageHover.style.setProperty('--arrow-color', color); // åŒæ­¥ç®­é ­é¡è‰²
      aqiMessageHover.textContent = getAQIMessage(station.aqi);
      aqiMessageHover.style.display="block";
    });
    aqiCircle.addEventListener("mouseleave",()=>{
      aqiMessageHover.style.display="none";
    });

  }catch(err){ console.error("AQI è¼‰å…¥å¤±æ•—",err); }
}

// æº«åº¦
async function fetchTemp(){
  try{
    const res = await fetch("https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=CWA-661C0400-2EF2-4448-9AD4-5A1793D5A6B7");
    const json = await res.json();
    const station = json.records.Station.find(s =>
  s.GeoInfo?.CountyName === "æ¡ƒåœ’å¸‚" &&
  s.GeoInfo?.TownName === "æ¡ƒåœ’å€"
);
if(!station) return;

    const nowTemp = station.WeatherElement.AirTemperature;
    const highTemp = station.WeatherElement.DailyExtreme?.DailyHigh?.TemperatureInfo?.AirTemperature;
    const lowTemp = station.WeatherElement.DailyExtreme?.DailyLow?.TemperatureInfo?.AirTemperature;

    tempValue.textContent = nowTemp || "--";

    tempCircle.onclick=(e)=>{
      e.stopPropagation();
      if(openTooltip && openTooltip!==tempTooltip){ openTooltip.style.display="none"; }
      if(tempTooltip.style.display==="block"){ tempTooltip.style.display="none"; openTooltip=null; }
      else{
        const weatherText = station.WeatherElement.Weather || "--";
        const icon = weatherIcons[weatherText] || "";
        tempTooltip.style.display="block";
        tempTooltip.innerHTML=`
          å¤©æ°£: ${weatherText} ${icon}<br>
          å³æ™‚æº«åº¦: ${nowTemp||"--"} Â°C<br>
          ä»Šæ—¥æœ€é«˜æº«: ${highTemp||"--"} Â°C<br>
          ä»Šæ—¥æœ€ä½æº«: ${lowTemp||"--"} Â°C<br>
          é¢¨å‘: ${station.WeatherElement.WindDirection||"--"}<br>
          é¢¨é€Ÿ: ${station.WeatherElement.WindSpeed||"--"} m/s<br>
          ç›¸å°æ¿•åº¦: ${station.WeatherElement.RelativeHumidity||"--"}%
        `;
        openTooltip=tempTooltip;
      }
    };
  }catch(err){ console.error("æº«åº¦è³‡æ–™è¼‰å…¥å¤±æ•—",err); }
}

// UV

// UV é¢¨éšªèªªæ˜ï¼ˆä¾ UV æŒ‡æ•¸åˆ†ç´šï¼‰
function getUvRiskText(uv){
  const v = Number(uv);
  if (!isFinite(v)) return "é¢¨éšªèªªæ˜ï¼š--";
  if (v < 3) return "ä½é‡ç´šï¼šä¸€èˆ¬å¤–å‡ºå³å¯ã€‚";
  if (v < 6) return "ä¸­é‡ç´šï¼šå»ºè­°æ¡å–é˜²æ›¬æªæ–½ï¼Œå¦‚ä½¿ç”¨é˜²æ›¬éœœå’Œä½©æˆ´å¸½å­ï¼Œä»¥ä¿è­·è‡ªå·±å…å—ç´«å¤–ç·šçš„å‚·å®³ã€‚";
  if (v < 8) return "é«˜é‡ç´šï¼šå»ºè­°ä½¿ç”¨ SPF é˜²æ›¬ã€æˆ´å¸½/å¢¨é¡ã€æ¸›å°‘æ­£ä¸­åˆé•·æ™‚é–“æ›æ›¬ã€‚";
  if (v < 11) return "éé‡ç´šï¼šé¿å…é•·æ™‚é–“æˆ¶å¤–æ´»å‹•ï¼Œå¤–å‡ºå‹™å¿…å®Œæ•´é˜²æ›¬ã€‚";
  return "å±éšªç´šï¼šç›¡é‡é¿å…å¤–å‡ºæ›æ›¬ï¼Œæ¡å–æœ€é«˜ç­‰ç´šé˜²æ›¬é˜²è­·ã€‚";
}

async function fetchUV(){
  try{
    const res = await fetch("https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0005-001?Authorization=CWA-661C0400-2EF2-4448-9AD4-5A1793D5A6B7");
    const json = await res.json();
    const record = json.records.weatherElement.location.find(l=>l.StationID==="467420"); // æ¡ƒåœ’ç«™
    if(!record) return;
    uvValue.textContent = record.UVIndex || "--";

    uvCircle.onclick=(e)=>{
      e.stopPropagation();
      if(openTooltip && openTooltip!==uvTooltip){ openTooltip.style.display="none"; }
      if(uvTooltip.style.display==="block"){ uvTooltip.style.display="none"; openTooltip=null; }
      else{
        uvTooltip.style.display="block";
        const uvNow = record.UVIndex || "--";
        const uvRisk = getUvRiskText(uvNow);
        uvTooltip.innerHTML = `ä»Šæ—¥ç´«å¤–ç·šæŒ‡æ•¸: ${uvNow}<br>${uvRisk}`;
        openTooltip=uvTooltip;
      }
    };
  }catch(err){ console.error("UVè³‡æ–™è¼‰å…¥å¤±æ•—",err); }
}

// é›¨é‡
async function fetchRain(){
  try{
    const res = await fetch("https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization=CWA-661C0400-2EF2-4448-9AD4-5A1793D5A6B7");
    const json = await res.json();
    const station = json.records.Station.find(s =>
  s.GeoInfo?.CountyName === "æ¡ƒåœ’å¸‚" &&
  s.GeoInfo?.TownName === "æ¡ƒåœ’å€"
);
if(!station) return;

    const rain = station.RainfallElement?.Now?.Precipitation || "--";
    rainValue.textContent = rain;

    rainCircle.onclick=(e)=>{
      e.stopPropagation();
      if(openTooltip && openTooltip!==rainTooltip){ openTooltip.style.display="none"; }
      if(rainTooltip.style.display==="block"){ rainTooltip.style.display="none"; openTooltip=null; }
      else{
        const r = station.RainfallElement;
        rainTooltip.style.display="block";
        rainTooltip.innerHTML=`
          ç¾åœ¨é›¨é‡: ${r.Now?.Precipitation||"--"} mm<br>
          éå»1å°æ™‚: ${r.Past1hr?.Precipitation||"--"} mm<br>
          éå»3å°æ™‚: ${r.Past3hr?.Precipitation||"--"} mm<br>
          éå»6å°æ™‚: ${r.Past6Hr?.Precipitation||"--"} mm<br>
          éå»24å°æ™‚: ${r.Past24hr?.Precipitation||"--"} mm
        `;
        openTooltip=rainTooltip;
      }
    };
  }catch(err){ console.error("é›¨é‡è³‡æ–™è¼‰å…¥å¤±æ•—",err); }
}

document.body.addEventListener("click",()=>{ if(openTooltip){ openTooltip.style.display="none"; openTooltip=null; } });

// åˆå§‹åŒ–
fetchAQI();
fetchTemp();
fetchUV();
fetchRain();
setInterval(fetchAQI,5*60*1000);
setInterval(fetchTemp,5*60*1000);
setInterval(fetchUV,5*60*1000);
setInterval(fetchRain,5*60*1000);

//------------- åœŸå£¤æ¶²åŒ– -------------//
const customGraphicsLayer = new GraphicsLayer();
  map.add(customGraphicsLayer);
  customGraphicsLayer.visible = false;

  const legendElement = document.getElementById("customLegend");
  const toggleButton = document.getElementById("customLayerToggleBtn");

  const classificationColors = {
    "ä½æ½›å‹¢": [0, 255, 0, 0.5],
    "ä¸­æ½›å‹¢": [255, 255, 0, 0.5],
    "é«˜æ½›å‹¢": [255, 0, 0, 0.5]
  };

  let geoJsonLoaded = false;

  toggleButton.addEventListener("click", (event) => {
    event.preventDefault();
    customGraphicsLayer.visible = !customGraphicsLayer.visible;
    legendElement.style.display = customGraphicsLayer.visible ? "block" : "none";

    if (customGraphicsLayer.visible && !geoJsonLoaded) {
      loadCustomGeoJSON();
    } else if (!customGraphicsLayer.visible) {
      view.goTo(initialCamera);
    }
  });

  function loadCustomGeoJSON() {
    geoJsonLoaded = true;

    fetch("https://jade0815.github.io/data/åœŸå£¤æ¶²åŒ–.geojson")
      .then(response => response.json())
      .then(geojson => {
        geojson.features.forEach(feature => {
          const polygonGeom = new Polygon({
            rings: feature.geometry.coordinates,
            spatialReference: { wkid: 4326 }
          });

          const classification = feature.properties["åˆ†ç´š"] || "æœªçŸ¥";
          const fillColor = classificationColors[classification] || [128, 128, 128, 0.5];

          const graphicItem = new Graphic({
            geometry: polygonGeom,
            symbol: {
              type: "polygon-3d",
              symbolLayers: [{
                type: "extrude",
                size: 40,
                material: { color: fillColor }
              }]
            }
          });

          customGraphicsLayer.add(graphicItem);
        });

        if (customGraphicsLayer.graphics.length > 0) {
          view.goTo(customGraphicsLayer.graphics.items[0].geometry.extent.expand(1.5));
        }
      })
      .catch(err => console.error("GeoJSON è®€å–éŒ¯èª¤:", err));
  };
  
//----------------æ°´è³ª+æ·¹æ°´------------------
const waterLayer = new GraphicsLayer();
map.add(waterLayer);

// âœ… æ”¹æˆ wqx_p_12
const waterAPI = "https://data.moenv.gov.tw/api/v2/wqx_p_12?api_key=477f0cbf-5bb3-4227-a115-c23b3ceb9e66";

// âœ… åªå–é€™å€‹ç«™
const WATER_SITE_ID = "1674";

// âœ… è‹±æ–‡é …ç›® â†’ ä¸­æ–‡é¡¯ç¤ºï¼ˆè¡¨æ ¼ç”¨ï¼‰
const itemNameMap = {
  "Mercury": "æ±",
  "Hexavalent Chromium": "å…­åƒ¹é‰»",
  "Silver": "éŠ€",
  "Selenium": "ç¡’",
  "Cadmium": "é˜",
  "Arsenic": "ç ·",
  "Lead": "é‰›",
  "Chromium": "é‰»",
  "Nickel": "é³",
  "Copper": "éŠ…",
  "Zinc": "é‹…",
  "Manganese": "éŒ³",
  "Coliform Group": "å¤§è…¸æ¡¿èŒç¾¤",
  "Total-Phosphate": "ç¸½ç£·",
  "Dissolved Oxygen Saturation": "æº¶æ°§é£½å’Œåº¦",
  "Dissolved Oxygen": "æº¶æ°§",
  "Chloride": "æ°¯é›¢å­",
  "Total Nitrogen": "ç¸½æ°®",
  "Nitrite-Nitrogen": "äºç¡é…¸æ°®",
  "Nitrate-Nitrogen": "ç¡é…¸æ°®",
  "TKN": "å‡±æ°æ°®(TKN)",
  "NH3-N": "æ°¨æ°®(NH3-N)",
  "Total Organic Carbon": "ç¸½æœ‰æ©Ÿç¢³(TOC)",
  "Chemical Oxygen Demand": "åŒ–å­¸éœ€æ°§é‡(COD)",
  "Biochemical Oxygen Demand": "ç”ŸåŒ–éœ€æ°§é‡(BOD5)",
  "Suspended Solid": "æ‡¸æµ®å›ºé«”(SS)",
  "Temperature": "æ°£æº«",
  "Conductivity": "å°é›»åº¦",
  "Turbidity": "æ¿åº¦",
  "pH": "é…¸é¹¼å€¼(pH)",
  "Water Temperature": "æ°´æº«",
  "River Pollution Index": "æ²³å·æ±¡æŸ“æŒ‡æ•¸(RPI)"
};

// âœ… å½ˆçª—æ¬„ä½ä¸­æ–‡
const fieldLabelMap = {
  "siteid": "ç«™é»ä»£ç¢¼",
  "siteengname": "ç«™é»åç¨±",
  "sampledate": "æ¡æ¨£æ™‚é–“",
  "basinen": "æµåŸŸ",
  "riveren": "æ²³å·",
  "twd97lon": "ç¶“åº¦",
  "twd97lat": "ç·¯åº¦"
};

function toZhItemName(en) {
  return itemNameMap[en] || en || "-";
}

let pointsVisible = false;
waterLayer.visible = pointsVisible;

const panelToggle = document.getElementById("panel-toggle");
const panel = document.getElementById("panel-water");

// âœ… å·¦ä¸‹è§’æŒ‰éˆ•æ§åˆ¶æ°´è³ªé¢æ¿ï¼ˆåŠ ä¸Šé˜²å‘†ï¼Œé¿å…äº‹ä»¶æ²’ç¶åˆ°/å…ƒç´ ä¸å­˜åœ¨å°±å ±éŒ¯ï¼‰
if (panelToggle && panel) {
  panelToggle.onclick = () => {
    const isOpen = panel.style.left === "0px";
    panel.style.left = isOpen ? "-290px" : "0px";

    // âœ… è‡ªå‹•æ”¶èµ·å¦ä¸€å€‹é¢æ¿ï¼ˆæ·¹æ°´ï¼‰
    const floodPanel = document.getElementById("flood3D_panel");
    if (floodPanel) floodPanel.style.left = "-290px";

    // âœ… ä¹Ÿæ”¶èµ·çŠ¯ç½ªé¢æ¿
    if (crimePanelEl) crimePanelEl.style.display = "none";

    // å±•é–‹æ™‚æ‰è¼‰å…¥è³‡æ–™ï¼ˆé¿å…ä¸€é–‹å§‹å°±æ‰“ APIï¼‰
    if (!isOpen && typeof fetchWaterData === "function") {
      try { fetchWaterData(); } catch (err) { console.error("fetchWaterData() éŒ¯èª¤ï¼š", err); }
    }
    syncLeftPanelMask();
  };
} else {
  console.warn("æ°´è³ªé¢æ¿åˆå§‹åŒ–å¤±æ•—ï¼šæ‰¾ä¸åˆ° #panel-toggle æˆ– #panel-water");
}



/* =========================
   âœ… å·¦å´é¢æ¿é®ç½©ï¼ˆæ“‹ä½å…¶ä»–æŒ‰éˆ•ï¼‰
   ========================= */
const leftPanelMask = document.getElementById("leftPanelMask");

function isLeftPanelOpen() {
  // âœ… åªæŠŠã€Œå·¦å´æ»‘å‡ºã€é¢æ¿ç®—é€²é®ç½©ï¼šæ°´è³ª + æ·¹æ°´
  const wOpen = panel && panel.style.left === "0px";
  const floodPanel = document.getElementById("flood3D_panel");
  const fOpen = floodPanel && floodPanel.style.left === "0px";
  return wOpen || fOpen;
}

function syncLeftPanelMask() {
  const root = document.getElementById("livabilityUI");
  if (!root) return;
  root.classList.toggle("left-panels-open", isLeftPanelOpen());
}

if (leftPanelMask) {
  leftPanelMask.onclick = () => {
    // é»é®ç½©ï¼šåªæ”¶èµ·ã€Œå·¦å´æ»‘å‡ºã€çš„æ°´è³ª/æ·¹æ°´ï¼ˆçŠ¯ç½ªé¢æ¿ç”¨å³ä¸Šè§’ X é—œï¼‰
    if (panel) panel.style.left = "-290px";
    const floodPanel = document.getElementById("flood3D_panel");
    if (floodPanel) floodPanel.style.left = "-290px";
    syncLeftPanelMask();
  };
}

/* =========================
   âœ… çŠ¯ç½ªé¢æ¿ï¼šå·¦ä¸‹è§’åœ“å½¢æŒ‰éˆ•é–‹é—œï¼ˆä½ç½®åœ¨æŒ‰éˆ•æ—é‚Šï¼‰
   ========================= */
const crimeToggleBtn = document.getElementById("crime-toggle-btn");
const crimePanelEl = document.getElementById("crimePanel");

// âœ… é—œé–‰çŠ¯ç½ªé¢æ¿ï¼šæ¸…æ‰çŠ¯ç½ª/å­¸æ ¡é»ä½ + æ’è¡Œæ¦œé» + ç¯„åœ + å›åˆ°å°æªœæºªåˆå§‹è¦–è§’
async function closeCrimePanelAndReset(){
  try{ crimePanelEl && (crimePanelEl.style.display = "none"); }catch(e){}
  // âœ… é—œæ‰è‡ªè¨‚å½ˆè·³è¦–çª—
  try{ if(typeof popupDiv!=="undefined" && popupDiv) popupDiv.style.display = "none"; }catch(e){}
// é—œé–‰å‹¾é¸
  try{
    const ct = document.getElementById("crimeToggle");
    const cht = document.getElementById("crimeHeatToggle");
    const st = document.getElementById("schoolToggle");
    if(ct) ct.checked = false;
    if(cht) cht.checked = false;
    if(st) st.checked = false;
  }catch(e){}

  // é—œé–‰ / æ¸…é™¤åœ–å±¤
  try{
    if (typeof crimeLayer !== "undefined" && crimeLayer){
      crimeLayer.visible = false;
      if (crimeLayer.removeAll) crimeLayer.removeAll();
    }
  }catch(e){}

  try{
    const sLyr = window.__schoolLayer || null;
    if(sLyr){
      sLyr.visible = false;
    }
  }catch(e){}

  try{
    const iso = window.__schoolIsoLayer || null;
    if(iso){
      iso.visible = false;
    }
  }catch(e){}

  try{
    const hl = window.__schoolHighlightLayer || null;
    if(hl){
      hl.visible = false;
    }
  }catch(e){}

  try{
    const sel = window.__schoolSelectedLayer || null;
    if(sel){
      sel.visible = false;
    }
  }catch(e){}

  // å›åˆ°å°æªœæºªåˆå§‹è¦–è§’
  try{
    if (typeof view !== "undefined" && view && typeof initialCamera !== "undefined"){
      await view.goTo(initialCamera, { duration: 900 });
    }
  }catch(e){}
}

if (crimeToggleBtn && crimePanelEl) {
  crimeToggleBtn.onclick = async () => {
    const isOpen = crimePanelEl.style.display === "block";

    if (isOpen) {
      // âœ… é—œé¢æ¿ï¼šæ¸…åœ–å±¤ + å›åˆ°åˆå§‹è¦–è§’
      await closeCrimePanelAndReset();
      return;
    }

    // âœ… é–‹çŠ¯ç½ªé¢æ¿æ™‚ï¼Œè‡ªå‹•æ”¶èµ·æ°´è³ª/æ·¹æ°´ï¼ˆé¿å…äº’ç›¸æ“‹ï¼‰
    try{
      if (typeof panel !== "undefined" && panel) panel.style.left = "-290px";
      const floodPanel = document.getElementById("flood3D_panel");
      if (floodPanel) floodPanel.style.left = "-290px";
    }catch(e){}

    crimePanelEl.style.display = "block";
    // âš ï¸ çŠ¯ç½ªé¢æ¿ä¸è§¸ç™¼å·¦å´é®ç½©ï¼ˆé¿å…å¡ä½åœ°åœ–ï¼‰
    if(typeof placeCrimePanelNextToBtn==="function") placeCrimePanelNextToBtn();
  };
}

/* =========================
   âœ… åœ“å½¢æŒ‰éˆ•ï¼šæ»‘é¼ æç¤ºå°æ¡†ï¼ˆTooltipï¼‰
   ========================= */
(function initCircleButtonTooltips(){
  const tip = document.createElement("div");
  tip.id = "circleBtnTip";
  tip.className = "tooltip circle-btn-tip";
  document.body.appendChild(tip);

  function bind(el, label){
    if (!el) return;
    el.dataset.tip = label;

    el.addEventListener("mouseenter", (e)=>{
      tip.textContent = el.dataset.tip || "";
      tip.classList.add("show");
      tip.style.display = "block";
    });

    el.addEventListener("mousemove", (e)=>{
      // è®“å°æ¡†åœ¨æ»‘é¼ å³ä¸Šæ–¹
      const offsetX = 12, offsetY = 12;
      tip.style.left = (e.clientX + offsetX) + "px";
      tip.style.top  = (e.clientY - offsetY) + "px";
    });

    el.addEventListener("mouseleave", ()=>{
      tip.classList.remove("show");
      tip.style.display = "none";
    });
  }

  // å·¦ä¸‹è§’åœ“æŒ‰éµï¼ˆå°æªœæºª UIï¼‰
  bind(document.getElementById("flood3D_toggleBtn"), "æ·¹æ°´é¢æ¿");
  bind(document.getElementById("panel-toggle"), "æ°´è³ªé¢æ¿");
  bind(document.getElementById("crime-toggle-btn"), "çŠ¯ç½ªé¢æ¿");
  bind(document.getElementById("customLayerToggleBtn"), "åœŸå£¤æ¶²åŒ–åœ–å±¤");
  bind(document.getElementById("basemapButton"), "åº•åœ–");
  bind(document.getElementById("rangeToolToggleBtn"), "è‡ªè¨‚ç¯„åœå·¥å…·");

  // å³ä¸‹è§’/å³ä¸Šè§’ï¼ˆäº¤é€š UIï¼‰
  bind(document.getElementById("layerPanelToggle"), "åœ–å±¤é–‹é—œ");
})();
/* =========================
   âœ… ä»¥å­¸æ ¡ç‚ºä¸­å¿ƒï¼šé»åœ°åœ–é¸ä¸­å¿ƒ â†’ ç”¢ç”Ÿ bufferï¼ˆæœƒè¢«ç´å…¥ã€Œè‡ªè¨‚ç¯„åœ/ç”Ÿæ´»åœˆã€çµ±è¨ˆèˆ‡æ²»å®‰è¨ˆç®—ï¼‰
   ========================= */
let isPickingSchoolCenter = false;
const crimeSchoolPickBtn = document.getElementById("crimeSchoolPickBtn");
const crimeSchoolRadiusSel = document.getElementById("crimeSchoolRadius");

if (crimeSchoolPickBtn) {
  crimeSchoolPickBtn.onclick = () => {
    isPickingSchoolCenter = true;
    crimeSchoolPickBtn.textContent = "è«‹åˆ°åœ°åœ–é»ä¸€ä¸‹â€¦";
    const msgEl = document.getElementById("msg");
    if (msgEl) msgEl.textContent = "âœ… è«‹åœ¨åœ°åœ–é»é¸ã€Œå­¸æ ¡ä¸­å¿ƒã€ä½ç½®ï¼ˆæœƒè‡ªå‹•ç”¢ç”ŸåŠå¾‘ç¯„åœï¼‰";
  };

/* =========================
   âœ… çŠ¯ç½ªé¢æ¿ï¼šåªç”¨å³ä¸Šè§’ X é—œé–‰ + é–‹å•Ÿæ™‚è²¼æŒ‰éˆ•æ—é‚Š
   âœ… å­¸æ ¡é»ä½é–‹é—œ + è‡ªå‹•å­¸æ ¡çŠ¯ç½ªç†±å€ï¼ˆä¸ç”¨é»å­¸æ ¡ï¼‰
   ========================= */
const crimePanelCloseBtn = document.getElementById("crimePanelClose");
const schoolPointsToggle = document.getElementById("schoolPointsToggle");

function placeCrimePanelNextToBtn(){
  if (!crimeToggleBtn || !crimePanelEl) return;
  const r = crimeToggleBtn.getBoundingClientRect();
  // è®“é¢æ¿è²¼åœ¨åœ“æŒ‰éµå³é‚Šï¼ˆåŒé«˜åº¦ï¼‰
  crimePanelEl.style.left = (r.right + 10) + "px";
  crimePanelEl.style.top = r.top + "px";
  crimePanelEl.style.bottom = "auto";
}

// è¦–çª—ç¸®æ”¾æ™‚ï¼Œè‹¥é¢æ¿é–‹è‘—å°±è·Ÿè‘—è²¼å›æŒ‰éˆ•æ—
window.addEventListener("resize", () => {
  if (crimePanelEl && crimePanelEl.style.display === "block") placeCrimePanelNextToBtn();
});

/* --- å­¸æ ¡é»ä½ï¼šç¨ç«‹åœ–å±¤ --- */
let schoolPointsLayer = null;      // GraphicsLayer
let schoolPointsReady = false;
const SCHOOL_HOT_THRESH = { low: 1, mid: 3 }; // 0=ç¶ ï¼Œ1-2=é»ƒï¼Œ>=3=ç´…

function schoolSymbolByCount(count){
  // ç”¨é¡è‰²æ¨™ç¤ºç†±å€ï¼ˆä¸ç”¨ iconï¼Œé¿å…ä¸èƒ½æ›è‰²ï¼‰
  let color = [34,197,94,0.95];     // ç¶ 
  if (count >= SCHOOL_HOT_THRESH.mid) color = [239,68,68,0.95];      // ç´…
  else if (count >= SCHOOL_HOT_THRESH.low) color = [234,179,8,0.95]; // é»ƒ
  return {
    type: "simple-marker",
    style: "circle",
    color,
    size: 10,
    outline: { color: [255,255,255,0.85], width: 1 }
  };
}

function ensureSchoolLayer(){
  if (schoolPointsLayer) return schoolPointsLayer;
  try{
    schoolPointsLayer = new GraphicsLayer({ visible: true });
    map.add(schoolPointsLayer);
  }catch(e){}
  return schoolPointsLayer;
}

function updateSchoolHotspots(){
  // åªæœ‰ã€ŒçŠ¯ç½ªåœ–å±¤é–‹ã€ä¸”ã€Œå­¸æ ¡é»ä½é–‹ã€æ‰æ›´æ–°
  if (!schoolPointsLayer || !schoolPointsReady) return;
  const crimeOn = (crimeToggleEl && crimeToggleEl.checked);
  const schoolOn = (!schoolPointsToggle || schoolPointsToggle.checked);
  if (!crimeOn || !schoolOn || !crimeLayer || !crimeLoaded) {
    // é‚„åŸæˆåŸºæœ¬ç¬¦è™Ÿ
    schoolPointsLayer.graphics.forEach(g => {
      g.symbol = schoolSymbolByCount(0);
      g.attributes = g.attributes || {};
      g.attributes.crimeCount = 0;
    });
    return;
  }

  const radius = parseFloat((crimeSchoolRadiusSel && crimeSchoolRadiusSel.value) ? crimeSchoolRadiusSel.value : "800");

  // é€æ ¡è¨ˆç®—ï¼šåŠå¾‘å…§çŠ¯ç½ªæ•¸ï¼ˆä¾ç›®å‰ç¯©é¸å¾Œçš„ crimeLayer.graphicsï¼‰
  const crimeGraphics = (crimeLayer && crimeLayer.graphics) ? crimeLayer.graphics.items : [];
  schoolPointsLayer.graphics.forEach(sg => {
    try{
      const buf = geometryEngine.buffer(sg.geometry, radius, "meters");
      let cnt = 0;
      for (const cg of crimeGraphics){
        if (!cg.geometry) continue;
        if (geometryEngine.contains(buf, cg.geometry)) cnt++;
      }
      sg.attributes = sg.attributes || {};
      sg.attributes.crimeCount = cnt;
      sg.symbol = schoolSymbolByCount(cnt);
    }catch(e){}
  });
}

// å­¸æ ¡é»ä½é–‹é—œ
if (schoolPointsToggle) {
  schoolPointsToggle.onchange = () => {
    const lyr = window.ensureSchoolLayer && window.ensureSchoolLayer();
    if (lyr) lyr.visible = !!schoolPointsToggle.checked;
    // âœ… ä¸åœ¨ã€Œæ‰“é–‹å­¸æ ¡é»ä½ã€æ™‚ç«‹åˆ»è¨ˆç®—ï¼ˆé¿å…ä¸€æ¬¡è·‘å¤§é‡ contains å°è‡´ç•¶æ©Ÿï¼‰
  };
}



}


const initCenter = [121.3128655838495, 24.99343185685978, 600]; // åˆå§‹ç¶“ç·¯åº¦
const initZoom = 16.5; // åˆå§‹ç¸®æ”¾

const btnPoints = document.getElementById("btn-points");
if (btnPoints) btnPoints.onclick = () => {
  pointsVisible = !pointsVisible;
  waterLayer.visible = pointsVisible;
  document.getElementById("btn-points").textContent = pointsVisible ? "éš±è—ç«™é»" : "é¡¯ç¤ºç«™é»";

  if (pointsVisible) {
    const graphics = waterLayer.graphics.toArray();
    if (graphics.length > 0) {
      const allPoints = graphics.map(g => g.geometry);
      const lons = allPoints.map(p => p.longitude);
      const lats = allPoints.map(p => p.latitude);
      const centerLon = (Math.min(...lons) + Math.max(...lons)) / 2;
      const centerLat = (Math.min(...lats) + Math.max(...lats)) / 2;

      view.goTo({ center: [centerLon, centerLat], zoom: 20, tilt: 45 }).then(() => {
        // è‡ªå‹•æ‰“é–‹ç¬¬ä¸€å€‹ç«™é»çš„å½ˆçª—
        const firstGraphic = graphics[0];
        const attr = firstGraphic.attributes || {};

        const popup = document.getElementById("custom-popup");
        popup.innerHTML = `
          <strong>${fieldLabelMap.siteid}ï¼š${attr.siteid || "-"}ï¼ˆ${attr.siteengname || "-"}ï¼‰</strong>
          <hr style="margin:4px 0; border:0; border-top:1px solid #ccc;">
          ${fieldLabelMap.sampledate}ï¼š${attr.sampledate || "-"}<br>
          ${fieldLabelMap.basinen}ï¼š${attr.basinen || "-"}<br>
          ${fieldLabelMap.riveren}ï¼š${attr.riveren || "-"}<br>
          ${fieldLabelMap.twd97lon}ï¼š${attr.twd97lon || "-"}<br>
          ${fieldLabelMap.twd97lat}ï¼š${attr.twd97lat || "-"}
        `;

        const screenPoint = view.toScreen(firstGraphic.geometry);
        popup.style.left = (screenPoint.x + 10) + "px";
        popup.style.top = (screenPoint.y + 10) + "px";
        popup.style.display = "block";
      });
    }
  } else {
    view.goTo({ center: initCenter, zoom: initZoom, tilt: 65 }); // å›åˆ°åŸå§‹ä½ç½®
    // ğŸš¨ éš±è—ç«™é»æ™‚ï¼ŒåŒæ™‚é—œæ‰å½ˆçª—
    document.getElementById("custom-popup").style.display = "none";
  }
};

function fetchWaterData() {
  fetch(waterAPI)
    .then(res => res.json())
    .then(data => {
      const records = data.records || [];

      // âœ… åªå– 1674 ç«™
      const filtered = records.filter(d => String(d.siteid) === WATER_SITE_ID);

      const wrapper = document.getElementById("water-table-wrapper");
      wrapper.innerHTML = "";

      // âœ… æ¯æ¬¡æ›´æ–°å…ˆæ¸…ç©ºï¼Œé¿å…ç–Šé»
      waterLayer.removeAll();

      let airTemp = null;   // Temperature
      let waterTemp = null; // Water Temperature
      let rpiValue = null;  // River Pollution Index (å¯å°æ•¸)

      // âœ… åŒç«™å¤šæŒ‡æ¨™åªç•«ä¸€æ¬¡é»ä½
      let stationPointAdded = false;

      // âœ… é€™ä¸‰å€‹ç”¨ä¸Šé¢æŒ‡æ¨™é¡¯ç¤ºï¼Œä¸æ”¾é€²è¡¨æ ¼ï¼ˆä¸­æ–‡åç¨±ï¼‰
      const skipForTable = new Set(["Temperature", "Water Temperature", "River Pollution Index"]);

      filtered.forEach(item => {
        const enName = (item.itemengname || "").trim();
        const zhName = toZhItemName(enName);

        const val = (item.itemvalue ?? "-");
        const unit = (item.itemunit || "").trim();

        // è¡¨æ ¼ï¼ˆæ’é™¤ï¼šæ°£æº«ã€æ°´æº«ã€RPIï¼‰
        if (!skipForTable.has(enName)) {
          const div = document.createElement("div");
          div.className = "table-item";
          div.innerHTML = `<span>${zhName}</span><span>${unit ? (val + " " + unit) : val}</span>`;
          wrapper.appendChild(div);
        }

        // ç«™é»åœ–å¾µåªåŠ ä¸€æ¬¡ï¼ˆç”¨ç¬¬ä¸€ç­†åº§æ¨™ï¼‰
        if (!stationPointAdded) {
          const lat = parseFloat(item.twd97lat);
          const lon = parseFloat(item.twd97lon);
          if (!isNaN(lat) && !isNaN(lon)) {
            const point = new Point({ longitude: lon, latitude: lat });
            const symbol = { type: "simple-marker", style: "circle", color: "#0077cc", size: 12, outline: { color: [255,255,255,0.9], width: 1 } };

            const graphic = new Graphic({
              geometry: point,
              symbol: symbol,
              attributes: item
            });

            waterLayer.add(graphic);
            stationPointAdded = true;
          }
        }

        // æŒ‡æ¨™åœˆåœˆ
        if (enName === "Temperature") airTemp = item.itemvalue;
        if (enName === "Water Temperature") waterTemp = item.itemvalue;
        if (enName === "River Pollution Index") rpiValue = parseFloat(item.itemvalue);
      });

      updateIndicators(airTemp, waterTemp, Number.isFinite(rpiValue) ? rpiValue : null);
    })
    .catch(err => console.error("æ°´è³ªè³‡æ–™éŒ¯èª¤ï¼š", err));
}

fetchWaterData();

// âœ… è®“ RPI å¯ä»¥é¡¯ç¤ºå°æ•¸ï¼ˆä¾‹å¦‚ 2.75ï¼‰
function updateIndicators(air, water, rpi) {
  document.getElementById("air-value").textContent = air ? air + "Â°C" : "--";
  document.getElementById("water-value").textContent = water ? water + "Â°C" : "--";

  const rpiCircle = document.getElementById("rpi-indicator");
  const rpiSpan = document.getElementById("rpi-value");

  if (rpi !== null && !Number.isNaN(rpi)) {
    rpiSpan.textContent = (Math.round(rpi * 100) / 100).toString();

    let color = "#4CAF50";
    if (rpi >= 6) color = "#F44336";
    else if (rpi >= 3) color = "#FF9800";
    else if (rpi >= 2) color = "#FFC107";

    rpiCircle.style.backgroundColor = color;
    rpiCircle.style.color = "#fff";
  } else {
    rpiSpan.textContent = "--";
    rpiCircle.style.backgroundColor = "#e3f2fd";
    rpiCircle.style.color = "#0077cc";
  }
}

// RPI å±•é–‹/æ”¶ç¸®
document.getElementById("btn-rpi").onclick = () => {
  const rpiPanel = document.getElementById("rpi-panel");
  if (rpiPanel.style.display === "block") {
    rpiPanel.style.display = "none";
    panel.classList.remove("expanded");
  } else {
    rpiPanel.style.display = "block";
    panel.classList.add("expanded");
    drawRPI();
  }
};

function drawRPI() {
  const container = document.getElementById("rpi-container");
  container.innerHTML = "";

  const points = [
    { value: 0, label: "æœª(ç¨)å—æ±¡æŸ“" },
    { value: 2, label: "è¼•åº¦" },
    { value: 3, label: "ä¸­åº¦" },
    { value: 6, label: "åš´é‡" }
  ];
  const colors = ["#4CAF50", "#FFC107", "#FF9800", "#F44336"];
  const top = 20, height = 200, maxValue = 6, scale = height / maxValue;

  for (let i = 0; i < points.length; i++) {
    const y1 = top + (maxValue - points[i].value) * scale;
    let y2 = (i < points.length - 1) ? top + (maxValue - points[i + 1].value) * scale : y1 - 40;

    const seg = document.createElement("div");
    seg.className = "rpi-line";
    seg.style.top = `${y2}px`;
    seg.style.height = `${y1 - y2}px`;
    seg.style.backgroundColor = colors[i];
    container.appendChild(seg);

    const label = document.createElement("div");
    label.className = "rpi-label";
    label.style.top = `${y2 + (y1 - y2) / 2 - 8}px`;
    label.style.color = colors[i];
    label.textContent = points[i].label;
    container.appendChild(label);
  }

  points.forEach((p, i) => {
    const y = top + (maxValue - p.value) * scale;

    const point = document.createElement("div");
    point.className = "rpi-point";
    point.style.top = `${y - 8}px`;
    point.style.backgroundColor = colors[i];
    container.appendChild(point);

    const value = document.createElement("div");
    value.className = "rpi-value";
    value.style.top = `${y - value.offsetHeight / 2}px`;
    value.textContent = p.value;
    container.appendChild(value);
  });
}

/* ============================
   ä¸‹é¢æ·¹æ°´ï¼ˆä½ åŸæœ¬çš„ç¨‹å¼ç¢¼ç…§è²¼ï¼‰
   ============================ */

const flood3D_graphicsLayer = new GraphicsLayer();
map.add(flood3D_graphicsLayer);

const baseUrl = "https://sta.colife.org.tw/STA_WaterResource_v2/v1.0/Datastreams?$expand=Thing,Thing/Locations&$top=100";
let preservedStations = [];

async function fetchObservations(datastreamId) {
  try {
    const obsUrl = `https://sta.colife.org.tw/STA_WaterResource_v2/v1.0/Datastreams(${datastreamId})/Observations?$orderby=phenomenonTime desc&$top=1`;
    const response = await fetch(obsUrl);
    const obsData = await response.json();
    return obsData.value && obsData.value[0] ? obsData.value[0] : null;
  } catch (err) {
    console.error(err);
    return null;
  }
}

async function fetchAllPages(url) {
  let allData = [];
  while (url) {
    const response = await fetch(url);
    const data = await response.json();
    allData = allData.concat(data.value || []);
    url = data['@iot.nextLink'] || null;
  }
  return allData;
}

function getDepthColor(depth) {
  if (depth === "-" || depth === null) return "rgba(0,0,0,0.1)";
  if (depth < 10) return "#a0e1ff";
  if (depth < 50) return "#3399ff";
  return "#0055cc";
}

function getDepthImage() {
  return "https://vvrl.cc/api/image/il4t6q/view";
}

async function initStations(){
  try{
  const allDatastreams = await fetchAllPages(baseUrl);
  if (!allDatastreams || allDatastreams.length === 0) return;

  const taoyuanStations = allDatastreams.filter(item => {
    const thing = item.Thing || {};
    const props = thing.properties || {};
    return (props.authority && props.authority.includes("æ¡ƒåœ’")) ||
           (props.stationName && props.stationName.includes("æ¡ƒåœ’"));
  });

  const select = document.getElementById("flood3D_stationSelect");

  for (const item of taoyuanStations) {
    const obs = await fetchObservations(item['@iot.id']);
    const depth = obs ? obs.result : null;
    // âœ… ä¸è¦åªä¿ç•™ depth==0ï¼Œä¿ç•™æ‰€æœ‰æ¸¬ç«™ï¼ˆdepth å¯èƒ½æ˜¯ 0 / null / >0ï¼‰
    preservedStations.push({ item, depth });

    const props = item.Thing?.properties || {};
    const option = document.createElement("option");
    option.value = item['@iot.id'];
    option.text = props.stationName || "-";
    select.appendChild(option);
  }

  select.addEventListener("change", async (e) => {
    const selectedId = e.target.value;
    const stationInfoEl = document.getElementById("flood3D_stationInfo");
    const imgEl = document.getElementById("flood3D_depthImg");
    const depthEl = document.getElementById("flood3D_depth");
    const basicEl = document.getElementById("flood3D_basicInfo");

    flood3D_graphicsLayer.removeAll();

    if (!selectedId) {
      stationInfoEl.style.display = "none";
      imgEl.style.display = "none";
      depthEl.textContent = "";
      basicEl.textContent = "";
      imgEl.src = "";
      return;
    }

    const station = preservedStations.find(s => s.item['@iot.id'] == selectedId);
    if (station) {
      const obs = await fetchObservations(selectedId);
      const depth = obs ? obs.result : "-";

      stationInfoEl.style.display = "flex";

      const thing = station.item.Thing || {};
      const props = thing.properties || {};
      const loc = thing.Locations?.[0]?.location?.coordinates || ["-", "-"];
      basicEl.innerHTML = `
        ç·¯åº¦: ${loc[1]} <br>
        ç¶“åº¦: ${loc[0]} <br>
        éš¸å±¬æ©Ÿé—œ: ${props.authority || "-"}
      `;

      imgEl.style.background = getDepthColor(depth);
      imgEl.src = getDepthImage();
      imgEl.style.display = "block";

      depthEl.textContent = `æ°´æ·±: ${depth} cm`;

      if (loc[0] !== "-" && loc[1] !== "-") {
        const graphic = new Graphic({
          geometry: { type: "point", longitude: loc[0], latitude: loc[1], z: 300 },
          symbol: {
            type: "point-3d",
            symbolLayers: [{
              type: "icon",
              resource: { primitive: "circle" },
              size: 20,
              material: { color: getDepthColor(depth) },
              outline: { color: "black", size: 1 }
            }]
          },
          popupTemplate: null  // ç¦ç”¨å½ˆè·³è¦–çª—
        });
        flood3D_graphicsLayer.add(graphic);
        view.goTo({ center: [loc[0], loc[1]], zoom: 14, tilt: 45 });
      }
    }
  });

  updateTimeDisplay();
  setInterval(updateTimeDisplay, 5 * 60 * 1000);
  }catch(err){
    console.warn("æ·¹æ°´è³‡æ–™è®€å–å¤±æ•—", err);
    const box = document.getElementById("floodStationsList") || document.getElementById("floodList") || document.getElementById("waterStationsList");
    if(box){
      box.innerHTML = `<div style="padding:10px;line-height:1.5;">âš ï¸ æ·¹æ°´/æ°´æ–‡è³‡æ–™è®€å–å¤±æ•—ã€‚<br>å¯èƒ½åŸå› ï¼šAPIæ†‘è­‰éæœŸæˆ–è¢«ç€è¦½å™¨é˜»æ“‹ï¼ˆERR_CERT_DATE_INVALIDï¼‰ã€‚<br>å»ºè­°ï¼šæ”¹ç”¨ sta.colife.org.twï¼ˆå·²å¥—ç”¨ï¼‰æˆ–ç¢ºèªé›»è…¦æ™‚é–“æ­£ç¢ºã€‚</div>`;
    }
  }
}

function updateTimeDisplay() {
  const now = new Date();
  document.getElementById('flood3D_updateTime').textContent = `è§€æ¸¬æ™‚é–“: ${now.toLocaleString()}`;
}

// ğŸ”¹ å„²å­˜åŸå§‹ç›¸æ©Ÿä½ç½®
const originalCamera = view.camera.clone();

// å·¦ä¸‹è§’æŒ‰éˆ•æ§åˆ¶é¢æ¿
const toggleBtn1 = document.getElementById("flood3D_toggleBtn");
const pane2 = document.getElementById("flood3D_panel");

// æ·¹æ°´é¢æ¿æŒ‰éˆ•
toggleBtn1.onclick = () => {
  if (pane2.style.left === "0px") {
    pane2.style.left = "-290px";
    syncLeftPanelMask();
    // ğŸ”„ å›åˆ°åŸæœ¬ä½ç½®
    view.goTo(originalCamera);
  } else {
    pane2.style.left = "0px";
    syncLeftPanelMask();
    panel.style.left = "-290px"; // è‡ªå‹•æ”¶èµ·å¦ä¸€å€‹
    if (crimePanelEl) crimePanelEl.style.display = "none"; // ä¹Ÿæ”¶èµ·çŠ¯ç½ªé¢æ¿
  }
};


    // ==============================
    // âœ… å­¸æ ¡ 10 åˆ†é˜æ­¥è¡Œç†±å€ï¼ˆåˆ†æ‰¹è¨ˆç®— + æ’è¡Œæ¦œï¼‰
    // ==============================
    const btnSchoolCompute = document.getElementById("btnSchoolCompute");
    const schoolComputeStatus = document.getElementById("schoolComputeStatus");
    const schoolRankList = document.getElementById("schoolRankList");
    const schoolToggleEl = document.getElementById("schoolToggle");
    const schoolRadiusSel = document.getElementById("schoolRadiusSelect"); // ä»ä¿ç•™åŠå¾‘(é¡è‰²å¿«é€Ÿé è¦½ç”¨)

    // é¿å… UI è¢«å¡ï¼šæ¯ N é–“å­¸æ ¡è®“å‡ºäº‹ä»¶è¿´åœˆä¸€æ¬¡
    const __yield = () => new Promise(r => setTimeout(r, 0));
    const __sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // å¹¾ä½•è½‰ç¶“ç·¯åº¦ï¼šæ”¯æ´ 3857/102100 èˆ‡ 4326ï¼ˆé¿å…å­¸æ ¡é»ä½ä¸æ˜¯ WebMercator æ™‚å…¨éƒ¨ç®—ä¸åˆ°ï¼‰
    function __toLonLat(geom){
      if(!geom) return null;
      const sr = geom.spatialReference && (geom.spatialReference.wkid || geom.spatialReference.latestWkid);
      try{
        if (sr === 4326) {
          return { lon: geom.longitude ?? geom.x, lat: geom.latitude ?? geom.y };
        }
        // å…¶ä»–ä¸€å¾‹ç•¶ä½œ WebMercator è½‰å› WGS84
        const g = webMercatorUtils.webMercatorToGeographic(geom);
        return { lon: g.longitude, lat: g.latitude };
      }catch(e){
        // æœ€å¾Œå˜—è©¦ç›´æ¥å– x/y
        if (typeof geom.x === "number" && typeof geom.y === "number") return { lon: geom.x, lat: geom.y };
        return null;
      }
    }


    // 10åˆ†é˜æ­¥è¡Œç­‰æ™‚åœˆï¼ˆORSï¼‰
    async function __getSchoolIso10min(lon, lat){
      const key = lon.toFixed(6)+","+lat.toFixed(6);
      if (window.__schoolIsoCache.has(key)) return window.__schoolIsoCache.get(key);

      const url = "https://api.openrouteservice.org/v2/isochrones/foot-walking";
      // æ²¿ç”¨ä½ ç¾æœ‰çš„ ORS keyï¼ˆåŒ getIsochroneï¼‰
      const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjExMzNhMTliYWE1OTQzZDViYTI0MTgzZjQwNmM2YzM5IiwiaCI6Im11cm11cjY0In0=";

      const body = { locations: [[lon, lat]], range: [600] }; // 10åˆ†é˜ = 600ç§’
      const res = await fetch(url, {
        method: "POST",
        headers: { "Authorization": apiKey, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        let msg = "";
        try{ msg = await res.text(); }catch(e){}
        throw new Error("ORS ç­‰æ™‚åœˆå¤±æ•—: " + res.status + (msg?(" / " + msg.slice(0,120)):""));
      }

      const gj = await res.json();
      const f = (gj.features && gj.features[0]) ? gj.features[0] : null;
      if (!f) throw new Error("ORS ç­‰æ™‚åœˆæ²’æœ‰å›å‚³ polygon");

      // æ”¯æ´ Polygon / MultiPolygon
      let poly4326 = null;
      if (f.geometry.type === "Polygon") {
        poly4326 = new Polygon({ rings: f.geometry.coordinates[0], spatialReference: { wkid: 4326 }});
      } else if (f.geometry.type === "MultiPolygon") {
        const polys = f.geometry.coordinates.map(p => new Polygon({ rings: p[0], spatialReference: { wkid: 4326 }}));
        poly4326 = geometryEngine.union(polys);
      } else {
        throw new Error("ORS geometry é Polygon");
      }

      const polyWM = webMercatorUtils.geographicToWebMercator(poly4326);
      const areaKm2 = Math.max(0.000001, geometryEngine.geodesicArea(poly4326, "square-kilometers"));

      const out = { polyWM, areaKm2 };
      window.__schoolIsoCache.set(key, out);
      return out;
    }

    
    function __buildSchoolPopupHTML(it){
      const a = (it && (it.attributes || it.attrs)) ? (it.attributes || it.attrs) : {};
      const name = it?.name || a?.name || a?.å­¸æ ¡åç¨± || a?.å­¸æ ¡ || a?.SCHOOLNAME || a?.schoolname || "å­¸æ ¡";
      const addr = a?.address || a?.åœ°å€ || a?.ADDRESS || a?.addr || a?.å­¸æ ¡åœ°å€ || "";
      const tel  = a?.tel || a?.é›»è©± || a?.TEL || a?.phone || a?.Phone || "";
      const type = a?.type || a?.é¡åˆ¥ || a?.TYPE || a?.school_type || "";
      const count = (it?.count ?? it?.crimeCount ?? a?.crimeCount ?? 0);
      const density = (it?.density ?? a?.density);
      const areaKm2 = (it?.areaKm2 ?? a?.areaKm2);

      const densityTxt = (typeof density === "number" && isFinite(density))
        ? density.toFixed(3) + " ä»¶/å¹³æ–¹å…¬é‡Œ"
        : "â€”";

      const areaTxt = (typeof areaKm2 === "number" && isFinite(areaKm2))
        ? areaKm2.toFixed(3) + " å¹³æ–¹å…¬é‡Œ"
        : "â€”";

      return `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;font-size:14px;">ğŸ« ${name}</div>
          <button id="popupCloseBtn" style="border:none;background:#ef4444;color:#fff;border-radius:8px;padding:4px 8px;cursor:pointer;">é—œé–‰</button>
        </div>
        <hr style="border:none;border-top:1px solid rgba(0,0,0,0.15);margin:8px 0;">
        <div style="line-height:1.55;">
          ${type ? `<div><b>é¡åˆ¥ï¼š</b>${type}</div>` : ""}
          ${addr ? `<div><b>åœ°å€ï¼š</b>${addr}</div>` : ""}
          ${tel  ? `<div><b>é›»è©±ï¼š</b>${tel}</div>` : ""}
          <div style="margin-top:6px;"><b>å‘¨é‚ŠçŠ¯ç½ªæ•¸ï¼š</b>${count}</div>
          <div><b>çŠ¯ç½ªå¯†åº¦ï¼š</b>${densityTxt}</div>
          <div><b>è¨ˆç®—é¢ç©ï¼š</b>${areaTxt}</div>
        </div>
      `;
    }

    function __showSchoolPopup(it){
      try{
        popupDiv.innerHTML = __buildSchoolPopupHTML(it);
        popupDiv.style.display = "block";
        const btn = document.getElementById("popupCloseBtn");
        if(btn){
          btn.onclick = async (e)=>{
            e.stopPropagation();
            popupDiv.style.display = "none";

            // âœ… é—œé–‰ã€Œæ’è¡Œæ¦œå­¸æ ¡ã€å½ˆè·³è¦–çª—ï¼šæ¸…æ‰é»ƒè‰²åœˆåœˆ + æ³›è—è‰²ç¯„åœ
            try{
              const sel = window.ensureSchoolSelectedLayer && window.ensureSchoolSelectedLayer();
              if(sel) sel.removeAll();
            }catch(err){}
            try{
              const isoLyr = window.ensureSchoolIsoLayer && window.ensureSchoolIsoLayer();
              if(isoLyr) isoLyr.removeAll();
            }catch(err){}

            // âœ… å›åˆ°é»æ“Šæ’è¡Œæ¦œå‰çš„åŸå§‹è¦–è§’
            try{
              if(__rankReturnCam) await view.goTo(__rankReturnCam, { duration: 350 });
            }catch(err){}
            __rankReturnCam = null;
          };
        }
        // å®šä½ï¼šä»¥å­¸æ ¡é»ä½ï¼ˆæˆ–å…¶ç¯„åœä¸­å¿ƒï¼‰
        const mp = (it?.geometryWM?.extent) ? it.geometryWM.extent.center : (it?.geometryWM || it?.geometry || null);
        if(mp) positionPopupAtPoint(mp);
      }catch(e){}
    }

    function __renderSchoolRank(items){
      if(!schoolRankList) return;
      if(!items || items.length===0){
        schoolRankList.innerHTML = "<div style='opacity:.8'>å°šç„¡çµæœ</div>";
        return;
      }

      const top = items.slice(0, 20);
      schoolRankList.innerHTML = top.map((it, i)=>{
        const name = it?.name || it?.attributes?.name || it?.attributes?.å­¸æ ¡åç¨± || it?.attributes?.SCHOOLNAME || `å­¸æ ¡${i+1}`;
        const density = (typeof it.density === "number" && isFinite(it.density)) ? it.density : 0;
        const count = (it.count ?? it.crimeCount ?? it.attributes?.crimeCount ?? 0);

        return `
          <div class="rankItem" data-idx="${i}">
            <div class="rankNo">${i+1}</div>
            <div class="rankName">${name}</div>
            <div class="rankMeta">
              <div class="rankDensity">${density.toFixed(3)} ä»¶/kmÂ²</div>
              <div class="rankCount">çŠ¯ç½ªæ•¸ï¼š${count}</div>
            </div>
          </div>
        `;
      }).join("");
// é»æ’è¡Œæ¦œï¼šé£›åˆ°å­¸æ ¡ + é¡¯ç¤º10åˆ†é˜ç¯„åœ + è‡ªè¨‚å½ˆè·³è¦–çª—
      Array.from(schoolRankList.querySelectorAll(".rankItem")).forEach(el=>{
        el.onclick = async ()=>{
          const idx = Number(el.dataset.idx);
          const it = top[idx];
          if(!it) return;

          // 1) é£›åˆ°è©²å­¸æ ¡
          try{
            // âœ… è¨˜ä½é»æ“Šå‰çš„ç›¸æ©Ÿä½ç½®ï¼šé—œé–‰å½ˆçª—è¦å›åˆ°åŸä½
            __rankReturnCam = view.camera.clone();

            const target = (it.geometryWM && it.geometryWM.extent) ? it.geometryWM.extent.center : it.geometryWM;
            await view.goTo({ target, zoom: 17, tilt: 65 }, { duration: 800 });
          }catch(e){}

          // 2) é¡¯ç¤ºè©²å­¸æ ¡çš„ 10 åˆ†é˜ç¯„åœ
          try{
            const isoLyr = window.ensureSchoolIsoLayer && window.ensureSchoolIsoLayer();
            if(isoLyr){
              isoLyr.removeAll();
              if(it.iso && it.iso.polyWM){
                isoLyr.add(new Graphic({
                  geometry: it.iso.polyWM,
                  symbol: { type:"simple-fill", color:[59,130,246,0.12], outline:{ color:[59,130,246,0.9], width:2 } }
                }));
              }else if(it.geometryWM){
                // æ²’æœ‰ ORS å¤šé‚Šå½¢å°±ç”¨åœ“å½¢ï¼ˆç”¨ç›®å‰åŠå¾‘ï¼‰
                const radiusM = parseFloat((crimeSchoolRadiusSel && crimeSchoolRadiusSel.value) ? crimeSchoolRadiusSel.value : "800");
                const buf = geometryEngine.geodesicBuffer(it.geometryWM, radiusM, "meters");
                isoLyr.add(new Graphic({
                  geometry: buf,
                  symbol: { type:"simple-fill", color:[59,130,246,0.10], outline:{ color:[59,130,246,0.9], width:2 } }
                }));
              }
            }
          }catch(e){}

          // 3) é«˜äº®é¸å–å­¸æ ¡ï¼ˆæ”¾å¤§/å¤–æ¡†ï¼‰
          try{
            const sel = window.ensureSchoolSelectedLayer && window.ensureSchoolSelectedLayer();
            if(sel && it.geometryWM){
              sel.visible = true;
              sel.removeAll();
              sel.add(new Graphic({
                geometry: it.geometryWM,
                symbol: { type:"simple-marker", style:"circle", size:"18px",
                  color:[255,255,255,0.0],
                  outline:{ color:[255,215,0,1], width:4 }
                }
              }));
              sel.add(new Graphic({
                geometry: it.geometryWM,
                symbol: { type:"simple-marker", style:"circle", size:"34px",
                  color:[255,215,0,0.12],
                  outline:{ color:[255,215,0,0.9], width:2 }
                }
              }));
            }
          }catch(e){}

// 4) è‡ªè¨‚å½ˆè·³è¦–çª—ï¼šå­¸æ ¡è³‡è¨Š + çŠ¯ç½ªæ•¸/å¯†åº¦
          __showSchoolPopup(it);
        };
      });
    }
async function __computeSchoolHotspotsCircle(schools, where){
      const radiusM = Number(schoolRadiusSel?.value || 800); // ç”¨ä½ é¢æ¿åŸæœ¬çš„åŠå¾‘ä¸‹æ‹‰
      const areaKm2 = Math.max(0.000001, Math.PI * Math.pow(radiusM/1000, 2));
      const out = [];
      if(schoolComputeStatus) schoolComputeStatus.textContent = `å¿«é€Ÿè¨ˆç®—ï¼ˆåœ“å½¢ ${radiusM}mï¼‰ï¼šå…± ${schools.length} é–“...`;

      for (let i=0;i<schools.length;i++){
        const s = schools[i];
        if(schoolComputeStatus) schoolComputeStatus.textContent = `å¿«é€Ÿè¨ˆç®— ${i+1}/${schools.length}ï¼š${s.name}`;

        let cnt = 0;
        try{
          const buf = geometryEngine.geodesicBuffer(s.geometryWM, radiusM, "meters");
          cnt = await crimeLayer.queryFeatureCount({ where, geometry: buf, spatialRelationship: "intersects" });
        }catch(e){ cnt = 0; }

        const density = cnt / areaKm2;
        out.push({ ...s, count: cnt, density, areaKm2 });

        try{
          if (window.schoolSymbolByCount) s.graphic.symbol = window.schoolSymbolByCount(cnt);
          s.graphic.attributes = s.graphic.attributes || {};
          s.graphic.attributes.crimeCount = cnt;
          s.graphic.attributes.density = density;
        }catch(e){}

        if ((i % 10) === 9) await __yield();
      }

      out.sort((a,b)=> b.density - a.density);
      __renderSchoolRank(out);
      if(schoolComputeStatus) schoolComputeStatus.textContent = `å®Œæˆ âœ…ï¼ˆå¿«é€Ÿç‰ˆï¼‰å·²è¨ˆç®— ${out.length}/${schools.length} é–“`;
      return out;
    }

    // âœ… å…ˆæ¢æ¸¬ ORS æ˜¯å¦å¯ç”¨ï¼ˆé¿å…æ•´æ‰¹è·‘å®Œæ‰ç™¼ç¾å…¨éƒ¨ 403/429ï¼‰
    async function __probeORS(lon, lat){
      try{
        await __getSchoolIso10min(lon, lat);
        return true;
      }catch(e){
        if(schoolComputeStatus) schoolComputeStatus.textContent = `ORS 10åˆ†é˜æ­¥è¡Œç›®å‰ä¸å¯ç”¨ï¼ˆ${e.message}ï¼‰â†’ å·²æ”¹ç”¨ã€Œåœ“å½¢å¿«é€Ÿç‰ˆã€è¨ˆç®—`;
        return false;
      }
    }

window.computeSchoolHotspotsNetwork = async function(){
      try{
        const sl = window.ensureSchoolLayer && window.ensureSchoolLayer();
        if(!sl || sl.graphics.length===0){
          if(schoolComputeStatus) schoolComputeStatus.textContent = "æ‰¾ä¸åˆ°å­¸æ ¡é»ä½ï¼ˆè«‹ç¢ºèªå…¬å…±è¨­æ–½è³‡æ–™å·²è¼‰å…¥ä¸”å«ã€Œå­¸æ ¡ã€ï¼‰";
          return;
        }

        // ç¢ºä¿çŠ¯ç½ªè³‡æ–™è¼‰å…¥ï¼ˆä¸ä¸€å®šè¦å‹¾çŠ¯ç½ªåœ–å±¤ï¼‰
        if (typeof loadCrimeLayerOnce === "function") {
          try{ await loadCrimeLayerOnce(); }catch(e){}
        }
        if (!crimeLayer){
          if(schoolComputeStatus) schoolComputeStatus.textContent = "çŠ¯ç½ªåœ–å±¤å°šæœªå»ºç«‹ï¼Œç„¡æ³•è¨ˆç®—";
          return;
        }

        const where = (typeof buildWhereFromUI === "function") ? buildWhereFromUI() : "1=1";
        const schools = sl.graphics.items.map(g=>{
          const ll = __toLonLat(g.geometry) || { lon: NaN, lat: NaN };
          return {
            name: String(g.attributes?.schoolName || g.attributes?.name || g.attributes?.NAME || "å­¸æ ¡"),
            geometryWM: g.geometry,
            lon: ll.lon,
            lat: ll.lat,
            graphic: g,
            attrs: (g.attributes||{})
          };
        }).filter(s=> Number.isFinite(s.lon) && Number.isFinite(s.lat));

        // å…ˆç”¨ç¬¬ä¸€é–“å­¸æ ¡æ¢æ¸¬ ORS æ˜¯å¦å¯ç”¨ï¼›ä¸å¯ç”¨å°±ç›´æ¥ç”¨ã€Œåœ“å½¢å¿«é€Ÿç‰ˆã€ç¢ºä¿ä¸€å®šæœ‰æ’è¡Œæ¦œ
        if (schools.length > 0){
          const ok = await __probeORS(schools[0].lon, schools[0].lat);
          if (!ok){
            await __computeSchoolHotspotsCircle(schools, where);
            return;
          }
        }

        // åˆ†æ‰¹è¨ˆç®—ï¼šé¿å…ç•¶æ©Ÿï¼ˆä¹Ÿé¿å… ORS è¢«æ‰“çˆ†ï¼‰
        const results = [];
        if(schoolComputeStatus) schoolComputeStatus.textContent = `é–‹å§‹è¨ˆç®—ï¼šå…± ${schools.length} é–“å­¸æ ¡ï¼ˆ10åˆ†é˜æ­¥è¡Œï¼‰...`;

        for (let i=0;i<schools.length;i++){
          const s = schools[i];

          // é€²åº¦
          if(schoolComputeStatus) schoolComputeStatus.textContent = `è¨ˆç®—ä¸­ ${i+1}/${schools.length}ï¼š${s.name}`;

          // å–å¾— 10 åˆ†é˜ç­‰æ™‚åœˆï¼ˆåŠ ç¯€æµï¼Œé¿å… API æ‹’çµ•ï¼‰
          let iso = null;
          try{
            iso = await __getSchoolIso10min(s.lon, s.lat);
          }catch(e){
            // ORS å¤±æ•—å°±ç•¥éï¼ˆä¸ç•¶æ©Ÿï¼‰
            await __sleep(100);
            continue;
          }

          // ç¯„åœå…§çŠ¯ç½ªæ•¸
          let count = 0;
          try{
            count = await crimeLayer.queryFeatureCount({
              where,
              geometry: iso.polyWM,
              spatialRelationship: "intersects"
            });
          }catch(e){ count = 0; }

          const density = count / iso.areaKm2;
          results.push({ ...s, count, density, areaKm2: iso.areaKm2, iso });

          // æ›´æ–°å­¸æ ¡ç¬¦è™Ÿï¼ˆç”¨ä»¶æ•¸å¿«é€Ÿé¡è‰²é è¦½ï¼‰
          try{
            if (window.schoolSymbolByCount) s.graphic.symbol = window.schoolSymbolByCount(count);
            s.graphic.attributes = s.graphic.attributes || {};
            s.graphic.attributes.crimeCount = count;
            s.graphic.attributes.density = density;
          }catch(e){}

          // âœ… æ¯ 3 é–“å­¸æ ¡è®“å‡ºäº‹ä»¶è¿´åœˆ + ç¯€æµ API
          if ((i % 3) === 2) await __yield();
          await __sleep(250);
        }

        results.sort((a,b)=> b.density - a.density);
        // è‹¥ ORS å…¨éƒ¨å¤±æ•—ï¼Œæ”¹ç”¨åœ“å½¢å¿«é€Ÿç‰ˆè£œå‡ºæ’è¡Œæ¦œ
        if (results.length === 0){
          await __computeSchoolHotspotsCircle(schools, where);
          return;
        }
        __renderSchoolRank(results);

        if(schoolComputeStatus){
          schoolComputeStatus.textContent = (results.length>0) ? `å®Œæˆ âœ… å·²è¨ˆç®— ${results.length}/${schools.length} é–“` : `å®Œæˆä½†æ²’æœ‰ç”¢ç”Ÿçµæœ âš ï¸ï¼ˆORS å¯èƒ½å› 429/403ï¼Œæˆ–å­¸æ ¡é»ä½åº§æ¨™ç•°å¸¸ï¼›è«‹çœ‹ä¸‹æ–¹æç¤ºï¼‰`;
        }
      }catch(err){
        console.error(err);
        if(schoolComputeStatus) schoolComputeStatus.textContent = "è¨ˆç®—å¤±æ•—ï¼š" + err.message;
      }
    };

    // âœ… äº‹ä»¶ï¼šå­¸æ ¡é»ä½é–‹é—œï¼ˆåªé¡¯ç¤º/éš±è—ï¼Œä¸è‡ªå‹•ç®—ï¼‰
    if (schoolToggleEl){
      schoolToggleEl.onchange = () => {
        const sl = window.ensureSchoolLayer && window.ensureSchoolLayer();
        if (sl) sl.visible = !!schoolToggleEl.checked;
      };
    }

    // âœ… äº‹ä»¶ï¼šæŒ‰è¨ˆç®—
    if (btnSchoolCompute){
      btnSchoolCompute.onclick = async () => {
        const wrap = document.getElementById("schoolRankWrap");
        // å†æŒ‰ä¸€æ¬¡ï¼šé—œé–‰æ’è¡Œæ¦œï¼ˆä¸é‡ç®—ï¼‰
        if (wrap && wrap.style.display === "block") {
          wrap.style.display = "none";
          return;
        }
        if (wrap) wrap.style.display = "block";
        await window.computeSchoolHotspotsNetwork();
      };
    }

    // âœ… å•Ÿå‹•ï¼ˆå…¬è»Šç«™ç‰Œ/å…¬è»Šè·¯ç·š/YouBike/EV/åœè»Šå ´â€¦ï¼‰
    initStations();

});</script>



<!-- ===== æ•™è‚²ç¨‹åº¦çµ±è¨ˆï¼ˆç§»æ¤è‡ª äººå£+æ•™è‚² æª”ï¼‰ ===== -->
<script>
(() => {
  const DATA_URL = "https://jade0815.github.io/data/106%E5%B9%B4~113%E6%95%99%E8%82%B2%E7%A8%8B%E5%BA%A6%E8%A8%BB%E8%A8%98.geojson";
  const yearsExpected = ["106","107","108","109","110","111","112","113"];

  // ====== å¹´é½¡åˆ¥æ­£è¦åŒ–ï¼ˆç©ºæ ¼/å…¨å½¢/æ³¢æµªç·šï¼‰ ======
  function normalizeAgeLabel(ageRaw){
    const s = (ageRaw ?? "").toString().trim();
    if(!s) return "æœªå¡«";
    let t = s.replace(/\s+/g,"");
    t = t.replace(/ï½/g,"~").replace(/ï¹/g,"~").replace(/ï¼/g,"-").replace(/æ­²/g,"");
    const m = t.match(/(\d+)[^\d]+(\d+)/);
    if(m){
      const a = parseInt(m[1],10), b = parseInt(m[2],10);
      if(Number.isFinite(a) && Number.isFinite(b)) return `${a}-${b}`;
    }
    return t;
  }

  function toNum(x){
    const n = Number((x ?? "0").toString().replace(/,/g,""));
    return Number.isFinite(n) ? n : 0;
  }

  // ====== æ•™è‚²åˆ†é¡ï¼šåªç®—ã€Œç•¢æ¥­ã€ï¼ˆä¸å«è‚„æ¥­ï¼‰ ======
  const EDU_ORDER = ["åšå£«","ç¢©å£«","å¤§å­¸","å°ˆç§‘","é«˜ä¸­è·","åœ‹ä¸­","åœ‹å°","è‡ªä¿®","ä¸è­˜å­—"];

  function getGraduatedOnlyCounts(props){
    const phd = toNum(props["è­˜å­—è€…ç ”ç©¶æ‰€åšå£«ç•¢æ¥­äººæ•¸"]);
    const master = toNum(props["è­˜å­—è€…ç ”ç©¶æ‰€ç¢©å£«ç•¢æ¥­äººæ•¸"]);
    const uni = toNum(props["è­˜å­—è€…å¤§å­¸ç•¢æ¥­äººæ•¸"]);
    const juniorCollege =
      toNum(props["è­˜å­—è€…å°ˆç§‘äºŒæˆ–ä¸‰å¹´åˆ¶ç•¢æ¥­äººæ•¸"]) +
      toNum(props["è­˜å­—è€…å°ˆç§‘äº”å¹´åˆ¶å¾ŒäºŒå¹´ç•¢æ¥­äººæ•¸"]);
    const highSchool =
      toNum(props["è­˜å­—è€…é«˜ç´šä¸­ç­‰æ™®é€šæ•™è‚²é«˜ä¸­ç•¢æ¥­äººæ•¸"]) +
      toNum(props["è­˜å­—è€…é«˜ç´šä¸­ç­‰è·æ¥­æ•™è‚²é«˜è·ç•¢æ¥­äººæ•¸"]);
    const juniorHigh =
      toNum(props["è­˜å­—è€…åœ‹ä¸­ç•¢æ¥­äººæ•¸"]) +
      toNum(props["è­˜å­—è€…åˆè·ç•¢æ¥­äººæ•¸"]);
    const elementary = toNum(props["è­˜å­—è€…åœ‹å°ç•¢æ¥­äººæ•¸"]);
    const selfStudy = toNum(props["è­˜å­—è€…è‡ªä¿®äººæ•¸"]);
    const illiterate = toNum(props["ä¸è­˜å­—è€…äººæ•¸"]);
    return { "åšå£«":phd,"ç¢©å£«":master,"å¤§å­¸":uni,"å°ˆç§‘":juniorCollege,"é«˜ä¸­è·":highSchool,"åœ‹ä¸­":juniorHigh,"åœ‹å°":elementary,"è‡ªä¿®":selfStudy,"ä¸è­˜å­—":illiterate };
  }

  // ====== store: area -> year -> sex -> ageKey -> record ======
  const store = new Map();
  function ensure(path){
    let cur = store;
    for(const key of path){
      if(!cur.has(key)) cur.set(key, new Map());
      cur = cur.get(key);
    }
    return cur;
  }
  function getRecord(area, year, sex, ageKey){
    const mAge = ensure([area, year, sex]);
    if(!mAge.has(ageKey)){
      const init = { total:0, grouped:{} };
      for(const k of EDU_ORDER) init.grouped[k] = 0;
      mAge.set(ageKey, init);
    }
    return mAge.get(ageKey);
  }
  function addToRecord(rec, props){
    rec.total += toNum(props["è­˜å­—è€…åˆè¨ˆäººæ•¸"]);
    const g = getGraduatedOnlyCounts(props);
    for(const k of EDU_ORDER) rec.grouped[k] += (g[k] || 0);
  }
  function getCombinedRecord(area, year, ageKey){
    const total0 = store.get(area)?.get(year)?.get("0")?.get(ageKey);
    if(total0) return total0;

    const male = store.get(area)?.get(year)?.get("1")?.get(ageKey);
    const female = store.get(area)?.get(year)?.get("2")?.get(ageKey);
    const rec = { total:0, grouped:{} };
    for(const k of EDU_ORDER) rec.grouped[k] = 0;
    const add = (r)=>{
      if(!r) return;
      rec.total += (r.total||0);
      for(const k of EDU_ORDER) rec.grouped[k] += (r.grouped?.[k] || 0);
    };
    add(male); add(female);
    return rec;
  }
  function sortAgesAsc(list){
    const withKey = list.map(a=>{
      const m = a.match(/^(\d+)-(\d+)$/);
      if(m) return {a, k: parseInt(m[1],10)};
      return {a, k: 999999};
    });
    withKey.sort((p,q)=>p.k-q.k);
    return withKey.map(x=>x.a);
  }

  // ====== UI ======
  const elSmallTitle = document.getElementById("eduSmallTitle");
  const elDetailPanel = document.getElementById("eduDetailPanel");
  const elDetailTitle = document.getElementById("eduDetailTitle");
  const elCloseBtn = document.getElementById("eduCloseBtn");
  const overlay = document.getElementById("statsOverlay");

  const selArea = document.getElementById("eduSelArea");
  const selSex  = document.getElementById("eduSelSex");
  const selYear = document.getElementById("eduSelYear");
  const selAge  = document.getElementById("eduSelAge");

  elCloseBtn.onclick = () => { elDetailPanel.style.display = "none"; overlay.style.display="none"; document.body.classList.remove("edu-open"); };
// ====== é¡è‰²ï¼ˆäº®ï¼‰ ======
  const BRIGHT_COLORS = ["#22c55e","#38bdf8","#a78bfa","#fb7185","#fbbf24","#f97316","#2dd4bf","#60a5fa","#f472b6"];

  // ====== Charts ======
  const smallLine = new Chart(document.getElementById("eduSmallLine").getContext("2d"), {
    type: "line",
    data: {
      labels: yearsExpected,
      datasets: [{
        label: "è­˜å­—è€…åˆè¨ˆäººæ•¸",
        data: [],
        borderColor: "#ffffff",
        backgroundColor: "rgba(255,255,255,0.25)",
        fill: true,
        tension: 0.3,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color:"#ffffff" } },
        tooltip: { enabled:true, mode:"index", intersect:false }
      },
      scales: {
        x: { ticks:{ color:"#ffffff" }, grid:{ display:false } },
        y: { ticks:{ color:"#ffffff" }, beginAtZero:true }
      }
    }
  });

  const stackBar = new Chart(document.getElementById("eduStackBar").getContext("2d"), {
    type: "bar",
    data: { labels: [], datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position:"bottom", labels:{ color:"#ffffff" } },
        tooltip: { enabled:true, mode:"index", intersect:false }
      },
      scales: {
        x: { stacked:true, ticks:{ color:"#ffffff" } },
        y: { stacked:true, ticks:{ color:"#ffffff" }, beginAtZero:true }
      }
    }
  });

  const singleBar = new Chart(document.getElementById("eduSingleBar").getContext("2d"), {
    type: "bar",
    data: { labels: [], datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display:false }, tooltip: { enabled:true } },
      scales: {
        x: { ticks:{ color:"#ffffff" } },
        y: { ticks:{ color:"#ffffff" }, beginAtZero:true }
      }
    }
  });

  // ====== selectors ======
  function fillSelect(select, list, prefer){
    select.innerHTML = "";
    list.forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      select.appendChild(opt);
    });
    if(prefer && list.includes(prefer)) select.value = prefer;
  }
  function getAreaList(){ return Array.from(store.keys()).sort((a,b)=>a.localeCompare(b, "zh-Hant")); }
  function getYearList(area){
    const m = store.get(area);
    if(!m) return yearsExpected;
    const ys = Array.from(m.keys());
    const ordered = yearsExpected.filter(y=>ys.includes(y));
    ys.forEach(y=>{ if(!ordered.includes(y)) ordered.push(y); });
    return ordered;
  }
  function getAgeUnion(area, year, sex){
    const out = new Set();
    if(sex === "0"){
      ["1","2","0"].forEach(s=>{
        const mA = store.get(area)?.get(year)?.get(s);
        if(mA) Array.from(mA.keys()).forEach(a=>out.add(a));
      });
    } else {
      const mA = store.get(area)?.get(year)?.get(sex);
      if(mA) Array.from(mA.keys()).forEach(a=>out.add(a));
    }
    return sortAgesAsc(Array.from(out));
  }
  function refreshSelectors(){
    const areas = getAreaList();
    fillSelect(selArea, areas, selArea.value || areas[0]);
    const years = getYearList(selArea.value);
    fillSelect(selYear, years, selYear.value || years[0]);
    const ages = getAgeUnion(selArea.value, selYear.value, selSex.value || "0");
    fillSelect(selAge, ages, selAge.value || ages[0]);
    if(!selAge.value) selAge.value = (selAge.options[0]?.value || "æœªå¡«");
    if(!selYear.value) selYear.value = yearsExpected[0];
  }

  // ====== small panel: å…¨éƒ¨å¹´é½¡åŠ ç¸½ï¼ˆä¾å¹´ä»½ï¼‰ ======
  function totalByYear(area, year, sex){
    let sum = 0;
    const ages = getAgeUnion(area, year, sex);
    for(const a of ages){
      if(sex === "0") sum += (getCombinedRecord(area, year, a).total || 0);
      else sum += (store.get(area)?.get(year)?.get(sex)?.get(a)?.total || 0);
    }
    return sum;
  }
  function renderSmallLine(){
    const area = selArea.value;
    const sex  = selSex.value;
    const series = yearsExpected.map(y => totalByYear(area, y, sex));
    smallLine.data.datasets[0].data = series;
    smallLine.update();
    elSmallTitle.textContent = `æ•™è‚²ç¨‹åº¦äººå£æŠ˜ç·šåœ–ï¼ˆå…¨éƒ¨å¹´é½¡åŠ ç¸½ï¼‰`;
  }

  function renderStack(){
    const area = selArea.value;
    const year = selYear.value;
    const sex  = selSex.value;
    const ageList = getAgeUnion(area, year, sex);
    const getRec = (ageKey)=>{
      if(sex === "0") return getCombinedRecord(area, year, ageKey);
      return store.get(area)?.get(year)?.get(sex)?.get(ageKey) || { total:0, grouped:{} };
    };
    const datasets = EDU_ORDER.map((k, i)=>({
      label: k,
      data: ageList.map(a => (getRec(a).grouped?.[k] || 0)),
      backgroundColor: BRIGHT_COLORS[i % BRIGHT_COLORS.length],
      borderColor: "rgba(255,255,255,0.6)",
      borderWidth: 0.5
    }));
    stackBar.data.labels = ageList;
    stackBar.data.datasets = datasets;
    stackBar.update();
    document.getElementById("eduStackTitle").textContent = `${year}å¹´å„å¹´é½¡åˆ¥æ•™è‚²ç¨‹åº¦çµ±è¨ˆ`;
  }

  function renderSingleBar(){
    const area = selArea.value;
    const year = selYear.value;
    const sex  = selSex.value;
    const age  = selAge.value;
    const rec = (sex === "0")
      ? getCombinedRecord(area, year, age)
      : (store.get(area)?.get(year)?.get(sex)?.get(age) || { grouped:{} });
    const values = EDU_ORDER.map(k => rec.grouped?.[k] || 0);
    singleBar.data.labels = EDU_ORDER;
    singleBar.data.datasets = [{
      data: values,
      backgroundColor: EDU_ORDER.map((_,i)=>BRIGHT_COLORS[i % BRIGHT_COLORS.length]),
      borderColor: "rgba(255,255,255,0.7)",
      borderWidth: 0.6
    }];
    singleBar.update();
    document.getElementById("eduSingleBarTitle").textContent = `${year}å¹´ ${age} æ­² æ•™è‚²ç¨‹åº¦ç›´æ–¹åœ–`;
  }

  function renderAll(){
    renderSmallLine();
    renderStack();
    renderSingleBar();
    elDetailTitle.textContent = `æ•™è‚²ç¨‹åº¦çµ±è¨ˆï¼ˆ${selArea.value}ï¼‰`;
  }
[selArea, selSex, selYear, selAge].forEach(el=>{
    el.addEventListener("change", ()=>{
      refreshSelectors();
      renderAll();
    });
  });

  async function load(){
    elSmallTitle.textContent = "æ•™è‚²ç¨‹åº¦äººå£æŠ˜ç·šåœ–ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰";
    const res = await fetch(DATA_URL);
    const gj = await res.json();
    const feats = Array.isArray(gj.features) ? gj.features : [];
    feats.forEach(f=>{
      const p = f.properties || {};
      const area = (p["å€åŸŸåˆ¥"] ?? "æœªå¡«").toString().trim() || "æœªå¡«";
      const year = (p["å¹´ä»½"] ?? "").toString().trim() || "æœªå¡«";
      const sex  = (p["æ€§åˆ¥"] ?? "0").toString().trim() || "0";
      const ageKey = normalizeAgeLabel(p["å¹´é½¡åˆ¥"]);
      const rec = getRecord(area, year, sex, ageKey);
      addToRecord(rec, p);
    });


// âœ… æä¾›å®œå±…åˆ†æ•¸è¨ˆç®—ä½¿ç”¨ï¼ˆä¸å½±éŸ¿åŸæœ¬æ•™è‚²é¢æ¿ï¼‰
window.__eduStore = store;
window.__eduAreas = () => Array.from(store.keys());
window.__eduGetAgg = (area, year) => {
  const mYear = store.get(area);
  if(!mYear) return null;
  const mSex = mYear.get(year);
  if(!mSex) return null;

  const sums = { popTotal: 0, grad: {} };
  EDU_ORDER.forEach(k => sums.grad[k]=0);

  mSex.forEach((mAge)=>{
    mAge.forEach((rec)=>{
      const ill = rec.grouped["ä¸è­˜å­—"] || 0;
      const pop = (rec.total || 0) + ill;
      sums.popTotal += pop;
      EDU_ORDER.forEach(k => { sums.grad[k] += (rec.grouped[k] || 0); });
    });
  });
  return sums;
};

    refreshSelectors();
    if(getAreaList().includes("æ¡ƒåœ’å€")) selArea.value = "æ¡ƒåœ’å€";
    refreshSelectors();

    const agesNow = Array.from(selAge.options).map(o=>o.value);
    if(agesNow.includes("15-19")) selAge.value = "15-19";
    renderAll();
  }

  load().catch(err=>{
    console.error(err);
    elSmallTitle.textContent = "è¼‰å…¥å¤±æ•—ï¼šè«‹æª¢æŸ¥è³‡æ–™ç¶²å€æ˜¯å¦å¯é€£ç·š";
  });
})();
</script>

<!-- ===== äººå£/æ•™è‚² å°é¢æ¿åˆ‡æ›ï¼ˆç§»æ¤è‡ª äººå£+æ•™è‚² æª”ï¼‰ ===== -->
<script>
(function initUnifiedStatsPanels(){
  const overlay = document.getElementById("statsOverlay");
  const smallWrap = document.getElementById("statsSmallPanel");
  const panePop = document.getElementById("statsPanePop");
  const paneEdu = document.getElementById("statsPaneEdu");
  const tabPop = document.getElementById("tabStatsPop");
  const tabEdu = document.getElementById("tabStatsEdu");

  const popSmall = document.getElementById("chartContainer");
  const eduSmall = document.getElementById("eduSmallPanel");
  const popBig = document.getElementById("detailPanel");
  const eduBig = document.getElementById("eduDetailPanel");

  let current = "pop";

  function show(which){
    current = which;
    tabPop.classList.toggle("active", which==="pop");
    tabEdu.classList.toggle("active", which==="edu");
    panePop.classList.toggle("active", which==="pop");
    paneEdu.classList.toggle("active", which==="edu");

    // åˆ‡åˆ°æ•™è‚²æ™‚åˆ·æ–° chart å°ºå¯¸ï¼ˆé¿å… display none å°ºå¯¸æ€ªï¼‰
    if(which==="edu"){
      setTimeout(()=>{ window.__edu_forceRefresh && window.__edu_forceRefresh(); }, 80);
    }
  }

  function openBig(which){
    // å…ˆé—œæ‰å¦ä¸€å€‹
    if(popBig) popBig.style.display = "none";
    if(eduBig) eduBig.style.display = "none";

    overlay.style.display = "block";
    if(which==="pop"){
      document.body.classList.remove("edu-open");
      if(popBig) popBig.style.display = "block";
    }
    if(which==="edu"){
      document.body.classList.add("edu-open");
      if(eduBig) eduBig.style.display = "flex";
      // é€²ä¸€æ­¥ç¢ºä¿æ•™è‚²åœ–è¡¨å°ºå¯¸
      setTimeout(()=>{ window.__edu_forceRefresh && window.__edu_forceRefresh(); }, 120);
    }
  }

  function closeAll(){
  overlay.style.display = "none";
  document.body.classList.remove("edu-open");
  if(popBig) popBig.style.display = "none";
  if(eduBig) eduBig.style.display = "none";

  // âœ… é—œé–‰ä»»ä½•å¤§é¢æ¿å¾Œï¼šå°é¢æ¿ä¸€å¾‹å›åˆ°ã€Œäººå£ç¸½æ•¸æŠ˜ç·šåœ–ã€åˆå§‹ç‹€æ…‹
  try{ show("pop"); }catch(e){}
  try{ currentFeature = null; }catch(e){}
  try{
    if (typeof updatePopulationChartTotal === "function" && Array.isArray(allFeatures) && allFeatures.length){
      updatePopulationChartTotal(allFeatures);
    }
  }catch(e){}

  // è®“ã€Œç¸½åˆçµ±è¨ˆã€æŒ‰éˆ•ä¿æŒ activeï¼ˆé¿å…çœ‹èµ·ä¾†é‚„åœåœ¨å–®å€æ¨¡å¼ï¼‰
  try{
    const btnTotal = document.getElementById("btnTotal");
    if(btnTotal) btnTotal.classList.add("active");
  }catch(e){}
}


  // æŠŠå…©å€‹å°é¢æ¿æ¬é€² wrapper
  function mount(){
    if(popSmall && !panePop.contains(popSmall)) panePop.appendChild(popSmall);
    if(eduSmall && !paneEdu.contains(eduSmall)) paneEdu.appendChild(eduSmall);
  }

  // å–ä»£åŸæœ¬å°é¢æ¿çš„ click è¡Œç‚ºï¼ˆç”¨ capture + stopImmediatePropagation æ“‹æ‰èˆŠ handlerï¼‰
  function overrideClicks(){
    if(popSmall){
      popSmall.addEventListener("click", (e)=>{
        // âœ… é»åˆ°å…§éƒ¨æŒ‰éˆ•ï¼ˆä¾‹å¦‚ã€Œé–‹å•Ÿæœ€å°çµ±è¨ˆå€ã€ï¼‰æ™‚ï¼Œä¸è¦è§¸ç™¼é–‹å¤§é¢æ¿
        if (e.target && e.target.closest && e.target.closest("#toggleLayerBtn")) return;
        e.preventDefault();
        e.stopImmediatePropagation();
        show("pop");
        openBig("pop");
      }, true);
    }
    if(eduSmall){
      eduSmall.addEventListener("click", (e)=>{
        e.preventDefault();
        e.stopImmediatePropagation();
        show("edu");
        openBig("edu");
      }, true);
    }
  }

  tabPop.addEventListener("click", (e)=>{ e.stopPropagation(); show("pop"); });
  tabEdu.addEventListener("click", (e)=>{ e.stopPropagation(); show("edu"); });

  overlay.addEventListener("click", closeAll);

  // ä¹Ÿè®“å…©å¥—å¤§é¢æ¿çš„é—œé–‰éˆ•åŒæ­¥é—œ overlay
  const popClose = document.getElementById("closeDetailBtn") || document.getElementById("closeBtn"); // ä½ äººå£é¢æ¿çš„ close id å¯èƒ½ä¸åŒ
  if(popClose) popClose.addEventListener("click", ()=>{ closeAll(); }, true);
  const eduClose = document.getElementById("eduCloseBtn");
  if(eduClose) eduClose.addEventListener("click", ()=>{ closeAll(); }, true);

  // åˆå§‹åŒ–
  mount();
  overrideClicks();
  show("pop"); // é è¨­äººå£

})();


  // =========================
  // âœ… CMSï¼ˆé“è·¯è³‡è¨Šçœ‹æ¿ï¼‰æŒ‰éˆ• / Popup
  // =========================
  (function(){
    const cmsBtn = document.getElementById("cms-toggle-btn");
    const cmsPopup = document.getElementById("cms-popup");
    if(!cmsBtn || !cmsPopup) return;

    cmsBtn.addEventListener("click", async () => {
      // äº¤é€šé—œé–‰æ™‚ä¸åšäº‹
      if (document.body.classList.contains("map-only")) return;

      const opening = (cmsPopup.style.display === "none" || cmsPopup.style.display === "");
      if (opening) {
        cmsPopup.style.display = "block";
        cmsBtn.classList.add("active");

        // ç›®å‰ç‰ˆæœ¬æ²’æœ‰æ¥ CMS APIï¼Œå°±å…ˆé¡¯ç¤ºæç¤ºï¼ˆé¿å…ã€Œé»äº†æ²’åæ‡‰ã€ï¼‰
        if (!cmsPopup.dataset.inited) {
          cmsPopup.innerHTML = `
            <strong>CMS</strong>
            <p>ç›®å‰æ­¤ç‰ˆæœ¬å°šæœªä¸²æ¥ CMS å³æ™‚è³‡æ–™ã€‚</p>
            <p style="font-size:12px;color:#666">ï¼ˆæŒ‰ä¸€ä¸‹å¯é—œé–‰ï¼‰</p>
          `;
          cmsPopup.dataset.inited = "1";
        }
      } else {
        cmsPopup.style.display = "none";
        cmsBtn.classList.remove("active");
      }
    });
  })();

</script>


<script>
/* âœ… CCTV é¢æ¿å¯æ‹–æ›³ï¼šæ‹–æ›³æ¨™é¡Œåˆ—(h3)ç§»å‹•é¢æ¿ä½ç½® */
(function(){
  function makeDraggable(panel, handle){
    if(!panel || !handle) return;

    let dragging = false;
    let startX = 0, startY = 0;
    let startLeft = 0, startTop = 0;

    // Ensure panel uses top/left when dragged
    function ensurePositioning(){
      // keep fixed positioning, but if still centered by transform, convert to pixel top/left
      const rect = panel.getBoundingClientRect();
      panel.style.left = rect.left + "px";
      panel.style.top  = rect.top  + "px";
      panel.style.transform = "none";
      panel.style.margin = "0";
    }

    function clamp(val, min, max){ return Math.min(Math.max(val, min), max); }

    const onMove = (e) => {
      if(!dragging) return;
      const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
      const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;

      const dx = clientX - startX;
      const dy = clientY - startY;

      const rect = panel.getBoundingClientRect();
      const newLeftRaw = startLeft + dx;
      const newTopRaw  = startTop  + dy;

      const maxLeft = window.innerWidth  - rect.width;
      const maxTop  = window.innerHeight - rect.height;

      const newLeft = clamp(newLeftRaw, 0, Math.max(0, maxLeft));
      const newTop  = clamp(newTopRaw,  0, Math.max(0, maxTop));

      panel.style.left = newLeft + "px";
      panel.style.top  = newTop  + "px";
    };

    const onUp = () => {
      if(!dragging) return;
      dragging = false;
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
      document.removeEventListener("touchmove", onMove, {passive:false});
      document.removeEventListener("touchend", onUp);
    };

    const onDown = (e) => {
      // only allow drag when panel is visible
      const display = window.getComputedStyle(panel).display;
      if(display === "none") return;

      // avoid dragging when user is selecting text
      e.preventDefault();

      ensurePositioning();

      const rect = panel.getBoundingClientRect();
      startLeft = rect.left;
      startTop  = rect.top;

      const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
      const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
      startX = clientX;
      startY = clientY;

      dragging = true;

      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onUp);
      document.addEventListener("touchmove", onMove, {passive:false});
      document.addEventListener("touchend", onUp);
    };

    handle.addEventListener("mousedown", onDown);
    handle.addEventListener("touchstart", onDown, {passive:false});

    // If window resized, keep panel inside viewport
    window.addEventListener("resize", () => {
      if(window.getComputedStyle(panel).display === "none") return;
      const rect = panel.getBoundingClientRect();
      const maxLeft = window.innerWidth  - rect.width;
      const maxTop  = window.innerHeight - rect.height;
      const left = clamp(rect.left, 0, Math.max(0, maxLeft));
      const top  = clamp(rect.top,  0, Math.max(0, maxTop));
      panel.style.left = left + "px";
      panel.style.top  = top  + "px";
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    const panel = document.getElementById("cctv-panel");
    const handle = panel ? panel.querySelector("h3") : null;
    makeDraggable(panel, handle);
  });
})();
</script>


<script>
/* ===== ä¿®æ­£ï¼šé—œé–‰è‡ªè¨‚ç¯„åœæ™‚ï¼ŒåŒæ­¥é—œé–‰ 15 åˆ†é˜ç”Ÿæ´»åœˆç¯„åœ ===== */
(function(){
  function closeLifeCircleIfAny(){
    try{
      // é—œé–‰ iso/15åˆ†é˜ç›¸é—œåœ–å±¤ï¼ˆåç¨±ä¾ä½ åŸæœ¬å°ˆæ¡ˆå¸¸è¦‹å¯«æ³•ï¼‰
      if(window.isoLayer) isoLayer.visible = false;
      if(window.lifeIsoLayer) lifeIsoLayer.visible = false;
      if(window.isochroneLayer) isochroneLayer.visible = false;

      // æ¸…é™¤ Graphics
      if(window.isoGraphicsLayer) isoGraphicsLayer.removeAll();
      if(window.lifeIsoGraphicsLayer) lifeIsoGraphicsLayer.removeAll();

      // é‡ç½® UI ç‹€æ…‹
      if(window.lifeSwitch) lifeSwitch.checked = false;
      // âœ… äº’æ–¥åªæš«åœã€Œ15 åˆ†é˜ç”Ÿæ´»åœˆåŠŸèƒ½ã€ï¼šä¸è¦æŠŠ lifePanel æ•´å€‹éš±è—ï¼ˆé¿å…é¢æ¿æ¶ˆå¤±ï¼‰

      try{ if(typeof switchLifeTab === "function") switchLifeTab("live"); }catch(e){}
      if(window.lifeIsoPage) lifeIsoPage.classList.remove("active");
    }catch(e){}
  }

  // æ””æˆªè‡ªè¨‚ç¯„åœé¢æ¿é—œé–‰è¡Œç‚º
  const origClose = window.closeCustomRangePanel;
  window.closeCustomRangePanel = function(){
    if(typeof origClose === "function") origClose();
    // åŒæ­¥é—œé–‰ 15 åˆ†é˜ç”Ÿæ´»åœˆ
    closeLifeCircleIfAny();
  };

  // è‹¥ä½ æ˜¯ç”¨æŒ‰éˆ•åˆ‡æ›é¡¯ç¤º/éš±è—è‡ªè¨‚ç¯„åœ
  const btn = document.getElementById("rangeToolToggleBtn");
  if(btn){
    btn.addEventListener("click", () => {
      const panel = document.getElementById("customPanel");
      if(panel && panel.style.display === "none"){
        // é¢æ¿è¢«é—œé–‰æ™‚
        closeLifeCircleIfAny();
      }
    });
  }
})();
</script>

</body>
</html>